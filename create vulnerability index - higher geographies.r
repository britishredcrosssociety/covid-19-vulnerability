##
## Aggregate England's MSOA-level Vulnerability Index into Regions and Tactical Cells
##
library(tidyverse)
library(janitor)
library(sf)

source("functions.r")
source("load lookup tables.r")

vi_msoa = read_csv("output/vulnerability-MSOA-UK.csv")  # run "create vulnerability index - MSOA.r" to make this dataset
vi_lad = read_csv("output/vulnerability-LA.csv")  # run "create vulnerability index - LA.r" to make this dataset

##
## lookup tables
##
# MSOA to LA codes for England, Wales and Scotland
msoa_lad_ews = load_lookup_lsoa_msoa_lad() %>% 
  select(MSOA11CD, LAD17CD) %>% 
  distinct()

# SOA to LA codes for Northern Ireland
soa_lgd = load_lookup_sa_lgd() %>% 
  select(MSOA11CD = LSOA11CD, LAD17CD = LAD18CD) %>% 
  distinct()

# append NI's codes to the rest
msoa_lad = bind_rows(msoa_lad_ews, soa_lgd)

lad_17_19 = read_csv("data/LAD 2017 to LAD 2019 codes.csv")  # lookup of Local Authority codes from 2017 to 2019

lad_regions = read_csv("https://opendata.arcgis.com/datasets/3ba3daf9278f47daba0f561889c3521a_0.csv") %>% 
  select(LAD19CD, RGN19NM)

# tactical cells
msoa_tc = read_csv("data/lookup msoa to tactical cell.csv") %>% select(MSOA11CD, TacticalCell)
lad_tc = read_csv("data/lookup local authority to tactical cell.csv")

# get 2019 LA codes and regions and Cells
msoa_lad_tc = msoa_lad %>% 
  left_join(lad_17_19, by = "LAD17CD") %>% 
  left_join(lad_regions, by = "LAD19CD") %>% 
  left_join(msoa_tc, by = "MSOA11CD")

# make sure all TCs and regions are named
msoa_lad_tc = msoa_lad_tc %>% 
  mutate(TacticalCell = case_when(
    str_sub(MSOA11CD, 1, 1) == "9" ~ "Northern Ireland and Isle of Man",
    TRUE ~ TacticalCell
  )) %>% 
  
  mutate(RGN19NM = case_when(
    str_sub(MSOA11CD, 1, 1) == "9" ~ "Northern Ireland and Isle of Man",
    str_sub(MSOA11CD, 1, 1) == "S" ~ "Scotland",
    str_sub(MSOA11CD, 1, 1) == "W" ~ "Wales",
    TRUE ~ RGN19NM
  )) 

# check all regions/cells are named
# msoa_lad %>% 
#   filter(is.na(RGN19NM) | is.na(TacticalCell)) %>% 
#   mutate(X = str_sub(MSOA11CD, 1, 1)) %>% 
#   select(X) %>% 
#   distinct()

# get MSOA-level population estimates
source("prep population estimates.r")

# get Regions and Tactical Cells for VI
vi_msoa = vi_msoa %>% 
  left_join(msoa_lad_tc, by = c("Code" = "MSOA11CD")) %>% 
  left_join(pop, by = "Code")


###############################################################################
## Aggregate into Tactical Cells
##
# clinical vulnerability
clinical = vi_msoa %>% 
  aggregate_scores(domain = "Clinical", aggregate_by = "TacticalCell") %>% 
  rename(`Proportion of neighbourhoods in 20% most clinically vulnerable` = Proportion,
         `Extent of population living in highly clinically vulnerable areas` = Extent,
         `Population-weighted clinical vulnerability score` = Score)

# health/wellbeing vulnerability 
health_wellbeing = vi_msoa %>% 
  aggregate_scores(domain = "Health/Wellbeing", aggregate_by = "TacticalCell") %>% 
  rename(`Proportion of neighbourhoods in 20% most health/wellbeing vulnerable` = Proportion,
         `Extent of population living in highly health/wellbeing vulnerable areas` = Extent,
         `Population-weighted health/wellbeing vulnerability score` = Score)

# economic vulnerability
economic = vi_msoa %>% 
  aggregate_scores(domain = "Economic", aggregate_by = "TacticalCell") %>% 
  rename(`Proportion of neighbourhoods in 20% most economically vulnerable` = Proportion,
         `Extent of population living in highly economically vulnerable areas` = Extent,
         `Population-weighted economic vulnerability score` = Score)

# social vulnerability 
social = vi_msoa %>% 
  aggregate_scores(domain = "Social", aggregate_by = "TacticalCell") %>% 
  rename(`Proportion of neighbourhoods in 20% most socially vulnerable` = Proportion,
         `Extent of population living in highly socially vulnerable areas` = Extent,
         `Population-weighted social vulnerability score` = Score)

# combine and save
vi_cell = clinical %>% 
  left_join(health_wellbeing, by = "TacticalCell") %>% 
  left_join(economic, by = "TacticalCell") %>% 
  left_join(social, by = "TacticalCell")

write_csv(vi_cell, "output/archive/vulnerability-tactical-cell.csv")


###############################################################################
## Aggregate into Regions
##
# clinical vulnerability
clinical = vi_msoa %>% 
  aggregate_scores(domain = "Clinical", aggregate_by = "RGN19NM") %>% 
  rename(`Proportion of neighbourhoods in 20% most clinically vulnerable` = Proportion,
         `Extent of population living in highly clinically vulnerable areas` = Extent,
         `Population-weighted clinical vulnerability score` = Score)

# health/wellbeing vulnerability 
health_wellbeing = vi_msoa %>% 
  aggregate_scores(domain = "Health/Wellbeing", aggregate_by = "RGN19NM") %>% 
  rename(`Proportion of neighbourhoods in 20% most health/wellbeing vulnerable` = Proportion,
         `Extent of population living in highly health/wellbeing vulnerable areas` = Extent,
         `Population-weighted health/wellbeing vulnerability score` = Score)

# economic vulnerability
economic = vi_msoa %>% 
  aggregate_scores(domain = "Economic", aggregate_by = "RGN19NM") %>% 
  rename(`Proportion of neighbourhoods in 20% most economically vulnerable` = Proportion,
         `Extent of population living in highly economically vulnerable areas` = Extent,
         `Population-weighted economic vulnerability score` = Score)

# social vulnerability 
social = vi_msoa %>% 
  aggregate_scores(domain = "Social", aggregate_by = "RGN19NM") %>% 
  rename(`Proportion of neighbourhoods in 20% most socially vulnerable` = Proportion,
         `Extent of population living in highly socially vulnerable areas` = Extent,
         `Population-weighted social vulnerability score` = Score)

# combine and save
vi_region = clinical %>% 
  left_join(health_wellbeing, by = "RGN19NM") %>% 
  left_join(economic, by = "RGN19NM") %>% 
  left_join(social, by = "RGN19NM")

write_csv(vi_cell, "output/archive/vulnerability-region.csv")
