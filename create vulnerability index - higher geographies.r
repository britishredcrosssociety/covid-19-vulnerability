##
## Aggregate England's MSOA-level Vulnerability Index into Regions, Tactical Cells and Local Resilience Forums
##
library(tidyverse)
library(janitor)
library(sf)

source("functions.r")
source("load lookup tables.r")

vi_msoa = read_csv("output/vulnerability-MSOA-UK.csv")  # run "create vulnerability index - MSOA.r" to make this dataset
vi_lad = read_csv("output/vulnerability-LA.csv")  # run "create vulnerability index - LA.r" to make this dataset

##
## lookup tables
##
msoa_lad_tc = read_csv("data/lookup mosa11 to lad17 to lad19 to tactical cell.csv")

lad_regions = read_csv("https://opendata.arcgis.com/datasets/3ba3daf9278f47daba0f561889c3521a_0.csv") %>%
  select(LAD19CD, RGN19NM)

# Local Authority District to Local Resilience Forum (December 2019) Lookup in England and Wales
# https://geoportal.statistics.gov.uk/datasets/local-authority-district-to-local-resilience-forum-december-2019-lookup-in-england-and-wales
lad_lrf = read_csv("https://opendata.arcgis.com/datasets/203ea94d324b4fcda24875e83e577060_0.csv") %>% 
  select(LAD19CD, LRF19CD)

# make sure all TCs and regions are named
msoa_lad_tc = msoa_lad_tc %>%
  left_join(lad_lrf, by = "LAD19CD") %>% 
  
  left_join(lad_regions, by = "LAD19CD") %>% 

  mutate(RGN19NM = case_when(
    str_sub(MSOA11CD, 1, 1) == "9" ~ "Northern Ireland and Isle of Man",
    str_sub(MSOA11CD, 1, 1) == "S" ~ "Scotland",
    str_sub(MSOA11CD, 1, 1) == "W" ~ "Wales",
    TRUE ~ RGN19NM
  ))

# get MSOA-level population estimates
source("prep population estimates.r")

# get Regions and Tactical Cells for VI
vi_msoa = vi_msoa %>% 
  left_join(msoa_lad_tc, by = c("Code" = "MSOA11CD")) %>% 
  left_join(pop, by = "Code")


###############################################################################
## Aggregate into Tactical Cells
##
# clinical vulnerability
clinical = vi_msoa %>% 
  aggregate_scores(domain = "Clinical", aggregate_by = "TacticalCell") %>% 
  rename(`Proportion of neighbourhoods in 20% most clinically vulnerable` = Proportion,
         `Extent of population living in highly clinically vulnerable areas` = Extent,
         `Population-weighted clinical vulnerability score` = Score)

# health/wellbeing vulnerability 
health_wellbeing = vi_msoa %>% 
  aggregate_scores(domain = "Health/Wellbeing", aggregate_by = "TacticalCell") %>% 
  rename(`Proportion of neighbourhoods in 20% most health/wellbeing vulnerable` = Proportion,
         `Extent of population living in highly health/wellbeing vulnerable areas` = Extent,
         `Population-weighted health/wellbeing vulnerability score` = Score)

# economic vulnerability
economic = vi_msoa %>% 
  aggregate_scores(domain = "Economic", aggregate_by = "TacticalCell") %>% 
  rename(`Proportion of neighbourhoods in 20% most economically vulnerable` = Proportion,
         `Extent of population living in highly economically vulnerable areas` = Extent,
         `Population-weighted economic vulnerability score` = Score)

# social vulnerability 
social = vi_msoa %>% 
  aggregate_scores(domain = "Social", aggregate_by = "TacticalCell") %>% 
  rename(`Proportion of neighbourhoods in 20% most socially vulnerable` = Proportion,
         `Extent of population living in highly socially vulnerable areas` = Extent,
         `Population-weighted social vulnerability score` = Score)

# socioeconomic vulnerability
socioeconomic = vi_msoa %>% 
  aggregate_scores(domain = "Socioeconomic", aggregate_by = "TacticalCell") %>% 
  rename(`Proportion of neighbourhoods in 20% most socioeconomically vulnerable` = Proportion,
         `Extent of population living in highly socioeconomically vulnerable areas` = Extent,
         `Population-weighted socioeconomic vulnerability score` = Score)

# overall vulnerability
overall = vi_msoa %>% 
  aggregate_scores(aggregate_by = "TacticalCell") %>% 
  rename(`Proportion of neighbourhoods in 20% most vulnerable` = Proportion,
         `Extent of population living in highly vulnerable areas` = Extent,
         `Population-weighted vulnerability score` = Score)

# combine and save
vi_cell = clinical %>% 
  left_join(health_wellbeing, by = "TacticalCell") %>% 
  left_join(economic, by = "TacticalCell") %>% 
  left_join(social, by = "TacticalCell") %>% 
  left_join(socioeconomic, by = "TacticalCell") %>% 
  left_join(overall, by = "TacticalCell")

write_csv(vi_cell, "output/vulnerability-cell.csv")


###############################################################################
## Aggregate into Regions
##
# clinical vulnerability
clinical = vi_msoa %>% 
  aggregate_scores(domain = "Clinical", aggregate_by = "RGN19NM") %>% 
  rename(`Proportion of neighbourhoods in 20% most clinically vulnerable` = Proportion,
         `Extent of population living in highly clinically vulnerable areas` = Extent,
         `Population-weighted clinical vulnerability score` = Score)

# health/wellbeing vulnerability 
health_wellbeing = vi_msoa %>% 
  aggregate_scores(domain = "Health/Wellbeing", aggregate_by = "RGN19NM") %>% 
  rename(`Proportion of neighbourhoods in 20% most health/wellbeing vulnerable` = Proportion,
         `Extent of population living in highly health/wellbeing vulnerable areas` = Extent,
         `Population-weighted health/wellbeing vulnerability score` = Score)

# economic vulnerability
economic = vi_msoa %>% 
  aggregate_scores(domain = "Economic", aggregate_by = "RGN19NM") %>% 
  rename(`Proportion of neighbourhoods in 20% most economically vulnerable` = Proportion,
         `Extent of population living in highly economically vulnerable areas` = Extent,
         `Population-weighted economic vulnerability score` = Score)

# social vulnerability 
social = vi_msoa %>% 
  aggregate_scores(domain = "Social", aggregate_by = "RGN19NM") %>% 
  rename(`Proportion of neighbourhoods in 20% most socially vulnerable` = Proportion,
         `Extent of population living in highly socially vulnerable areas` = Extent,
         `Population-weighted social vulnerability score` = Score)

# socioeconomic vulnerability
socioeconomic = vi_msoa %>% 
  aggregate_scores(domain = "Socioeconomic", aggregate_by = "RGN19NM") %>% 
  rename(`Proportion of neighbourhoods in 20% most socioeconomically vulnerable` = Proportion,
         `Extent of population living in highly socioeconomically vulnerable areas` = Extent,
         `Population-weighted socioeconomic vulnerability score` = Score)

# overall vulnerability
overall = vi_msoa %>% 
  aggregate_scores(aggregate_by = "RGN19NM") %>% 
  rename(`Proportion of neighbourhoods in 20% most vulnerable` = Proportion,
         `Extent of population living in highly vulnerable areas` = Extent,
         `Population-weighted vulnerability score` = Score)

# combine and save
vi_region = clinical %>% 
  left_join(health_wellbeing, by = "RGN19NM") %>% 
  left_join(economic, by = "RGN19NM") %>% 
  left_join(social, by = "RGN19NM") %>% 
  left_join(socioeconomic, by = "RGN19NM") %>% 
  left_join(overall, by = "RGN19NM")

write_csv(vi_region, "output/vulnerability-region.csv")


###############################################################################
## Aggregate into Local Resilience Forums (England and Wales)
##
# clinical vulnerability
clinical = vi_msoa %>% 
  filter(str_sub(Code, 1, 1) %in% c("E", "W")) %>% 
  aggregate_scores(domain = "Clinical", aggregate_by = "LRF19CD") %>% 
  rename(`Proportion of neighbourhoods in 20% most clinically vulnerable` = Proportion,
         `Extent of population living in highly clinically vulnerable areas` = Extent,
         `Population-weighted clinical vulnerability score` = Score)

# health/wellbeing vulnerability 
health_wellbeing = vi_msoa %>% 
  filter(str_sub(Code, 1, 1) %in% c("E", "W")) %>% 
  aggregate_scores(domain = "Health/Wellbeing", aggregate_by = "LRF19CD") %>% 
  rename(`Proportion of neighbourhoods in 20% most health/wellbeing vulnerable` = Proportion,
         `Extent of population living in highly health/wellbeing vulnerable areas` = Extent,
         `Population-weighted health/wellbeing vulnerability score` = Score)

# economic vulnerability
economic = vi_msoa %>% 
  filter(str_sub(Code, 1, 1) %in% c("E", "W")) %>% 
  aggregate_scores(domain = "Economic", aggregate_by = "LRF19CD") %>% 
  rename(`Proportion of neighbourhoods in 20% most economically vulnerable` = Proportion,
         `Extent of population living in highly economically vulnerable areas` = Extent,
         `Population-weighted economic vulnerability score` = Score)

# social vulnerability 
social = vi_msoa %>% 
  filter(str_sub(Code, 1, 1) %in% c("E", "W")) %>% 
  aggregate_scores(domain = "Social", aggregate_by = "LRF19CD") %>% 
  rename(`Proportion of neighbourhoods in 20% most socially vulnerable` = Proportion,
         `Extent of population living in highly socially vulnerable areas` = Extent,
         `Population-weighted social vulnerability score` = Score)

# socioeconomic vulnerability
socioeconomic = vi_msoa %>% 
  filter(str_sub(Code, 1, 1) %in% c("E", "W")) %>% 
  aggregate_scores(domain = "Socioeconomic", aggregate_by = "LRF19CD") %>% 
  rename(`Proportion of neighbourhoods in 20% most socioeconomically vulnerable` = Proportion,
         `Extent of population living in highly socioeconomically vulnerable areas` = Extent,
         `Population-weighted socioeconomic vulnerability score` = Score)

# overall vulnerability
overall = vi_msoa %>% 
  filter(str_sub(Code, 1, 1) %in% c("E", "W")) %>% 
  aggregate_scores(aggregate_by = "LRF19CD") %>% 
  rename(`Proportion of neighbourhoods in 20% most vulnerable` = Proportion,
         `Extent of population living in highly vulnerable areas` = Extent,
         `Population-weighted vulnerability score` = Score)

# combine and save
vi_lrf = clinical %>% 
  left_join(health_wellbeing, by = "LRF19CD") %>% 
  left_join(economic, by = "LRF19CD") %>% 
  left_join(social, by = "LRF19CD") %>% 
  left_join(socioeconomic, by = "LRF19CD") %>% 
  left_join(overall, by = "LRF19CD")

write_csv(vi_lrf, "output/vulnerability-lrf.csv")
