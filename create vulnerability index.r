##
## combine all vulnerability indicators into a single dataset, outputting .csv and .geojson files for wards and Local Authorities
##
library(tidyverse)
library(Hmisc)
library(sf)

source("init.r")

reproduce_data = FALSE

if (reproduce_data) {
  source("prep deprivation.r")
  source("prep community needs index.r")
  source("prep prevalence of underlying conditions.r")
  source("prep prevalence of underlying conditions - Local Authority.r")
  source("prep asylum stats.r")
  source("prep healthy life expectancy.r")
  source("prep loneliness.r")
  source("prep older population.r")
}


###############################################################################
## Ward-level data
##
# load data for mapping
imd_covid_ward = read_csv("output/covid-deprivation-ward.csv")  # for whole UK
clinical_wards = read_csv("output/clinical-vulnerability-ward.csv")
community_needs = read_csv("output/community-needs-ward.csv")

# Wards (December 2017) Generalised Clipped Boundaries in UK (WGS84)
# source: https://geoportal.statistics.gov.uk/datasets/wards-december-2017-generalised-clipped-boundaries-in-uk-wgs84
wards = read_sf("https://opendata.arcgis.com/datasets/7193daa99995445aa84a0b23352e56a1_2.geojson")

# keep only England
wards = wards %>% 
  filter(startsWith(wd17cd, "E"))

# combine all the data sources
wards_vulnerability = wards %>% 
  left_join(clinical_wards, by = "wd17cd") %>% 
  left_join(imd_covid_ward, by = c("wd17cd" = "WD17CD")) %>% 
  left_join(community_needs, by = "wd17cd")

# make a combined vulnerability index (weighting everything equally)
wards_vulnerability = wards_vulnerability %>% 
  # filter(left_behind == 1) %>% 
  
  mutate(Vulnerability = Clinical_Risk_q %++% Deprivation_q %++% need_index_q) %>%
  mutate(Vulnerability_q = as.integer(cut2(Vulnerability, g = 5)))

# save spatial file so don't have to keep re-making this (only include left-behind areas)
wards_vulnerability %>% 
  filter(left_behind == 1) %>% 
  write_sf("output/vulnerability-ward.geojson")

# save .csv with indicators
wards_vulnerability %>% 
  st_drop_geometry() %>% 
  select(wd17cd, wd17nm, CHD_mean:Vulnerability_q) %>% 
  write_csv("output/vulnerability-ward.csv")

# make the interactive map
rmarkdown::render("ward-vulnerability.Rmd", output_file="index.html", output_dir="docs")


###############################################################################
## Local Authority-level data
##
# load data for mapping
imd_covid_lad = read_csv("output/covid-deprivation-LA.csv")  # for whole UK
clinical_lad = read_csv("output/clinical-vulnerability-LA.csv")
community_needs_lad = read_csv("output/community-needs-LA.csv")
asylum = read_csv("output/asylum-LA.csv")
hle = read_csv("output/healthy-life-expectancy-LA.csv")
digital = read_csv("output/digital-exclusion-LA.csv")
lonely_lad = read_csv("output/loneliness-LA.csv")
pop_70_lad = read_csv("output/population-LA.csv")

# Local Authority Districts (December 2019) Boundaries UK BUC
# source: https://geoportal.statistics.gov.uk/datasets/local-authority-districts-december-2019-boundaries-uk-buc
lads = read_sf("https://opendata.arcgis.com/datasets/3a4fa2ce68f642e399b4de07643eeed3_0.geojson")

# keep only England
# lads = lads %>% 
#   filter(startsWith(lad19cd, "E"))

# combine all the data sources
lads_vulnerability = lads %>% 
  # health/clinical vulnerability
  left_join(clinical_lad, by = c("lad19cd" = "LAD19CD")) %>% 
  left_join(hle, by = c("lad19cd" = "LAD19CD")) %>% 
  left_join(lonely_lad, by = c("lad19cd" = "LAD19CD")) %>% 
  
  # demographic vulnerability
  left_join(pop_70_lad, by = c("lad19cd" = "LAD19CD")) %>% 
  left_join(asylum, by = c("lad19cd" = "LAD19CD")) %>% 
  
  # social vulnerability
  left_join(imd_covid_lad, by = c("lad19cd" = "LAD19CD")) %>% 
  left_join(community_needs_lad, by = c("lad19cd" = "LAD19CD")) %>% 
  left_join(digital, by = c("lad19cd" = "LAD19CD")) %>% 
  
  # get rid of underlying indicators we don't really need
  select(-ends_with("_z"), -`Dispersed Accommodation`, -`Subsistence Only`, -infrastructure, -access, -skill, -use)

# make a combined vulnerability index (weighting everything equally)
lads_vulnerability = lads_vulnerability %>% 
  mutate(Vulnerability = Clinical_Risk_q %++% Community_Need_q %++% Deprivation_q %++% Sec95_q %++% HLE_65_q %++% Digital_q %++% Loneliness_q %++% Over70_q) %>%
  mutate(Vulnerability_q = as.integer(cut2(Vulnerability, g = 5)))

# names(lads_vulnerability)  # check names

# save spatial file so don't have to keep re-making this
write_sf(lads_vulnerability, "output/vulnerability-LA.geojson")

# save .csv with indicators
lads_vulnerability %>% 
  st_drop_geometry() %>% 
  select(lad19cd, lad19nm, `Estimated prevalence of CHD`:Vulnerability_q) %>% 
  write_csv("output/vulnerability-LA.csv")

lads_vulnerability = lads_vulnerability %>% 
  st_drop_geometry() %>% 
  select(lad19cd, lad19nm, `Estimated prevalence of CHD`:Vulnerability_q)

# save .csv with only overall vulnerability score
lads_vulnerability %>% 
  st_drop_geometry() %>% 
  select(lad19cd, lad19nm, Vulnerability:Vulnerability_q) %>% 
  write_csv("output/vulnerability-scores-LA.csv")
