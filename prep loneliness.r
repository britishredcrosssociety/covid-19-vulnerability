##
## Load and process loneliness risks - Local Authorities
##
library(tidyverse)
library(janitor)
library(Hmisc)

source("load lookup tables.r")

# load lookup tables
lookup_lsoa_msoa_lad = load_lookup_lsoa_msoa_lad()
lad_17_19 = read_csv("data/LAD 2017 to LAD 2019 codes.csv")  # lookup of Local Authority codes from 2017 to 2019

# get loneliness risk data
eng_msoa_loneliness = read_csv("https://github.com/matthewgthomas/loneliness/raw/master/England/msoa_loneliness.csv")  # generated by Python code in https://github.com/matthewgthomas/loneliness

# of the MSOAs with above-average loneliness risks (i.e. `loneills_2018` > 0), cut into two categories: lonely_q = 2 will be highest-risk category
eng_msoa_loneliness_high = eng_msoa_loneliness %>% 
  select(msoa11cd, loneills_2018) %>% 
  filter(loneills_2018 > 0) %>% 
  mutate(lonely_q      = as.integer(cut2(loneills_2018, g = 2)))

# summarise loneliness risks into LADs - calculate proportion of highest-risk MSOAs (in the whole nation) within each LAD
lonely = lookup_lsoa_msoa_lad %>% 
  # get full list of MSOAs
  filter(startsWith(MSOA11CD, "E")) %>% 
  select(MSOA11CD, LAD17CD) %>% 
  distinct() %>% 
  
  # get quantiles for the above-average MSOAs
  left_join(eng_msoa_loneliness_high, by = c("MSOA11CD" = "msoa11cd")) %>% 
  
  # if the MSOA has a quantile of `NA`, it means it's not above average - just label this as '3'
  mutate(lonely_q = replace_na(lonely_q, 0)) %>% 
  
  # label deciles by whether they're in top 10 then summarise by this label
  tabyl(LAD17CD, lonely_q) %>% 
  
  # calculate proportion of loneliest MSOAs in each LAD
  mutate(Prop_loneliest = `2` / (`0` + `1` + `2`)) %>% 
  
  mutate(Loneliness_q = as.integer(cut2(Prop_loneliest, g = 5))) %>% 
  
  left_join(lad_17_19, by = "LAD17CD") %>% 
  select(LAD19CD, Prop_loneliest, Loneliness_q)

write_csv(lonely, "output/loneliness-LA.csv")

rm(lookup_lsoa_msoa_lad, lad_17_19, eng_msoa_loneliness, eng_msoa_loneliness_high)
