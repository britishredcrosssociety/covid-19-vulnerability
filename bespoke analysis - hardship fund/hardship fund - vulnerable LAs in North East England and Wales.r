##
##
##
library(tidyverse)
library(readxl)

source("functions.r")
source("load lookup tables.r")


##
## lookup tables
##
# load LSOA to MSOA codes lookup table
lookup_lsoa_msoa = load_lookup_lsoa_msoa_lad() %>% 
  select(LSOA11CD, MSOA11CD)

# MSOA to LA codes for England, Wales and Scotland
msoa_lad = load_lookup_lsoa_msoa_lad() %>% 
  select(MSOA11CD, LAD17CD) %>% 
  distinct()

lad_17_19 = read_csv("data/LAD 2017 to LAD 2019 codes.csv")  # lookup of Local Authority codes from 2017 to 2019

# get 2019 LA codes
msoa_lad = msoa_lad %>% 
  left_join(lad_17_19, by = "LAD17CD")

lad_regions = read_csv("https://opendata.arcgis.com/datasets/3ba3daf9278f47daba0f561889c3521a_0.csv") %>% 
  select(LAD19CD, RGN19NM)

lad_names = read_csv("https://opendata.arcgis.com/datasets/c3ddcd23a15c4d7985d8b36f1344b1db_0.csv") %>% 
  select(LAD19CD, LAD19NM)


##
## Load data on jobs in vulnerable sectors
##
# ocsi = read_excel("data/England MSOA data from OCSI.xlsx", sheet = "Subset of indicators")
jobs_eng = read_csv("data/OCSI/ocsi-jobs-england.csv") %>% 
  rename(Code = `MSOA Code`) %>% 
  select(-`MSOA Name`, -`MSOA New Name`)

# Wales
source("prep wales ocsi data.R")
jobs_wales = ocsiw %>% 
  select(Code, `Jobs in accommodation and food services (hospitality) Rate`, `Jobs in arts, entertainment, recreation and other services Rate`, `Jobs in retail Rate`)

rm(ocsiw)


##
## calculate proportion of older population from MSOA population estimates
## source: https://www.ons.gov.uk/peoplepopulationandcommunity/populationandmigration/populationestimates/datasets/middlesuperoutputareamidyearpopulationestimates
##
GET("https://www.ons.gov.uk/file?uri=%2fpeoplepopulationandcommunity%2fpopulationandmigration%2fpopulationestimates%2fdatasets%2fmiddlesuperoutputareamidyearpopulationestimates%2fmid2018sape21dt3a/sape21dt3amid2018msoaon2019lasyoaestimatesformatted.zip",
    write_disk(tf <- tempfile(fileext = ".zip")))

unzip(tf, exdir = "data/population")
unlink(tf); rm(tf)

pop = read_excel("data/population/SAPE21DT3a-mid-2018-msoa-on-2019-LA-syoa-estimates-formatted.xlsx", sheet = "Mid-2018 Persons", skip = 4)

pop_older = pop %>% 
  filter(!is.na(MSOA)) %>%  # drop Local Authorities
  
  # convert age columns to long format
  pivot_longer(cols = `0`:`90+`, names_to = "Age", values_to = "n_people") %>% 
  mutate(Age = as.integer(Age)) %>% 
  
  # sum whole population and people over 70
  group_by(`Area Codes`) %>% 
  summarise(`No. people` = sum(n_people),
            `No. people over 70` = sum(n_people[Age >= 70], na.rm = TRUE)) %>% 
  
  mutate(`Proportion people over 70` = `No. people over 70` / `No. people`) %>% 
  rename(Code = `Area Codes`)

pop_older = pop_older %>% 
  select(Code, `Proportion people over 70`)

rm(pop)


##
## income deprivation (England):
## •	Adults and children in Income Support families
## •	Adults and children in income-based Jobseeker's Allowance families
## •	Adults and children in income-based Employment and Support Allowance families
## •	Adults and children in Pension Credit (Guarantee) families
## •	Adults and children in Working Tax Credit and Child Tax Credit families not already counted
## •	Adults and children in Universal Credit families where no adult is in 'Working - no requirements' conditionality regime
## •	Asylum seekers in England in receipt of subsistence support, accommodation support, or both
##
# load underlying indicators for IMD
# source: "File 5: scores for the indices of deprivation" from https://www.gov.uk/government/statistics/english-indices-of-deprivation-2019
GET("https://assets.publishing.service.gov.uk/government/uploads/system/uploads/attachment_data/file/833978/File_5_-_IoD2019_Scores.xlsx",
    write_disk(tf <- tempfile(fileext = ".xlsx")))
imd_eng_scores = read_excel(tf, sheet = "IoD2019 Scores")
unlink(tf); rm(tf)

# aggregate into MSOAs
imd_eng_income = imd_eng_scores %>% 
  select(LSOA11CD = `LSOA code (2011)`, `Income Score (rate)`) %>% 
  
  left_join(lookup_lsoa_msoa, by = "LSOA11CD") %>% 
  rename(Code = MSOA11CD) %>% 
  
  group_by(Code) %>% 
  summarise(`Income deprivation` = max(`Income Score (rate)`))


##
## Homelessness indicator from English IMD
##
GET("https://assets.publishing.service.gov.uk/government/uploads/system/uploads/attachment_data/file/833992/File_8_-_IoD2019_Underlying_Indicators.xlsx",
    write_disk(tf <- tempfile(fileext = ".xlsx")))

imd_eng_barriers = read_excel(tf, sheet = "IoD2019 Barriers Domain")
unlink(tf); rm(tf)

imd_eng_homelessness = imd_eng_barriers %>% 
  select(LSOA11CD = `LSOA code (2011)`, `Homelessness indicator (rate per 1000 households)`) %>% 
  left_join(lookup_lsoa_msoa, by = "LSOA11CD") %>% 
  rename(Code = MSOA11CD) %>% 
  
  group_by(Code) %>% 
  summarise(Homelessness = max(`Homelessness indicator (rate per 1000 households)`))


##
## income deprivation (Wales):
## - Income-Related Benefit claimants
## - Tax Credit recipient
## - Supported Asylum Seeker
## - People on Universal Credit (excluding those "working with no requirements")
##
# load function to download data from Stats Wales (without having to install the assocaited `brclib` package)
source("https://github.com/matthewgthomas/brclib/raw/master/R/download_wales.R")

imd_wal = download_wales("http://open.statswales.gov.wales/en-gb/dataset/wimd1912")

imd_wal_income = imd_wal %>% 
  select(Code = MSOA_Code, Indicator = Indicator_ItemName_ENG, Data) %>% 
  filter(Indicator == "People in income deprivation (%)") %>% 
  pivot_wider(names_from = Indicator, values_from = Data)


##
## people living alone (from CACI)
##
living_alone_lsoa = read_csv("data/CACI/living-alone-lsoa.csv")
living_alone_msoa = read_csv("data/CACI/living-alone-msoa.csv")

# merge SOAs for Northern Ireland into the MSOA dataframe
living_alone_msoa = living_alone_msoa %>% 
  filter(!startsWith(MSOA11CD, "N")) %>%  # no MSOAs in Northern Ireland
  
  bind_rows( living_alone_lsoa %>% filter(startsWith(LSOA11CD, "9")) %>% rename(MSOA11CD = LSOA11CD) ) %>% 
  rename(Code = MSOA11CD)

rm(living_alone_lsoa)


##
## calculate bespoke vulnerability scores for hardship fund (England)
##
vi_hardship_eng = jobs_eng %>% 
  left_join(imd_eng_income, by = "Code") %>% 
  left_join(imd_eng_homelessness, by = "Code") %>% 
  left_join(pop_older, by = "Code") %>% 
  left_join(living_alone_msoa, by = "Code") %>% 
  
  calc_domain_scores(domain = "Hardship Fund")

# write_csv(vi_hardship_eng, "bespoke analysis - hardship fund/hardship-vulnerability-MSOA-England.csv")

vi_hardship_wal = imd_wal_income %>%
  left_join(jobs_wales, by = "Code") %>% 
  left_join(pop_older, by = "Code") %>% 
  left_join(living_alone_msoa, by = "Code") %>% 
  
  calc_domain_scores(domain = "Hardship Fund")


###############################################################################
## Aggregate into Local Authorities and choose the most vulnerable in NE England and Wales
##

##
## England
##
vi_hardship_eng_LA = vi_hardship_eng %>% 
  left_join(msoa_lad, by = c("Code" = "MSOA11CD")) %>% 
  
  mutate(Top20 = ifelse(`Hardship Fund Vulnerability decile` >= 9, "Top20", "Other")) %>% 
  tabyl(LAD19CD, Top20) %>% 
  
  # calculate proportion of most deprived LSOAs
  mutate(`Proportion of neighbourhoods in 20% most vulnerable` = Top20 / (Top20 + Other)) %>% 
  select(-Other, -Top20) %>% 
  na.omit()

eng_summary = vi_hardship_eng_LA %>% 
  left_join(lad_names, by = "LAD19CD") %>% 
  left_join(lad_regions, by = "LAD19CD") %>% 
  filter(RGN19NM %in% c("North East")) %>% 
  
  select(Region = RGN19NM, `Local Authority` = LAD19NM, `Proportion of neighbourhoods in 20% most vulnerable`) %>% 
  arrange(desc(`Proportion of neighbourhoods in 20% most vulnerable`))


##
## Wales
##
vi_hardship_wal_LA = vi_hardship_wal %>% 
  left_join(msoa_lad, by = c("Code" = "MSOA11CD")) %>% 
  
  mutate(Top20 = ifelse(`Hardship Fund Vulnerability decile` >= 9, "Top20", "Other")) %>% 
  tabyl(LAD19CD, Top20) %>% 
  
  # calculate proportion of most deprived LSOAs
  mutate(`Proportion of neighbourhoods in 20% most vulnerable` = Top20 / (Top20 + Other)) %>% 
  select(-Other, -Top20) %>% 
  na.omit()

wales_summary = vi_hardship_wal_LA %>% 
  left_join(lad_names, by = "LAD19CD") %>% 
  mutate(Region = "Wales") %>% 
  
  select(Region, `Local Authority` = LAD19NM, `Proportion of neighbourhoods in 20% most vulnerable`) %>% 
  arrange(desc(`Proportion of neighbourhoods in 20% most vulnerable`))

bind_rows(eng_summary, wales_summary) %>% 
  write_csv("bespoke analysis - hardship fund/Hardship Fund Local Authorities.csv")


##
## test
##
vi_eng = read_csv("output/vulnerability-MSOA-England.csv")
food = read_csv("output/food-vulnerability-MSOA-England.csv")

cor.test(vi_eng$`Vulnerability score`, vi_hardship_eng$`Hardship Fund Vulnerability score`)
cor.test(food$`Food Vulnerability score`, vi_hardship_eng$`Hardship Fund Vulnerability score`)

vi_eng = vi_eng %>% 
  select(Code, `Vulnerability score`) %>% 
  left_join(vi_hardship_eng, by = "Code") %>% 
  left_join(food, by = "Code")

plot(vi_eng$`Vulnerability score`, vi_eng$`Hardship Fund Vulnerability score`)
plot(vi_eng$`Vulnerability score`, vi_eng$`Food Vulnerability score`)

