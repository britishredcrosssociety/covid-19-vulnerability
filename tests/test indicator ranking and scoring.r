##
## test with one indicator
##
test = tibble(X = 1:1000) %>% 
  mutate_if(is.numeric, list(rank = rank)) %>%  # convert indicators to ranks
  
  # normalise the ranks so they're between 0 and 1
  mutate_at(vars(ends_with("rank")), list(scaled = scale_ranks)) %>% 
  
  # transform to an exponential distribution
  mutate_at(vars(ends_with("scaled")), list(exp = exp_transform)) %>% 
  
  # combine with equal weights to get domain score
  mutate(`Vulnerability score` = reduce(select(., ends_with("exp")), `+`)) %>%   # source: https://stackoverflow.com/a/54527609
  
  # calculate domain ranks and deciles
  mutate(`Vulnerability rank` = rank(`Vulnerability score`)) %>% 
  mutate(`Vulnerability decile` = calc_risk_quantiles(`Vulnerability rank`, quants = 10))

test

hist(test$rank)
hist(test$scaled)
hist(test$exp)
hist(test$`Vulnerability score`)

hist(exp_transform(seq(0, 1, by = 0.01)))
hist(exp_transform(scale_ranks(1:6791)))

all.equal(test$scaled, scale_ranks(1:1000))  # TRUE
all.equal(test$exp, exp_transform(scale_ranks(1:1000)))  # TRUE

##
## test with two indicators
##
test2 = tibble(X = 1:1000, Y = runif(n = 1000)) %>% 
  mutate_if(is.numeric, list(rank = rank)) %>%  # convert indicators to ranks
  
  # normalise the ranks so they're between 0 and 1
  mutate_at(vars(ends_with("rank")), list(scaled = scale_ranks)) %>% 
  
  # transform to an exponential distribution
  mutate_at(vars(ends_with("scaled")), list(exp = exp_transform)) %>% 
  
  # combine with equal weights to get domain score
  mutate(`Vulnerability score` = reduce(select(., ends_with("exp")), `+`)) %>%   # source: https://stackoverflow.com/a/54527609
  
  # calculate domain ranks and deciles
  mutate(`Vulnerability rank` = rank(`Vulnerability score`)) %>% 
  mutate(`Vulnerability decile` = calc_risk_quantiles(`Vulnerability rank`, quants = 10))

test2

hist(test2$Y_rank)
hist(test2$Y_rank_scaled)

hist(test2$X_rank_scaled_exp)      # this follows an exponential distribution
hist(test2$Y_rank_scaled_exp)      #... and so does this
hist(test2$`Vulnerability score`)  #... but this doesn't - because it's a sum of exponential distribs


##
## check out the distributions of English IMD domain scores
## - to make sure that their summed domain scores look similar to hist(test2$`Vulnerability score`)
## - (which they do)
##
imd_all_scores = read_csv("https://assets.publishing.service.gov.uk/government/uploads/system/uploads/attachment_data/file/845345/File_7_-_All_IoD2019_Scores__Ranks__Deciles_and_Population_Denominators_3.csv")

# these two distributions look similar to hist(test2$`Vulnerability score`), so all good
hist(imd_all_scores$`Index of Multiple Deprivation (IMD) Score`)
hist(imd_all_scores$`Barriers to Housing and Services Score`)

rm(test, test2, imd_all_scores)
