##
## Investigate correlations between vulnerability domains in Local Authorities
##
library(tidyverse)
library(ggcorrplot)
library(cowplot)
library(GGally)
library(httr)
library(readxl)

source("load lookup tables.r")  # for get_country()

vi_raw = read_csv("output/vulnerability-LA.csv")

vi = vi_raw %>% 
  mutate(Country = get_country(Code)) %>% 
  select(#Country, 
         Clinical_Prop = `Proportion of neighbourhoods in 20% most clinically vulnerable`,
         Clinical_Ext = `Extent of population living in highly clinically vulnerable areas`,
         Clinical_Score = `Population-weighted clinical vulnerability score`,
         
         Health_Prop = `Proportion of neighbourhoods in 20% most health/wellbeing vulnerable`,
         Health_Ext = `Extent of population living in highly health/wellbeing vulnerable areas`,
         Health_Score = `Population-weighted health/wellbeing vulnerability score`,
         
         Economic_Prop = `Proportion of neighbourhoods in 20% most economically vulnerable`,
         Economic_Ext = `Extent of population living in highly economically vulnerable areas`,
         Economic_Score = `Population-weighted economic vulnerability score`,
         
         Social_Prop = `Proportion of neighbourhoods in 20% most socially vulnerable`,
         Social_Ext = `Extent of population living in highly socially vulnerable areas`,
         Social_Score = `Social Vulnerability score`,
         
         `Vulnerability score`)


##
## between-domain correlations
##
# correlations between proportions
vi %>% 
  select(ends_with("_Prop"), `Vulnerability score`) %>% 
  ggpairs(lower = list(continuous = wrap("smooth", alpha = 0.3, size = 0.01)), diag = NULL) +
  theme_classic()

# correlations between extents
vi %>% 
  select(ends_with("_Ext"), `Vulnerability score`) %>% 
  ggpairs(lower = list(continuous = wrap("smooth", alpha = 0.3, size = 0.01)), diag = NULL) +
  theme_classic()

# correlations between scores
vi %>% 
  select(ends_with("_Score"), `Vulnerability score`) %>% 
  ggpairs(lower = list(continuous = wrap("smooth", alpha = 0.3, size = 0.01)), diag = NULL) +
  theme_classic()


##
## within-domain correlations
##
# clinical
vi %>% 
  select(starts_with("Clinical"), `Vulnerability score`) %>% 
  ggpairs(lower = list(continuous = wrap("smooth", alpha = 0.3, size = 0.01)), diag = NULL) +
  theme_classic()

# health/wellbeing
vi %>% 
  select(starts_with("Health"), `Vulnerability score`) %>% 
  ggpairs(lower = list(continuous = wrap("smooth", alpha = 0.3, size = 0.01)), diag = NULL) +
  theme_classic()

# economic
vi %>% 
  select(starts_with("Economic"), `Vulnerability score`) %>% 
  ggpairs(lower = list(continuous = wrap("smooth", alpha = 0.3, size = 0.01)), diag = NULL) +
  theme_classic()

# social
vi %>% 
  select(starts_with("Social"), `Vulnerability score`) %>% 
  ggpairs(lower = list(continuous = wrap("smooth", alpha = 0.3, size = 0.01)), diag = NULL) +
  theme_classic()


###############################################################################
## Look at correlations between proportions, extents and scores in the English IMD
##

##
## Load LA-level deprivation scores
## - from: https://www.gov.uk/government/statistics/english-indices-of-deprivation-2019
## - source: File 10: local authority district summaries
##
## We'll use two summary measures of deprivation in LAs: extent and proportion of Lower-layer Super Output Areas in most deprived 10% nationally
## - extent =  the proportion of the local population that live in areas classified as among the most deprived in the country
## 
## (see Table 3.2 in the IMD technical report for more details: https://assets.publishing.service.gov.uk/government/uploads/system/uploads/attachment_data/file/833951/IoD2019_Technical_Report.pdf)
##
GET("https://assets.publishing.service.gov.uk/government/uploads/system/uploads/attachment_data/file/833995/File_10_-_IoD2019_Local_Authority_District_Summaries__lower-tier__.xlsx",
    write_disk(tf_imd <- tempfile(fileext = ".xlsx")))

imd = read_excel(tf_imd, sheet = "IMD") 

imd %>% 
  select(Proportion = `IMD - Proportion of LSOAs in most deprived 10% nationally`, 
         Extent = `IMD 2019 - Extent`,
         Score = `IMD - Average score`) %>% 
  
  ggpairs(lower = list(continuous = wrap("smooth", alpha = 0.3, size = 0.01)), diag = NULL) +
  theme_classic()

##
## correlations between vulnerability and deprivation
##
vi_imd = vi_raw %>% 
  select(Code, Prop_VI = `Proportion of neighbourhoods in 20% most socioeconomically vulnerable`, Extent_VI = `Extent of population living in highly socioeconomically vulnerable areas`) %>% 
  
  left_join(imd %>% select(Code = `Local Authority District code (2019)`, 
                           Prop_IMD = `IMD - Proportion of LSOAs in most deprived 10% nationally`, 
                           Extent_IMD = `IMD 2019 - Extent`),
            by = "Code") %>% 
  select(-Code) %>% 
  na.omit() 
  
vi_imd %>% 
  ggpairs(lower = list(continuous = wrap("smooth", alpha = 0.3, size = 0.01)), diag = NULL) +
  theme_classic()
