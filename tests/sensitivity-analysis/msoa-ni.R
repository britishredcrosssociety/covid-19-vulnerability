# --------------------------------------------
# ---- NI MSOA Sensitivity Analysis -----
# --------------------------------------------

# ---- Load libraries ----
library(tidyverse)
library(patchwork)
library(glue)
source("functions.r")

# ---- Load data ----
# # Source MSOA England file up to line 326, just before the VI is created
# source(textConnection(read_lines("create vulnerability index - MSOA - NI.r",
#                                  n_max = 179)))
# 
# # Combine MSOA data ready to be piped into calc_domain_scores function
# msoa_ni <- clinical %>% 
#   select(Code, `Clinical Vulnerability rank`) %>% 
#   left_join(health_wellbeing %>% select(Code, `Health/Wellbeing Vulnerability rank`),
#             by = "Code") %>% 
#   left_join(economic %>% select(Code, `Economic Vulnerability rank`),
#             by = "Code") %>% 
#   left_join(social %>% select(Code, `Social Vulnerability rank`),
#             by = "Code")
# 
# # Save data
# write_csv(msoa_ni, "tests/sensitivity-analysis/data/msoa_ni.csv")

# Load saved msoa_data created above
msoa_ni <- read_csv("tests/sensitivity-analysis/data/msoa_ni.csv")

# ---- Weights ----
# Create a tibble of weights to iterate over
weights <- crossing(clinical_weight = c(0, .25, .5, .75, 1),
                    health_weight   = c(0, .25, .5, .75, 1),
                    economic_weight = c(0, .25, .5, .75, 1),
                    social_weight   = c(0, .25, .5, .75, 1)) %>% 
  rowwise() %>% 
  filter(sum(c_across(everything())) == 1,
         # removes rows where more than two indicators are varying
         !if_else(sum(c_across(everything()) > 0) > 2, TRUE, FALSE))

# ---- Iterate ----
# Iterate over each row of weighs, inputting weights into calc_domain_scores
# Store result in new column, vi (nested data structure - i.e., one tibble per row)
weighted_vi <- weights %>% 
  # First create column of unweighted (i.e., all = .25) scores
  mutate(unweighted_vi = list(calc_domain_scores(d = msoa_ni,
                                                 rank.indicators = FALSE,
                                                 clinical_weight = 0.25,
                                                 health_weight = 0.25,
                                                 economic_weight = 0.25,
                                                 social_weight = 0.25)),
         # Then weighted scores
         weighted_vi = list(calc_domain_scores(d = msoa_ni,
                                               rank.indicators = FALSE,
                                               clinical_weight = clinical_weight,
                                               health_weight = health_weight,
                                               economic_weight = economic_weight,
                                               social_weight = social_weight) %>% 
                              select_all(list(~ paste0(., " weighted"))))) %>% 
  ungroup()

# ---- Calculate Assessment Metric ----
# To establish whether the allocated weights have an effect on the VI, create global
# metric that measures if an area has changed decile.
# see: https://assets.publishing.service.gov.uk/government/uploads/system/uploads/attachment_data/file/835115/IoD2019_Statistical_Release.pdf

# Create tibble id's
weighted_vi <- weighted_vi %>% 
  mutate(id = row_number()) %>% 
  relocate(id)

# Unnest data
weighted_vi_unnested <- weighted_vi %>%
  unnest(cols = c(unweighted_vi, weighted_vi)) %>% 
  select(-`Clinical Vulnerability rank`:-`Vulnerability rank`,
         -`Code weighted`: -`Vulnerability rank weighted`,
         decile = `Vulnerability decile`,
         decile_weighted = `Vulnerability decile weighted`)

# Calculate difference between weighted and unweighted in terms of the proportion of
# areas that have changed decile and the actual difference
sens_metrics <- weighted_vi_unnested %>%
  mutate(decile_same = decile == decile_weighted,
         decile_difference = decile - decile_weighted) %>% 
  group_by(id, decile) %>% 
  mutate(decile_same_perc = (sum(decile_same)/n()*100)) %>% 
  ungroup() %>% 
  group_by(id) %>% 
  mutate(decile_same_perc_mean = mean(decile_same_perc)) %>% 
  ungroup()

# Create labels
sens_metrics <- sens_metrics %>% 
  mutate(clinical_perc = clinical_weight*100,
         health_perc = health_weight*100,
         economic_perc = economic_weight*100,
         social_perc = social_weight*100) %>% 
  mutate(label = "") %>% 
  mutate(label = if_else(clinical_perc == 0, label, as.character(glue('{label}', 'clinical:{clinical_perc}% '))),
         label = if_else(health_perc == 0, label, as.character(glue('{label}', 'health:{health_perc}% '))),
         label = if_else(economic_perc == 0, label, as.character(glue('{label}', 'economic:{economic_perc}% '))),
         label = if_else(social_perc == 0, label, as.character(glue('{label}', 'social:{social_perc}% ')))) %>%
  mutate(label = str_trim(label)) %>% 
  select(-ends_with("_weight"))

# ---- Plot ----
# Plot1: Proportion of MSOA's that remain in 10th decile bar plot
sens_metrics %>%
  count(label, decile, decile_same_perc) %>% 
  filter(decile == 10) %>% 
  mutate(percent = str_c(round(decile_same_perc), "%")) %>% 
  mutate(label = fct_reorder(label, decile_same_perc)) %>% 
  ggplot(aes(x = label, y = decile_same_perc, fill = label)) +
  # geom_text(aes(label = percent), size = 3, hjust = -0.5) +
  geom_col(show.legend = FALSE) +
  labs(x = "Decile",
       y = NULL,
       title = expression(paste("Proportion of NI MSOA's that remain in the 10"^{th}, " decile after adjusting domain weights compared to a baseline of equal weights across all domains."))) +
  scale_fill_viridis_d(option = "D", begin = 0 , end = .9) +
  scale_y_continuous(breaks = seq(0, 100, by = 10),
                     labels = function(x) paste0(x, "%")) +
  coord_flip() +
  theme_minimal()

ggsave("tests/sensitivity-analysis/plots/plot1-ni.png", width = 18.5, height = 11.6)

# Plot2: Proportion of MSOA's that remain in each decile bar plot
sens_metrics %>%
  count(label, decile, decile_same_perc) %>% 
  mutate(percent = str_c(round(decile_same_perc), "%")) %>% 
  ggplot(aes(x = decile, y = decile_same_perc, fill = label)) +
  # geom_text(aes(label = percent), size = 3, hjust = -0.5) +
  geom_col(show.legend = FALSE) +
  facet_wrap(vars(label)) +
  labs(x = "Decile",
       y = NULL,
       title = "Proportion of NI MSOA's that remain in the same decile after adjusting domain weights (indicated by facet) compared to a baseline of equal weighting across all domains") +
  scale_fill_viridis_d(option = "D", begin = 0 , end = .9) +
  scale_x_continuous(breaks = seq(1, 10, by = 1)) +
  scale_y_continuous(breaks = seq(0, 100, by = 10),
                     labels = function(x) paste0(x, "%")) +
  coord_flip()

ggsave("tests/sensitivity-analysis/plots/plot2-ni.png", width = 18.5, height = 11.6)

# Plot3: Domain weighting interaction raster plots
# Show domain combinations to pass into plots
# combn(c("clinical", "health", "economic", "social"), 2)

# Set legend limits to keep consitency when joining plots
limit_lower <- sens_metrics %>% filter(decile == 10) %>% pull(decile_same_perc) %>% range() %>% pluck(1)
limit_upper <- sens_metrics %>% filter(decile == 10) %>% pull(decile_same_perc) %>% range() %>% pluck(2)

# Clinical / Health
p1 <- sens_metrics %>% 
  filter(decile == 10) %>% 
  distinct(clinical_perc,
           health_perc,
           decile_same_perc) %>% 
  rowwise() %>% 
  filter(sum(clinical_perc, health_perc) == 100) %>% 
  ungroup() %>% 
  ggplot(aes(clinical_perc, health_perc, fill = decile_same_perc)) +
  geom_raster() +
  scale_x_continuous(breaks = seq(0, 100, by = 25),
                     labels = function(x) paste0(x, "%")) +
  scale_y_continuous(breaks = seq(0, 100, by = 25),
                     labels = function(x) paste0(x, "%")) +
  scale_fill_viridis_c(option = "C",
                       begin = 0,
                       end = 1,
                       direction = -1,
                       guide = guide_colourbar(ticks= TRUE,
                                               barheight = 55,
                                               barwidth = .5),
                       breaks = seq(0, 100, by = 5),
                       labels = paste0(seq(0, 100, by = 5), "%"),
                       limits = c(limit_lower, limit_upper)) +
  labs(x = "Clincal Weighting",
       y = "Health Weighting") +
  theme_minimal() +
  theme(legend.title=element_blank(),
        legend.position = "right")

# Clinical / Economic
p2 <- sens_metrics %>% 
  filter(decile == 10) %>% 
  distinct(clinical_perc,
           economic_perc,
           decile_same_perc) %>% 
  rowwise() %>% 
  filter(sum(clinical_perc, economic_perc) == 100) %>% 
  ungroup() %>% 
  ggplot(aes(clinical_perc, economic_perc, fill = decile_same_perc)) +
  geom_raster(show.legend = FALSE) +
  scale_x_continuous(breaks = seq(0, 100, by = 25),
                     labels = function(x) paste0(x, "%")) +
  scale_y_continuous(breaks = seq(0, 100, by = 25),
                     labels = function(x) paste0(x, "%")) +
  scale_fill_viridis_c(option = "C",
                       begin = 0,
                       end = 1,
                       direction = -1,
                       guide = guide_colourbar(ticks= TRUE,
                                               barheight = 55,
                                               barwidth = .5),
                       breaks = seq(0, 100, by = 5),
                       labels = paste0(seq(0, 100, by = 5), "%"),
                       limits = c(limit_lower, limit_upper)) +
  labs(x = "Clincal Weighting",
       y = "Economic Weighting") +
  theme_minimal() +
  theme(legend.title=element_blank(),
        legend.position = "top")

# Clinical / Social
p3 <- sens_metrics %>% 
  filter(decile == 10) %>% 
  distinct(clinical_perc,
           social_perc,
           decile_same_perc) %>% 
  rowwise() %>% 
  filter(sum(clinical_perc, social_perc) == 100) %>% 
  ungroup() %>% 
  ggplot(aes(clinical_perc, social_perc, fill = decile_same_perc)) +
  geom_raster(show.legend = FALSE) +
  scale_x_continuous(breaks = seq(0, 100, by = 25),
                     labels = function(x) paste0(x, "%")) +
  scale_y_continuous(breaks = seq(0, 100, by = 25),
                     labels = function(x) paste0(x, "%")) +
  scale_fill_viridis_c(option = "C",
                       begin = 0,
                       end = 1,
                       direction = -1,
                       guide = guide_colourbar(ticks= TRUE,
                                               barheight = 55,
                                               barwidth = .5),
                       breaks = seq(0, 100, by = 5),
                       labels = paste0(seq(0, 100, by = 5), "%"),
                       limits = c(limit_lower, limit_upper)) +
  labs(x = "Clincal Weighting",
       y = "Social Weighting") +
  theme_minimal() +
  theme(legend.title=element_blank(),
        legend.position = "top")

# Health / Economic
p4 <- sens_metrics %>% 
  filter(decile == 10) %>% 
  distinct(health_perc,
           economic_perc,
           decile_same_perc) %>% 
  rowwise() %>% 
  filter(sum(health_perc, economic_perc) == 100) %>% 
  ungroup() %>% 
  ggplot(aes(health_perc, economic_perc, fill = decile_same_perc)) +
  geom_raster(show.legend = FALSE) +
  scale_x_continuous(breaks = seq(0, 100, by = 25),
                     labels = function(x) paste0(x, "%")) +
  scale_y_continuous(breaks = seq(0, 100, by = 25),
                     labels = function(x) paste0(x, "%")) +
  scale_fill_viridis_c(option = "C",
                       begin = 0,
                       end = 1,
                       direction = -1,
                       guide = guide_colourbar(ticks= TRUE,
                                               barheight = 55,
                                               barwidth = .5),
                       breaks = seq(0, 100, by = 5),
                       labels = paste0(seq(0, 100, by = 5), "%"),
                       limits = c(limit_lower, limit_upper)) +
  labs(x = "Health Weighting",
       y = "Economic Weighting") +
  theme_minimal() +
  theme(legend.title=element_blank(),
        legend.position = "top")

# Health / Social
p5 <- sens_metrics %>% 
  filter(decile == 10) %>% 
  distinct(health_perc,
           social_perc,
           decile_same_perc) %>% 
  rowwise() %>% 
  filter(sum(health_perc, social_perc) == 100) %>% 
  ungroup() %>% 
  ggplot(aes(health_perc, social_perc, fill = decile_same_perc)) +
  geom_raster(show.legend = FALSE) +
  scale_x_continuous(breaks = seq(0, 100, by = 25),
                     labels = function(x) paste0(x, "%")) +
  scale_y_continuous(breaks = seq(0, 100, by = 25),
                     labels = function(x) paste0(x, "%")) +
  scale_fill_viridis_c(option = "C",
                       begin = 0,
                       end = 1,
                       direction = -1,
                       guide = guide_colourbar(ticks= TRUE,
                                               barheight = 55,
                                               barwidth = .5),
                       breaks = seq(0, 100, by = 5),
                       labels = paste0(seq(0, 100, by = 5), "%"),
                       limits = c(limit_lower, limit_upper)) +
  labs(x = "Health Weighting",
       y = "Social Weighting") +
  theme_minimal() +
  theme(legend.title=element_blank(),
        legend.position = "top")

# Economic / Social
p6 <- sens_metrics %>% 
  filter(decile == 10) %>% 
  distinct(economic_perc,
           social_perc,
           decile_same_perc) %>% 
  rowwise() %>% 
  filter(sum(economic_perc, social_perc) == 100) %>% 
  ungroup() %>% 
  ggplot(aes(economic_perc, social_perc, fill = decile_same_perc)) +
  geom_raster(show.legend = FALSE) +
  scale_x_continuous(breaks = seq(0, 100, by = 25),
                     labels = function(x) paste0(x, "%")) +
  scale_y_continuous(breaks = seq(0, 100, by = 25),
                     labels = function(x) paste0(x, "%")) +
  scale_fill_viridis_c(option = "C",
                       begin = 0,
                       end = 1,
                       direction = -1,
                       guide = guide_colourbar(ticks= TRUE,
                                               barheight = 55,
                                               barwidth = .5),
                       breaks = seq(0, 100, by = 5),
                       labels = paste0(seq(0, 100, by = 5), "%"),
                       limits = c(limit_lower, limit_upper)) +
  labs(x = "Economic Weighting",
       y = "Social Weighting") +
  theme_minimal() +
  theme(legend.title=element_blank(),
        legend.position = "top")

# Patch plots
p1 + p2 + p3 + p4 + p5 + p6 + 
  plot_layout(guides = "collect") +
  plot_annotation(title = expression(paste("The percentage of NI MSOA's that remained in the 10"^{th}, " decile of the VI (inidicated by colour) for each combination of domain weights compared to a baseline of equal weights across all domains.")))

ggsave("tests/sensitivity-analysis/plots/plot3-ni.png", width = 18.5, height = 11.6)

