library(leaflet)

# Local Authority Districts (December 2019) Boundaries UK BUC
# source: https://geoportal.statistics.gov.uk/datasets/local-authority-districts-december-2019-boundaries-uk-buc
lads = read_sf("https://opendata.arcgis.com/datasets/3a4fa2ce68f642e399b4de07643eeed3_0.geojson")

vi_msoa = read_sf("output/vulnerability-MSOA-UK.geojson")  # run "create vulnerability index - MSOA.r" to make this dataset

# ----
pcn_shp_tmp = pcn_shp %>% 
  #filter(PCN_Name %in% c("TOWER HAMLETS NETWORK 1 PCN", "TOWER HAMLETS NETWORK 5 PCN"))
  #filter(str_detect(PCN_Name, "TOWER HAMLETS NETWORK"))
  filter(str_detect(PCN_Name, "COASTAL"))

pcn_shp_box = st_bbox(pcn_shp_tmp)

pcn_pal = colorFactor("Set3", pcn_shp_tmp$PCN_Code)

vi_tmp = vi_msoa %>% 
  left_join(msoa_pcn, by = c("Code" = "MSOA11CD")) %>% 
  filter(PCN_Code %in% pcn_shp_tmp$PCN_Code)

leaflet(pcn_shp_tmp, options = leafletOptions(minZoom = 5, maxZoom = 15, attributionControl = F)) %>%
  #setView(lat = 54.00366, lng = -2.547855, zoom = 7) %>% # centre map on Whitendale Hanging Stones, the centre of GB: https://en.wikipedia.org/wiki/Centre_points_of_the_United_Kingdom
  addProviderTiles(providers$CartoDB.Positron) %>% 
  
  # addPolygons(data = vi_tmp, fillColor = "white", fillOpacity = 0.5, color = "black", weight = 0.7) %>% 
  
  addPolygons(data = lads, fillColor = NA, color = "cornflowerblue", weight = 0.7) %>% 
  
  addPolygons(
    fillColor = ~pcn_pal(PCN_Code),  #"cornflowerblue", 
    fillOpacity = 0.5, color = "white", weight = 0.7
  ) %>% 
  
  setMaxBounds(lat1 = pcn_shp_box[1], lng1 = pcn_shp_box[2], lat2 = pcn_shp_box[3], lng2 = pcn_shp_box[4])


#----
pcn_shp_tmp = pcn_shp %>% 
  filter(str_detect(PCN_Name, "^TRAFFORD"))

pcn_shp_box = st_bbox(pcn_shp_tmp)

pcn_pal = colorFactor("Set3", pcn_shp_tmp$PCN_Code)

# get MSOAs that overlap with this PCN
curr_msoas <- pcn_msoa %>% filter(PCN_Code == pcn_shp_tmp$PCN_Code)

vi_tmp = vi_msoa %>% 
  filter(Code %in% curr_msoas$MSOA11CD)

leaflet(pcn_shp_tmp, options = leafletOptions(minZoom = 5, maxZoom = 15, attributionControl = F)) %>%
  #setView(lat = 54.00366, lng = -2.547855, zoom = 7) %>% # centre map on Whitendale Hanging Stones, the centre of GB: https://en.wikipedia.org/wiki/Centre_points_of_the_United_Kingdom
  addProviderTiles(providers$CartoDB.Positron) %>% 
  
  addPolygons(data = vi_tmp, fillColor = "white", fillOpacity = 0.5, color = "black", weight = 0.7) %>% 
  
  addPolygons(
    fillColor = ~pcn_pal(PCN_Code),  #"cornflowerblue", 
    fillOpacity = 0.5, color = "white", weight = 0.7
  ) %>% 
  
  setMaxBounds(lat1 = pcn_shp_box[1], lng1 = pcn_shp_box[2], lat2 = pcn_shp_box[3], lng2 = pcn_shp_box[4])
