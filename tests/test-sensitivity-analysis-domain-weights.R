# This is a test file to experiment with sensitivity analysis for varying domain weights.
# This file has been written to use the "create vulnerability index - MSOA - England.r" file.
# Other files can be exchanged in its place, but the 'Load data' section needs updating
# accordingly.

# ---- Load libraries ----
library(tidyverse)

# ---- Load data ----
# Source MSOA England file up to line 326, just before the VI is created
source(textConnection(read_lines("create vulnerability index - MSOA - England.r",
                                 n_max = 326)))

# Combine MSOA data ready to be piped into calc_domain_scores function
msoa_data <- clinical %>%
  select(MSOA11CD, `Clinical Vulnerability rank`) %>%
  left_join(health_wellbeing %>% select(MSOA11CD, `Health/Wellbeing Vulnerability rank`),
            by = "MSOA11CD") %>%
  left_join(economic %>% select(MSOA11CD, ends_with("Vulnerability rank")),
            by = "MSOA11CD") %>%
  left_join(social %>% select(MSOA11CD, `Social Vulnerability rank`),
            by = "MSOA11CD")

# ---- Weights ----
# Create a tibble of weights to iterate over
# Idea: hold all but one domain constant, to see how weighting that domain effects the
#       overall score. This should highlight any particularly sensitive domains. Do this
#       where the domain holds all of the weight, and where also where it also holds most 
#       of the weight.
weights_tibble <- tibble(clinical_weight = c(1, 0, 0, 0, .7, .1, .1, .1),
                         health_weight   = c(0, 1, 0, 0, .1, .7, .1, .1),
                         economic_weight = c(0, 0, 1, 0, .1, .1, .7, .1),
                         social_weight   = c(0, 0, 0, 1, .1, .1, .1, .7))

# TODO: research how to vary weights for a sensitivity analysis. I would assume a step-wise
#       or stochastic model exists to generate weights in a systematic way.

# ---- Iterate ----
# Iterate over each row of weighs_tibble, inputting weights into calc_domain_scores
# Store result in new column of weights_tibble (nested data structure - i.e., one tibble per row)

# ---- Plot ----
