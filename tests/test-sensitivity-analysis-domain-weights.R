# This is a test file to experiment with sensitivity analysis for varying domain weights.
# This file has been written to use the "create vulnerability index - MSOA - England.r" file.
# Other files can be exchanged in its place, but the 'Load data' section needs updating
# accordingly.

# ---- Load libraries ----
library(tidyverse)

# ---- Load data ----
# # Source MSOA England file up to line 326, just before the VI is created
# source(textConnection(read_lines("create vulnerability index - MSOA - England.r",
#                                  n_max = 326)))
# 
# # Combine MSOA data ready to be piped into calc_domain_scores function
# msoa_data <- clinical %>%
#   select(MSOA11CD, `Clinical Vulnerability rank`) %>%
#   left_join(health_wellbeing %>% select(MSOA11CD, `Health/Wellbeing Vulnerability rank`),
#             by = "MSOA11CD") %>%
#   left_join(economic %>% select(MSOA11CD, ends_with("Vulnerability rank")),
#             by = "MSOA11CD") %>%
#   left_join(social %>% select(MSOA11CD, `Social Vulnerability rank`),
#             by = "MSOA11CD")

msoa_data <- read_csv("tests/msoa_data.csv")
source("functions.r")

# ---- Weights ----
# Create a tibble of weights to iterate over
weights <- crossing(clinical_weight = c(0, .25, .5, .75, 1),
                    health_weight   = c(0, .25, .5, .75, 1),
                    economic_weight = c(0, .25, .5, .75, 1),
                    social_weight   = c(0, .25, .5, .75, 1)) %>% 
  rowwise() %>% 
  filter(sum(c_across(everything())) == 1,
         # removes rows where more than two indicators are varying
         !if_else(sum(c_across(everything()) > 0) > 2, TRUE, FALSE))

# ---- Iterate ----
# Iterate over each row of weighs, inputting weights into calc_domain_scores
# Store result in new column, vi (nested data structure - i.e., one tibble per row)
weighted_vi <- weights %>% 
  # First create column of unweighted (i.e., all = .25) scores
  mutate(unweighted_vi = list(calc_domain_scores(d = msoa_data,
                                                 rank.indicators = FALSE,
                                                 clinical_weight = 0.25,
                                                 health_weight = 0.25,
                                                 economic_weight = 0.25,
                                                 social_weight = 0.25)),
         # Then weighted scores
         weighted_vi = list(calc_domain_scores(d = msoa_data,
                                               rank.indicators = FALSE,
                                               clinical_weight = clinical_weight,
                                               health_weight = health_weight,
                                               economic_weight = economic_weight,
                                               social_weight = social_weight) %>% 
                              select_all(list(~ paste0(., " weighted"))))) %>% 
  ungroup()

# ---- Calculate Assessment Metric ----
# To establish whether the allocated weights have an effect on the VI, create global
# metric that measures if an area has changed decile.
# see: https://assets.publishing.service.gov.uk/government/uploads/system/uploads/attachment_data/file/835115/IoD2019_Statistical_Release.pdf

# Create tibble id's
weighted_vi <- weighted_vi %>% 
  mutate(id = row_number()) %>% 
  relocate(id)

# Unnest data
weighted_vi_unnested <- weighted_vi %>%
  unnest(cols = c(unweighted_vi, weighted_vi))

# Calculate difference between weighted and unweighted in terms of the proportion of
# Areas that have changed decile.

# ---- Plot ----


# Facet chart one of link in assessment metric above