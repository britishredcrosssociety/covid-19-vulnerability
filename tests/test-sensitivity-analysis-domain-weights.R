# This is a test file to experiment with sensitivity analysis for varying domain weights.
# This file has been written to use the "create vulnerability index - MSOA - England.r" file.
# Other files can be exchanged in its place, but the 'Load data' section needs updating
# accordingly.

# ---- Load libraries ----
library(tidyverse)
library(glue)
source("functions.r")

# ---- Load data ----
# # Source MSOA England file up to line 326, just before the VI is created
# source(textConnection(read_lines("create vulnerability index - MSOA - England.r",
#                                  n_max = 326)))
# 
# # Combine MSOA data ready to be piped into calc_domain_scores function
# msoa_data <- clinical %>%
#   select(MSOA11CD, `Clinical Vulnerability rank`) %>%
#   left_join(health_wellbeing %>% select(MSOA11CD, `Health/Wellbeing Vulnerability rank`),
#             by = "MSOA11CD") %>%
#   left_join(economic %>% select(MSOA11CD, ends_with("Vulnerability rank")),
#             by = "MSOA11CD") %>%
#   left_join(social %>% select(MSOA11CD, `Social Vulnerability rank`),
#             by = "MSOA11CD")

# Load saved msoa_data created above
msoa_data <- read_csv("tests/msoa_data.csv")

# ---- Weights ----
# Create a tibble of weights to iterate over
weights <- crossing(clinical_weight = c(0, .25, .5, .75, 1),
                    health_weight   = c(0, .25, .5, .75, 1),
                    economic_weight = c(0, .25, .5, .75, 1),
                    social_weight   = c(0, .25, .5, .75, 1)) %>% 
  rowwise() %>% 
  filter(sum(c_across(everything())) == 1,
         # removes rows where more than two indicators are varying
         !if_else(sum(c_across(everything()) > 0) > 2, TRUE, FALSE))

# ---- Iterate ----
# Iterate over each row of weighs, inputting weights into calc_domain_scores
# Store result in new column, vi (nested data structure - i.e., one tibble per row)
weighted_vi <- weights %>% 
  # First create column of unweighted (i.e., all = .25) scores
  mutate(unweighted_vi = list(calc_domain_scores(d = msoa_data,
                                                 rank.indicators = FALSE,
                                                 clinical_weight = 0.25,
                                                 health_weight = 0.25,
                                                 economic_weight = 0.25,
                                                 social_weight = 0.25)),
         # Then weighted scores
         weighted_vi = list(calc_domain_scores(d = msoa_data,
                                               rank.indicators = FALSE,
                                               clinical_weight = clinical_weight,
                                               health_weight = health_weight,
                                               economic_weight = economic_weight,
                                               social_weight = social_weight) %>% 
                              select_all(list(~ paste0(., " weighted"))))) %>% 
  ungroup()

# ---- Calculate Assessment Metric ----
# To establish whether the allocated weights have an effect on the VI, create global
# metric that measures if an area has changed decile.
# see: https://assets.publishing.service.gov.uk/government/uploads/system/uploads/attachment_data/file/835115/IoD2019_Statistical_Release.pdf

# Create tibble id's
weighted_vi <- weighted_vi %>% 
  mutate(id = row_number()) %>% 
  relocate(id)

# Unnest data
weighted_vi_unnested <- weighted_vi %>%
  unnest(cols = c(unweighted_vi, weighted_vi)) %>% 
  select(-`Clinical Vulnerability rank`:-`Vulnerability rank`,
         -`MSOA11CD weighted`: -`Vulnerability rank weighted`,
         decile = `Vulnerability decile`,
         decile_weighted = `Vulnerability decile weighted`)

# Calculate difference between weighted and unweighted in terms of the proportion of
# areas that have changed decile and the actual difference
sens_metrics <- weighted_vi_unnested %>%
  mutate(decile_same = decile == decile_weighted,
         decile_difference = decile - decile_weighted) %>% 
  group_by(id, decile) %>% 
  mutate(decile_perc_difference = (sum(decile_same)/n()*100)) %>% 
  ungroup()

# Create labels
sens_metrics <- sens_metrics %>% 
  mutate(clinical_perc = clinical_weight*100,
         health_perc = health_weight*100,
         economic_perc = economic_weight*100,
         social_perc = social_weight*100) %>% 
  mutate(label = "") %>% 
  mutate(label = if_else(clinical_perc == 0, label, as.character(glue('{label}', 'clinical:{clinical_perc}% '))),
         label = if_else(health_perc == 0, label, as.character(glue('{label}', 'health:{health_perc}% '))),
         label = if_else(economic_perc == 0, label, as.character(glue('{label}', 'economic:{economic_perc}% '))),
         label = if_else(social_perc == 0, label, as.character(glue('{label}', 'social:{social_perc}% ')))) %>%
  mutate(label = str_trim(label))
# ---- Plot ----
sens_metrics %>%
  count(label, decile, decile_perc_difference) %>% 
  mutate(percent = str_c(round(decile_perc_difference), "%")) %>% 
  ggplot(aes(x = decile, y = decile_perc_difference, fill = label)) +
  # geom_text(aes(label = percent), size = 3, hjust = -0.5) +
  geom_col(show.legend = FALSE) +
  facet_wrap(vars(label)) +
  labs(x = "Decile",
       y = NULL,
       title = "Proportion of MSOA's that remain in the same decile after adjusting domain weights (indicated by facet) compared to a baseline of equal weighting across all domains") +
  scale_fill_viridis_d(option = "D", begin = 0 , end = .9) +
  scale_x_continuous(breaks = seq(1, 10, by = 1)) +
  scale_y_continuous(breaks = seq(0, 100, by = 10),
                     labels = function(x) paste0(x, "%")) +
  coord_flip()
  
ggsave("tests/sens-analysis-msoa-england.png", width = 15, height = 10)