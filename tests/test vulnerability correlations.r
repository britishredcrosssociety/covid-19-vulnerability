library(tidyverse)
library(ggcorrplot)
library(cowplot)
library(GGally)

source("load lookup tables.r")  # for get_country()

vi = read_csv("output/vulnerability-MSOA-UK.csv")

vi = vi %>% 
  mutate(Country = get_country(Code)) %>% 
  select(Country, ends_with("rank")) %>% 
  rename_at(vars(ends_with("rank")), ~ str_extract(., "\\w+")) %>%   # just keep first word in rank column names
  select(-Digital)

# make a correlation matrix for each nation
cor_eng = vi %>% 
  filter(Country == "England") %>% 
  select(-Country) %>% 
  cor()

cor_wal = vi %>% 
  filter(Country == "Wales") %>% 
  select(-Country) %>% 
  cor()

cor_sco = vi %>% 
  filter(Country == "Scotland") %>% 
  select(-Country) %>% 
  cor()

cor_ni = vi %>% 
  filter(Country == "Northern Ireland") %>% 
  select(-Country) %>% 
  cor()

# make a matrix of p-values for each nation
p_eng = vi %>% 
  filter(Country == "England") %>% 
  select(-Country) %>% 
  cor_pmat()

p_wal = vi %>% 
  filter(Country == "Wales") %>% 
  select(-Country) %>% 
  cor_pmat()

p_sco = vi %>% 
  filter(Country == "Scotland") %>% 
  select(-Country) %>% 
  cor_pmat()

p_ni = vi %>% 
  filter(Country == "Northern Ireland") %>% 
  select(-Country) %>% 
  cor_pmat()

plt_eng = ggcorrplot(cor_eng, hc.order = TRUE, type = "lower", p.mat = p_eng)
plt_wal = ggcorrplot(cor_wal, hc.order = TRUE, type = "lower", p.mat = p_wal)
plt_sco = ggcorrplot(cor_sco, hc.order = TRUE, type = "lower", p.mat = p_sco)
plt_ni  = ggcorrplot(cor_ni,  hc.order = TRUE, type = "lower", p.mat = p_ni)

plot_grid(plt_eng, plt_wal, plt_sco, plt_ni,
          labels = c("England", "Wales", "Scotland", "Northern Ireland"), label_size = 10)

ggsave("tests/correlations between vulnerability domains.png", width = 200, height = 200, units = "mm")


##
## plot relationships between vulnerability domains for each nation
##
for (curr_country in unique(vi$Country)) {
  plt_pairs = vi %>% 
    filter(Country == curr_country) %>% 
    select(-Country) %>% 
    ggpairs(lower = list(continuous = wrap("smooth", alpha = 0.3, size = 0.01)), diag = NULL) +
    theme_classic()
  
  ggsave(paste0("tests/pairs plot - ", curr_country, ".png"), plot = plt_pairs, width = 200, height = 200, units = "mm")
}


###############################################################################
## Look at correlations between domains of deprivation, for comparison
##
# load deprivation ranks for each nation
imd = read_csv("https://raw.githubusercontent.com/matthewgthomas/IMD/master/data/UK%20IMD%20domains.csv", 
               col_types = cols(
                   .default = col_double(),
                   LSOA = col_character(),
                   Name = col_character(),
                   RUC = col_character()
                 ))

imd = imd %>% 
  mutate(Country = get_country(LSOA)) %>% 
  select(Country, ends_with("rank")) %>% 
  rename_at(vars(ends_with("rank")), ~ str_sub(., 1, nchar(.) - nchar("_rank")))


##
## plot correlation matrices
##
plt_cor = list()
i = 1

for (curr_country in unique(imd$Country)) {
  curr_data = imd %>% 
    filter(Country == curr_country) %>% 
    select(-Country) %>% 
    janitor::remove_empty("cols")
  
  # make a correlation and p-value matrix
  cor_mat = cor(curr_data)
  p_mat = cor_pmat(curr_data)
  
  plt_cor[[i]] = ggcorrplot(cor_mat, hc.order = TRUE, type = "lower", p.mat = p_mat) + labs(title = curr_country)
  i = i + 1
}

plot_grid(plotlist = plt_cor)
ggsave("tests/deprivation - correlations between domains.png", width = 250, height = 250, units = "mm")


##
## plot relationships between deprivation domains for each nation
##
for (curr_country in unique(imd$Country)) {
  plt_pairs = imd %>% 
    filter(Country == curr_country) %>% 
    select(-Country) %>% 
    janitor::remove_empty("cols") %>% 
    
    ggpairs(lower = list(continuous = wrap("smooth", alpha = 0.1, size = 0.01)), diag = NULL) +
    theme_classic()
  
  ggsave(paste0("tests/deprivation pairs plot - ", curr_country, ".png"), plot = plt_pairs, width = 200, height = 200, units = "mm")
}
