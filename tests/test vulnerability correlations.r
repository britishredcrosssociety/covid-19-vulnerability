library(tidyverse)

vulnerability_all = read_csv("output/vulnerability-MSOA-England.csv")

vulnerability_all %>%
  ggplot(aes(x = `Clinical Vulnerability rank`, y = `Social Vulnerability rank`)) +
  geom_point(alpha = .3, colour = "steelblue") +
  geom_smooth(method = "lm")

cor.test(~ `Clinical Vulnerability rank` + `Social Vulnerability rank`, data = vulnerability_all)
cor.test(~ `Economic Vulnerability rank` + `Social Vulnerability rank`, data = vulnerability_all)

vulnerability_all %>%
  ggplot(aes(x = `Clinical Vulnerability decile`, y = `Social Vulnerability decile`)) +
  geom_jitter(alpha = .3, colour = "steelblue") +
  geom_smooth(method = "lm")

clin_soc = vulnerability_all %>% 
  filter(`Clinical Vulnerability decile` == 10 & `Social Vulnerability decile` == 10)


vulnerability_all %>%
  ggplot(aes(x = `Clinical Vulnerability rank`, y = `Health/Wellbeing Vulnerability rank`)) +
  geom_point(alpha = .3, colour = "steelblue") +
  geom_smooth(method = "lm")


panel.cor <- function(x, y, digits = 2, prefix = "", cex.cor, ...)
{
  usr <- par("usr"); on.exit(par(usr))
  par(usr = c(0, 1, 0, 1))
  r <- (cor(x, y))
  txt <- format(c(r, 0.123456789), digits = digits)[1]
  txt <- paste0(prefix, txt)
  if(missing(cex.cor)) cex.cor <- 0.8/strwidth(txt)
  text(0.5, 0.5, txt)
}

pairs(~ `Clinical Vulnerability rank` + `Health/Wellbeing Vulnerability rank` + `Economic Vulnerability rank` + `Social Vulnerability rank`, data = vulnerability_all,
      lower.panel = panel.smooth, upper.panel = panel.cor)




##
## IMD
##
# File 7: all ranks, deciles and scores for the indices of deprivation, and population denominators
# source: https://www.gov.uk/government/statistics/english-indices-of-deprivation-2019
imd = read_csv("https://assets.publishing.service.gov.uk/government/uploads/system/uploads/attachment_data/file/845345/File_7_-_All_IoD2019_Scores__Ranks__Deciles_and_Population_Denominators_3.csv")

names(imd)[str_detect(names(imd), "Rank")]

pairs(~ `Income Rank (where 1 is most deprived)` + `Employment Rank (where 1 is most deprived)` + `Health Deprivation and Disability Rank (where 1 is most deprived)` + 
        `Barriers to Housing and Services Rank (where 1 is most deprived)`, 
      data = imd,
      lower.panel = panel.smooth, upper.panel = panel.cor)

cor.test(~ `Health Deprivation and Disability Rank (where 1 is most deprived)` + 
           `Barriers to Housing and Services Rank (where 1 is most deprived)`, data = imd)
