library(tidyverse)
library(ggcorrplot)
library(cowplot)
library(GGally)

source("load lookup tables.r")  # for get_country()

vi = read_csv("output/vulnerability-MSOA-UK.csv")

vi = vi %>% 
  mutate(Country = get_country(Code)) %>% 
  select(Country, ends_with("rank")) %>% 
  rename_at(vars(ends_with("rank")), ~ str_extract(., "\\w+")) %>%   # just keep first word in rank column names
  select(-Digital)

# make a correlation matrix for each nation
cor_eng = vi %>% 
  filter(Country == "England") %>% 
  select(-Country) %>% 
  cor()

cor_wal = vi %>% 
  filter(Country == "Wales") %>% 
  select(-Country) %>% 
  cor()

cor_sco = vi %>% 
  filter(Country == "Scotland") %>% 
  select(-Country) %>% 
  cor()

cor_ni = vi %>% 
  filter(Country == "Northern Ireland") %>% 
  select(-Country) %>% 
  cor()

# make a matrix of p-values for each nation
p_eng = vi %>% 
  filter(Country == "England") %>% 
  select(-Country) %>% 
  cor_pmat()

p_wal = vi %>% 
  filter(Country == "Wales") %>% 
  select(-Country) %>% 
  cor_pmat()

p_sco = vi %>% 
  filter(Country == "Scotland") %>% 
  select(-Country) %>% 
  cor_pmat()

p_ni = vi %>% 
  filter(Country == "Northern Ireland") %>% 
  select(-Country) %>% 
  cor_pmat()

plt_eng = ggcorrplot(cor_eng, hc.order = TRUE, type = "lower", p.mat = p_eng)
plt_wal = ggcorrplot(cor_wal, hc.order = TRUE, type = "lower", p.mat = p_wal)
plt_sco = ggcorrplot(cor_sco, hc.order = TRUE, type = "lower", p.mat = p_sco)
plt_ni  = ggcorrplot(cor_ni,  hc.order = TRUE, type = "lower", p.mat = p_ni)

plot_grid(plt_eng, plt_wal, plt_sco, plt_ni,
          labels = c("England", "Wales", "Scotland", "Northern Ireland"), label_size = 10)

ggsave("tests/correlations between vulnerability domains.png", width = 200, height = 200, units = "mm")


##
## plot relationships between vulnerability domains for each nation
##
for (curr_country in unique(vi$Country)) {
  plt_pairs = vi %>% 
    filter(Country == curr_country) %>% 
    select(-Country) %>% 
    ggpairs(lower = list(continuous = wrap("smooth", alpha = 0.3, size = 0.01)), diag = NULL) +
    theme_classic()
  
  ggsave(paste0("tests/pairs plot - ", curr_country, ".png"), plot = plt_pairs, width = 200, height = 200, units = "mm")
}






##
## IMD
##
# File 7: all ranks, deciles and scores for the indices of deprivation, and population denominators
# source: https://www.gov.uk/government/statistics/english-indices-of-deprivation-2019
imd = read_csv("https://assets.publishing.service.gov.uk/government/uploads/system/uploads/attachment_data/file/845345/File_7_-_All_IoD2019_Scores__Ranks__Deciles_and_Population_Denominators_3.csv")

names(imd)[str_detect(names(imd), "Rank")]

pairs(~ `Income Rank (where 1 is most deprived)` + `Employment Rank (where 1 is most deprived)` + `Health Deprivation and Disability Rank (where 1 is most deprived)` + 
        `Barriers to Housing and Services Rank (where 1 is most deprived)`, 
      data = imd,
      lower.panel = panel.smooth, upper.panel = panel.cor)

cor.test(~ `Health Deprivation and Disability Rank (where 1 is most deprived)` + 
           `Barriers to Housing and Services Rank (where 1 is most deprived)`, data = imd)
