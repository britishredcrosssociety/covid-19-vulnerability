##
## Food vulnerability for LAs
##
library(tidyverse)

source("functions.r")
source("load lookup tables.r")

# load hardship fund vulnerability index data
vi_food_eng = read_csv("bespoke vulnerability index - food/food-vulnerability-MSOA-England.csv")
vi_food_wal = read_csv("bespoke vulnerability index - food/food-vulnerability-MSOA-Wales.csv")
vi_food_sco = read_csv("bespoke vulnerability index - food/food-vulnerability-MSOA-Scotland.csv")
vi_food_ni  = read_csv("bespoke vulnerability index - food/food-vulnerability-SOA-NI.csv")


##
## lookup tables
##
# MSOA to LA codes for England, Wales and Scotland
msoa_lad = load_lookup_lsoa_msoa_lad() %>% 
  select(MSOA11CD, LAD17CD) %>% 
  distinct()

lad_17_19 = read_csv("data/LAD 2017 to LAD 2019 codes.csv")  # lookup of Local Authority codes from 2017 to 2019

lad_regions = read_csv("https://opendata.arcgis.com/datasets/3ba3daf9278f47daba0f561889c3521a_0.csv") %>% 
  select(LAD19CD, RGN19NM)

lad_names = read_csv("https://opendata.arcgis.com/datasets/c3ddcd23a15c4d7985d8b36f1344b1db_0.csv") %>% 
  select(LAD19CD, LAD19NM)

# get 2019 LA codes and regions
msoa_lad = msoa_lad %>% 
  left_join(lad_17_19, by = "LAD17CD") %>% 
  left_join(lad_regions, by = "LAD19CD")

# tactical cells
msoa_tc = read_csv("data/lookup msoa to tactical cell.csv")

# load population estimates
source("prep population estimates.r")


###############################################################################
## Aggregate into Tactical Cells
##
# England
extent_eng = vi_food_eng %>% 
  left_join(msoa_tc, by = c("Code" = "MSOA11CD")) %>% 
  left_join(pop_eng, by = "Code") %>% 
  aggregate_scores(domain = "Food", aggregate_by = "TacticalCell")

# Wales
extent_wal = vi_food_wal %>% 
  left_join(pop_eng, by = "Code") %>% 
  mutate(TacticalCell = "Wales") %>% 
  aggregate_scores(domain = "Food", aggregate_by = "TacticalCell")

# Scotland
extent_sco = vi_food_sco %>% 
  left_join(pop_sco, by = "Code") %>% 
  mutate(TacticalCell = "Scotland") %>% 
  aggregate_scores(domain = "Food", aggregate_by = "TacticalCell")

# NI
extent_ni = vi_food_ni %>% 
  left_join(pop_ni, by = "Code") %>% 
  mutate(TacticalCell = "Northern Ireland") %>% 
  aggregate_scores(domain = "Food", aggregate_by = "TacticalCell")

# combine and save
bind_rows(extent_eng, extent_wal, extent_sco, extent_ni) %>% 
  mutate(Percentage = (Score / sum(Score) * 100)) %>% 
  write_csv("bespoke vulnerability index - food/food-vulnerability-tactical-cell.csv")


###############################################################################
## Aggregate into Regions
##
# England
extent_eng = vi_food_eng %>% 
  left_join(msoa_lad, by = c("Code" = "MSOA11CD")) %>% 
  left_join(pop_eng, by = "Code") %>% 
  aggregate_scores(domain = "Food", aggregate_by = "RGN19NM")

# Wales
extent_wal = vi_food_wal %>% 
  left_join(pop_eng, by = "Code") %>% 
  mutate(RGN19NM = "Wales") %>% 
  aggregate_scores(domain = "Food", aggregate_by = "RGN19NM")

# Scotland
extent_sco = vi_food_sco %>% 
  left_join(pop_sco, by = "Code") %>% 
  mutate(RGN19NM = "Scotland") %>% 
  aggregate_scores(domain = "Food", aggregate_by = "RGN19NM")

# NI
extent_ni = vi_food_ni %>% 
  left_join(pop_ni, by = "Code") %>% 
  mutate(RGN19NM = "Northern Ireland") %>% 
  aggregate_scores(domain = "Food", aggregate_by = "RGN19NM")

# combine and save
bind_rows(extent_eng, extent_wal, extent_sco, extent_ni) %>% 
  mutate(Percentage = (Score / sum(Score) * 100)) %>% 
  write_csv("bespoke vulnerability index - food/food-vulnerability-region.csv")


###############################################################################
## Aggregate into Regions
##
# England
extent_eng = vi_food_eng %>% 
  left_join(msoa_lad, by = c("Code" = "MSOA11CD")) %>% 
  left_join(pop_eng, by = "Code") %>% 
  aggregate_scores(domain = "Food", aggregate_by = "LAD19CD")

# Wales
extent_wal = vi_food_wal %>% 
  left_join(pop_eng, by = "Code") %>% 
  mutate(RGN19NM = "Wales") %>% 
  aggregate_scores(domain = "Food", aggregate_by = "LAD19CD")

# Scotland
extent_sco = vi_food_sco %>% 
  left_join(pop_sco, by = "Code") %>% 
  mutate(RGN19NM = "Scotland") %>% 
  aggregate_scores(domain = "Food", aggregate_by = "LAD19CD")

# NI
extent_ni = vi_food_ni %>% 
  left_join(pop_ni, by = "Code") %>% 
  mutate(RGN19NM = "Northern Ireland") %>% 
  aggregate_scores(domain = "Food", aggregate_by = "LAD19CD")

# combine and save
bind_rows(extent_eng, extent_wal, extent_sco, extent_ni) %>% 
  mutate(Percentage = (Score / sum(Score) * 100)) %>% 
  write_csv("bespoke vulnerability index - food/food-vulnerability-LA.csv")
