##
## Food vulnerability in England
## - distance to supermarkets
## - distance to food banks
## - people living alone
## - people otherwise isolated (esp. older people)
## - digital exclusion
## - frailty
##
## - income deprivation (from IMD)
## - 
##
library(tidyverse)
library(readxl)
library(httr)
library(sf)

source("functions.r")
source("load lookup tables.r")

# load LSOA to MSOA codes lookup table
lookup_lsoa_msoa = load_lookup_lsoa_msoa_lad() %>% 
  select(LSOA11CD, MSOA11CD)

msoa_names = read_csv("https://visual.parliament.uk/msoanames/static/MSOA-Names-v1.1.0.csv") %>% 
  select(Code = msoa11cd, Name = msoa11nm)


##
## load England vulnerability index
##
vi_eng = read_csv("output/vulnerability-MSOA-England.csv")

# keep just the indicators we need for food vulnerability
vi_food_eng = vi_eng %>% 
  select(Code, `Frailty rank`, `Longest distance to supermarket (km)`, `Longest distance to food bank (km)`, `Longest distance to Post Office (km)`)


##
## income deprivation:
## •	Adults and children in Income Support families
## •	Adults and children in income-based Jobseeker's Allowance families
## •	Adults and children in income-based Employment and Support Allowance families
## •	Adults and children in Pension Credit (Guarantee) families
## •	Adults and children in Working Tax Credit and Child Tax Credit families not already counted
## •	Adults and children in Universal Credit families where no adult is in 'Working - no requirements' conditionality regime
## •	Asylum seekers in England in receipt of subsistence support, accommodation support, or both
##
# load underlying indicators for IMD
# source: "File 5: scores for the indices of deprivation" from https://www.gov.uk/government/statistics/english-indices-of-deprivation-2019
GET("https://assets.publishing.service.gov.uk/government/uploads/system/uploads/attachment_data/file/833978/File_5_-_IoD2019_Scores.xlsx",
    write_disk(tf <- tempfile(fileext = ".xlsx")))
imd_scores = read_excel(tf, sheet = "IoD2019 Scores")
unlink(tf); rm(tf)

# aggregate into MSOAs
imd_income = imd_scores %>% 
  select(LSOA11CD = `LSOA code (2011)`, `Income Score (rate)`) %>% 
  
  left_join(lookup_lsoa_msoa, by = "LSOA11CD") %>% 
  rename(Code = MSOA11CD) %>% 
  
  group_by(Code) %>% 
  summarise(`Income deprivation` = max(`Income Score (rate)`))


##
## Benefits claims data associated with food insecurity (from Smith et al. 2018: https://doi.org/10.1016/j.apgeog.2017.12.022)
## - Working age (16-64) people claiming Personal Independence Payments (average value from three months most recent data)
## - Children and working age adults claiming Disability Living Allowance (three month average, as above)
hunger_raw = read_excel("C:/Users/040026704/Documents/Data science/Data/Hunger/Food insecurity - Sept 2019.xlsx", sheet = "Data")

# keep only the indicators we need for this (most of the rest are covered by income deprivation)
hunger = hunger_raw %>% 
  select(Code = MSOAcode, `Working age (16-64) people claiming Personal Independence Payments` = PIP_avg_WA)


##
## people living alone (from CACI)
##
living_alone_lsoa = read_csv("data/CACI/living-alone-lsoa.csv")
living_alone_msoa = read_csv("data/CACI/living-alone-msoa.csv")

# merge SOAs for Northern Ireland into the MSOA dataframe
living_alone_msoa = living_alone_msoa %>% 
  filter(!startsWith(MSOA11CD, "N")) %>%  # no MSOAs in Northern Ireland
  
  bind_rows( living_alone_lsoa %>% filter(startsWith(LSOA11CD, "9")) %>% rename(MSOA11CD = LSOA11CD) ) %>% 
  rename(Code = MSOA11CD)

rm(living_alone_lsoa)


##
## get digital exclusion and access to banks from CACI data
##
caci_vuln_lsoa = read_csv("data/CACI/digital-exclusion-lsoa.csv")
caci_vuln_msoa = read_csv("data/CACI/digital-exclusion-msoa.csv")

# merge SOAs for Northern Ireland into the MSOA dataframe
caci_vuln_msoa = caci_vuln_msoa %>% 
  filter(!startsWith(MSOA11CD, "N")) %>%  # no MSOAs in Northern Ireland
  
  bind_rows( caci_vuln_lsoa %>% filter(startsWith(LSOA11CD, "9")) %>% rename(MSOA11CD = LSOA11CD) ) %>% 
  
  select(Code = MSOA11CD, `Digital Vulnerability score`)

rm(caci_vuln_lsoa)


##
## calculate overall index of food vulnerability
##
food_vulnerability = vi_food_eng %>% 
  left_join(imd_income, by = "Code") %>% 
  left_join(hunger, by = "Code") %>% 
  left_join(living_alone_msoa, by = "Code") %>% 
  left_join(caci_vuln_msoa, by = "Code") %>% 
  
  calc_domain_scores(domain = "Food") %>% 
  
  left_join(msoa_names, by = "Code") %>% 
  select(Code, Name, everything())

write_csv(food_vulnerability, "bespoke vulnerability index - food/food-vulnerability-MSOA-England.csv")


##
## check food vulnerability against other measures
##
# correlation between our vulnerability scores and the food insecurity model
cor.test(hunger_raw$NewHHriskrate, food_vulnerability$`Food Vulnerability score`)  # r = 0.3603463

vi = read_csv("output/vulnerability-MSOA-England.csv")

cor.test(vi$`Vulnerability score`, food_vulnerability$`Food Vulnerability score`)  # r = 0.7113701


##
## save as geojson
##
# Middle Layer Super Output Areas (December 2011) Boundaries EW BSC
# source: https://geoportal.statistics.gov.uk/datasets/middle-layer-super-output-areas-december-2011-boundaries-ew-bsc
msoa = read_sf("https://opendata.arcgis.com/datasets/c661a8377e2647b0bae68c4911df868b_3.geojson") %>% 
  st_transform(crs = 4326)

msoa = msoa %>% 
  filter(startsWith(msoa11cd, "E")) %>% 
  left_join(food_vulnerability, by = c("msoa11cd" = "Code")) %>% 
  mutate(`Food Vulnerability quintile` = calc_risk_quantiles(`Food Vulnerability rank`, quants = 5))

geo_file = "bespoke vulnerability index - food/food-vulnerability-MSOA-England.geojson"
if (file.exists(geo_file)) file.remove(geo_file)

msoa %>% 
  select(Code = msoa11cd, Name, everything(), -objectid, -msoa11nm, -msoa11nmw, -st_area.shape., -st_length.shape.) %>% 
  write_sf(geo_file)


##
## aggregate into Local Authorities
##
# MSOA to LA codes for England, Wales and Scotland
msoa_lad = load_lookup_lsoa_msoa_lad() %>% 
  select(MSOA11CD, LAD17CD) %>% 
  distinct()

lad_17_19 = read_csv("data/LAD 2017 to LAD 2019 codes.csv")  # lookup of Local Authority codes from 2017 to 2019

# get 2019 LA codes
msoa_lad = msoa_lad %>% 
  left_join(lad_17_19, by = "LAD17CD")

# aggregate into LAs
food_LA = food_vulnerability %>% 
  left_join(msoa_lad, by = c("Code" = "MSOA11CD")) %>% 
  
  mutate(Top20 = ifelse(`Food Vulnerability decile` >= 9, "Top20", "Other")) %>% 
  tabyl(LAD19CD, Top20) %>% 
  
  # calculate proportion of most deprived LSOAs
  mutate(`Proportion of neighbourhoods in 20% most food vulnerable` = Top20 / (Top20 + Other)) %>% 
  select(-Other, -Top20) %>% 
  na.omit()

write_csv(food_LA, "bespoke vulnerability index - food/food-vulnerability-LA.csv")

# Local Authority Districts (December 2019) Boundaries UK BUC
# source: https://geoportal.statistics.gov.uk/datasets/local-authority-districts-december-2019-boundaries-uk-buc
lads = read_sf("https://opendata.arcgis.com/datasets/3a4fa2ce68f642e399b4de07643eeed3_0.geojson")

geo_file = "bespoke vulnerability index - food/food-vulnerability-LA.geojson"
if (file.exists(geo_file)) file.remove(geo_file)

lads %>% 
  left_join(food_LA, by = c("lad19cd" = "LAD19CD")) %>% 
  select(Code = lad19cd, Name = lad19nm, everything(), -objectid, -lad19nmw, -st_area.shape., -st_length.shape., -bng_e, -bng_n, -long, -lat) %>% 
  write_sf(geo_file)
