# ---- Food Vulnerability Index NI ----

# ---- Load Libraries ----
library(tidyverse)
library(sf)
library(rmapshaper)

# ---- Source Files ----
source("functions.r")
source("load lookup tables.r")

# ---- Load Data ----
# Load NI VI
vi_ni <- read_csv("output/vulnerability-SOA-NI.csv")

# Income deprivation
income <- vi_ni %>% 
  select(Code,
         `Proportion of low-income population`)

# Access to food banks / shops / post office
# Data not available so use proxy
travel <- vi_ni %>% 
  select(Code,
         `Service-weighted fastest travel time by private transport (Rank)`)

# people living alone (from CACI)
alone <- read_csv("data/CACI/living-alone-lsoa.csv") %>% 
  rename(Code = LSOA11CD)

# get digital exclusion and access to banks from CACI data
digital <- read_csv("data/CACI/digital-exclusion-lsoa.csv") %>% 
  select(Code = LSOA11CD, `Digital Vulnerability score`)

# ---- Calculate Overall Index ----
food_vulnerability <- income %>% 
  left_join(travel, by = "Code") %>% 
  left_join(alone, by = "Code") %>% 
  left_join(digital, by = "Code") %>% 
  calc_domain_scores(domain = "Food")

write_csv(food_vulnerability, "bespoke vulnerability index - food/food-vulnerability-SOA-NI.csv")  

# ---- Check Food Vulnerability Against Other Measures ----
cor.test(vi_ni$`Vulnerability score`, food_vulnerability$`Food Vulnerability score`)  # r = 0.6726881

# ---- Save as Geojson ----
# Super Output Areas from https://www.opendatani.gov.uk/dataset/nisra-open-data-boundaries-super-output-areas-2011/resource/80392e82-8bee-42de-a1e3-82d1cbaa983f
soa <- read_sf("data/boundaries/SOA2011.shp") %>% 
  st_transform(crs = 4326) %>% 
  ms_simplify(keep_shapes = T)

soa <- soa %>% 
  left_join(food_vulnerability, by = c("SOA_CODE" = "Code")) %>%
  mutate(`Food Vulnerability quintile` = calc_risk_quantiles(`Food Vulnerability rank`, quants = 5))

geo_file <- "bespoke vulnerability index - food/food-vulnerability-SOA-NI.geojson"
if (file.exists(geo_file)) file.remove(geo_file)

soa %>% 
  rename(Code = SOA_CODE,
         Name = SOA_LABEL) %>%
  write_sf(geo_file)
