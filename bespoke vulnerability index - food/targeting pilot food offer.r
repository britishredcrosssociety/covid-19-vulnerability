##
## Find Local Authorities with high food insecurity and a decent number of Community Reserve Volunteers
##
library(tidyverse)
library(readxl)
library(janitor)
library(sf)

source("functions.r")
source("load lookup tables.r")


###############################################################################
## Load data
##
# can't share these two datasets publicly
hunger = read_excel("C:/Users/040026704/Documents/Data science/Data/Hunger/Food insecurity - Sept 2019.xlsx", sheet = "Data")
crvs = read_csv("C:/Users/040026704/Documents/Data science/Data/Volunteers/CRV 21 April.csv")


##
## lookup tables
##
# MSOA to LA codes for England, Wales and Scotland
msoa_lad = load_lookup_lsoa_msoa_lad() %>% 
  select(MSOA11CD, LAD17CD) %>% 
  distinct()

lad_17_19 = read_csv("data/LAD 2017 to LAD 2019 codes.csv")  # lookup of Local Authority codes from 2017 to 2019

# get 2019 LA codes
msoa_lad = msoa_lad %>% 
  left_join(lad_17_19, by = "LAD17CD")

lad_regions = read_csv("https://opendata.arcgis.com/datasets/3ba3daf9278f47daba0f561889c3521a_0.csv") %>% 
  select(LAD19CD, RGN19NM)

msoa_names = read_csv("https://visual.parliament.uk/msoanames/static/MSOA-Names-v1.1.0.csv") %>% 
  select(Code = msoa11cd, Name = msoa11nm)

lad_names = read_csv("https://opendata.arcgis.com/datasets/c3ddcd23a15c4d7985d8b36f1344b1db_0.csv") %>% 
  select(LAD19CD, LAD19NM)

##
## boundaries
##
lads = read_sf("https://opendata.arcgis.com/datasets/3a4fa2ce68f642e399b4de07643eeed3_0.geojson")
msoas = read_sf("https://opendata.arcgis.com/datasets/c661a8377e2647b0bae68c4911df868b_3.geojson")  # Middle Layer Super Output Areas (December 2011) Boundaries EW BSC


###############################################################################
## Analysis
##

##
## mark which MSOAs are at greatest combined risk (i.e. are in the highest household risk quintile and are > 2SD for benefits claimants)
##
benefits_risk = 2 * sd(hunger$PertotClaim)

hunger = hunger %>% 
  mutate(RiskRateQ = calc_risk_quantiles(NewHHriskrate, quants = 5)) %>%  # calculate household risk quintiles
  mutate(HighestRisk = ifelse(RiskRateQ == 5 & PertotClaim >= benefits_risk, "Yes", "No"))


##
## calculate proportions of highest risk food insecure MSOAs in each LA
##
hunger = hunger %>% 
  left_join(msoa_lad, by = c("MSOAcode" = "MSOA11CD"))

hungry_lads = hunger %>% 
  tabyl(LAD19CD, HighestRisk) %>% 
  
  # calculate proportion of most deprived LSOAs
  mutate(`Food insecurity` = Yes / (Yes + No)) %>% 
  
  left_join(lad_names, by = "LAD19CD") %>% 
  left_join(lad_regions, by = "LAD19CD")


##
## count number of CRVs in each LA
##
crvs = crvs %>% 
  # convert clinical_geo to spatial object
  st_as_sf(coords = c("Longitude", "Latitude"), crs = 4326) %>% 
  
  # look up which LA each CRV is in
  st_join(lads, join = st_intersects) %>% 
  st_drop_geometry()     # don't need it to be a spatial dataframe anymore
  
# merge everything into a single table
hungry_lads_crv = hungry_lads %>% 
  left_join(crvs %>% count(lad19cd), by = c("LAD19CD" = "lad19cd"))
  
hungry_lads_crv %>% 
  filter(n >= 100) %>% 
  filter(RGN19NM %in% c("North East", "North West")) %>% 
  arrange(desc(`Food insecurity`)) %>% 
  write_csv("bespoke vulnerability index - food/food insecurity and CRVs - north east and west.csv")

hungry_lads_crv %>% 
  filter(n >= 100) %>% 
  group_by(RGN19NM) %>% 
  top_n(3, `Food insecurity`) %>% 
  select(Region = RGN19NM, `Local Authority` = LAD19NM, `% of neighbourhoods with highest food insecurity` = `Food insecurity`, `Number of CRVs` = n) %>% 
  write_csv("bespoke vulnerability index - food/food insecurity and CRVs.csv")


##
## make geojson of food insecure MSOAs
##
# make prettier names for food insecurity variables
hunger_nice = hunger %>% 
  left_join(msoa_names, by = c("MSOAcode" = "Code")) %>% 
  select(Code = MSOAcode, Name, `High food insecurity area?` = HighestRisk, `Household food insecurity risk quintile` = RiskRateQ,
         `Perentage of people living in households with higher demographic risk` = NewHHriskrate, `Percentage of people claiming benefits` = PertotClaim)

msoas %>% 
  left_join(hunger_nice, by = c("msoa11cd" = "Code")) %>% 
  select(Code = msoa11cd, Name, everything(), -objectid, -msoa11nm, -msoa11nmw, -st_areashape, -st_lengthshape) %>% 
  write_sf("bespoke vulnerability index - food/food-insecurity-MSOA.geojson")
