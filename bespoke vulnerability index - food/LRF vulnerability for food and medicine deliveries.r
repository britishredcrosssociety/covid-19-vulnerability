##
## Bespoke analysis: vulnerability index for food and medicine deliveries - for Local Resilience Forums
##
library(tidyverse)
library(Hmisc)
library(janitor)

source("functions.r")
source("load lookup tables.r")

msoa_lad = load_lookup_lsoa_msoa_lad() %>% 
  select(MSOA11CD, LAD17CD) %>% 
  distinct()

lad_17_19 = read_csv("data/LAD 2017 to LAD 2019 codes.csv")  # lookup of Local Authority codes from 2017 to 2019

# Local Authority District to Local Resilience Forum (December 2019) Lookup in England and Wales
# https://geoportal.statistics.gov.uk/datasets/local-authority-district-to-local-resilience-forum-december-2019-lookup-in-england-and-wales
lad_lrf = read_csv("https://opendata.arcgis.com/datasets/203ea94d324b4fcda24875e83e577060_0.csv")

# msoa to lad lookup
msoa_lrf = msoa_lad %>% 
  left_join(lad_17_19, by = "LAD17CD") %>% 
  left_join(lad_lrf, by = "LAD19CD") %>% 
  select(MSOA11CD, LRF19CD) %>% 
  distinct()


##
## aggregate the clinical vulnerability domain into LRFs
##
clinical = read_csv("output/vulnerability-scores-MSOA.csv") %>% 
  select(MSOA11CD, `Clinical Vulnerability decile`)

clinical_lad = clinical %>% 
  left_join(msoa_lad, by = "MSOA11CD") %>% 
  left_join(lad_17_19, by = "LAD17CD") %>% 
  
  # label LSOAs by whether they're in top 20% most-deprived then summarise by this label
  mutate(Clinical_top20 = ifelse(`Clinical Vulnerability decile` >= 9, "Top20", "Other")) %>% 
  tabyl(LAD19CD, Clinical_top20) %>% 
  
  # calculate proportion of most deprived LSOAs
  mutate(`Proportion of neighbourhoods in 20% most clinically vulnerable` = Top20 / (Top20 + Other)) %>% 
  
  # split into quintiles
  mutate(Clinical_q = as.integer(cut2(`Proportion of neighbourhoods in 20% most clinically vulnerable`, g = 5))) %>% 
  select(-Other, -Top20)

clinical_lrf = clinical %>% 
  left_join(msoa_lrf, by = "MSOA11CD") %>% 
  
  # label LSOAs by whether they're in top 20% most-deprived then summarise by this label
  mutate(Clinical_top20 = ifelse(`Clinical Vulnerability decile` >= 9, "Top20", "Other")) %>% 
  tabyl(LRF19CD, Clinical_top20) %>% 
  
  # calculate proportion of most deprived LSOAs
  mutate(`Proportion of neighbourhoods in 20% most clinically vulnerable` = Top20 / (Top20 + Other)) %>% 
  
  # split into quintiles
  mutate(Clinical_q = as.integer(cut2(`Proportion of neighbourhoods in 20% most clinically vulnerable`, g = 5))) %>% 
  select(-Other, -Top20)


##
## aggregate social isolation scores into LRFs
##
phe = read_csv("data/social-isolation-processed.csv")  # data manually downloaded from Public Health England

indicator_list = c("Children in need due to socially unacceptable behaviour: rate per 10,000  aged under 18",
                   
                   # we'll get depression data from elsewhere and use in the 'health vulnerabilities' bit
                   # "Depression and anxiety among social care users: % of social care users", 
                   
                   # these two just use census data, so we'll ignore for now
                   # "Older people living alone, % of people aged 65 and over who are living alone", 
                   # "People living alone: % of all usual residents in households occupied by a single person",
                   
                   "Percentage of adult social care service users have control over their daily lives, age 65+",
                   "Percentage of people  aged 65 and over who were still at home 91 days after discharge from hospital",
                   "Percentage of people aged 65 and over using social care who receive self-directed support, and those receiving direct payments",
                   "Proportion of people who use services who have control over their daily life",
                   "Social Isolation: percentage of adult carers who have as much social contact as they would like",
                   "Social Isolation: percentage of adult social care users who have as much social contact as they would like")

# social_isolation_lad = phe %>% 
#   filter(`Area Type` == "County & UA (pre 4/19)") %>% 
#   
#   filter(`Indicator Name` %in% indicator_list) %>% 
#   
#   select(`Indicator Name`, Code = `Area Code`, Value) %>% 
#   
#   pivot_wider(names_from = `Indicator Name`, values_from = Value, values_fn = list(Value = sum))

social_isolation_lad = phe %>% 
  calc_domain_scores()

# label scores/ranks/deciles as "clinical vulnerability"
names(social_isolation_lad)[ grepl("Vulnerability", names(social_isolation_lad)) ] = paste0("Social ", grep("Vulnerability", names(social_isolation_lad), value = T))

social_lrf = social_isolation_lad %>% 
  left_join(lad_lrf, by = c("Row Labels" = "LAD19CD")) %>% 
  
  # label LSOAs by whether they're in top 20% most-deprived then summarise by this label
  mutate(Social_top20 = ifelse(`Social Vulnerability decile` >= 9, "Top20", "Other")) %>% 
  tabyl(LRF19CD, Social_top20) %>% 
  
  # calculate proportion of most deprived LSOAs
  mutate(`Proportion of neighbourhoods in 20% most socially vulnerable` = Top20 / (Top20 + Other)) %>% 
  
  # split into quintiles
  mutate(Social_q = as.integer(cut2(`Proportion of neighbourhoods in 20% most socially vulnerable`, g = 5))) %>% 
  select(-Other, -Top20)

##
## combined LAD index
##
vi_lad = clinical_lad %>% 
  calc_domain_scores() %>% 
  rename(`Clinical Vulnerability rank` = `Vulnerability rank`) %>% 
  
  left_join(social_isolation_lad, by = c("LAD19CD" = "Row Labels")) %>% 
  select(LAD19CD, ends_with("score")) %>% 
  mutate(`Social Vulnerability score` = replace_na(`Social Vulnerability score`, 0)) %>%   # set scores to zero for LAs with no info
  
  calc_domain_scores() %>% 
  mutate(`Vulnerability quintile` = calc_risk_quantiles(`Vulnerability rank`, quants = 5))

write_csv(vi_lad, "output/vulnerable-LA-food-medicine.csv")


##
## combined LRF index
##
vi_lrf = clinical_lrf %>% 
  left_join(social_lrf, by = "LRF19CD") %>% 
  select(LRF19CD, starts_with("Proportion")) %>% 
  
  calc_domain_scores() %>% 
  mutate(`Vulnerability quintile` = calc_risk_quantiles(`Vulnerability rank`, quants = 5))


library(sf)

lrf = read_sf("https://opendata.arcgis.com/datasets/1d510b7fd2d145de9b5665c06c4cfc25_4.geojson")

lrf_vi = lrf %>% 
  left_join(vi_lrf, by = c("lrf17cd" = "LRF19CD")) %>% 
  filter(startsWith(lrf17cd, "E"))

write_sf(lrf_vi, "output/vulnerable-LRF-food-medicine.geojson")
