---
output:
  html_document:
    theme: null
    highlight: null
    css: styles.css
---

```{r knitr_init, echo=FALSE, cache=FALSE}
library(knitr)

## Global options
opts_chunk$set(echo=FALSE,
	             cache=FALSE,
               prompt=FALSE,
               tidy=TRUE,
               comment=NA,
               message=FALSE,
               warning=FALSE)
#opts_knit$set(width=75)
```

```{r load_packages, message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
library(tidyverse)
library(sf)
library(leaflet)
```

```{r load_bounds, message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
# source("prep vulnerability index.r")
lrf_vulnerability = read_sf("output/vulnerable-LRF-food-medicine.geojson")

pal_vuln = colorFactor("Reds", 1:5)
```

<!--html_preserve-->
<style type="text/css">
.tg  {border-collapse:collapse;border-spacing:0;border:none;}
.tg td{padding:1px 5px;border-style:solid;border-width:0px;overflow:hidden;word-break:normal;}
.tg .tg-us36{border-color:inherit;vertical-align:top}
</style>

<div style="z-index: 1; position: absolute; top: 0px; left: 50px; background-color: rgba(255, 255, 255, 0.6); padding: 5px 5px 5px 5px; font-size: 12px; width: 350px">
  <h3>COVID-19 Vulnerability Index</h3>
  <p>This map shows Local Resilience Forums in the UK where people might be highly vulnerable to COVID-19 and experiencing unmet needs.</p>
  <p>The COVID-19 vulnerability index is composed of <b>clinical vulnerability</b> and <b>social vulnerability</b>. Clinical vulnerability will help identify who is likely to transition from 'social distancing' to 'self-isolating/quarantining' and back, allowing us to account for the potential differing needs of those two groups. Social vulnerability will identify whether someone has unmet needs by modelling their existing social support and isolation.</p>
  <p>Wards coloured in darker shades of red are more vulnerable..</p>
</div>
<!--/html_preserve-->

```{r map}
leaflet(lrf_vulnerability,
        width = "100%", height = "100%", padding = 0,
        options = leafletOptions(minZoom = 5, maxZoom = 12, attributionControl = T)) %>% 
  
  # centre map on Whitendale Hanging Stones, the centre of GB: https://en.wikipedia.org/wiki/Centre_points_of_the_United_Kingdom
  setView(lat = 54.00366, lng = -2.547855, zoom = 7) %>%
  addProviderTiles(providers$CartoDB.Positron) %>% 
  
  # wards
  addPolygons(weight = 1, smoothFactor = 0.5, fillOpacity = 0.7,
              color = "grey", fillColor = ~pal_vuln(Vulnerability.quintile),
              highlightOptions = highlightOptions(color = "grey", weight = 2, bringToFront = T),

              label = ~lrf17nm,

              popup = ~paste0(
                "<b>", lrf17nm, "</b><br/><br/>",
                
                "<b>Overall vulnerability: ", Vulnerability.quintile, " (5 is worst)</b><br/><br/>",
                
                "<b>Clinical vulnerability:</b><br/>",
                "Proportion of neighbourhoods in 20% most clinically vulnerable: ", round(Proportion.of.neighbourhoods.in.20..most.clinically.vulnerable * 100, 1), "%<br/>",

                "<b>Social vulnerability:</b><br/>",
                "Proportion of neighbourhoods in 20% most socially vulnerable: ", round(Proportion.of.neighbourhoods.in.20..most.socially.vulnerable * 100, 1), "%<br/>"
              )
  ) %>%
  
  addLegend("bottomright", 
            pal = pal_vuln, 
            values = ~Vulnerability.quintile,
            title = "Vulnerability index\n(5 is most vulnerable)",
            opacity = 1
            # group = "LRFs, EPGs & LRPs"
  )
```
