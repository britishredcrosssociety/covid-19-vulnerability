# ---- Food Vulnerability Index Scotland ----

# ---- Load Libraries ----
library(tidyverse)
library(sf)
library(janitor)
library(httr)
library(readxl)
library(rmapshaper)

# ---- Source Files ----
source("functions.r")
source("load lookup tables.r")

# ---- Load Data ----
lookup_dz_iz = load_lookup_dz_iz_lad() %>% 
  select(LSOA11CD, MSOA11CD)

lookup_iz_names = load_lookup_dz_iz_lad() %>% 
  select(Code = MSOA11CD, Name = MSOA11NM) %>% 
  distinct()

# Load Scotland VI
vi_scot <- read_csv("output/vulnerability-MSOA-Scotland.csv")

# Select relevant indicators for food index
vi_food_scot <- vi_scot %>% 
  select(Code,
         Name,
         `Longest drive time to a Post Office (minutes)`,
         `Longest drive time to a retail centre (minutes)`,
         `Longest distance to food bank (km)`)

# IMD
GET("https://www.gov.scot/binaries/content/documents/govscot/publications/statistics/2020/01/scottish-index-of-multiple-deprivation-2020-indicator-data/documents/simd_2020_indicators/simd_2020_indicators/govscot%3Adocument/SIMD_2020_Indicators.xlsx",
    write_disk(tf <- tempfile(fileext = ".xlsx")))

imd_indicators <- read_excel(tf, sheet = "Data")
unlink(tf); rm(tf)

imd_social_dz <- imd_indicators %>% 
  select(Data_Zone, Income_count)

imd_income <- imd_social_dz %>% 
  left_join(lookup_dz_iz, by = c("Data_Zone" = "LSOA11CD")) %>% 
  rename(Code = MSOA11CD) %>% 
  group_by(Code) %>% 
  summarise(income_count = min(Income_count))

# people living alone (from CACI)
living_alone_lsoa <- read_csv("data/CACI/living-alone-lsoa.csv")
living_alone_msoa <- read_csv("data/CACI/living-alone-msoa.csv")

# merge SOAs for Northern Ireland into the MSOA dataframe
living_alone_msoa <- living_alone_msoa %>% 
  filter(!startsWith(MSOA11CD, "N")) %>%  # no MSOAs in Northern Ireland
  bind_rows( living_alone_lsoa %>% filter(startsWith(LSOA11CD, "9")) %>% rename(MSOA11CD = LSOA11CD) ) %>% 
  rename(Code = MSOA11CD)

# get digital exclusion and access to banks from CACI data
caci_vuln_lsoa <- read_csv("data/CACI/digital-exclusion-lsoa.csv")
caci_vuln_msoa <- read_csv("data/CACI/digital-exclusion-msoa.csv")

# merge SOAs for Northern Ireland into the MSOA dataframe
caci_vuln_msoa <- caci_vuln_msoa %>% 
  filter(!startsWith(MSOA11CD, "N")) %>%  # no MSOAs in Northern Ireland
  bind_rows( caci_vuln_lsoa %>% filter(startsWith(LSOA11CD, "9")) %>% rename(MSOA11CD = LSOA11CD) ) %>% 
  select(Code = MSOA11CD, `Digital Vulnerability score`)

# ---- Calculate Overall Index ----
food_vulnerability <- vi_food_scot %>% 
  left_join(imd_income, by  = "Code") %>% 
  left_join(living_alone_msoa, by = "Code") %>% 
  left_join(caci_vuln_msoa, by = "Code") %>% 
  calc_domain_scores(domain = "Food")

write_csv(food_vulnerability, "bespoke vulnerability index - food/food-vulnerability-MSOA-Scotland.csv")  

# ---- Check Food Vulnerability Against Other Measures ----
vi <- read_csv("output/vulnerability-MSOA-Scotland.csv")
cor.test(vi$`Vulnerability score`, food_vulnerability$`Food Vulnerability score`)  # r = 0.5041718

# ---- Save as Geojson ----
iz <- read_sf("data/boundaries/SG_IntermediateZone_Bdry_2011.shp") %>% 
  st_transform(crs = 4326) %>% 
  ms_simplify(keep_shapes = T)

iz_vi <- iz %>% 
  left_join(food_vulnerability, by = c("InterZone" = "Code")) %>% 
  mutate(`Food Vulnerability quintile` = calc_risk_quantiles(`Food Vulnerability rank`, quants = 5))

geo_file <- "bespoke vulnerability index - food/food-vulnerability-MSOA-Scotland.geojson"
if (file.exists(geo_file)) file.remove(geo_file)

iz_vi %>%
  select(Code = InterZone,
         Name = Name.y,
         everything(),
         -Name.x,
         -TotPop2011,
         -ResPop2011,
         -HHCnt2011,
         -StdAreaHa,
         -StdAreaKm2,
         -Shape_Leng,
         -Shape_Area) %>%
  write_sf(geo_file)
