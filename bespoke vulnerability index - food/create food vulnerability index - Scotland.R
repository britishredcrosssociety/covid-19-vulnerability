# ---- Food Vulnerability Index Scotland ----

# ---- Load Libraries ----
library(tidyverse)
library(sf)
library(janitor)
library(httr)
library(readxl)
library(rmapshaper)

# ---- Source Files ----
source("functions.r")
source("load lookup tables.r")

# ---- Load Data ----
lookup_dz_iz = load_lookup_dz_iz_lad() %>% 
  select(LSOA11CD, MSOA11CD)

lookup_iz_names = load_lookup_dz_iz_lad() %>% 
  select(Code = MSOA11CD, Name = MSOA11NM) %>% 
  distinct()

# Load Scotland VI
vi_scot <- read_csv("output/vulnerability-MSOA-Scotland.csv")

# Select relevant indicators for food index
vi_food_scot <- vi_scot %>% 
  select(Code,
         Name,
         `Longest drive time to a Post Office (minutes)`,
         `Longest drive time to a retail centre (minutes)`,
         `Longest distance to food bank (km)`)

# IMD
GET("https://www.gov.scot/binaries/content/documents/govscot/publications/statistics/2020/01/scottish-index-of-multiple-deprivation-2020-indicator-data/documents/simd_2020_indicators/simd_2020_indicators/govscot%3Adocument/SIMD_2020_Indicators.xlsx",
    write_disk(tf <- tempfile(fileext = ".xlsx")))

imd_indicators <- read_excel(tf, sheet = "Data")
unlink(tf); rm(tf)

imd_social_dz <- imd_indicators %>% 
  select(Data_Zone, Income_count)

imd_income <- imd_social_dz %>% 
  left_join(lookup_dz_iz, by = c("Data_Zone" = "LSOA11CD")) %>% 
  rename(Code = MSOA11CD) %>% 
  group_by(Code) %>% 
  summarise(income_count = min(Income_count))

# people living alone (from CACI)
living_alone_lsoa <- read_csv("data/CACI/living-alone-lsoa.csv")
living_alone_msoa <- read_csv("data/CACI/living-alone-msoa.csv")

# merge SOAs for Northern Ireland into the MSOA dataframe
living_alone_msoa <- living_alone_msoa %>% 
  filter(!startsWith(MSOA11CD, "N")) %>%  # no MSOAs in Northern Ireland
  bind_rows( living_alone_lsoa %>% filter(startsWith(LSOA11CD, "9")) %>% rename(MSOA11CD = LSOA11CD) ) %>% 
  rename(Code = MSOA11CD)

# get digital exclusion and access to banks from CACI data
caci_vuln_lsoa <- read_csv("data/CACI/digital-exclusion-lsoa.csv")
caci_vuln_msoa <- read_csv("data/CACI/digital-exclusion-msoa.csv")

# merge SOAs for Northern Ireland into the MSOA dataframe
caci_vuln_msoa <- caci_vuln_msoa %>% 
  filter(!startsWith(MSOA11CD, "N")) %>%  # no MSOAs in Northern Ireland
  bind_rows( caci_vuln_lsoa %>% filter(startsWith(LSOA11CD, "9")) %>% rename(MSOA11CD = LSOA11CD) ) %>% 
  select(Code = MSOA11CD, `Digital Vulnerability score`)

# ---- Calculate Overall Index ----
food_vulnerability <- vi_food_scot %>% 
  left_join(imd_income, by  = "Code") %>% 
  left_join(living_alone_msoa, by = "Code") %>% 
  left_join(caci_vuln_msoa, by = "Code") %>% 
  calc_domain_scores(domain = "Food")

write_csv(food_vulnerability, "bespoke vulnerability index - food/food-vulnerability-MSOA-Scotland.csv")  

# ---- Check Food Vulnerability Against Other Measures ----
vi <- read_csv("output/vulnerability-MSOA-Scotland.csv")
cor.test(vi$`Vulnerability score`, food_vulnerability$`Food Vulnerability score`)  # r = 0.5041718

# ---- Save as Geojson ----



# ----
iz <- read_sf("data/boundaries/SG_IntermediateZone_Bdry_2011.shp") %>% 
  st_transform(crs = 4326) %>% 
  ms_simplify(keep_shapes = T)

iz_vi = iz %>% 
  left_join(vulnerability_all, by = c("InterZone" = "Code")) %>% 
  mutate(`Vulnerability quintile` = calc_risk_quantiles(`Vulnerability rank`, quants = 5))

iz_vi %>% 
  # append a note to deciles and ranks
  rename_at(vars(matches("decile|rank")), ~ str_c(., " (1 = least vulnerable)")) %>% 
  
  select(Code = InterZone, Name = Name.x, `Alcohol-related hospital admissions`:`Vulnerability quintile`) %>% 
  write_sf("output/vulnerability-MSOA-Scotland.geojson")
# ----






msoa <- read_sf("https://opendata.arcgis.com/datasets/c661a8377e2647b0bae68c4911df868b_3.geojson") %>%
  st_transform(crs = 4326)

msoa <- msoa %>%
  filter(startsWith(msoa11cd, "W")) %>%
  left_join(food_vulnerability, by = c("msoa11cd" = "Code")) %>%
  mutate(`Food Vulnerability quintile` = calc_risk_quantiles(`Food Vulnerability rank`, quants = 5))

geo_file <- "bespoke vulnerability index - food/food-vulnerability-MSOA-Wales.geojson"
if (file.exists(geo_file)) file.remove(geo_file)

msoa %>%
  select(Code = msoa11cd, Name, everything(), -objectid, -msoa11nm, -msoa11nmw, -st_area.shape., -st_length.shape.) %>%
  write_sf(geo_file)

# ---- Aggregate into Local Authorities ----
# MSOA to LA codes for England, Wales and Scotland
msoa_lad <- load_lookup_lsoa_msoa_lad() %>% 
  select(MSOA11CD, LAD17CD) %>% 
  distinct()

lad_17_19 <- read_csv("data/LAD 2017 to LAD 2019 codes.csv")  # lookup of Local Authority codes from 2017 to 2019

# get 2019 LA codes
msoa_lad <- msoa_lad %>% 
  left_join(lad_17_19, by = "LAD17CD")

# aggregate into LAs
food_LA <- food_vulnerability %>% 
  left_join(msoa_lad, by = c("Code" = "MSOA11CD")) %>% 
  
  mutate(Top20 = ifelse(`Food Vulnerability decile` >= 9, "Top20", "Other")) %>% 
  tabyl(LAD19CD, Top20) %>% 
  
  # calculate proportion of most deprived LSOAs
  mutate(`Proportion of neighbourhoods in 20% most food vulnerable` = Top20 / (Top20 + Other)) %>% 
  select(-Other, -Top20) %>% 
  na.omit()

write_csv(food_LA, "bespoke vulnerability index - food/food-vulnerability-LA-Wales.csv")

# Local Authority Districts (December 2019) Boundaries UK BUC
# source: https://geoportal.statistics.gov.uk/datasets/local-authority-districts-december-2019-boundaries-uk-buc
lads <- read_sf("https://opendata.arcgis.com/datasets/3a4fa2ce68f642e399b4de07643eeed3_0.geojson")

geo_file <- "bespoke vulnerability index - food/food-vulnerability-LA-Wales.geojson"
if (file.exists(geo_file)) file.remove(geo_file)

lads %>%
  filter(startsWith(lad19cd, "W")) %>% 
  left_join(food_LA, by = c("lad19cd" = "LAD19CD")) %>%
  select(Code = lad19cd, Name = lad19nm, everything(), -objectid, -lad19nmw, -st_area.shape., -st_length.shape., -bng_e, -bng_n, -long, -lat) %>%
  write_sf(geo_file)
