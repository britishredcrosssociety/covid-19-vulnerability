##
## Food vulnerability for Football Food Aid
##
## Barnet
## Dagenham and Redbridge
## Barrow (in-Furness)
## Harrogate
## Aldershot
##
library(tidyverse)
library(sf)
library(tmap)
# library(osmdata)
# library(ggmap)

source("load lookup tables.r")

food = read_sf("output/food-vulnerability-MSOA-England.geojson")

# football_LAs = c("Harrow", "Barking and Dagenham", "Barrow-in-Furness", "Harrogate", "Rushmoor")
football_LAs = c("E09000015", "E09000002", "E07000027", "E07000165", "E07000092")

# MSOA to LA codes for England, Wales and Scotland
msoa_lad = load_lookup_lsoa_msoa_lad() %>% 
  select(MSOA11CD, LAD17CD) %>% 
  distinct()

lad_names = read_csv("https://opendata.arcgis.com/datasets/c3ddcd23a15c4d7985d8b36f1344b1db_0.csv") %>% 
  select(LAD19CD, LAD19NM)

lad_17_19 = read_csv("data/LAD 2017 to LAD 2019 codes.csv")  # lookup of Local Authority codes from 2017 to 2019

food = food %>% 
  left_join(msoa_lad, by = c("Code" = "MSOA11CD")) %>% 
  left_join(lad_17_19, by = "LAD17CD") %>% 
  left_join(lad_names, by = "LAD19CD")


##
## football club locations
##
football_clubs = tibble(Latitude = 51.601518, Longitude = -0.288874) %>% 
  st_as_sf(coords = c("Longitude", "Latitude"), crs = 4326)


##
## 
##
current_LA = football_LAs[1]
current_LA_name = subset(lad_names, LAD19CD == current_LA, select = LAD19NM) %>% as.character()

current_food_map = food %>% filter(LAD19CD == current_LA)

current_map = tm_shape(current_food_map) +
  tm_polygons(col = "Food.Vulnerability.score", colorNA = "white",
              style = "jenks", legend.hist = FALSE) +
  
  tm_shape(football_clubs) +
  tm_dots(size = 2) +
  
  tm_layout(legend.outside = F, title = current_LA_name)

tmap_save(current_map, paste0("maps/", "food-vulnerability-", current_LA_name, ".png"))


