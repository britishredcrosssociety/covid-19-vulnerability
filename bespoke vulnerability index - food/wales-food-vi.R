# ---- Food Vulnerability Index Wales ----

# ---- Load Libraries ----
library(tidyverse)

# ---- Source files ----
source("functions.r")
source("load lookup tables.r")
source("https://github.com/matthewgthomas/brclib/raw/master/R/download_wales.R")

# ---- Load Data ----
# load LSOA to MSOA codes lookup table
lookup_lsoa_msoa = load_lookup_lsoa_msoa_lad() %>% 
  select(LSOA11CD, MSOA11CD)

# Load MSOA names
msoa_names = read_csv("https://visual.parliament.uk/msoanames/static/MSOA-Names-v1.1.0.csv") %>% 
  select(Code = msoa11cd, Name = msoa11nm)

# Load Wales VI
vi_wales = read_csv("output/vulnerability-MSOA-Wales.csv")

# Select relevant indicators for food index
vi_food_wales <- vi_wales %>% 
  select(Code,
         Name,
         `Average private return travel time to a food shop (minutes)`,
         `Average private return travel time to a post office (minutes)`,
         `Longest distance to food bank (km)`)

# IMD
imd <- download_wales("http://open.statswales.gov.wales/en-gb/dataset/wimd1912")

# Select income deprivation score and wrangle
imd <- imd %>% 
  select(Code = MSOA_Code, Indicator = Indicator_ItemName_ENG, Data) %>% 
  filter(Indicator == "People in income deprivation (%)") %>% 
  pivot_wider(names_from = Indicator, values_from = Data)

# people living alone (from CACI)
living_alone_lsoa <- read_csv("data/CACI/living-alone-lsoa.csv")
living_alone_msoa <- read_csv("data/CACI/living-alone-msoa.csv")

# merge SOAs for Northern Ireland into the MSOA dataframe
living_alone_msoa <- living_alone_msoa %>% 
  filter(!startsWith(MSOA11CD, "N")) %>%  # no MSOAs in Northern Ireland
  bind_rows( living_alone_lsoa %>% filter(startsWith(LSOA11CD, "9")) %>% rename(MSOA11CD = LSOA11CD) ) %>% 
  rename(Code = MSOA11CD)

# get digital exclusion and access to banks from CACI data
caci_vuln_lsoa <- read_csv("data/CACI/digital-exclusion-lsoa.csv")
caci_vuln_msoa <- read_csv("data/CACI/digital-exclusion-msoa.csv")

# merge SOAs for Northern Ireland into the MSOA dataframe
caci_vuln_msoa <- caci_vuln_msoa %>% 
  filter(!startsWith(MSOA11CD, "N")) %>%  # no MSOAs in Northern Ireland
  bind_rows( caci_vuln_lsoa %>% filter(startsWith(LSOA11CD, "9")) %>% rename(MSOA11CD = LSOA11CD) ) %>% 
  select(Code = MSOA11CD, `Proportion of postcodes in 20% most digitally excluded`)

