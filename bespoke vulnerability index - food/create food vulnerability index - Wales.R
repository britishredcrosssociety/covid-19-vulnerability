# ---- Food Vulnerability Index Wales ----

# ---- Load Libraries ----
library(tidyverse)
library(sf)
library(janitor)

# ---- Source Files ----
source("functions.r")
source("load lookup tables.r")
source("https://github.com/matthewgthomas/brclib/raw/master/R/download_wales.R")

# ---- Load Data ----
# load LSOA to MSOA codes lookup table
lookup_lsoa_msoa <- load_lookup_lsoa_msoa_lad() %>% 
  select(LSOA11CD, MSOA11CD)

# Load MSOA names
msoa_names <- read_csv("https://visual.parliament.uk/msoanames/static/MSOA-Names-v1.1.0.csv") %>% 
  select(Code = msoa11cd, Name = msoa11nm)

# Load Wales VI
vi_wales <- read_csv("output/vulnerability-MSOA-Wales.csv")

# Select relevant indicators for food index
vi_food_wales <- vi_wales %>% 
  select(Code,
         Name,
         `Average private return travel time to a food shop (minutes)`,
         `Average private return travel time to a post office (minutes)`,
         `Longest distance to food bank (km)`)

# IMD
imd <- download_wales("http://open.statswales.gov.wales/en-gb/dataset/wimd1912")

# Select income deprivation score and wrangle
imd <- imd %>% 
  select(Code = MSOA_Code, Indicator = Indicator_ItemName_ENG, Data) %>% 
  filter(Indicator == "People in income deprivation (%)") %>% 
  pivot_wider(names_from = Indicator, values_from = Data)

# people living alone (from CACI)
living_alone_lsoa <- read_csv("data/CACI/living-alone-lsoa.csv")
living_alone_msoa <- read_csv("data/CACI/living-alone-msoa.csv")

# merge SOAs for Northern Ireland into the MSOA dataframe
living_alone_msoa <- living_alone_msoa %>% 
  filter(!startsWith(MSOA11CD, "N")) %>%  # no MSOAs in Northern Ireland
  bind_rows( living_alone_lsoa %>% filter(startsWith(LSOA11CD, "9")) %>% rename(MSOA11CD = LSOA11CD) ) %>% 
  rename(Code = MSOA11CD)

# get digital exclusion and access to banks from CACI data
caci_vuln_lsoa <- read_csv("data/CACI/digital-exclusion-lsoa.csv")
caci_vuln_msoa <- read_csv("data/CACI/digital-exclusion-msoa.csv")

# merge SOAs for Northern Ireland into the MSOA dataframe
caci_vuln_msoa <- caci_vuln_msoa %>% 
  filter(!startsWith(MSOA11CD, "N")) %>%  # no MSOAs in Northern Ireland
  bind_rows( caci_vuln_lsoa %>% filter(startsWith(LSOA11CD, "9")) %>% rename(MSOA11CD = LSOA11CD) ) %>% 
  select(Code = MSOA11CD, `Digital Vulnerability score`)

# ---- Calculate Overall Index ----
food_vulnerability <- vi_food_wales %>% 
  left_join(imd, by  = "Code") %>% 
  left_join(living_alone_msoa, by = "Code") %>% 
  left_join(caci_vuln_msoa, by = "Code") %>% 
  calc_domain_scores(domain = "Food")

write_csv(food_vulnerability, "bespoke vulnerability index - food/food-vulnerability-MSOA-Wales.csv")  

# ---- Check Food Vulnerability Against Other Measures ----
vi <- read_csv("output/vulnerability-MSOA-Wales.csv")
cor.test(vi$`Vulnerability score`, food_vulnerability$`Food Vulnerability score`)  # r = 0.4163537

# ---- Save as Geojson ----
msoa <- read_sf("https://opendata.arcgis.com/datasets/c661a8377e2647b0bae68c4911df868b_3.geojson") %>%
  st_transform(crs = 4326)

msoa <- msoa %>%
  filter(startsWith(msoa11cd, "W")) %>%
  left_join(food_vulnerability, by = c("msoa11cd" = "Code")) %>%
  mutate(`Food Vulnerability quintile` = calc_risk_quantiles(`Food Vulnerability rank`, quants = 5))

geo_file <- "bespoke vulnerability index - food/food-vulnerability-MSOA-Wales.geojson"
if (file.exists(geo_file)) file.remove(geo_file)

msoa %>%
  select(Code = msoa11cd, Name, everything(), -objectid, -msoa11nm, -msoa11nmw, -st_areashape, -st_lengthshape) %>%
  write_sf(geo_file)

# ---- Aggregate into Local Authorities ----
# MSOA to LA codes for England, Wales and Scotland
msoa_lad <- load_lookup_lsoa_msoa_lad() %>% 
  select(MSOA11CD, LAD17CD) %>% 
  distinct()

lad_17_19 <- read_csv("data/LAD 2017 to LAD 2019 codes.csv")  # lookup of Local Authority codes from 2017 to 2019

# get 2019 LA codes
msoa_lad <- msoa_lad %>% 
  left_join(lad_17_19, by = "LAD17CD")

# aggregate into LAs
food_LA <- food_vulnerability %>% 
  left_join(msoa_lad, by = c("Code" = "MSOA11CD")) %>% 
  
  mutate(Top20 = ifelse(`Food Vulnerability decile` >= 9, "Top20", "Other")) %>% 
  tabyl(LAD19CD, Top20) %>% 
  
  # calculate proportion of most deprived LSOAs
  mutate(`Proportion of neighbourhoods in 20% most food vulnerable` = Top20 / (Top20 + Other)) %>% 
  select(-Other, -Top20) %>% 
  na.omit()

write_csv(food_LA, "bespoke vulnerability index - food/food-vulnerability-LA-Wales.csv")

# Local Authority Districts (December 2019) Boundaries UK BUC
# source: https://geoportal.statistics.gov.uk/datasets/local-authority-districts-december-2019-boundaries-uk-buc
lads <- read_sf("https://opendata.arcgis.com/datasets/3a4fa2ce68f642e399b4de07643eeed3_0.geojson")

geo_file <- "bespoke vulnerability index - food/food-vulnerability-LA-Wales.geojson"
if (file.exists(geo_file)) file.remove(geo_file)

lads %>%
  filter(startsWith(lad19cd, "W")) %>% 
  left_join(food_LA, by = c("lad19cd" = "LAD19CD")) %>%
  select(Code = lad19cd, Name = lad19nm, everything(), -objectid, -lad19nmw, -st_area.shape., -st_length.shape., -bng_e, -bng_n, -long, -lat) %>%
  write_sf(geo_file)
