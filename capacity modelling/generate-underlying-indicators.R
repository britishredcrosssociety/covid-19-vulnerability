# ---- Load libraries and helpers ----
library(tidyverse)
source("functions.r")

# ---- Load data -----
loneliness_e <- read_csv("https://github.com/matthewgthomas/loneliness/raw/master/England/msoa_loneliness.csv") %>% 
  select(msoa_code = msoa11cd,
         loneliness_score = loneills_2018)
  
loneliness_w <- read_csv("https://github.com/matthewgthomas/loneliness/raw/master/Wales/msoa_loneliness.csv") %>% 
  select(msoa_code = msoa11cd,
         loneliness_score = loneills_2018)
  
loneliness_s <- read_csv("https://github.com/matthewgthomas/loneliness/raw/master/Scotland/msoa_loneliness.csv") %>% 
  select(msoa_code = InterZone,
         loneliness_score = loneills_2018)

loneliness_ni <- read_csv("https://github.com/matthewgthomas/loneliness/raw/master/NI/msoa_loneliness.csv") %>% 
  select(msoa_code = SOA_CODE,
         loneliness_score = loneills_2018)

digital_e_w_s <- read_csv("data/CACI/digital-exclusion-msoa.csv") %>% 
  select(msoa_code = MSOA11CD,
         digital_score = `Digital Vulnerability score`)

digital_ni <- read_csv("data/CACI/digital-exclusion-lsoa.csv") %>% 
  filter(str_detect(LSOA11CD, "^9")) %>% 
  select(msoa_code = LSOA11CD,
         digital_score = `Digital Vulnerability score`)

frailty <- read_csv("data/frailty-MSOA-England.csv") %>% 
  select(msoa_code = MSOA11CD,
         frailty_rank = `Frailty rank`)

# ---- Combine loneliness and digital data ----
loneliness <- bind_rows(loneliness_e,
                        loneliness_w,
                        loneliness_s,
                        loneliness_ni)

digital <- bind_rows(digital_e_w_s,
                     digital_ni)

d_l <- digital %>% 
  left_join(loneliness, by = "msoa_code")

# ---- Compute ranks and quintiles ----
d_l <- d_l %>% 
  mutate(digital_rank = rank(digital_score),
         loneliness_rank = rank(loneliness_score)) %>% 
  select(-ends_with("score"))

d_l <- d_l %>% 
  mutate(digital_quintiles = calc_risk_quantiles(digital_rank),
         loneliness_quintiles = calc_risk_quantiles(loneliness_rank)) %>% 
  select(-ends_with("rank"))

frailty <- frailty %>% 
  mutate(frailty_quintiles = calc_risk_quantiles(frailty_rank)) %>% 
  select(-ends_with("rank"))

# ---- Combine indicators ----
indicators <- d_l %>% 
  left_join(frailty, by = "msoa_code")

# ---- Save output ----
write_csv(indicators, "output/capacity-modelling-indicators.csv")
