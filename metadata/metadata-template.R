# ---- Load libraries ----
library(tidyverse)
library(glue)

# ---- Overall MSOA Indicators ----
# - Load indicators -
msoa_e <- tibble(indicator = colnames(read_csv("output/vulnerability-MSOA-England.csv")),
                 country = "England",
                 geography = "MSOA",
                 date = NA,
                 source = NA,
                 domain = NA,
                 last_update = as.Date(file.info("output/vulnerability-MSOA-England.csv")$mtime))

msoa_w <- tibble(indicator = colnames(read_csv("output/vulnerability-MSOA-Wales.csv")),
                 country = "Wales",
                 geography = "MSOA",
                 date = NA,
                 source = NA,
                 domain = NA,
                 last_update = as.Date(file.info("output/vulnerability-MSOA-Wales.csv")$mtime))
  
msoa_s <- tibble(indicator = colnames(read_csv("output/vulnerability-MSOA-Scotland.csv")),
                 country = "Scotland",
                 geography = "MSOA",
                 date = NA,
                 source = NA,
                 domain = NA,
                 last_update = as.Date(file.info("output/vulnerability-MSOA-Scotland.csv")$mtime))
  
msoa_ni <- tibble(indicator = colnames(read_csv("output/vulnerability-SOA-NI.csv")),
                  country = "Northern Ireland",
                  geography = "SOA",
                  date = NA,
                  source = NA,
                  domain = NA,
                  last_update = as.Date(file.info("output/vulnerability-SOA-NI.csv")$mtime))

# Assign msoa domains fun
assign_msoa_domains <- function(.data){
  .data %>% 
    mutate(domain = case_when(
      row_number() %in% ((which(.data$indicator == "Name") + 1) : (which(.data$indicator == "Clinical Vulnerability decile"))) ~ "Clinical",
      row_number() %in% ((which(.data$indicator == "Clinical Vulnerability decile") + 1) : (which(.data$indicator == "Health/Wellbeing Vulnerability decile"))) ~ "Health/Wellbeing",
      row_number() %in% ((which(.data$indicator == "Health/Wellbeing Vulnerability decile") + 1) : (which(.data$indicator == "Economic Vulnerability decile"))) ~ "Economic",
      row_number() %in% ((which(.data$indicator == "Economic Vulnerability decile") + 1) : (which(.data$indicator == "Social Vulnerability decile"))) ~ "Social",
      row_number() %in% ((which(.data$indicator == "Social Vulnerability decile") + 1) : (which(.data$indicator == "Socioeconomic Vulnerability decile"))) ~ "Socioeconomic",
      TRUE ~ "All"))
}

# Apply msoa domains fun to nations
all_msoa <- map_dfr(list(msoa_e, msoa_w, msoa_s, msoa_ni), assign_msoa_domains)

# Remove rows where indicators are the same and merge countries and geographies
all_msoa <- all_msoa %>% 
  group_by(indicator, date, source, domain, last_update) %>%
  summarise(country = str_c(country, collapse = ", "),
            geography = str_c(geography, collapse = ", ")) %>% 
  ungroup()

# Write to disk, being careful to not overwrite an existing file with the sources column complete
if(file.exists("output/metadata_vi_overall.csv")) {
  write_csv(all_msoa, "output/metadata_vi_template.csv")
} else{
  write_csv(all_msoa, "output/metadata_vi.csv")
}

# ---- Bespoke Food Indicators ----
food_e <- tibble(indicator = colnames(read_csv("bespoke vulnerability index - food/food-vulnerability-MSOA-England.csv")),
                 country = "England",
                 geography = "MSOA",
                 date = NA,
                 source = NA,
                 domain = NA,
                 last_update = as.Date(file.info("bespoke vulnerability index - food/food-vulnerability-MSOA-England.csv")$mtime))

food_w <- tibble(indicator = colnames(read_csv("bespoke vulnerability index - food/food-vulnerability-MSOA-Wales.csv")),
                 country = "Wales",
                 geography = "MSOA",
                 date = NA,
                 source = NA,
                 domain = NA,
                 last_update = as.Date(file.info("bespoke vulnerability index - food/food-vulnerability-MSOA-Wales.csv")$mtime))

food_s <- tibble(indicator = colnames(read_csv("bespoke vulnerability index - food/food-vulnerability-MSOA-Scotland.csv")),
                 country = "Scotland",
                 geography = "MSOA",
                 date = NA,
                 source = NA,
                 domain = NA,
                 last_update = as.Date(file.info("bespoke vulnerability index - food/food-vulnerability-MSOA-Scotland.csv")$mtime))

food_ni <- tibble(indicator = colnames(read_csv("bespoke vulnerability index - food/food-vulnerability-SOA-NI.csv")),
                  country = "Northern Ireland",
                  geography = "SOA",
                  date = NA,
                  source = NA,
                  domain = NA,
                  last_update = as.Date(file.info("bespoke vulnerability index - food/food-vulnerability-SOA-NI.csv")$mtime))

food <- bind_rows(food_e,
                  food_w,
                  food_s,
                  food_ni)

# Remove rows where indicators are the same and merge countries and geographies
food <- food %>% 
  group_by(indicator, date, source, domain, last_update) %>%
  summarise(country = str_c(country, collapse = ", "),
            geography = str_c(geography, collapse = ", ")) %>% 
  ungroup()

# Write to disk, being careful to not overwrite an existing file with the sources column complete
if(file.exists("output/metadata_food.csv")) {
  write_csv(food, "output/metadata_food_template.csv")
} else{
  write_csv(food, "output/metadata_food.csv")
}

# ---- Bespoke Hardship Fund Indicators ----
hardship_e <- tibble(indicator = colnames(read_csv("bespoke vulnerability index - hardship fund/hardship-vulnerability-MSOA-England.csv")),
                     country = "England",
                     geography = "MSOA",
                     date = NA,
                     source = NA,
                     domain = NA,
                     last_update = as.Date(file.info("bespoke vulnerability index - hardship fund/hardship-vulnerability-MSOA-England.csv")$mtime))

hardship_w <- tibble(indicator = colnames(read_csv("bespoke vulnerability index - hardship fund/hardship-vulnerability-MSOA-Wales.csv")),
                     country = "Wales",
                     geography = "MSOA",
                     date = NA,
                     source = NA,
                     domain = NA,
                     last_update = as.Date(file.info("bespoke vulnerability index - hardship fund/hardship-vulnerability-MSOA-Wales.csv")$mtime))

hardship_s <- tibble(indicator = colnames(read_csv("bespoke vulnerability index - hardship fund/hardship-vulnerability-MSOA-Scotland.csv")),
                     country = "Scotland",
                     geography = "MSOA",
                     date = NA,
                     source = NA,
                     domain = NA,
                     last_update = as.Date(file.info("bespoke vulnerability index - hardship fund/hardship-vulnerability-MSOA-Scotland.csv")$mtime))
 
hardship_ni <- tibble(indicator = colnames(read_csv("bespoke vulnerability index - hardship fund/hardship-vulnerability-MSOA-NI.csv")),
                      country = "Northern Ireland",
                      geography = "SOA",
                      date = NA,
                      source = NA,
                      domain = NA,
                      last_update = as.Date(file.info("bespoke vulnerability index - hardship fund/hardship-vulnerability-MSOA-NI.csv")$mtime))

hardship <- bind_rows(hardship_e,
                      hardship_w,
                      hardship_s,
                      hardship_ni)

# Remove rows where indicators are the same and merge countries and geographies
hardship <- hardship %>% 
  group_by(indicator, date, source, domain, last_update) %>%
  summarise(country = str_c(country, collapse = ", "),
            geography = str_c(geography, collapse = ", ")) %>% 
  ungroup()

# Write to disk, being careful to not overwrite an existing file with the sources column complete
if(file.exists("output/metadata_hardship.csv")) {
  write_csv(hardship, "output/metadata_hardship_template.csv")
} else{
  write_csv(hardship, "output/metadata_hardship.csv")
}
