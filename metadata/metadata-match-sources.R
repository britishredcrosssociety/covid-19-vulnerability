# ---- Load libraries ----
library(tidyverse)

# ---- Load data ----
vi <- read_csv("output/metadata_vi.csv")
food <- read_csv("output/metadata_food.csv")
hs <- read_csv("output/metadata_hardship.csv")

vi_template <- read_csv("output/metadata_vi_template.csv")
food_template <- read_csv("output/metadata_food_template.csv")
hs_template <- read_csv("output/metadata_hardship_template.csv")

# ---- Merge old indicators ----
vi_merged <- left_join(vi_template, vi, by = "indicator") %>% 
  mutate(date.x = if_else(!is.na(date.y), date.y, NA_character_),
         source.x = if_else(!is.na(source.y), source.y, NA_character_)) %>% 
  select(-ends_with(".y")) %>% 
  rename(date = date.x,
         source = source.x,
         domain = domain.x,
         last_update = last_update.x,
         country = country.x,
         geography = geography.x)

food_merged <- left_join(food_template, food, by = "indicator") %>% 
  mutate(date.x = if_else(!is.na(date.y), date.y, NA_character_),
         source.x = if_else(!is.na(source.y), source.y, NA_character_)) %>% 
  select(-ends_with(".y")) %>% 
  rename(date = date.x,
         source = source.x,
         domain = domain.x,
         last_update = last_update.x,
         country = country.x,
         geography = geography.x)

hs_merged <- left_join(hs_template, (hs %>% mutate(date = as.character(date))), by = "indicator") %>% 
  mutate(date.x = if_else(!is.na(date.y), date.y, NA_character_),
         source.x = if_else(!is.na(source.y), source.y, NA_character_)) %>% 
  select(-ends_with(".y")) %>% 
  rename(date = date.x,
         source = source.x,
         domain = domain.x,
         last_update = last_update.x,
         country = country.x,
         geography = geography.x)

# ---- Overwrite metadata template files ----
# This code block will need un-commenting
# This is to prevent files accidentally being overwritten

# write_csv(vi_merged, "output/metadata_vi.csv")
# write_csv(food_merged, "output/metadata_food.csv")
# write_csv(hs_merged, "output/metadata_hardship.csv")