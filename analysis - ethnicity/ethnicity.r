##
## Ethnicity and Vulnerability and Deprivation
## - using LA-level data from the Annual Population Survey
## - and LSOA-level ethnicity data from the Census summed up into MSOAs
##
library(tidyverse)
library(nomisr)
library(readxl)
library(httr)
library(Hmisc)

source("functions.r")
source("load lookup tables.r")

lsoa_msoa = load_lookup_lsoa_msoa_lad() %>% 
  select(LSOA11CD, MSOA11CD)

##
## Load LA-level data from the Annual Population Survey:
## - Percentage of population who are {white or ethnic minority} and {UK born or not}
## - Percentage of working-age population who are {white or ethnic minority} and {UK born or not}
## - Unemployment rate: {white or ethnic minority} and {UK born or not}
## - Economic inactivity rate: {white or ethnic minority} and {UK born or not}
##
## Based on this URL: https://www.nomisweb.co.uk/api/v01/dataset/NM_17_5.jsonstat.json?geography=1811939329...1811939332,1811939334...1811939336,1811939338...1811939497,1811939499...1811939501,1811939503,1811939505...1811939507,1811939509...1811939517,1811939519,1811939520,1811939524...1811939570,1811939575...1811939599,1811939601...1811939628,1811939630...1811939634,1811939636...1811939647,1811939649,1811939655...1811939664,1811939667...1811939680,1811939682,1811939683,1811939685,1811939687...1811939704,1811939707,1811939708,1811939710,1811939712...1811939717,1811939719,1811939720,1811939722...1811939730,943718401...943718419,943718421...943718463,943718465...943718497,943718499...943718512,943718420,943718464,943718498&date=latest&variable=861...868,873...880&measures=20599,21001,21002,21003
##
aps_raw = nomis_get_data(
  id = "NM_17_5",
  date = "latest",
  geography = "TYPE432",  # 2019 LAD
  variable = "861...868,873...880",
  measures = "20599,21001,21002,21003",
  
  # variables to keep
  select = c(
    "GEOGRAPHY_CODE",
    "VARIABLE_NAME",
    "MEASURES_NAME",
    "OBS_VALUE"
  )
)

aps = aps_raw %>% 
  filter(MEASURES_NAME == "Variable") %>% 
  #pivot_wider(names_from = "VARIABLE_NAME", values_from = "OBS_VALUE") %>% 
  #select(Code = GEOGRAPHY_CODE, everything(), -MEASURES_NAME)
  select(Code = GEOGRAPHY_CODE, Variable = VARIABLE_NAME, Value = OBS_VALUE)


##
## Census ethnicity data from table KS201EW: Ethnic Group
## https://www.nomisweb.co.uk/census/2011/ks201ew
##
# Nomis API URL: https://www.nomisweb.co.uk/api/v01/dataset/NM_608_1.jsonstat.json?date=latest&geography=&rural_urban=0,100,101&cell=0,100,1...4,200,5...8,300,9...13,400,14...16,500,17,18&measures=20301
census_raw = nomis_get_data(
  id = "NM_608_1",
  date = "latest",
  geography = "TYPE297",  # MSOA

  rural_urban = "0,100,101",  # total urban and total rural, plus overall total
  cell = "0,100,1...4,200,5...8,300,9...13,400,14...16,500,17,18",  # all ethnic group categories
  
  # measures = "20301",  # percentages
  measure = "20100",   # values
  
  
  # variables to keep
  select = c(
    "GEOGRAPHY_CODE",
    "MEASURES_NAME",
    "RURAL_URBAN_NAME",
    "CELL_NAME",
    "OBS_VALUE"
  )
)

unique(census_raw$CELL_NAME)

census = census_raw %>% 
  filter(RURAL_URBAN_NAME == "Total") %>% 
  select(Code = GEOGRAPHY_CODE, Ethnicity = CELL_NAME, Value = OBS_VALUE) %>% 
  filter(Ethnicity %in% c("White", "Asian/Asian British", "Black/African/Caribbean/Black British", "Mixed/multiple ethnic groups", "Other ethnic group"))

census_detailed = census_raw %>% 
  filter(RURAL_URBAN_NAME == "Total") %>% 
  select(Code = GEOGRAPHY_CODE, Ethnicity = CELL_NAME, Value = OBS_VALUE) %>% 
  filter(!Ethnicity %in% c("All usual residents", "White", "Asian/Asian British", "Black/African/Caribbean/Black British", "Mixed/multiple ethnic groups", "Other ethnic group"))


##
## Load Vulnerability Index
##
vi_lad = read_csv("output/vulnerability-LA.csv")

vi_msoa_vi = read_csv("output/vulnerability-MSOA-England.csv")
vi_msoa_food = read_csv("bespoke vulnerability index - food/food-vulnerability-MSOA-England.csv")
vi_msoa_fund = read_csv("bespoke vulnerability index - hardship fund/hardship-vulnerability-MSOA-England.csv")

# combine all VI domain deciles
vi_msoa = vi_msoa_vi %>% 
  select(Code, ends_with("decile")) %>% 
  left_join(vi_msoa_food %>% select(Code, ends_with("decile")), by = "Code") %>% 
  left_join(vi_msoa_fund %>% select(Code, ends_with("decile")), by = "Code") 

# invert deciles so 1 = most vulnerable (matching IMD's approach)
reverse_decile = function(x) 11 - x

vi_lad = vi_lad %>% 
  mutate_at(vars(ends_with("decile")), reverse_decile)

vi_msoa = vi_msoa %>% 
  mutate_at(vars(ends_with("decile")), reverse_decile)


##
## Load LA-level deprivation scores
## - from: https://www.gov.uk/government/statistics/english-indices-of-deprivation-2019
## - source: File 10: local authority district summaries
##
## We'll use two summary measures of deprivation in LAs: extent and proportion of Lower-layer Super Output Areas in most deprived 10% nationally
## - extent =  the proportion of the local population that live in areas classified as among the most deprived in the country
## 
## (see Table 3.2 in the IMD technical report for more details: https://assets.publishing.service.gov.uk/government/uploads/system/uploads/attachment_data/file/833951/IoD2019_Technical_Report.pdf)
##
GET("https://assets.publishing.service.gov.uk/government/uploads/system/uploads/attachment_data/file/833995/File_10_-_IoD2019_Local_Authority_District_Summaries__lower-tier__.xlsx",
    write_disk(tf_imd <- tempfile(fileext = ".xlsx")))

imd_lad = read_excel(tf_imd, sheet = "IMD") %>% 
  select(Code = `Local Authority District code (2019)`, 
         Proportion = `IMD - Proportion of LSOAs in most deprived 10% nationally`, Proportion_rank = `IMD - Rank of proportion of LSOAs in most deprived 10% nationally`, 
         Extent = `IMD 2019 - Extent`, Extent_rank = `IMD 2019 - Rank of extent`) %>% 
  
  # calculate deciles
  mutate(Proportion_decile = calc_risk_quantiles(Proportion_rank, quants = 10),
         Extent_decile = calc_risk_quantiles(Extent_rank, quants = 10))


##
## Calculate IMD scores for MSOAs
##
# File 5: scores for the indices of deprivation
GET("https://assets.publishing.service.gov.uk/government/uploads/system/uploads/attachment_data/file/833978/File_5_-_IoD2019_Scores.xlsx",
    write_disk(tf_scores <- tempfile(fileext = ".xlsx")))

# File 6: population denominators
GET("https://assets.publishing.service.gov.uk/government/uploads/system/uploads/attachment_data/file/833980/File_6_-_IoD2019_Population_Denominators.xlsx",
    write_disk(tf_pop <- tempfile(fileext = ".xlsx")))

imd_scores = read_excel(tf_scores, sheet = "IoD2019 Scores")
imd_pop = read_excel(tf_pop, sheet = "Population Denominators")

# merge scores and population denominators
imd_msoa = imd_scores %>% 
  select(LSOA11CD = `LSOA code (2011)`, 
         IMD_Score = `Index of Multiple Deprivation (IMD) Score`, 
         Income_Score = `Income Score (rate)`, 
         Employment_Score = `Employment Score (rate)`,
         Health_Score = `Health Deprivation and Disability Score`,
         Barriers_Score = `Barriers to Housing and Services Score`) %>% 
  
  left_join(imd_pop %>% select(LSOA11CD = `LSOA code (2011)`, Pop = `Total population: mid 2015 (excluding prisoners)`),
            by = "LSOA11CD") %>% 
  
  left_join(lsoa_msoa, by = "LSOA11CD")

# calculate total population per MSOA
imd_pop_msoa = imd_msoa %>% 
  group_by(MSOA11CD) %>% 
  summarise(Pop_Total = sum(Pop))

# calculate average scores in each MSOA
imd_score_msoa = imd_msoa %>% 
  mutate(IMD_Score = IMD_Score * Pop,
         Income_Score = Income_Score * Pop,
         Employment_Score = Employment_Score * Pop,
         Health_Score = Health_Score * Pop,
         Barriers_Score = Barriers_Score * Pop) %>% 
  
  group_by(MSOA11CD) %>% 
  summarise(Score_Total = sum(IMD_Score),
            Income_Score = sum(Income_Score),
            Employment_Score = sum(Employment_Score),
            Health_Score = sum(Health_Score),
            Barriers_Score = sum(Barriers_Score))

n_msoa = nrow(imd_msoa)

# calculate average score for each MSOA
imd_msoa = imd_score_msoa %>% 
  left_join(imd_pop_msoa, by = "MSOA11CD") %>% 
  mutate(IMD_Score = Score_Total / Pop_Total,
         Income_Score = Income_Score / Pop_Total,
         Employment_Score = Employment_Score / Pop_Total,
         Health_Score = Health_Score / Pop_Total,
         Barriers_Score = Barriers_Score / Pop_Total) %>% 
  
  # calculate ranks and deciles
  mutate(IMD_Rank = rank(IMD_Score),
         IMD_Decile = 11 - as.integer(cut2(IMD_Score, g = 10)),
         Income_Decile = 11 - as.integer(cut2(Income_Score, g = 10)),
         Employment_Decile = 11 - as.integer(cut2(Employment_Score, g = 10)),
         Health_Decile = 11 - as.integer(cut2(Health_Score, g = 10)),
         Barriers_Decile = 11 - as.integer(cut2(Barriers_Score, g = 10)))


###############################################################################
## Local Authorities
##

# merge ethnicity data from APS with VI and IMD
aps_vi_imd = aps %>% 
  left_join(vi_lad, by = "Code") %>% 
  left_join(imd_lad, by = "Code")

plot_ethnicity_aps = function(d, var) {
  d_sum = d %>% 
    group_by((!!sym(var)), (!!sym("Variable"))) %>% 
    
    summarise(Value_mean = mean(Value, na.rm = TRUE),
              Value_median = median(Value, na.rm = TRUE),
              Value_sd = sd(Value, na.rm = TRUE),
              Value_sum = sum(Value, na.rm = TRUE)) %>% 
    
    mutate(Value_prop = Value_mean / 100,
           Value_prop_sd = Value_sd / 100)
  
  d_sum %>% 
    filter(!is.na((!!sym(var)))) %>% 
    mutate(X = factor((!!sym(var)), levels = 1:10)) %>% 
    
    ggplot(aes(x = X, y = Value_prop)) +
    geom_col() +
    geom_errorbar(aes(ymin = Value_prop, ymax = Value_prop + Value_prop_sd), 
                  size = 0.5, width = 0.25, position = position_dodge(.9)) +
    
    facet_wrap(~ Variable, scales = "free_y") +
    scale_y_continuous(labels = scales::percent) +
    theme_classic() +
    labs(x = var, y = "Proportion of people within ethnic groups")
}


##
## APS and VI
##
aps_vi_imd %>% plot_ethnicity_aps("Vulnerability decile")
aps_vi_imd %>% plot_ethnicity_aps("Clinical Vulnerability decile") + labs(x = "Clinical")
aps_vi_imd %>% plot_ethnicity_aps("Health/Wellbeing Vulnerability decile")
aps_vi_imd %>% plot_ethnicity_aps("Economic Vulnerability decile")
aps_vi_imd %>% plot_ethnicity_aps("Social Vulnerability decile")

##
## APS and IMD
##
aps_vi_imd %>% plot_ethnicity_aps("Proportion_decile")
aps_vi_imd %>% plot_ethnicity_aps("Extent_decile")


###############################################################################
## MSOAs
##

# merge census, IMD and VI data
census_vi_imd = census %>% 
  filter(startsWith(Code, "E")) %>% 
  left_join(vi_msoa, by = "Code") %>% 
  left_join(imd_msoa, by = c("Code" = "MSOA11CD"))


#' Plot proportions of people in each ethnic group against Vulnerability/Deprivation deciles
#' 
#' @param d Dataframe containing rows for ethnic groups and vulnerability/deprivation deciles
#' @param var Which decile to plot on a graph (string)
#' 
plot_ethnicity = function(d, var) {
  d_sum = d %>% 
    group_by((!!sym(var)), (!!sym("Ethnicity"))) %>% 
    # group_by(`Economic Vulnerability decile`, Ethnicity) %>% 
    
    summarise(Value_mean = mean(Value, na.rm = TRUE),
              Value_median = median(Value, na.rm = TRUE),
              Value_sd = sd(Value, na.rm = TRUE),
              Value_sum = sum(Value, na.rm = TRUE))
  
  d_n = d %>% 
    # group_by((!!sym(var))) %>% 
    group_by(Ethnicity) %>% 
    summarise(Value_total = sum(Value, na.rm = TRUE))
  
  # n_people = sum(d$Value, na.rm = TRUE)
  
  d_sum = d_sum %>% 
    left_join(d_n, by = "Ethnicity") %>% 
    mutate(Value_prop = Value_sum / Value_total)
  
  d_sum %>% 
    filter(!is.na((!!sym(var)))) %>% 
    mutate(X = factor((!!sym(var)), levels = 1:10)) %>% 
    
    ggplot(aes(x = X, y = Value_prop)) +
    geom_col() +

    facet_wrap(~ Ethnicity, scales = "free_y") +
    scale_y_continuous(labels = scales::percent) +
    theme_classic() +
    labs(x = var, y = "Proportion of people within ethnic groups")
}


##
## census and VI
##
census_vi_imd %>% plot_ethnicity("Vulnerability decile") + labs(x = "Overall Vulnerability decile")
census_vi_imd %>% plot_ethnicity("Clinical Vulnerability decile")
census_vi_imd %>% plot_ethnicity("Health/Wellbeing Vulnerability decile")
census_vi_imd %>% plot_ethnicity("Economic Vulnerability decile")
census_vi_imd %>% plot_ethnicity("Social Vulnerability decile")

census_vi_imd %>% plot_ethnicity("Food Vulnerability decile")
census_vi_imd %>% plot_ethnicity("Hardship Fund Vulnerability decile")

##
## Census and IMD
##
census_vi_imd %>% plot_ethnicity("IMD_Decile") + labs(x = "Overall Deprivation decile")
census_vi_imd %>% plot_ethnicity("Income_Decile") + labs(x = "Income Deprivation decile")
census_vi_imd %>% plot_ethnicity("Employment_Decile") + labs(x = "Employment Deprivation decile")
census_vi_imd %>% plot_ethnicity("Health_Decile") + labs(x = "Health Deprivation decile")
census_vi_imd %>% plot_ethnicity("Barriers_Decile") + labs(x = "Barriers to Housing and Services decile")


###############################################################################
## Breakdown of ethnic groups in the 20% most vulnerable areas
##

# total number of people, for calculating percentages within the most vulnerable areas
# n_people = sum(census_detailed$Value)

census_uk = census_detailed %>% 
  group_by(Ethnicity) %>% 
  summarise(Prop = sum(Value) / sum(census_detailed$Value))

##
## use either one of these next two code chunk in the plotting code chunk
##
# social vulnerability
# most_vuln = census_detailed %>% 
#   filter(startsWith(Code, "E")) %>% 
#   left_join(vi_msoa, by = "Code") %>% 
#   
#   filter(`Social Vulnerability decile` <= 2)

# socioeconomic vulnerability
most_vuln = census_detailed %>% 
  filter(startsWith(Code, "E")) %>% 
  left_join(vi_msoa, by = "Code") %>% 
  
  filter(`Socioeconomic Vulnerability decile` <= 2)

# total number of people, for calculating percentages within the most vulnerable areas
n_people = sum(most_vuln$Value)

##
## plot social/economic vulnerability
##
# calculate percentage of people (as proportion of all people in ENgland) in the most vulnerable area
most_vuln %>% 
  group_by(Ethnicity) %>% 
  summarise(Prop = sum(Value) / n_people) %>% 
  
  mutate(Group = str_extract(unique(Ethnicity), ".*:")) %>%  # extract ethnicty group categories (for shading bars in the graph)
  
  ggplot(aes(x = Ethnicity, y = Prop)) +
  geom_col(aes(fill = Group), alpha = 0.75, show.legend = FALSE) +
  
  geom_point(data = census_uk, size = 1.5) +
  
  scale_y_continuous(labels = scales::percent) +
  scale_fill_brewer(palette = "Set1") +
  coord_flip() +
  
  theme_classic() +
  labs(y = "Percentage of people living in the most vulnerable 20% of neighbourhoods", x = NULL)

ggsave("analysis - ethnicity/ethnic breakdown in socioeconomically vulnerable areas.png", 
       width = 250, height = 150, units = "mm")


###############################################################################
## Map of most vulnerable areas
##
soc_vuln_all = census_vi_imd %>% 
  filter(`Social Vulnerability decile` <= 2 | `Economic Vulnerability decile` <= 2) %>% 
  
  mutate(Ethnicity = ifelse(Ethnicity == "White", "White", "Not")) %>% 
  group_by(Code, Ethnicity) %>% 
  summarise(Value = sum(Value)) %>% 
  ungroup() %>% 
  
  pivot_wider(names_from = Ethnicity, values_from = Value) %>% 
  mutate(Prop_Not_White = Not / (White + Not)) %>% 
  
  mutate(Ethnicity_Quintile = as.integer(cut2(Prop_Not_White, g = 5)))

soc_vuln = soc_vuln_all %>% 
  filter(Ethnicity_Quintile == 5)
  

# Middle Layer Super Output Areas (December 2011) Boundaries EW BSC
# source: https://geoportal.statistics.gov.uk/datasets/middle-layer-super-output-areas-december-2011-boundaries-ew-bsc
msoa = read_sf("https://opendata.arcgis.com/datasets/c661a8377e2647b0bae68c4911df868b_3.geojson") %>%
  st_transform(crs = 27700)

msoa_vuln = msoa %>%
  left_join(soc_vuln, by = c("msoa11cd" = "Code")) %>%
  filter(!is.na(Ethnicity_Quintile))

# plot(msoa_vuln$geometry)

write_sf(msoa_vuln, "analysis - ethnicity/MSOAs with high vulnerability and BAME populations.geojson")

msoa_names = read_csv("https://visual.parliament.uk/msoanames/static/MSOA-Names-v1.1.0.csv") %>% 
  select(Code = msoa11cd, Name = msoa11nm)

soc_vuln = soc_vuln %>% left_join(msoa_names, by = "Code")

soc_vuln %>% 
  # select(Name, `Proportion of population who are non-white` = Prop_Not_White) %>% 
  mutate(Name = str_trim(str_extract(Name, "[A-Za-z\\s]+"))) %>% 
  select(Name) %>% 
  distinct() %>% 
  write_csv("analysis - ethnicity/List of MSOAs with high vulnerability and BAME populations.csv")

soc_vuln %>% 
  left_join(vi_msoa_vi %>% select(Code, `Social Vulnerability rank`, `Economic Vulnerability rank`),
            by = "Code") %>% 
  arrange(`Social Vulnerability rank`) %>% 
  arrange(`Economic Vulnerability rank`)
