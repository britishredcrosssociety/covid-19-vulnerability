##
## Ethnicity and Vulnerability
## - using LA-level data from the Annual Population Survey
## - and LSOA-level ethnicity data from the Census
##
library(tidyverse)
library(nomisr)
library(readxl)
library(httr)
library(Hmisc)

source("functions.r")
source("load lookup tables.r")

lsoa_msoa = load_lookup_lsoa_msoa_lad() %>% 
  select(LSOA11CD, MSOA11CD)

##
## Load LA-level data from the Annual Population Survey:
## - Percentage of population who are {white or ethnic minority} and {UK born or not}
## - Percentage of working-age population who are {white or ethnic minority} and {UK born or not}
## - Unemployment rate: {white or ethnic minority} and {UK born or not}
## - Economic inactivity rate: {white or ethnic minority} and {UK born or not}
##
## Based on this URL: https://www.nomisweb.co.uk/api/v01/dataset/NM_17_5.jsonstat.json?geography=1811939329...1811939332,1811939334...1811939336,1811939338...1811939497,1811939499...1811939501,1811939503,1811939505...1811939507,1811939509...1811939517,1811939519,1811939520,1811939524...1811939570,1811939575...1811939599,1811939601...1811939628,1811939630...1811939634,1811939636...1811939647,1811939649,1811939655...1811939664,1811939667...1811939680,1811939682,1811939683,1811939685,1811939687...1811939704,1811939707,1811939708,1811939710,1811939712...1811939717,1811939719,1811939720,1811939722...1811939730,943718401...943718419,943718421...943718463,943718465...943718497,943718499...943718512,943718420,943718464,943718498&date=latest&variable=861...868,873...880&measures=20599,21001,21002,21003
##
aps_raw = nomis_get_data(
  id = "NM_17_5",
  date = "latest",
  geography = "TYPE432",  # 2019 LAD
  variable = "861...868,873...880",
  measures = "20599,21001,21002,21003",
  
  # variables to keep
  select = c(
    "GEOGRAPHY_CODE",
    "VARIABLE_NAME",
    "MEASURES_NAME",
    "OBS_VALUE"
  )
)

aps = aps_raw %>% 
  filter(MEASURES_NAME == "Variable") %>% 
  #pivot_wider(names_from = "VARIABLE_NAME", values_from = "OBS_VALUE") %>% 
  #select(Code = GEOGRAPHY_CODE, everything(), -MEASURES_NAME)
  select(Code = GEOGRAPHY_CODE, Variable = VARIABLE_NAME, Value = OBS_VALUE)


##
## Census ethnicity data from table KS201EW: Ethnic Group
## https://www.nomisweb.co.uk/census/2011/ks201ew
##
# Nomis API URL: https://www.nomisweb.co.uk/api/v01/dataset/NM_608_1.jsonstat.json?date=latest&geography=&rural_urban=0,100,101&cell=0,100,1...4,200,5...8,300,9...13,400,14...16,500,17,18&measures=20301
census_raw = nomis_get_data(
  id = "NM_608_1",
  date = "latest",
  geography = "TYPE297",  # MSOA

  rural_urban = "0,100,101",  # total urban and total rural, plus overall total
  cell = "0,100,1...4,200,5...8,300,9...13,400,14...16,500,17,18",  # all ethnic group categories
  
  # measures = "20301",  # percentages
  measure = "20100",   # values
  
  
  # variables to keep
  select = c(
    "GEOGRAPHY_CODE",
    "MEASURES_NAME",
    "RURAL_URBAN_NAME",
    "CELL_NAME",
    "OBS_VALUE"
  )
)

census = census_raw %>% 
  filter(RURAL_URBAN_NAME == "Total") %>% 
  select(Code = GEOGRAPHY_CODE, Ethnicity = CELL_NAME, Value = OBS_VALUE) %>% 
  filter(Ethnicity %in% c("White", "Asian/Asian British", "Black/African/Caribbean/Black British", "Mixed/multiple ethnic groups", "Other ethnic group"))


##
## Load Vulnerability Index
##
vi = read_csv("output/vulnerability-LA.csv")
vi_msoa = read_csv("output/vulnerability-MSOA-UK.csv")


##
## Load LA-level deprivation scores
## - from: https://www.gov.uk/government/statistics/english-indices-of-deprivation-2019
## - source: File 10: local authority district summaries
##
## We'll use two summary measures of deprivation in LAs: extent and proportion of Lower-layer Super Output Areas in most deprived 10% nationally
## - extent =  the proportion of the local population that live in areas classified as among the most deprived in the country
## 
## (see Table 3.2 in the IMD technical report for more details: https://assets.publishing.service.gov.uk/government/uploads/system/uploads/attachment_data/file/833951/IoD2019_Technical_Report.pdf)
##
GET("https://assets.publishing.service.gov.uk/government/uploads/system/uploads/attachment_data/file/833995/File_10_-_IoD2019_Local_Authority_District_Summaries__lower-tier__.xlsx",
    write_disk(tf_imd <- tempfile(fileext = ".xlsx")))

imd = read_excel(tf_imd, sheet = "IMD") %>% 
  select(Code = `Local Authority District code (2019)`, 
         Proportion = `IMD - Proportion of LSOAs in most deprived 10% nationally`, Proportion_rank = `IMD - Rank of proportion of LSOAs in most deprived 10% nationally`, 
         Extent = `IMD 2019 - Extent`, Extent_rank = `IMD 2019 - Rank of extent`) %>% 
  
  # calculate deciles
  mutate(Proportion_decile = calc_risk_quantiles(Proportion_rank, quants = 10),
         Extent_decile = calc_risk_quantiles(Extent_rank, quants = 10))


##
## Calculate IMD scores for MSOAs
##
# File 5: scores for the indices of deprivation
GET("https://assets.publishing.service.gov.uk/government/uploads/system/uploads/attachment_data/file/833978/File_5_-_IoD2019_Scores.xlsx",
    write_disk(tf_scores <- tempfile(fileext = ".xlsx")))

# File 6: population denominators
GET("https://assets.publishing.service.gov.uk/government/uploads/system/uploads/attachment_data/file/833980/File_6_-_IoD2019_Population_Denominators.xlsx",
    write_disk(tf_pop <- tempfile(fileext = ".xlsx")))

imd_scores = read_excel(tf_scores, sheet = "IoD2019 Scores")
imd_pop = read_excel(tf_pop, sheet = "Population Denominators")

# merge scores and population denominators
imd_msoa = imd_scores %>% 
  select(LSOA11CD = `LSOA code (2011)`, IMD_Score = `Index of Multiple Deprivation (IMD) Score`) %>% 
  
  left_join(imd_pop %>% select(LSOA11CD = `LSOA code (2011)`, Pop = `Total population: mid 2015 (excluding prisoners)`),
            by = "LSOA11CD") %>% 
  
  left_join(lsoa_msoa, by = "LSOA11CD")

# calculate total population per MSOA
imd_pop_msoa = imd_msoa %>% 
  group_by(MSOA11CD) %>% 
  summarise(Pop_Total = sum(Pop))

# calculate average scores in each MSOA
imd_score_msoa = imd_msoa %>% 
  mutate(Score = IMD_Score * Pop) %>% 
  
  group_by(MSOA11CD) %>% 
  summarise(Score_Total = sum(Score))

n_msoa = nrow(imd_msoa)

# calculate average score for each MSOA
imd_msoa = imd_score_msoa %>% 
  left_join(imd_pop_msoa, by = "MSOA11CD") %>% 
  mutate(IMD_Score = Score_Total / Pop_Total) %>% 
  
  # calculate ranks and deciles
  mutate(IMD_Rank = rank(IMD_Score),
         IMD_Decile = 11 - as.integer(cut2(IMD_Score, g = 10)))


##
## summarise LA-level data
##
aps_vi_imd = aps %>% 
  left_join(vi, by = "Code") %>% 
  left_join(imd, by = "Code")

aps_vi_sum = aps_vi_imd %>% 
  group_by(`Vulnerability decile`, Variable) %>% 
  summarise(Value_mean = mean(Value, na.rm = TRUE),
            Value_sd = sd(Value, na.rm = TRUE))

aps_imd_sum = aps_vi_imd %>% 
  group_by(Proportion_decile, Variable) %>% 
  summarise(Value_mean = mean(Value, na.rm = TRUE),
            Value_sd = sd(Value, na.rm = TRUE))

##
## Viz vulnerability
##

# overall vulnerability
aps_vi_sum %>% 
  ggplot(aes(x = factor(`Vulnerability decile`), y = Value_mean)) +
  geom_col() +
  geom_errorbar(aes(ymin = Value_mean, ymax = Value_mean + Value_sd), 
                size = 0.5, width = 0.25, position = position_dodge(.9)) +
  
  facet_wrap(~ Variable) +
  theme_classic()

# economic vulnerability
aps %>% 
  ggplot(aes(x = `Proportion of neighbourhoods in 20% most economically vulnerable`, y = Value)) +
  geom_point() +
  facet_wrap(~ Variable) +
  geom_smooth(method = "lm") +
  theme_classic()

# deprivation
aps_imd_sum %>% 
  ggplot(aes(x = factor(Proportion_decile), y = Value_mean)) +
  geom_col() +
  geom_errorbar(aes(ymin = Value_mean, ymax = Value_mean + Value_sd), 
                size = 0.5, width = 0.25, position = position_dodge(.9)) +
  
  facet_wrap(~ Variable) +
  theme_classic()


##
## Viz deprivation
##
aps_imd_sum = aps_vi_imd %>% 
  group_by(Extent_decile, Variable) %>% 
  summarise(Value_mean = mean(Value, na.rm = TRUE),
            Value_sd = sd(Value, na.rm = TRUE))

aps_imd_sum %>% 
  ggplot(aes(x = factor(Extent_decile), y = Value_mean)) +
  geom_col() +
  geom_errorbar(aes(ymin = Value_mean, ymax = Value_mean + Value_sd), 
                size = 0.5, width = 0.25, position = position_dodge(.9)) +
  
  facet_wrap(~ Variable) +
  theme_classic()


##
## census and VI
##
census_vi = census %>% 
  left_join(vi_msoa, by = "Code")

census_vi_sum = census_vi %>% 
  group_by(`Clinical Vulnerability decile`, Ethnicity) %>% 
  summarise(Value_mean = mean(Value, na.rm = TRUE),
            Value_median = median(Value, na.rm = TRUE),
            Value_sd = sd(Value, na.rm = TRUE),
            Value_sum = sum(Value, na.rm = TRUE))

census_vi_n = census_vi %>% 
  group_by(`Clinical Vulnerability decile`) %>% 
  summarise(Value_total = sum(Value, na.rm = TRUE))

census_vi_sum = census_vi_sum %>% 
  left_join(census_vi_n, by = "Clinical Vulnerability decile") %>% 
  mutate(Value_prop = Value_sum / Value_total)

#
census_vi_sum %>% 
  ggplot(aes(x = factor(`Clinical Vulnerability decile`), y = Value_prop)) +
  geom_col() +
  # geom_errorbar(aes(ymin = Value_mean, ymax = Value_mean + Value_sd), 
  #               size = 0.5, width = 0.25, position = position_dodge(.9)) +
  
  facet_wrap(~ Ethnicity, scales = "free_y") +
  scale_y_continuous(labels = scales::percent) +
  theme_classic()


##
## Census and IMD
##
census_imd = census %>% 
  left_join(imd_msoa, by = c("Code" = "MSOA11CD"))

census_imd_sum = census_imd %>% 
  group_by(IMD_Decile, Ethnicity) %>% 
  summarise(Value_mean = mean(Value, na.rm = TRUE),
            Value_median = median(Value, na.rm = TRUE),
            Value_sd = sd(Value, na.rm = TRUE),
            Value_sum = sum(Value, na.rm = TRUE))

census_imd_n = census_imd %>% 
  group_by(IMD_Decile) %>% 
  summarise(Value_total = sum(Value, na.rm = TRUE))

census_imd_sum = census_imd_sum %>% 
  left_join(census_imd_n, by = "IMD_Decile") %>% 
  mutate(Value_prop = Value_sum / Value_total)

#
census_imd_sum %>% 
  filter(!is.na(IMD_Decile)) %>% 
  ggplot(aes(x = factor(IMD_Decile), y = Value_prop)) +
  geom_col() +
  # geom_errorbar(aes(ymin = Value_mean, ymax = Value_mean + Value_sd), 
  #               size = 0.5, width = 0.25, position = position_dodge(.9)) +
  
  facet_wrap(~ Ethnicity, scales = "free_y") +
  scale_y_continuous(labels = scales::percent) +
  theme_classic()
