##
## Make .geojson of Local Authorities, highlighting those with high proportions of people with BAME backgrounds
##
library(tidyverse)
library(nomisr)
library(sf)

##
## Load LA-level data from the Annual Population Survey:
## - Percentage of population who are {white or ethnic minority} and {UK born or not}
## - Percentage of working-age population who are {white or ethnic minority} and {UK born or not}
## - Unemployment rate: {white or ethnic minority} and {UK born or not}
## - Economic inactivity rate: {white or ethnic minority} and {UK born or not}
##
## Based on this URL: https://www.nomisweb.co.uk/api/v01/dataset/NM_17_5.jsonstat.json?geography=1811939329...1811939332,1811939334...1811939336,1811939338...1811939497,1811939499...1811939501,1811939503,1811939505...1811939507,1811939509...1811939517,1811939519,1811939520,1811939524...1811939570,1811939575...1811939599,1811939601...1811939628,1811939630...1811939634,1811939636...1811939647,1811939649,1811939655...1811939664,1811939667...1811939680,1811939682,1811939683,1811939685,1811939687...1811939704,1811939707,1811939708,1811939710,1811939712...1811939717,1811939719,1811939720,1811939722...1811939730,943718401...943718419,943718421...943718463,943718465...943718497,943718499...943718512,943718420,943718464,943718498&date=latest&variable=861...868,873...880&measures=20599,21001,21002,21003
##
aps_raw = nomis_get_data(
  id = "NM_17_5",
  date = "latest",
  geography = "TYPE432",  # 2019 LAD
  variable = "861...864", #"868,873...880",
  measures = "20599", #,21001,21002,21003",
  
  # variables to keep
  select = c(
    "GEOGRAPHY_CODE",
    "VARIABLE_NAME",
    "MEASURES_NAME",
    "OBS_VALUE"
  )
)

aps = aps_raw %>% 
  filter(MEASURES_NAME == "Variable") %>% 
  #pivot_wider(names_from = "VARIABLE_NAME", values_from = "OBS_VALUE") %>% 
  #select(Code = GEOGRAPHY_CODE, everything(), -MEASURES_NAME)
  select(Code = GEOGRAPHY_CODE, Variable = VARIABLE_NAME, Value = OBS_VALUE)

aps_bame = aps %>% 
  #filter(Variable %in% c("Percentage of population who are ethnic minority UK born", "Percentage of population who are ethnic minority not UK born")) %>% 
  pivot_wider(names_from = Variable, values_from = Value) %>% 

  # sum both 'ethnic minority' columns
  rowwise() %>% 
  mutate(`Percentage of population with BAME backgrounds` = sum(c(`Percentage of population who are ethnic minority UK born`, `Percentage of population who are ethnic minority not UK born`), na.rm = TRUE)) %>% 
  ungroup() %>% 
  
  # highlight LAs where more than 20% of the population have BAME backgrounds
  # choosing this threshold because, according to 2011 Census, 80.5% of the population was White British: https://www.ethnicity-facts-figures.service.gov.uk/uk-population-by-ethnicity/national-and-regional-populations/population-of-england-and-wales/latest
  mutate(`Over 20% of population has BAME backgrounds?` = ifelse(`Percentage of population with BAME backgrounds` > 20, "Yes", "No"))
  
  # quintiles for BAME percentages
  # mutate(`Quintile for percentage of population with BAME backgrounds` = calc_risk_quantiles(`Percentage of population with BAME backgrounds`))

# hist(aps_bame$`Percentage of population with BAME backgrounds`)

# Local Authority Districts (December 2019) Boundaries UK BUC
# source: https://geoportal.statistics.gov.uk/datasets/local-authority-districts-december-2019-boundaries-uk-buc
lads = read_sf("https://opendata.arcgis.com/datasets/3a4fa2ce68f642e399b4de07643eeed3_0.geojson")

lads_bame = lads %>% 
  left_join(aps_bame, by = c("lad19cd" = "Code")) %>% 
  select(Code = lad19cd, Name = lad19nm, everything(), 
         -objectid, -lad19nmw, -bng_e, -bng_n, -long, -lat, -st_areashape, -st_lengthshape)

lads_bame_only = lads_bame %>% 
  filter(`Over 20% of population has BAME backgrounds?` == "Yes")

write_sf(lads_bame, "analysis - ethnicity/LAs and ethnicity.geojson")
write_sf(lads_bame_only, "analysis - ethnicity/LAs and ethnicity - high proportion of BAME only.geojson")
