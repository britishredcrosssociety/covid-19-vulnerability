##
## Bespoke vulnerability for England Local Authority capacity analysis
##
## Formed of these indicators in these domains:
## (1) Clinical vulnerability
## - no. shielded in LA
##
## (2) Social needs
## - social isolation for adult carers
## - social isolation for adults receiving social care
## - loneliness risk
## - digital exclusion
##
## (3) Economic needs
## - at-risk jobs
## - financial vulnerability
##
## (4) Winter risks
## - flood risk 
##
library(tidyverse)
library(lubridate)

source("functions.r")

# ---- Lookup tables ----
# Local Authority District to County (December 2019) Lookup in England
lad_county = read_csv("https://opendata.arcgis.com/datasets/1512e57c5aa34d049569750083765eba_0.csv")

# msoa_lad = read_csv("data/lookup mosa11 to lad17 to lad19 to tactical cell.csv")

pop = read_csv("data/population estimates msoa11 lad17 lad19 tacticall cell.csv")

# ---- Shielding data (LA districts) ----
# Coronavirus Shielded Patient List, England - Local Authority: https://digital.nhs.uk/data-and-information/publications/statistical/mi-english-coronavirus-covid-19-shielded-patient-list-summary-totals/latest
shielded = read_csv("https://files.digital.nhs.uk/BC/85E39A/Coronavirus%20Shielded%20Patient%20List%2C%20England%20-%20Open%20Data%20with%20CMO%20DG%20-%20LA%20-%202020-09-09.csv")

shielded = shielded %>% 
  # keep only latest values (if more than one extraction happens to be in this file)
  mutate(`Extract Date` = dmy(`Extract Date`)) %>% 
  filter(`Extract Date` == max(`Extract Date`)) %>% 
  
  filter(`LA Code` != "ENG") %>%  # don't need England-wide figures
  filter(`Breakdown Field` == "ALL") %>%  #don't need age/gender splits
  
  select(LAD19CD = `LA Code`, `Clinically extremely vulnerable` = `Patient Count`)

shielded = shielded %>% 
  mutate_if(is.numeric,
            list(`Clinical Vulnerability score` = function(x) standardised(rank2(x))))

# --- Social isolation (Upper tier LAs: counties and unitary authorities - spread across LA Districts) ----
phe = read_csv("data/social-isolation-indicators-CountyUA.data.csv")

social_isolation = phe %>% 
  filter(`Area Type` == "County & UA" & `Time period` == "2018/19" & Age == "18+ yrs") %>%
  
  select(`Indicator Name`, Code = `Area Code`, Value) %>%
  
  pivot_wider(names_from = `Indicator Name`, values_from = Value, values_fn = list(Value = sum)) %>% 
  
  # Get LA Districts within each county and assign them the county-wide values
  left_join(lad_county %>% select(LAD19CD, CTY19CD), by = c("Code" = "CTY19CD")) %>% 
  mutate(LAD19CD = if_else(is.na(LAD19CD), Code, LAD19CD)) %>% 
  select(LAD19CD, everything(), -Code)

# Calculate LA-level scores/ranks/deciles
social_isolation = social_isolation %>% 
  calc_domain_scores(domain = "Social Isolation", bespoke.domains = TRUE)

rm(phe)

# ---- Loneliness risk (MSOAs, aggregated into LAs) ----
# source: https://github.com/matthewgthomas/loneliness
loneliness = read_csv("https://github.com/matthewgthomas/loneliness/raw/master/England/msoa_loneliness.csv") %>% 
  select(MSOA11CD = msoa11cd, Loneliness = loneills_2018) %>% 
  
  calc_domain_scores(domain = "Loneliness", bespoke.domains = TRUE)

# Aggregate into LAs
loneliness_lad = loneliness %>% 
  left_join(pop, by = "MSOA11CD") %>% 
  
  aggregate_scores(domain = "Loneliness", aggregate_by = "LAD19CD", population_col = "pop_msoa11") %>% 
  select(LAD19CD,
         `Extent of population living in highly lonely areas` = Extent)

# ---- Digital exclusion (MSOAs, aggregated into LAs) ----
digital_exclusion = read_csv("data/CACI/digital-exclusion-msoa.csv")

# Aggregate into LAs
digital_exclusion_lad = digital_exclusion %>% 
  left_join(pop, by = "MSOA11CD") %>% 
  
  aggregate_scores(domain = "Digital", aggregate_by = "LAD19CD", population_col = "pop_msoa11") %>% 
  select(LAD19CD,
         `Extent of population living in digitally excluded areas` = Extent)

# ---- Economic needs ----
# At-risk jobs
source("prep ocsi data - england.r")

jobs = ocsi %>% 
  select(MSOA11CD = `MSOA Code`,
         `Jobs in accommodation and food services (hospitality) Rate`, 
         `Jobs in arts, entertainment, recreation and other services Rate`, 
         `Jobs in retail Rate`, 
         `Jobs in transport and storage (inc postal) Rate`) %>% 
  
  # Use MLFA model to combine indicators
  weighted_domain_scores(model = "MLFA",
                         domain = "Jobs") %>% 
  
  select(MSOA11CD, ends_with("Vulnerability score"))

# Financial vulnerability
financial = read_csv("data/CACI/financial-msoa.csv") %>% 
  select(MSOA11CD, `Financial Vulnerability score`)

# Make economic needs domain - combine jobs and financial vulnerability with equal weight
economic = jobs %>% 
  left_join(financial, by = "MSOA11CD") %>% 
  
  mutate(`Jobs Vulnerability score` = 0.5 * `Jobs Vulnerability score`,
         `Financial Vulnerability score` = 0.5 * `Financial Vulnerability score`) %>% 
  
  mutate(`Economic Vulnerability score` = reduce(select(., ends_with("Vulnerability score")), `+`)) %>% 
  mutate(`Economic Vulnerability rank` = rank(`Economic Vulnerability score`)) %>%
  mutate(`Economic Vulnerability decile` = calc_risk_quantiles(`Economic Vulnerability rank`, quants = 10))

# Aggregate into LAs
economic_lad = economic %>% 
  left_join(pop, by = "MSOA11CD") %>% 
  
  aggregate_scores(domain = "Economic", aggregate_by = "LAD19CD", population_col = "pop_msoa11") %>% 
  select(LAD19CD,
         `Extent of population living in economically vulnerable areas` = Extent)
  
rm(ocsi)

# ---- Flood risks ----
floods_lad = read_csv("data/resilience-index/flood-risk-la.csv")

floods_lad = floods_lad %>% 
  select(LAD19CD, `Proportion of population at risk of flooding` = prop_at_risk_of_flooding)

# ---- Combine social indicators into one LA-level domain ----
social = social_isolation %>% 
  select(LAD19CD, ends_with("score")) %>% 
  
  left_join(loneliness_lad, by = "LAD19CD") %>% 
  
  left_join(digital_exclusion_lad, by = "LAD19CD") %>% 
  
  weighted_domain_scores(model = "PCA",
                         domain = "Social")

# ---- Build bespoke index ----
vulnerability = shielded %>% 
  select(LAD19CD, `Clinical Vulnerability score`) %>% 
  
  left_join(social %>% select(LAD19CD, `Social Vulnerability score`),
            by = "LAD19CD") %>% 
  
  left_join(economic_lad, by = "LAD19CD") %>% 
  
  left_join(floods_lad, by = "LAD19CD") %>% 
  
  calc_domain_scores(bespoke.domains = TRUE)

write_csv(vulnerability, "analysis - LA capacity/vulnerability-LA.csv")
