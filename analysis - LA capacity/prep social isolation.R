##
## PHE data on carers and social isolation
## - using carers and social isolation data from https://fingertips.phe.org.uk/search/carers%20and%20social%20isolation
##
library(tidyverse)
library(Hmisc)

source("functions.r")
source("load lookup tables.r")

scale2 = function(x, na.rm = TRUE) (x - mean(x, na.rm = na.rm)) / sd(x, na.rm)

phe = read_csv("data/social-isolation-processed.csv")  # data manually downloaded from Public Health England

indicator_list = c("Children in need due to socially unacceptable behaviour: rate per 10,000  aged under 18",
                   
                   # we'll get depression data from elsewhere and use in the 'health vulnerabilities' bit
                   # "Depression and anxiety among social care users: % of social care users", 
                   
                   # these two just use census data, so we'll ignore for now
                   # "Older people living alone, % of people aged 65 and over who are living alone", 
                   # "People living alone: % of all usual residents in households occupied by a single person",
                   
                   "Percentage of adult social care service users have control over their daily lives, age 65+",
                   "Percentage of people  aged 65 and over who were still at home 91 days after discharge from hospital",
                   "Percentage of people aged 65 and over using social care who receive self-directed support, and those receiving direct payments",
                   "Proportion of people who use services who have control over their daily life",
                   "Social Isolation: percentage of adult carers who have as much social contact as they would like",
                   "Social Isolation: percentage of adult social care users who have as much social contact as they would like")

# social_isolation_lad = phe %>% 
#   filter(`Area Type` == "County & UA (pre 4/19)") %>% 
#   
#   filter(`Indicator Name` %in% indicator_list) %>% 
#   
#   select(`Indicator Name`, Code = `Area Code`, Value) %>% 
#   
#   pivot_wider(names_from = `Indicator Name`, values_from = Value, values_fn = list(Value = sum))

social_isolation_lad = phe %>% 
  calc_domain_scores()


# phe = read_csv("data/carers-and-social-isolation.csv")  # data manually downloaded from Public Health England
# lad_17_19 = read_csv("data/LAD 2017 to LAD 2019 codes.csv")
# 
# indicator_list = c("Children in need due to socially unacceptable behaviour: rate per 10,000  aged under 18",
#                    
#                    # we'll get depression data from elsewhere and use in the 'health vulnerabilities' bit
#                    # "Depression and anxiety among social care users: % of social care users", 
#                    
#                    # these two just use census data, so we'll ignore for now
#                    # "Older people living alone, % of people aged 65 and over who are living alone", 
#                    # "People living alone: % of all usual residents in households occupied by a single person",
#                    
#                    "Percentage of adult social care service users have control over their daily lives, age 65+",
#                    "Percentage of people  aged 65 and over who were still at home 91 days after discharge from hospital",
#                    "Percentage of people aged 65 and over using social care who receive self-directed support, and those receiving direct payments",
#                    "Proportion of people who use services who have control over their daily life",
#                    "Social Isolation: percentage of adult carers who have as much social contact as they would like",
#                    "Social Isolation: percentage of adult social care users who have as much social contact as they would like")
# 
# social_isolation_lad = phe %>% 
#   filter(`Area Type` == "County & UA (pre 4/19)") %>% 
#   
#   filter(`Indicator Name` %in% indicator_list) %>% 
#   
#   select(`Indicator Name`, Code = `Area Code`, Value) %>% 
#   
#   pivot_wider(names_from = `Indicator Name`, values_from = Value, values_fn = list(Value = sum))
# 
# social_isolation_lad = social_isolation_lad %>%
#   # z-scores for indicators
#   mutate_if(is.numeric, list(z = scale2))  
#   
# social_isolation_lad %>% 
#   mutate(`Carers and isolation` = `Social Isolation: percentage of adult social care users who have as much social contact as they would like_z` %++% 
#            `Social Isolation: percentage of adult carers who have as much social contact as they would like_z` %++% 
#            `Children in need due to socially unacceptable behaviour: rate per 10,000  aged under 18_z` %++% 
#            `Percentage of people  aged 65 and over who were still at home 91 days after discharge from hospital_z` %++% 
#            `Percentage of people aged 65 and over using social care who receive self-directed support, and those receiving direct payments_z` %++% 
#            `Percentage of adult social care service users have control over their daily lives, age 65%++%_z` %++% 
#            `Proportion of people who use services who have control over their daily life_z`) %>% 
#   mutate(Carers_Isolation_q = as.integer(cut2(`Carers and isolation`, g = 5)))
#   
#   
#   
#   group_by(Code) %>% 
#   summarise_at(vars(ends_with("_z")), list(Social_Isolation = sum))
#   
#   # clculate clinical vulnerability based on z-scores
#   mutate(Clinical_Risk = CHD_z + COPD_z + HF_z + Arterial_z) %>% 
#   mutate(Clinical_Risk_q = as.integer(cut2(Clinical_Risk, g = 5)))
# 
# # get 2019 Local Authority codes
# clinical_lad = clinical_lad %>% 
#   left_join(lad_17_19, by = c("Code" = "LAD17CD")) %>% 
#   select(LAD19CD, everything(), -Code)
# 
# write_csv(clinical_lad, "output/clinical-vulnerability-LA.csv")
# 
# rm(phe, lad_17_19)
