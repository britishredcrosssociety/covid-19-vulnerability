# ---- Load libraries ----
library(tidyverse)

# ---- Load data ----
# Functions
source("functions.R")

# LA names
la_names <-
  read_csv("output/vulnerability-LA.csv") %>%
  select(Code, Name)

# Vulnerability
vulnerability <-
  read_csv("analysis - LA capacity/vulnerability-LA.csv")

# Spending power <-
spending <-
  read_csv("analysis - LA capacity/la-spending.csv")

# Adult social care
social_care <-
  read_csv("analysis - LA capacity/adult-social-care-domains.csv")

# Volunteering
volunteer <-
  read_csv("analysis - LA capacity/volunteer-scores-lad19.csv")

# ---- Create coping index -----
# Build volunteer domain
volunteer <-
  volunteer %>% filter(str_detect(LAD19CD, "^E"))

vols <-
  volunteer %>%
  select(LAD19CD, `Worst volunteer capacity rating` = worst_score) %>%
  mutate_if(
    is.numeric,
    list(`volunteer score` = function(x) standardised(rank2(x)))
  ) %>%
  mutate(`volunteer rank` = rank(`volunteer score`))

# Join domains and calculate coping index
coping_index <-
  social_care %>%
  left_join(spending, by = "LAD19CD") %>%
  left_join(vols, by = "LAD19CD") %>%
  select(
    LAD19CD,
    ends_with("rank")
  ) %>%
  calc_domain_scores(bespoke.domains = TRUE, rank.indicators = FALSE) %>%
  select(LAD19CD, `Coping score` = `Vulnerability score`, `Coping rank` = `Vulnerability rank`, `Coping decile` = `Vulnerability decile`)

coping_index %>% 
  write_csv("analysis - LA capacity/coping_index.csv")

# ---- Find Local Authorities with both a high individual vulnerability AND a high supply vulnerability ----
capacity_top_list <-
  vulnerability %>%
  select(
    LAD19CD,
    `Vulnerability score`,
    `Vulnerability rank`,
    `Vulnerability decile`
  ) %>%
  left_join(coping_index, by = "LAD19CD") %>%
  filter(
    `Vulnerability decile` == 10 | `Vulnerability decile` == 9,
    `Coping decile` == 10 | `Coping decile` == 9
  ) %>%
  left_join(la_names, by = c("LAD19CD" = "Code")) %>%
  relocate(Name, .after = LAD19CD)

capacity_top_list %>%
  write_csv("analysis - LA capacity/capacity_top_list.csv")
