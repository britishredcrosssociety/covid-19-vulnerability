# ---- Load libraries ----
library(tidyverse)

# ---- Load data ----
# Functions
source("functions.R")

# Vulnerability
vulnerability <-
  read_csv("analysis - LA capacity/vulnerability-LA.csv")

# Spending power <-
spending <-
  read_csv("analysis - LA capacity/la-spending.csv")

# Adult social care
social_care <-
  read_csv("analysis - LA capacity/adult-social-care-domains.csv")

# Volunteering
volunteer <-
  read_csv("analysis - LA capacity/volunteer-scores-lad19.csv")

# ---- Create supply index -----
# Build volunteer domain
volunteer <-
  volunteer %>% filter(str_detect(LAD19CD, "^E"))

vols <-
  volunteer %>% 
  select(LAD19CD, `Worst volunteer capacity rating` = worst_score) %>% 
  mutate_if(is.numeric,
            list(`volunteer score` = function(x) standardised(rank2(x)))) %>% 
  mutate(`volunteer rank` = rank(`volunteer score`))

# Join domains
social_care %>% 
  left_join(spending, by = "LAD19CD") %>% 
  left_join(vols, by = "LAD19CD") %>% 
  select(LAD19CD,
         ends_with("rank")) %>% 
  calc_domain_scores(bespoke.domains = TRUE, rank.indicators = FALSE) %>% 

  select(LAD19CD, `Resilience score` = `Vulnerability score`, `Resilience rank` = `Vulnerability rank`, `Resilience decile` = `Vulnerability decile`)


# ---- Find Local Authorities with both a high individual vulnerability AND a high supply vulnerability ----


