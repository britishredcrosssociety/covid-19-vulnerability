# ---- Load libraries ----
library(tidyverse)
library(sf)
library(httr)
library(readxl)
library(lubridate)
library(ggsflabel)
library(conflicted)
library(cowplot)

# ---- Declare conflicts ----
# conflict_scout()
conflict_prefer("select", "dplyr")
conflict_prefer("filter", "dplyr")
conflict_prefer("geom_sf_label", "ggsflabel")

# ---- Load data ----
capacity_top <- read_csv("analysis - LA capacity/capacity_top_list.csv")
coping_index <- read_csv("analysis - LA capacity/coping_index.csv")
vulnerability_index <- read_csv("analysis - LA capacity/vulnerability-LA.csv")
vi_shp <- read_sf("output/vulnerability-LA.geojson") %>% 
  select(Code, Name, geometry)

# ---- Clean data ----
# Prep data for bivariate maps
bivar_data <-
  coping_index %>% 
  left_join(vulnerability_index, by = "LAD19CD") %>% 
  select(LAD19CD, coping = `Coping decile`, vuln = `Vulnerability decile`)

# ---- Bivariate Scores ----
# create 3 buckets for vulnerability and resilience to map to colours
# vul_buckets <-
#   bivar_data %>%
#   pull(vuln) %>%
#   quantile(probs = seq(0, 1, length.out = 4), na.rm = TRUE)
# 
# res_buckets <-
#   bivar_data %>%
#   pull(coping) %>%
#   quantile(probs = seq(0, 1, length.out = 4), na.rm = TRUE)

# Create 3 buckets: 1-4, 5-8, 9-10
decile_buckets <- c(1, 4, 8, 10)
vul_buckets <- decile_buckets
res_buckets <- decile_buckets

# create color scale that encodes two variables
# red for vulnerability and blue for resilience
bivariate_color_scale <- tibble(
  "3 - 3" = "#3F2949", 
  "2 - 3" = "#435786",
  "1 - 3" = "#4885C1",
  "3 - 2" = "#77324C",
  "2 - 2" = "#806A8A",
  "1 - 2" = "#89A1C8",
  "3 - 1" = "#AE3A4E",
  "2 - 1" = "#BC7C8F",
  "1 - 1" = "#CABED0"
) %>%
  gather("group", "fill")

# Cut vulnerability and coping scores into groups defined by buckets
# Join colour scale
vul_coping_bivariate <-
  bivar_data %>% 
  mutate(vul_cut = cut(vuln,
                       breaks = vul_buckets,
                       include.lowest = TRUE),
         coping_cut = cut(coping,
                          breaks = res_buckets,
                          include.lowest = TRUE),
         group = paste(as.numeric(vul_cut),
                       "-",
                       as.numeric(coping_cut))) %>%
  left_join(bivariate_color_scale, by = "group")

# - Create legend -
bivariate_color_scale <-
  bivariate_color_scale %>% 
  separate(group, into = c("vul", "coping"), sep = " - ") %>%
  mutate(vul = as.integer(vul),
         res = as.integer(coping))

# Legend
legend <-
  ggplot() +
  geom_tile(
    data = bivariate_color_scale,
    mapping = aes(
      x = vul,
      y = res,
      fill = fill),
    show.legend = FALSE
  ) +
  scale_fill_identity() +
  theme_void() +
labs(x = expression("Higher Vulnerability" %->% " "),
     y = expression("Lower Coping" %->% " ")) +
theme_minimal() +
theme(
  panel.background = element_rect(fill = "transparent", color = NA),
  plot.background = element_rect(fill = "transparent", color = NA),
  legend.background = element_rect(fill = "transparent"),
  legend.box.background = element_rect(fill = "transparent"),
  axis.title.x = element_text(size = 6),
  axis.title.y = element_text(size = 6),
  axis.ticks = element_blank(),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  axis.text.x = element_blank(),
  axis.text.y = element_blank()
) +
coord_fixed()

ggsave(filename = "analysis - LA capacity/bivar-legend-void-no-labels.jpg",
       bg = "transparent",
       width = 5.21,
       height = 5.21)

# ---- plot ----
theme_map <- 
  function(...) {
  theme_minimal() +
    theme(
      text = element_text(family = "FiraCode-Retina", color = "#22211d"),
      axis.line = element_blank(),
      axis.text.x = element_blank(),
      axis.text.y = element_blank(),
      axis.ticks = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank(),
      panel.grid.major = element_line(color = "#ebebe5", size = 0.2),
      panel.grid.minor = element_blank(),
      plot.background = element_rect(fill = "#f5f5f2", color = NA), 
      panel.background = element_rect(fill = "#f5f5f2", color = NA), 
      legend.background = element_rect(fill = "#f5f5f2", color = NA),
      panel.border = element_blank(),
      legend.title = element_text(size = 11),
      legend.text = element_text(size = 9, hjust = 0),
      plot.title = element_text(size = 15, hjust = 0.5,
                                margin = margin(b = 0.2,
                                                t = 0.5,
                                                l = 2,
                                                unit = "cm")),
      plot.subtitle = element_text(size = 10, hjust = 0.5,
                                   margin = margin(b = 0.2,
                                                   t = 0.2,
                                                   l = 2,
                                                   unit = "cm"),
                                   debug = F),
      plot.caption = element_text(size = 7,
                                  hjust = .5,
                                  margin = margin(t = 0.2,
                                                  b = 0.5,
                                                  unit = "cm"),
                                  color = "#939184"),
      ...
    )
}

# prep shape file
shp_bivar <-
  vi_shp %>% 
  left_join(
    vul_coping_bivariate, 
    by = c("Code" = "LAD19CD")
  )

# - Draw base map - 
map <- 
    shp_bivar %>% 
  filter(str_detect(Code, "^E")) %>% 
  mutate(label = if_else(Code %in% capacity_top$LAD19CD,
         Name,
         NA_character_)) %>% 
    ggplot() +
    geom_sf(mapping = aes(fill = fill),
            color = "black",
            size = 0.1) +
  geom_sf_label(aes(label = label),
                size = 1.5,
                alpha = .6) +
    scale_fill_identity() +
    theme_map() +
  labs(title = "Local authority capacity analysis",
       subtitle = "Violet areas with labels have high vulnerability and low capacity to cope",
       caption = "Code: https://github.com/britishredcrosssociety/covid-19-vulnerability") +
  theme(
    plot.margin = unit(c(1, 12, 1, 12), "cm")
  )

# - Join pop and save -
ggdraw() +
  draw_plot(map, 0, 0, 1, 1) +
  draw_plot(legend, 0.1, 0.075, 0.1, 0.1)

ggsave("analysis - LA capacity/bivariate-map.png", width = 15, height = 11.6)
