# ---- Load libraries ----
library(tidyverse)
library(readxl)
library(httr)

# ---- Load data ----
# Functions
source("functions.R")

# Spending power
# Source: https://commonslibrary.parliament.uk/local-authority-data-finances/
GET("https://www.skillsforcare.org.uk/adult-social-care-workforce-data/Workforce-intelligence/documents/Raw-data/LA-data-download-2018-19.xlsx",
    write_disk(tf <- tempfile(fileext = ".xlsx")))

social <- read_excel(tf, sheet = "LA level data")
unlink(tf); rm(tf)

# La Lookup table
lad_county <- read_csv("https://opendata.arcgis.com/datasets/1512e57c5aa34d049569750083765eba_0.csv")

# ---- Clean data ----
# Select cols
social <- 
  social %>% 
  select(la_name = `CSSR (LA area)`,
         sector = Sector,
         service = Service,
         job_role = `Job role`,
         employee_count = `Employees (perm+temp)`,
         job_count = Jobs)

# Select all services, sectors and job roles
social_all <-
  social %>% 
  filter(sector == "All sectors" &
           service == "All services" &
           job_role == "All job roles") %>% 
  select(la_name,
         employee_count,
         job_count)

# Calculate difference between employee and job counts
social_deficit <-
  social_all %>% 
  mutate(employee_count = as.integer(employee_count),
         job_count = as.integer(job_count),
         employee_deficit = job_count - employee_count)

# Align la's with ONS codes
social_deficit %>% 
  filter((la_name %in% lookup_la$lad18nm))

