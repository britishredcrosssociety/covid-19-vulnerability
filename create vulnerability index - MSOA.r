##
## Make UK-wide .csv and .geojson for MSOA-level Vulnerability Index
##
library(tidyverse)
library(sf)
library(rmapshaper)

##
## load vulnerability data
##
vi_eng = read_csv("output/vulnerability-scores-MSOA-England.csv")
vi_wal = read_csv("output/vulnerability-scores-MSOA-Wales.csv")
vi_sco = read_csv("output/vulnerability-scores-MSOA-Scotland.csv")
vi_ni  = read_csv("output/vulnerability-scores-SOA-NI.csv")

vi = bind_rows(vi_eng, vi_wal, vi_sco, vi_ni)

vi %>% write_csv("output/vulnerability-MSOA-UK.csv")

##
## load geographies
##
# Middle Layer Super Output Areas (December 2011) Boundaries EW BSC
# source: https://geoportal.statistics.gov.uk/datasets/middle-layer-super-output-areas-december-2011-ew-bsc-v2
msoa = read_sf("https://opendata.arcgis.com/datasets/23cdb60ee47e4fef8d72e4ee202accb0_0.geojson") %>%
  st_transform(crs = 4326)

# Intermediate zones
iz = read_sf("data/boundaries/SG_IntermediateZone_Bdry_2011.shp") %>% 
  st_transform(crs = 4326) %>% 
  ms_simplify(keep_shapes = T)

# Super Output Areas
# soa = read_sf("https://cc-p-ni.ckan.io/dataset/678697e1-ae71-41f3-abba-0ef5f3f352c2/resource/80392e82-8bee-42de-a1e3-82d1cbaa983f/download/soa2001.json") %>% 
soa = read_sf("data/boundaries/SOA2011.shp") %>% 
  st_transform(crs = 4326) %>% 
  ms_simplify(keep_shapes = T)

# combine into a single spatial dataframe and merge in vulnerability index
msoa_uk = rbind(msoa %>% select(Code = MSOA11CD), 
                iz %>% select(Code = InterZone),
                soa %>% select(Code = SOA_CODE)) %>% 
  
  left_join(vi, by = "Code")

geojson_name = "output/vulnerability-MSOA-UK.geojson"
if (file.exists(geojson_name)) file.remove(geojson_name)

msoa_uk %>% 
  write_sf(geojson_name)
