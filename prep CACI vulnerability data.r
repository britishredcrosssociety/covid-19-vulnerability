##
## Prepare/analyse data on vulnerabilities provided by CACI (caci.co.uk) - we can't share the underlying data publicly, though
##
library(tidyverse)
library(readxl)
library(janitor)

data_dir = "C:/Users/040026704/Documents/Data science/Data/CACI"

##
## load data (that we can't share publicly)
##
single_occ_houses = read_csv(file.path(data_dir, "CCI_British Red Cross - UK Postcodes with Counts of Single Occupancy Households - 2020.csv"), col_types = "ci")
single_occ_houses = single_occ_houses %>% filter(!is.na(`Household_size_:_1_person`))

vuln = read_csv(file.path(data_dir, "CCI_British Red Cross - UK Postcodes with Vunerability Indicators.csv"))
vuln_raw = read_csv(file.path(data_dir, "vul_zscores.csv"))

wellbeing = read_csv(file.path(data_dir, "CCI_British Red Cross - Wellbeing Acorn Directory UK Formatted.csv"), col_types = "clliic")


##
## load data (that can be shared publicly)
##
postcodes = read_csv("data/postcodes/Data/ONSPD_FEB_2020_UK.csv")

# the ONS data truncates 7-character postcodes to remove spaces (e.g. CM99 1AB --> CM991AB); get rid of all spaces in both datasets to allow merging
postcodes$Postcode2 = gsub(" ", "", postcodes$pcd)
single_occ_houses$Postcode2 = gsub(" ", "", single_occ_houses$Postcode)
vuln$Postcode2 = gsub(" ", "", vuln$Postcode)
wellbeing$Postcode2 = gsub(" ", "", wellbeing$Postcode)

pc_msoa = postcodes %>% select(Postcode2, msoa11)
pc_lsoa = postcodes %>% select(Postcode2, lsoa11)


##
## calculate numbers of people living alone in MSOAs 
##
living_alone_lsoa = single_occ_houses %>% 
  left_join(pc_lsoa, by="Postcode2") %>% 
  rename(LSOA11CD = lsoa11) %>% 
  group_by(LSOA11CD) %>% 
  summarise(`No. people living alone` = sum(`Household_size_:_1_person`, na.rm = TRUE))

living_alone_msoa = single_occ_houses %>% 
  left_join(pc_msoa, by="Postcode2") %>% 
  rename(MSOA11CD = msoa11) %>% 
  group_by(MSOA11CD) %>% 
  summarise(`No. people living alone` = sum(`Household_size_:_1_person`, na.rm = TRUE))

write_csv(living_alone_lsoa, "data/CACI/living-alone-lsoa.csv")
write_csv(living_alone_msoa, "data/CACI/living-alone-msoa.csv")


##
## Aggregate postcode-level vulnerability into LSOAs and MSOAs by calculating the 20% most vulnerable postcodes in each LSOA/MSOA
##
vuln_msoa = vuln %>% 
  left_join(pc_msoa, by="Postcode2") %>% 
  rename(MSOA11CD = msoa11) %>%
  
  # run this code to see what the distributions of deciles within some random MSOAs look like
  # filter(MSOA11CD %in% sample(pc_msoa$msoa11, 4)) %>% 
  # ggplot(aes(x = `Digital_combined_-_Decile`)) +
  # geom_histogram(binwidth = 1) +
  # facet_wrap(~ MSOA11CD) %>% 
  
  # group_by(MSOA11CD) %>% 
  # summarise_if(is.numeric, median, na.rm = TRUE) %>% 
  
  mutate(Top20 = ifelse(`Digital_combined_-_Decile` <= 2, "Top20", "Other")) %>% 
  tabyl(MSOA11CD, Top20) %>% 
  mutate(`Proportion of postcodes in 20% most digitally excluded` = Top20 / (Top20 + Other))


write_csv(vuln_msoa, "data/CACI/digital-exclusion-msoa.csv")





  
  
vuln_lsoa = vuln %>% 
  left_join(pc_lsoa, by="Postcode2") %>% 
  rename(LSOA11CD = lsoa11) %>%
  
  # group_by(LSOA11CD) %>% 
  # summarise_if(is.numeric, median, na.rm = TRUE) %>% 
  
  mutate(Top20 = ifelse(`Digital_combined_-_Decile` <= 2, "Top20", "Other")) %>% 
  tabyl(LSOA11CD, Top20) %>% 
  mutate(`Proportion of postcodes in 20% most digitally excluded` = Top20 / (Top20 + Other))

write_csv(vuln_lsoa, "data/CACI/digital-exclusion-lsoa.csv")



write_csv(vuln_lsoa, "data/CACI/vulnerability-lsoa.csv")
write_csv(vuln_msoa, "data/CACI/vulnerability-msoa.csv")
