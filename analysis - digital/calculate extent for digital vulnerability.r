##
## Calculate Extent score for digital vulnerability
##
library(tidyverse)

source("functions.r")
source("load lookup tables.r")

msoa_lad = read_csv("data/lookup mosa11 to lad17 to lad19 to tactical cell.csv")

# Load digital vulnerability
digital_exclusion_lsoa = read_csv("data/CACI/digital-exclusion-lsoa.csv")
digital_exclusion_msoa = read_csv("data/CACI/digital-exclusion-msoa.csv")

# Merge SOAs for Northern Ireland into the MSOA dataframe
digital_exclusion_msoa = digital_exclusion_msoa %>% 
  filter(!startsWith(MSOA11CD, "N")) %>%  # no MSOAs in Northern Ireland
  
  bind_rows( digital_exclusion_lsoa %>% filter(startsWith(LSOA11CD, "9")) %>% rename(MSOA11CD = LSOA11CD) ) %>% 
  rename(Code = MSOA11CD)

rm(digital_exclusion_lsoa)

# Load MSOA-level population estimates
source("prep population estimates.r")
pop = read_csv("data/population estimates msoa11 lad17 lad19 tacticall cell.csv")

# Merge digital exclusion, LAs and Cells, and population estimates
digital_exclusion = digital_exclusion_msoa %>% 
  # left_join(msoa_lad, by = c("Code" = "MSOA11CD")) %>% 
  left_join(pop, by = c("Code" = "MSOA11CD")) %>% 
  rename(`No. people` = pop_msoa11)

# Aggregate into Local Authorities
digital_lad = digital_exclusion %>% 
  aggregate_scores(domain = "Digital", aggregate_by = "LAD19CD") %>% 
  rename(`Proportion of neighbourhoods in 20% most digitally excluded` = Proportion,
         `Extent of population living in highly digitally excluded areas` = Extent,
         `Population-weighted digitally exclusion score` = Score)

# Aggregate into Tactical Cells
digital_cell = digital_exclusion %>% 
  aggregate_scores(domain = "Digital", aggregate_by = "TacticalCell") %>% 
  rename(`Proportion of neighbourhoods in 20% most digitally excluded` = Proportion,
         `Extent of population living in highly digitally excluded areas` = Extent,
         `Population-weighted digitally exclusion score` = Score)

# Save
digital_lad %>% write_csv("analysis - digital/digital_exclusion_extent_lad19.csv")
digital_cell %>% write_csv("analysis - digital/digital_exclusion_extent_cell.csv")
