##
## MSOA-level vulnerability index for Wales
##
library(tidyverse)
library(readxl)
library(httr)
library(sf)

source("functions.r")
source("load lookup tables.r")
source("prep wales ocsi data.R")

msoa_names = read_csv("https://visual.parliament.uk/msoanames/static/MSOA-Names-v1.1.0.csv") %>% 
  select(Code = msoa11cd, Name = msoa11nm)

# load function to download data from Stats Wales (without having to install the assocaited `brclib` package)
source("https://github.com/matthewgthomas/brclib/raw/master/R/download_wales.R")


###############################################################################
## Load and prep all data sources
##

# load LSOA to MSOA codes lookup table
lookup_lsoa_msoa = load_lookup_lsoa_msoa_lad() %>% 
  select(LSOA11CD, MSOA11CD)

##
## MSOA-level data from Public Health Observatory Wales Public Health Outcomes Framework reporting tool
## source: https://public.tableau.com/views/PHOF2017SubLA-HOME/Home?:embed=y&:showVizHome=no
##
GET("http://www2.nphs.wales.nhs.uk:8080/PubHObservatoryProjDocs.nsf/3653c00e7bb6259d80256f27004900db/920b258a5a6102fc802581a1003c196d/$FILE/PHOFDataDownload2017_v1.xlsx",
    write_disk(tf <- tempfile(fileext = ".xlsx")))

phof = read_excel(tf, sheet = "MSOA")
unlink(tf); rm(tf)

phof %>% 
  select(Outcome, Title) %>% 
  distinct()

pho_clinical_indicator_names = c(
  "Hip fractures among older people, 2009/10 to 2018/19"
)

clinical_indicators = phof %>% 
  select(Code = MSOA, Title, `Area Value`) %>% 
  filter(Title %in% pho_clinical_indicator_names) %>% 
  pivot_wider(names_from = Title, values_from = `Area Value`)

pho_social_indicator_names = c(
  "Premature deaths from key non communicable diseases, 2016 to 2018",
  "Children living in poverty, 2017",
  "Nitrogen dioxide (NOâ‚‚) concentration at residential dwelling locations, 2017"
)

social_indicators = phof %>% 
  filter(Title %in% pho_social_indicator_names | Outcome == "Natural and built environment that supports health and well-being") %>% 
  select(Code = MSOA, Title, `Area Value`) %>%
  pivot_wider(names_from = Title, values_from = `Area Value`)


##
## Welsh IMD underlying indicators for MSOAs
##
imd = download_wales("http://open.statswales.gov.wales/en-gb/dataset/wimd1912")

# sort(unique(imd$Indicator_ItemName_ENG))

imd_clinical_indicator_names = c(
  "Cancer incidence (rate per 100,000)",
  "GP-recorded chronic condition (rate per 100)",
  "Limiting long-term illness (rate per 100)"
)

imd_clinical_indicators = imd %>% 
  select(Code = MSOA_Code, Indicator = Indicator_ItemName_ENG, Data) %>% 
  filter(Indicator %in% imd_clinical_indicator_names) %>% 
  pivot_wider(names_from = Indicator, values_from = Data)

imd_wellbeing_indicator_names = c(
  "GP-recorded mental health condition (rate per 100)",
  "Proximity to accessible natural green space score (% of households)"
)

imd_wellbeing_indicators = imd %>% 
  select(Code = MSOA_Code, Indicator = Indicator_ItemName_ENG, Data) %>% 
  filter(Indicator %in% imd_wellbeing_indicator_names) %>% 
  pivot_wider(names_from = Indicator, values_from = Data)

imd_social_indicator_names = c(
  "% Unavailability of broadband at 30Mb/s",
  "Average private return travel time to a food shop (minutes)",
  "Average private return travel time to a GP surgery (minutes)",
  "Average private return travel time to a pharmacy (minutes)",
  "Average private return travel time to a post office (minutes)",
  # "Likelihood of housing containing serious hazards (%)",  # this is a component of the poor quality housing indicator
  # "Likelihood of housing being in disrepair (%)",          # this is a component of the poor quality housing indicator
  "Likelihood of poor quality housing (%)",
  "People in overcrowded households (%)"
)

imd_social_indicators = imd %>% 
  select(Code = MSOA_Code, Indicator = Indicator_ItemName_ENG, Data) %>% 
  filter(Indicator %in% imd_social_indicator_names) %>% 
  pivot_wider(names_from = Indicator, values_from = Data)


##
## loneliness risks
## source: https://github.com/matthewgthomas/loneliness
##
loneliness = read_csv("https://github.com/matthewgthomas/loneliness/raw/master/Wales/msoa_loneliness.csv") %>% 
  select(Code = msoa11cd, Loneliness = loneills_2018)


##
## Load distance to hospitals
##
hospital_distance = read_csv("data/hospital-data/england-wales-nearest-hospitals-lsoa.csv")  # produced by `prep hospitals accessibility.py`

# similar to road distances in the IMD data, calculate longest mean distance
hospital_distance = hospital_distance %>% 
  select(LSOA11CD = lsoa11cd, mean_distance_nearest_three_hospitals) %>% 
  mutate(mean_distance_nearest_three_hospitals = mean_distance_nearest_three_hospitals / 1000) %>%  # convert to km
  
  # merge MSOA codes
  left_join(lookup_lsoa_msoa, by = "LSOA11CD") %>% 
  
  # take further mean distance to a hospital for LSOAs within an MSOA
  group_by(MSOA11CD) %>% 
  summarise(`Longest distance to hospital (km)` = max(mean_distance_nearest_three_hospitals)) %>% 
  rename(Code = MSOA11CD)


##
## Load distance to food banks
##
foodbank_distance = read_csv("data/foodbank/nearest-foodbanks-lsoas.csv")  # produced by `prep food bank accessibility.py`

# similar to road distances in the IMD data, calculate longest mean distance
foodbank_distance = foodbank_distance %>% 
  select(LSOA11CD = lsoa11cd, mean_distance_nearest_three_foodbanks) %>% 
  mutate(mean_distance_nearest_three_foodbanks = mean_distance_nearest_three_foodbanks / 1000) %>%  # convert to km
  
  # merge MSOA codes
  left_join(lookup_lsoa_msoa, by = "LSOA11CD") %>% 
  
  # take further mean distance to a hospital for LSOAs within an MSOA
  group_by(MSOA11CD) %>% 
  summarise(`Longest distance to food bank (km)` = max(mean_distance_nearest_three_foodbanks)) %>% 
  rename(Code = MSOA11CD)



###############################################################################
## Calculate scores for each domain of vulnerability
##

# ---- OCSI Wales data ----
# ocsiw data set sourced from 'prep wales ocsi data.R'
# Original data provided by OCSI containing various useful indicators: https://ocsi.uk/2020/04/01/covid-19-vulnerability-index-and-data-download/

# ---- Clinical vulnerability domain ----
# Prep OCSI data
ocsiw_clinical <- ocsiw %>% 
  select(Code, `Cancer Incidence Rate`)

# Join clinical indicators and calculate domain score
clinical <- clinical_indicators %>% 
  left_join(imd_clinical_indicators, by = "Code") %>%
  left_join(ocsiw_clinical, by = "Code") %>% 
  calc_domain_scores(domain = "Clinical")

health_wellbeing = imd_wellbeing_indicators %>% 
  left_join(loneliness, by = "Code") %>% 
  calc_domain_scores(domain = "Health/Wellbeing")

social = social_indicators %>% 
  left_join(imd_social_indicators, by = "Code") %>% 
  left_join(hospital_distance, by = "Code") %>% 
  left_join(foodbank_distance, by = "Code") %>% 
  calc_domain_scores(domain = "Social")


###############################################################################
## Construct the overall MSOA-level vulnerability index
##
vulnerability = clinical %>% 
  # keep only vulnerability ranks for each domain
  select(Code, `Clinical Vulnerability rank`) %>% 
  
  left_join(health_wellbeing %>% select(Code, `Health/Wellbeing Vulnerability rank`),
            by = "Code") %>% 
  
  left_join(social %>% select(Code, `Social Vulnerability rank`),
            by = "Code") %>% 
  
  calc_domain_scores(rank.indicators = FALSE) %>% 
  
  select(Code, starts_with("Vulnerability"))

##
## combine all domains and overall scores into one dataframe and save
##
vulnerability_all = clinical %>% 
  left_join(health_wellbeing, by = "Code") %>% 
  left_join(social, by = "Code") %>% 
  left_join(vulnerability, by = "Code") %>% 
  
  # get MSOA names
  left_join(msoa_names, by = "Code") %>% 
  
  select(Code, Name, everything())

vulnerability_all %>% write_csv("output/vulnerability-MSOA-Wales.csv")

# save a copy with only vulnerability scores
vulnerability_all %>% 
  select(Code, Name, contains("Vulnerability")) %>% 
  write_csv("output/vulnerability-scores-MSOA-Wales.csv")

##
## save as geojson
##
# Middle Layer Super Output Areas (December 2011) Boundaries EW BSC
# source: https://geoportal.statistics.gov.uk/datasets/middle-layer-super-output-areas-december-2011-boundaries-ew-bsc
msoa = read_sf("https://opendata.arcgis.com/datasets/c661a8377e2647b0bae68c4911df868b_3.geojson") %>% 
  st_transform(crs = 4326)

msoa = msoa %>% 
  filter(startsWith(msoa11cd, "W")) %>% 
  left_join(vulnerability_all, by = c("msoa11cd" = "Code")) %>% 
  mutate(`Vulnerability quintile` = calc_risk_quantiles(`Vulnerability rank`, quants = 5))

msoa %>% 
  # select(Code = msoa11cd, Name, ends_with("rank"), ends_with("decile")) %>% 
  select(Code = msoa11cd, Name, everything(), -objectid, -msoa11nm, -msoa11nmw, -st_areashape, -st_lengthshape) %>% 
  write_sf("output/vulnerability-MSOA-Wales.geojson")

##
## checking and debugging
##
# check that it's not just giving high vulnerability scores to larger MSOAs (which it shouldn't necessarily)
# the correlation is statistically significant (unsurprising because there's a lot of data)
# ... but the correlation itself is small (r = 0.182178), so nothing to worry about
cor.test(~ st_areashape + `Vulnerability rank`, data = msoa)

# get most and least vulnerable MSOAs to check their underlying indicators look correct (they do)
test = vulnerability_all %>% filter(`Vulnerability rank` %in% c(1, nrow(vulnerability_all)))
