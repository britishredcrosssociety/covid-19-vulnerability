##
## Distribution of vulnerability and deprivation within Tactical Cells
##
library(tidyverse)
library(cowplot)

source("functions.r")
source("load lookup tables.r")

source("analysis - tactical cells/create lookup table - neighbourhood to Tactical Cell.r")
tc_curr = "South and the Channel Islands"

##
## distribution of vulnerability deciles within TCs
##
vi = read_csv("output/vulnerability-MSOA-UK.csv") %>% 
  left_join(msoa_lad_tc, by = c("Code" = "MSOA11CD"))

# show vulnerability distribs for all Cells
# vi %>% 
#   ggplot(aes(x = factor(`Vulnerability decile`))) +
#   geom_bar() +
#   facet_wrap(~TacticalCell)

# convert deciles to a factor and label the least and most vulnerable
vi$Decile = factor(vi$`Vulnerability decile`)
levels(vi$Decile)[levels(vi$Decile) %in% c("1", "10")] = c("1 (least vulnerable)", "10 (most vulnerable)")

# label
vi_sum = vi %>% 
  filter(TacticalCell == tc_curr) %>% 
  janitor::tabyl(`Vulnerability decile`) %>% 
  mutate(percent = round(percent * 100, 0))

vi_sum_least = vi_sum %>% filter(`Vulnerability decile` == 1)
vi_sum_most = vi_sum %>% filter(`Vulnerability decile` == 10)

labA = paste0(vi_sum_least$percent, "% of areas are among country's least vulnerable\n", vi_sum_most$percent, "% of areas are among country's most vulnerable")

ann_text1 = data.frame(Decile = 5, values = 175)  # where to place the annotation

plt_vi = vi %>% 
  filter(TacticalCell == tc_curr) %>% 
  ggplot(aes(x = Decile)) +
  geom_bar(fill = "#f1864e") +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = NULL, y = "Number of neighbourhoods", title = "Vulnerability decile")
  # 
  # geom_text(data = ann_text1, aes(x = Decile, y = values), 
  #           label = labA, colour="Grey40") 


##
## distribution of deprivation deciles within TCs
##
imd = read_csv("https://github.com/matthewgthomas/IMD/raw/master/data/UK%20IMD%20domains.csv") 
imd = imd %>% 
  left_join(lsoa_lad_tc, by = c("LSOA" = "LSOA11CD"))

# convert deciles to a factor and label the least and most vulnerable
imd$IMD_decile = reverse_decile(imd$IMD_decile)
imd$Decile = factor(imd$IMD_decile)
levels(imd$Decile)[levels(imd$Decile) %in% c("1", "10")] = c("1 (least deprivation)", "10 (most deprivation)")

# label
imd_sum = imd %>% 
  filter(TacticalCell == tc_curr) %>% 
  janitor::tabyl(IMD_decile) %>% 
  mutate(percent = round(percent * 100, 0))

imd_sum_least = imd_sum %>% filter(IMD_decile == 1)
imd_sum_most = imd_sum %>% filter(IMD_decile == 10)

labA = paste0(imd_sum_least$percent, "% of areas are among country's least deprived\n", imd_sum_most$percent, "% of areas are among country's most deprived")

ann_text1 = data.frame(Decile = 5, values = 750)  # where to place the annotation

plt_imd = imd %>% 
  filter(TacticalCell == tc_curr) %>% 
  ggplot(aes(x = Decile)) +
  geom_bar(fill = "#f1864e") +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = NULL, y = "Number of neighbourhoods", title = "Deprivation decile")
  # 
  # geom_text(data = ann_text1, aes(x = Decile, y = values), 
  #           label = labA, colour="Grey40") 

# combine plots and save
plot_grid(plt_vi, plt_imd, nrow = 2, ncol = 1)
ggsave(file.path("maps/tactical cells", tc_curr, "vulnerability and deprivation.png"), width = 100, height = 200, units = "mm")

ggsave(file.path("maps/tactical cells", tc_curr, "vulnerability.png"), plot = plt_vi,  width = 100, height = 100, units = "mm")
ggsave(file.path("maps/tactical cells", tc_curr, "deprivation.png"),   plot = plt_imd, width = 100, height = 100, units = "mm")
