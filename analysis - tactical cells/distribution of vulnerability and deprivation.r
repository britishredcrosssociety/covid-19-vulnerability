##
## Distribution of vulnerability and deprivation within Tactical Cells
##
library(tidyverse)

source("load lookup tables.r")

##
## make MSOA to LA to Tactical Cell lookup
##
msoa_lad = load_lookup_lsoa_msoa_lad() %>% 
  select(MSOA11CD, LAD17CD) %>% 
  distinct()

lad_17_19 = read_csv("data/LAD 2017 to LAD 2019 codes.csv")

lad_tc = read_csv("data/lookup local authority to tactical cell.csv")

msoa_lad_tc = msoa_lad %>% 
  left_join(lad_17_19, by = "LAD17CD") %>% 
  left_join(lad_tc, by = "LAD19CD")

# make list of LA names in each TC
# lad_names = read_csv("https://opendata.arcgis.com/datasets/c3ddcd23a15c4d7985d8b36f1344b1db_0.csv") %>% 
#   select(LAD19CD, LAD19NM)
# 
# lad_tc %>% 
#   left_join(lad_names, by = "LAD19CD") %>% 
#   arrange(TacticalCell, LAD19NM) %>% 
#   write_csv("data/local authorities and tactical cells.csv")


##
## distribution of vulnerability deciles within TCs
##
vi = read_csv("output/vulnerability-MSOA-UK.csv") %>% 
  left_join(msoa_lad_tc, by = c("Code" = "MSOA11CD"))

vi %>% 
  # filter(startsWith(Code, "E")) %>% 
  # filter(TacticalCell == "South and the Channel Islands") %>% 
  ggplot(aes(x = factor(`Vulnerability decile`))) +
  geom_bar() +
  facet_wrap(~TacticalCell)

vi %>% filter(is.na(TacticalCell)) %>% select(Code, LAD17CD, LAD19CD, TacticalCell)


##
## distribution of deprivation deciles within TCs
##


