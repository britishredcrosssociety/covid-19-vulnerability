##
## SOA-level vulnerability index for Northern Ireland
##
library(tidyverse)
library(readxl)
library(httr)
library(sf)
library(rmapshaper)

source("functions.r")
source("load lookup tables.r")


###############################################################################
## Load and prep all data sources
##

##
## IMD data
##
# download Super Output Area results
# source: https://www.nisra.gov.uk/statistics/deprivation/northern-ireland-multiple-deprivation-measure-2017-nimdm2017
GET("https://www.nisra.gov.uk/sites/nisra.gov.uk/files/publications/NIMDM17_SOAresults.xls",
    write_disk(tf <- tempfile(fileext = ".xls")))

imd_health = read_excel(tf, sheet = "Health and Disability")
imd_access = read_excel(tf, sheet = "Access to Services")
imd_env = read_excel(tf, sheet = "Living Environment")

soa_names = imd_health %>% 
  select(Code = SOA2001, Name = SOA2001_name)

unlink(tf); rm(tf)

# helper function to swap ranks from low to high
reverse_ranks = function(x) (length(x) + 1) - x

clinical_indicators = imd_health %>% 
  select(
    Code = SOA2001, 
    `Standardized ratio of people registered as having cancer (Rank)` = `Standardized ratio of people registered as having cancer (excluding non-melanoma skin cancers)\n(rank)`, 
    `Standardized ratio of people on multiple prescriptions (Rank)` = `Standardized ratio of people on multiple prescriptions on a regular basis\n(rank)`, 
    `Standardized ratio of people with a long-term health problem or disability (Rank)` = `Standardized ratio of people with a long-term health problem or disability\n(Excluding Mental Health problems)\n(rank)`
  ) %>%  
  mutate_if(is.numeric, reverse_ranks)  # reverse ranks so 1 = least deprived
  

wellbeing_indicators = imd_health %>% 
  select(Code = SOA2001, `Combined Mental Health Indicator (Rank)` = `Combined Mental Health Indicator\n(rank)`) %>% 
  mutate_if(is.numeric, reverse_ranks)  # reverse ranks so 1 = least deprived

social_indicators = imd_access %>% 
  left_join(imd_env, by = "SOA2001") %>% 
  select(
    Code = SOA2001, 
    `Service-weighted fastest travel time by private transport (Rank)` = `Service-weighted fastest travel time by private transport\n(rank)`, 
    `Proportion of properties with broadband speed below 10Mb/s (Rank)` = `Proportion of properties with broadband speed below 10Mb/s\n(rank)`, 
    `Housing Quality (Rank)` = `Housing Quality \nSub-Domain \n(Rank)`, 
    `Housing Access (Rank)` = `Housing Acces Sub-Domain (Rank)`,
    `Outdoor physical environment Sub-Domain (Rank)` = `Outdoor physical environment Sub-Domain (Rank)`
  ) %>% 
  mutate_if(is.numeric, reverse_ranks)  # reverse ranks so 1 = least deprived


##
## Load loneliness risks
## source: https://github.com/matthewgthomas/loneliness
##
loneliness = read_csv("https://github.com/matthewgthomas/loneliness/raw/master/NI/msoa_loneliness.csv") %>% 
  select(Code = SOA_CODE, Loneliness = loneills_2018)


###############################################################################
## Calculate scores for each domain of vulnerability
##
clinical = clinical_indicators %>% 
  calc_domain_scores(domain = "Clinical")

health_wellbeing = wellbeing_indicators %>% 
  left_join(loneliness, by = "Code") %>% 
  calc_domain_scores(domain = "Health/Wellbeing")

social = social_indicators %>% 
  calc_domain_scores("Social")


###############################################################################
## Construct the overall MSOA-level vulnerability index
##
vulnerability = clinical %>% 
  # keep only vulnerability ranks for each domain
  select(Code, `Clinical Vulnerability rank`) %>% 
  
  left_join(health_wellbeing %>% select(Code, `Health/Wellbeing Vulnerability rank`),
            by = "Code") %>% 
  
  left_join(social %>% select(Code, `Social Vulnerability rank`),
            by = "Code") %>% 
  
  calc_domain_scores(rank.indicators = FALSE) %>% 
  
  select(Code, starts_with("Vulnerability"))

##
## combine all domains and overall scores into one dataframe and save
##
vulnerability_all = clinical %>% 
  left_join(health_wellbeing, by = "Code") %>% 
  left_join(social, by = "Code") %>% 
  left_join(vulnerability, by = "Code") %>% 
  
  # get MSOA names
  left_join(soa_names, by = "Code") %>% 
  
  select(Code, Name, everything())

vulnerability_all %>% write_csv("output/vulnerability-SOA-NI.csv")

# save a copy with only vulnerability scores
vulnerability_all %>% 
  select(Code, Name, contains("Vulnerability")) %>% 
  write_csv("output/vulnerability-scores-SOA-NI.csv")


##
## save as geojson
##
# Super Output Areas from https://www.opendatani.gov.uk/dataset/nisra-open-data-boundaries-super-output-areas-2011/resource/80392e82-8bee-42de-a1e3-82d1cbaa983f
# soa = read_sf("https://cc-p-ni.ckan.io/dataset/678697e1-ae71-41f3-abba-0ef5f3f352c2/resource/80392e82-8bee-42de-a1e3-82d1cbaa983f/download/soa2001.json") %>% 
soa = read_sf("data/boundaries/SOA2011.shp") %>% 
  st_transform(crs = 4326) %>% 
  ms_simplify(keep_shapes = T)

soa = soa %>% 
  left_join(vulnerability_all, by = c("SOA_CODE" = "Code")) %>% 
  mutate(`Vulnerability quintile` = calc_risk_quantiles(`Vulnerability rank`, quants = 5))

soa %>% 
  rename(Code = SOA_CODE) %>% 
  select(-SOA_LABEL) %>% 
  write_sf("output/vulnerability-SOA-NI.geojson")


##
## checking and debugging
##
# get most and least vulnerable MSOAs to check their underlying indicators look correct (they do)
test = vulnerability_all %>% filter(`Vulnerability rank` %in% c(1, nrow(vulnerability_all)))
