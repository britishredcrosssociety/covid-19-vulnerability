##
## Build a 'resilience index' for England based on these LA-level indicators:
##
## Individual/household resilience:
## - overall vulnerability
##
## Community resilience:
## - Community Needs Index
## - flood risks
##
## VCS/volunteer capacity:
## - volunteer capacity
##
## System resilience:
## - LA spending power
## - NHS bed occupancy rates
##

# ---- Load libraries ----
library(tidyverse)

source("functions.r")


# ---- Load data ----
vi = read_csv("output/vulnerability-LA.csv")   # Vulnerability Index
cmi = read_csv("data/community-needs-LA.csv")  # Community Needs Index
beds = read_csv("data/resilience-index/bed-occupancy-rates-la.csv")

vols = read_csv("C:/Users/040026704/Voluntary and Community Sector Emergencies Partnership/VCSEP Data Platform - Documents/Local Lockdown Sprint/Outbox/volunteer-scores-lad19.csv")

floods_msoa = read_csv("data/resilience-index/MSOAs in flood risk zones.csv")  # created by https://github.com/britishredcrosssociety/brc-risk-maps/blob/master/prep%20flood%20risks.r

pop_estimates = read_csv("data/population estimates msoa11 lad17 lad19 tacticall cell.csv")


# ---- Clean data ----
# Keep on England's MSOAs
vi = vi %>% filter(str_sub(Code, 1, 1) == "E")

beds = beds %>% filter(str_sub(LAD19CD, 1, 1) == "E")

vols = vols %>% filter(str_sub(LAD19CD, 1, 1) == "E")

# get % of MSOA population at risk of flooding and aggregate up to LA
floods_la = pop_estimates %>% 
  left_join(floods_msoa, by = "MSOA11CD") %>% 
  mutate(n = replace_na(n, 0)) %>% 
  
  group_by(LAD19CD) %>% 
  summarise(pop = sum(pop_msoa11),
            pop_flood = sum(n)) %>% 
  
  mutate(prop_at_risk_of_flooding = pop_flood / pop)

write_csv(floods_la, "data/resilience-index/flood-risk-la.csv")


# ---- Build sub-domains ----
individual = vi %>% 
  select(`Population-weighted vulnerability score`)

community = cmi %>% 
  select(LAD19CD, `Proportion of wards with greatest community needs`) %>% 
  
  left_join(floods_la %>% select(LAD19CD, `% of population at risk of flooding` = prop_at_risk_of_flooding),
            by = "LAD19CD") %>% 
  
  weighted_domain_scores(model = "PCA",
                         domain = "Community") 

vcs = vols %>% 
  select(LAD19CD, worst_score) %>% 
  mutate_if(is.numeric,
            list(`VCS Vulnerability score` = function(x) standardised(rank2(x))))

system = beds %>% 
  mutate_if(is.numeric,
            list(`System Vulnerability score` = function(x) standardised(rank2(x))))


# ---- Calculate overall resilience index score ----
resilience = 
