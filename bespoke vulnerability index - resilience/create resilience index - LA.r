##
## Build a 'resilience index' for England based on these LA-level indicators:
##
## Individual/household resilience:
## - overall vulnerability
##
## Community resilience:
## - Community Needs Index
## - flood risks
##
## VCS/volunteer capacity:
## - volunteer capacity
##
## System resilience:
## - LA spending power
## - NHS bed occupancy rates
##

# ---- Load libraries ----
library(tidyverse)

source("functions.r")


# ---- Load data ----
vi = read_csv("output/vulnerability-LA.csv")   # Vulnerability Index
cmi = read_csv("data/community-needs-LA.csv")  # Community Needs Index
beds = read_csv("data/resilience-index/bed-occupancy-rates-la.csv")

vols = read_csv("C:/Users/040026704/Voluntary and Community Sector Emergencies Partnership/VCSEP Data Platform - Documents/Local Lockdown Sprint/Outbox/volunteer-scores-lad19.csv")

floods_msoa = read_csv("data/resilience-index/MSOAs in flood risk zones.csv")  # created by https://github.com/britishredcrosssociety/brc-risk-maps/blob/master/prep%20flood%20risks.r

la_spending = read_csv("data/resilience-index/la-spending.csv")

pop_estimates = read_csv("data/population estimates msoa11 lad17 lad19 tacticall cell.csv")


# ---- Clean data ----
# Keep on England's MSOAs
vi = vi %>% filter(str_sub(Code, 1, 1) == "E")

beds = beds %>% filter(str_sub(LAD19CD, 1, 1) == "E")

vols = vols %>% filter(str_sub(LAD19CD, 1, 1) == "E")

# get % of MSOA population at risk of flooding and aggregate up to LA
floods_la = pop_estimates %>% 
  left_join(floods_msoa, by = "MSOA11CD") %>% 
  mutate(n = replace_na(n, 0)) %>% 
  
  group_by(LAD19CD) %>% 
  summarise(pop = sum(pop_msoa11),
            pop_flood = sum(n)) %>% 
  
  mutate(prop_at_risk_of_flooding = pop_flood / pop)

write_csv(floods_la, "data/resilience-index/flood-risk-la.csv")


# ---- Build sub-domains ----
individual = vi %>% 
  select(LAD19CD = Code, `Individual/household Resilience score` = `Population-weighted vulnerability score`) %>% 
  mutate(`Individual/household Resilience rank` = rank(`Individual/household Resilience score`)) %>%
  mutate(`Individual/household Resilience decile` = calc_risk_quantiles(`Individual/household Resilience rank`, quants = 10))

community = cmi %>% 
  select(LAD19CD, `Proportion of wards with greatest community needs`) %>% 
  
  left_join(floods_la %>% select(LAD19CD, `% of population at risk of flooding` = prop_at_risk_of_flooding),
            by = "LAD19CD") %>% 
  
  weighted_domain_scores(model = "PCA",
                         domain = "Community") %>% 
  rename(`Community Resilience score` = `Community Vulnerability score`, `Community Resilience rank` = `Community Vulnerability rank`, `Community Resilience decile` = `Community Vulnerability decile`)

vcs = vols %>% 
  select(LAD19CD, `Worst volunteer capacity rating` = worst_score) %>% 
  mutate_if(is.numeric,
            list(`VCS Resilience score` = function(x) standardised(rank2(x)))) %>% 
  mutate(`VCS Resilience rank` = rank(`VCS Resilience score`)) %>%
  mutate(`VCS Resilience decile` = calc_risk_quantiles(`VCS Resilience rank`, quants = 10))

system = la_spending %>% 
  select(LAD19CD, `LA spending power (rank)` = spend_rank_inverted) %>% 
  
  left_join(beds %>% rename(`Worst NHS bed occupancy rate` = worst_bed_occupancy_rate), by = "LAD19CD") %>% 
  
  weighted_domain_scores(model = "PCA",
                         domain = "System") %>% 
  rename(`System Resilience score` = `System Vulnerability score`, `System Resilience rank` = `System Vulnerability rank`, `System Resilience decile` = `System Vulnerability decile`)


# ---- Calculate overall resilience index score ----
resilience_index = individual %>% 
  select(LAD19CD, `Individual/household Resilience rank`) %>% 
  
  left_join(community %>% select(LAD19CD, `Community Resilience rank`),
            by = "LAD19CD") %>% 
  
  left_join(vcs %>% select(LAD19CD, `VCS Resilience rank`),
            by = "LAD19CD") %>% 
  
  left_join(system %>% select(LAD19CD, `System Resilience rank`),
            by = "LAD19CD") %>% 
  
  calc_domain_scores(bespoke.domains = TRUE, rank.indicators = FALSE) %>% 

  select(LAD19CD, `Resilience score` = `Vulnerability score`, `Resilience rank` = `Vulnerability rank`, `Resilience decile` = `Vulnerability decile`)


# ---- Merge indicators and overall resilience index into one dataframe and save ----
overall_resilience = individual %>% 
  
  left_join(community, by = "LAD19CD") %>% 
  
  left_join(vcs, by = "LAD19CD") %>% 
  
  left_join(system, by = "LAD19CD") %>% 

  left_join(resilience_index, by = "LAD19CD")

write_csv(overall_resilience, "bespoke vulnerability index - resilience/resilience-index-la.csv")


res2 = read_csv("bespoke vulnerability index - resilience/resilience-index-la - Copy.csv")

cor(overall_resilience$`Resilience rank`, res2$`Resilience rank`)
