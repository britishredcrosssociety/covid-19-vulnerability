# ---- Load libraries ----
library(tidyverse)
library(sf)
library(viridis)

# ---- Load data ----
res_index <- read_csv("bespoke vulnerability index - resilience/resilience-index-la.csv")
la_shp <- read_sf("output/vulnerability-LA.geojson")
tc_lookup <- read_csv("data/lookup mosa11 to lad17 to lad19 to tactical cell.csv")
watchlist <- read_csv("data/resilience-index/la-watchlist-week-33.csv")

# ---- Clean data ----
res_score <-
  res_index %>% 
  select(LAD19CD,
         res_score = `Resilience decile`)

tc_lookup <-
  tc_lookup %>% 
  distinct(LAD19CD, TacticalCell)

la_shp <-
  la_shp %>% 
  select(LAD19CD = Code,
         geometry)

watchlist <-
  watchlist %>% 
  select(LAD19CD, watchlist_status)

data <-
  la_shp %>% 
  left_join(res_score, by = "LAD19CD") %>% 
  left_join(tc_lookup, by = "LAD19CD") %>% 
  left_join(watchlist, by = "LAD19CD")

# ---- Plot ----
# - England - 
data %>% 
  filter(str_detect(LAD19CD, "^E")) %>% 
  mutate(res_score = as.integer(res_score),
         res_score = if_else(watchlist_status == "No interventions",
                             NA_integer_,
                             res_score)) %>% 
  ggplot() +
  geom_sf(mapping = aes(fill = res_score),
          color = "black",
          size = 0.1) +
  scale_fill_viridis(
    breaks = seq(1, 10, by = 1),
    # labels = seq(1, 10, by = 1),
    labels = c("Most resilient", "Most resilient", rep("", 6), "Least resilient", "Least resilient"),
    na.value = "transparent",
    option = "magma",
    name = expression(paste("Overall Resilience \nScore")),
    alpha = 0.8, # make fill a bit brighter
    begin = 0.1, # this option seems to be new (compared to 2016):
    # with this we can truncate the
    # color scale, so that extreme colors (very dark and very bright) are not
    # used, which makes the map a bit more aesthetic
    end = 0.9,
    discrete = F, # discrete classes, thus guide_legend instead of _colorbar
    direction = -1, # dark is lowest, yellow is highest
    guide = guide_legend(
      keyheight = unit(5, units = "mm"),
      title.position = "top",
      reverse = T)) +
  theme_void()

ggsave(filename = "bespoke vulnerability index - resilience/England-local-lockdown-resilience.png")

# - London -
data %>% 
  filter(str_detect(LAD19CD, "^E")) %>%
  filter(TacticalCell == "London") %>% 
  ggplot() +
  geom_sf(mapping = aes(fill = res_score),
          color = "black",
          size = 0.1) +
  scale_fill_viridis(
    breaks = seq(1, 10, by = 1),
    labels = seq(1, 10, by = 1),
    na.value = "transparent",
    option = "magma",
    name = expression(paste("Overall Resilience \nScore")),
    alpha = 0.8, # make fill a bit brighter
    begin = 0.1, # this option seems to be new (compared to 2016):
    # with this we can truncate the
    # color scale, so that extreme colors (very dark and very bright) are not
    # used, which makes the map a bit more aesthetic
    end = 0.9,
    discrete = F, # discrete classes, thus guide_legend instead of _colorbar
    direction = -1, # dark is lowest, yellow is highest
    guide = guide_legend(
      keyheight = unit(5, units = "mm"),
      title.position = "top",
      reverse = T)) +
  theme_void()

ggsave(filename = "bespoke vulnerability index - resilience/London-resilience.png")


# ---- Get ethnicity data from Annual Population Survey ----
library(nomisr)

# - Percentage of population who are {white or ethnic minority} and {UK born or not}
# - Percentage of working-age population who are {white or ethnic minority} and {UK born or not}
# - Unemployment rate: {white or ethnic minority} and {UK born or not}
# - Economic inactivity rate: {white or ethnic minority} and {UK born or not}
#
# Based on this URL: https://www.nomisweb.co.uk/api/v01/dataset/NM_17_5.jsonstat.json?geography=1811939329...1811939332,1811939334...1811939336,1811939338...1811939497,1811939499...1811939501,1811939503,1811939505...1811939507,1811939509...1811939517,1811939519,1811939520,1811939524...1811939570,1811939575...1811939599,1811939601...1811939628,1811939630...1811939634,1811939636...1811939647,1811939649,1811939655...1811939664,1811939667...1811939680,1811939682,1811939683,1811939685,1811939687...1811939704,1811939707,1811939708,1811939710,1811939712...1811939717,1811939719,1811939720,1811939722...1811939730,943718401...943718419,943718421...943718463,943718465...943718497,943718499...943718512,943718420,943718464,943718498&date=latest&variable=861...868,873...880&measures=20599,21001,21002,21003
#
aps_raw = nomis_get_data(
  id = "NM_17_5",
  date = "latest",
  geography = "TYPE432",  # 2019 LAD
  variable = "861...864", #"868,873...880",
  measures = "20599", #,21001,21002,21003",
  
  # variables to keep
  select = c(
    "GEOGRAPHY_CODE",
    "VARIABLE_NAME",
    "MEASURES_NAME",
    "OBS_VALUE"
  )
)

aps = aps_raw %>% 
  filter(MEASURES_NAME == "Variable") %>% 
  select(LAD19CD = GEOGRAPHY_CODE, Variable = VARIABLE_NAME, Value = OBS_VALUE) %>% 

  pivot_wider(names_from = Variable, values_from = Value) %>% 
  
  # sum both 'ethnic minority' columns
  rowwise() %>% 
  mutate(`Percentage of population with BAME backgrounds` = sum(c(`Percentage of population who are ethnic minority UK born`, `Percentage of population who are ethnic minority not UK born`), na.rm = TRUE)) %>% 
  ungroup()


# ---- Save list of LAs on watchlist with their resilience scores ----
# Local Authority Districts (December 2019) Names and Codes in the United Kingdom
lads = read_csv("https://opendata.arcgis.com/datasets/35de30c6778b463a8305939216656132_0.csv")

res_index %>% 
  left_join(watchlist, by = "LAD19CD") %>% 
  left_join(lads %>% select(LAD19CD, LAD19NM), by = "LAD19CD") %>% 
  left_join(aps, by = "LAD19CD") %>% 
  
  relocate(LAD19CD, LAD19NM, watchlist_status) %>% 
  
  # filter(str_detect(LAD19CD, "^E") & watchlist_status != "No interventions") %>% 
  
  write_csv("bespoke vulnerability index - resilience/resilience in watchlist LAs.csv")
