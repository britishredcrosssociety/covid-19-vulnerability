# ---- Load libraries ----
library(tidyverse)
library(sf)
library(viridis)

# ---- Load data ----
res_index <- read_csv("bespoke vulnerability index - resilience/resilience-index-la.csv")
la_shp <- read_sf("output/vulnerability-LA.geojson")
tc_lookup <- read_csv("data/lookup mosa11 to lad17 to lad19 to tactical cell.csv")
watchlist <- read_csv("bespoke vulnerability index - resilience/data/la-watchlist.csv")

# ---- Clean data ----
res_score <-
  res_index %>% 
  select(LAD19CD,
         res_score = `Resilience decile`)

tc_lookup <-
  tc_lookup %>% 
  distinct(LAD19CD, TacticalCell)

la_shp <-
  la_shp %>% 
  select(LAD19CD = Code,
         geometry)

watchlist <-
  watchlist %>% 
  select(LAD19CD, watchlist_status)

data <-
  la_shp %>% 
  left_join(res_score, by = "LAD19CD") %>% 
  left_join(tc_lookup, by = "LAD19CD") %>% 
  left_join(watchlist, by = "LAD19CD")
  
# ---- Plot ----
plot_la <- ggplot(shp_la) +
  geom_sf(mapping = aes(fill = Vulnerability_q),
          color = "black",
          size = 0.1) +
  scale_fill_viridis(
    breaks = seq(1, 5, by = 1),
    labels = seq(1, 5, by = 1),
    na.value = "transparent",
    option = "magma",
    name = expression(paste("Vulnerability \nQuintile")),
    alpha = 0.8, # make fill a bit brighter
    begin = 0.1, # this option seems to be new (compared to 2016):
    # with this we can truncate the
    # color scale, so that extreme colors (very dark and very bright) are not
    # used, which makes the map a bit more aesthetic
    end = 0.9,
    discrete = F, # discrete classes, thus guide_legend instead of _colorbar
    direction = -1, # dark is lowest, yellow is highest
    guide = guide_legend(
      keyheight = unit(5, units = "mm"),
      title.position = "top",
      reverse = T)) +
  theme(plot.margin = unit(c(0.5, 1.5, 0.5, 1.5), "cm"))

plot_msoa <- ggplot(shp_msoa) +
  geom_sf(mapping = aes(fill = decile),
          color = "black",
          size = 0.05) +
  scale_fill_viridis(
    breaks = seq(1, 10, by = 1),
    labels = seq(1, 10, by = 1),
    na.value = "transparent",
    option = "magma",
    name = expression(paste("Vulnerability \nDecile")),
    alpha = 0.8, # make fill a bit brighter
    begin = 0.1, # this option seems to be new (compared to 2016):
    # with this we can truncate the
    # color scale, so that extreme colors (very dark and very bright) are not
    # used, which makes the map a bit more aesthetic
    end = 0.9,
    discrete = F, # discrete classes, thus guide_legend instead of _colorbar
    direction = -1, # dark is lowest, yellow is highest
    guide = guide_legend(
      keyheight = unit(5, units = "mm"),
      title.position = "top",
      reverse = T)) +
  theme_map() +
  theme(plot.margin = unit(c(0.5, 1.5, 0.5, 1.5), "cm"))

plot_la + plot_msoa + plot_annotation(
  tag_levels = 'a',
  title = "LA (a) and MSOA (b) vulnerability index scores",
  subtitle = "Coloured by vulnerability quintiles (a) and deciles (b)",
  caption = "Code: https://github.com/britishredcrosssociety/covid-19-vulnerability/",
  theme = theme_map()
)

ggsave(filename = "maps/uk-vi-msoa-la.png",
       width = 18,
       height = 14)

