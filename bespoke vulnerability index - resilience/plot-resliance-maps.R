# ---- Load libraries ----
library(tidyverse)
library(sf)
library(viridis)

# ---- Load data ----
res_index <- read_csv("bespoke vulnerability index - resilience/resilience-index-la.csv")
la_shp <- read_sf("output/vulnerability-LA.geojson")
tc_lookup <- read_csv("data/lookup mosa11 to lad17 to lad19 to tactical cell.csv")
watchlist <- read_csv("bespoke vulnerability index - resilience/data/la-watchlist.csv")

# ---- Clean data ----
res_score <-
  res_index %>% 
  select(LAD19CD,
         res_score = `Resilience decile`)

tc_lookup <-
  tc_lookup %>% 
  distinct(LAD19CD, TacticalCell)

la_shp <-
  la_shp %>% 
  select(LAD19CD = Code,
         geometry)

watchlist <-
  watchlist %>% 
  select(LAD19CD, watchlist_status)

data <-
  la_shp %>% 
  left_join(res_score, by = "LAD19CD") %>% 
  left_join(tc_lookup, by = "LAD19CD") %>% 
  left_join(watchlist, by = "LAD19CD")
  
# ---- Plot ----
# - England - 
data %>% 
  filter(str_detect(LAD19CD, "^E")) %>% 
  mutate(res_score = as.integer(res_score),
         res_score = if_else(watchlist_status == "No interventions",
                             NA_integer_,
                             res_score)) %>% 
  ggplot() +
  geom_sf(mapping = aes(fill = res_score),
          color = "black",
          size = 0.1) +
  scale_fill_viridis(
    breaks = seq(1, 10, by = 1),
    labels = seq(1, 10, by = 1),
    na.value = "transparent",
    option = "magma",
    name = expression(paste("Overall Resilience \nScore")),
    alpha = 0.8, # make fill a bit brighter
    begin = 0.1, # this option seems to be new (compared to 2016):
    # with this we can truncate the
    # color scale, so that extreme colors (very dark and very bright) are not
    # used, which makes the map a bit more aesthetic
    end = 0.9,
    discrete = F, # discrete classes, thus guide_legend instead of _colorbar
    direction = -1, # dark is lowest, yellow is highest
    guide = guide_legend(
      keyheight = unit(5, units = "mm"),
      title.position = "top",
      reverse = T)) +
  theme_void()

ggsave(filename = "bespoke vulnerability index - resilience/England-local-lockdown-resilience.png")

# - London -
data %>% 
  filter(str_detect(LAD19CD, "^E")) %>%
  filter(TacticalCell == "London") %>% 
  ggplot() +
  geom_sf(mapping = aes(fill = res_score),
          color = "black",
          size = 0.1) +
  scale_fill_viridis(
    breaks = seq(1, 10, by = 1),
    labels = seq(1, 10, by = 1),
    na.value = "transparent",
    option = "magma",
    name = expression(paste("Overall Resilience \nScore")),
    alpha = 0.8, # make fill a bit brighter
    begin = 0.1, # this option seems to be new (compared to 2016):
    # with this we can truncate the
    # color scale, so that extreme colors (very dark and very bright) are not
    # used, which makes the map a bit more aesthetic
    end = 0.9,
    discrete = F, # discrete classes, thus guide_legend instead of _colorbar
    direction = -1, # dark is lowest, yellow is highest
    guide = guide_legend(
      keyheight = unit(5, units = "mm"),
      title.position = "top",
      reverse = T)) +
  theme_void()

ggsave(filename = "bespoke vulnerability index - resilience/London-resilience.png")
