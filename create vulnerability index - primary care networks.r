##
## Aggregate VI into Primary Care Networks (PCNs)
##
library(tidyverse)
library(readxl)
library(sf)


# ---- Build Primary Care Network boundaries ----
# PCNs don't have boundaries as such, but we can build them from the boundaries of their member GPs

# Load GP Practice Submitted Inner Catchment Area
# Source: https://data.england.nhs.uk/dataset/gp-practice-submitted-inner-catchment-area-kml-file
# Using the latest data we can find: 2019_03_KML_Data
gp_shp = read_sf("data/boundaries/GP_Catchment_Area.kml")

# Some GPs have more than one polygon - merge them
gp_shp = gp_shp %>% 
  group_by(Name) %>% 
  summarise()

# Split `Name` column into Codes and Names
gp_shp = gp_shp %>% 
  separate(Name, c("Code", "Name"), sep = " - ")

# Load GP to PCN lookup
# Source: `epcn` file from https://digital.nhs.uk/services/organisation-data-service/data-downloads/gp-and-gp-practice-related-data
gp_pcn = read_excel("data/primary-care-networks/ePCN.xlsx", sheet = "PCN Core Partner Details")

gp_pcn = gp_pcn %>% 
  select(GP_Code = `Partner\r\nOrganisation\r\nCode`, GP_Name = `Partner\r\nName`, PCN_Code = `PCN Code`, PCN_Name = `PCN Name`)

pcn_shp_all = gp_shp %>% 
  left_join(gp_pcn, by = c("Code" = "GP_Code")) %>% 
  filter(!is.na(PCN_Code))

pcn_shp = pcn_shp_all %>% 
  group_by(PCN_Code, PCN_Name) %>% 
  summarise()

write_csv(pcn_shp, "data/boundaries/Primary_Care_Networks.shp")
