##
## Aggregate VI into Primary Care Networks (PCNs)
##
library(tidyverse)
library(readxl)
library(sf)

source("functions.r")

# ---- Build Primary Care Network boundaries ----
# PCNs don't have boundaries as such, but we can build them from the boundaries of their member GPs

# Load GP Practice Submitted Inner Catchment Area
# Source: https://data.england.nhs.uk/dataset/gp-practice-submitted-inner-catchment-area-kml-file
# Using the latest data we can find: 2019_03_KML_Data
# gp_shp = read_sf("data/boundaries/GP_Catchment_Area.kml")

# Load GP submitted inner catchment areas - Jan-Mar 2020
# Source: https://digital.nhs.uk/data-and-information/data-collections-and-data-sets/data-collections/general-practice-data-collections
gp_shp = read_sf("https://files.digital.nhs.uk/assets/eDEC/eDecJan-Mar2020.kml")

# Some GPs have more than one polygon - merge them
gp_shp = gp_shp %>% 
  group_by(Name) %>% 
  summarise()

# Split `Name` column into Codes and Names
gp_shp = gp_shp %>% 
  separate(Name, c("Code", "Name"), sep = " - ")

# Load GP to PCN lookup
# Source: `epcn` file from https://digital.nhs.uk/services/organisation-data-service/data-downloads/gp-and-gp-practice-related-data
gp_pcn = read_excel("data/primary-care-networks/ePCN.xlsx", sheet = "PCN Core Partner Details")

gp_pcn = gp_pcn %>% 
  select(GP_Code = `Partner\r\nOrganisation\r\nCode`, GP_Name = `Partner\r\nName`, PCN_Code = `PCN Code`, PCN_Name = `PCN Name`)

pcn_shp_all = gp_shp %>% 
  left_join(gp_pcn, by = c("Code" = "GP_Code")) %>% 
  filter(!is.na(PCN_Code))

pcn_shp = pcn_shp_all %>% 
  group_by(PCN_Code, PCN_Name) %>% 
  summarise()

write_csv(pcn_shp, "data/boundaries/Primary_Care_Networks.shp")


# TO DO:
# - Some parts of some MSOAs might be in multiple PCNs and a PCN contains multiple (parts of) MSOAs...
# - ... so calculate population-weighted vulnerability based on proportion of population in each PCN
#
# ---- Create lookup for MSOAs to PCNs based on centroids ----
# Middle Layer Super Output Areas (December 2011) Population Weighted Centroids
# Source: https://geoportal.statistics.gov.uk/datasets/middle-layer-super-output-areas-december-2011-population-weighted-centroids
# msoa_centroids = read_sf("https://opendata.arcgis.com/datasets/b0a6d8a3dc5d4718b3fd62c548d60f81_0.geojson") %>% 
#   st_transform(crs = 4326)
# 
# # Lookup the PCN each MSOA centroid is in
# msoa_pcn = msoa_centroids %>% 
#   st_join(pcn_shp) %>% 
#   st_drop_geometry() %>% 
#   select(MSOA11CD = msoa11cd, PCN_Code)
# 
# 
# # ---- Aggregate VI into PCNs ----
# # - Load data -
# vi_msoa = read_sf("output/vulnerability-MSOA-UK.geojson")  # run "create vulnerability index - MSOA.r" to make this dataset
# pop = read_csv("data/population estimates msoa11 lad17 lad19 tacticall cell.csv")



