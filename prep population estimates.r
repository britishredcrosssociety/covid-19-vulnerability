##
## Prep population estimates
##
library(tidyverse)
library(readxl)
library(readODS)
library(httr)

##
## England - from MSOA population estimates
## source: https://www.ons.gov.uk/peoplepopulationandcommunity/populationandmigration/populationestimates/datasets/middlesuperoutputareamidyearpopulationestimates
##
GET("https://www.ons.gov.uk/file?uri=%2fpeoplepopulationandcommunity%2fpopulationandmigration%2fpopulationestimates%2fdatasets%2fmiddlesuperoutputareamidyearpopulationestimates%2fmid2018sape21dt3a/sape21dt3amid2018msoaon2019lasyoaestimatesformatted.zip",
    write_disk(tf <- tempfile(fileext = ".zip")))

unzip(tf, exdir = "data/population")
unlink(tf); rm(tf)

pop_eng = read_excel("data/population/SAPE21DT3a-mid-2018-msoa-on-2019-LA-syoa-estimates-formatted.xlsx", sheet = "Mid-2018 Persons", skip = 4)

pop_eng = pop_eng %>% 
  filter(!is.na(MSOA)) %>%  # drop Local Authorities
  
  # convert age columns to long format
  rename(`90` = `90+`) %>% 
  pivot_longer(cols = `0`:`90`, names_to = "Age", values_to = "n_people") %>% 
  mutate(Age = as.integer(Age)) %>% 
  
  rename(Code = `Area Codes`) %>% 
  
  # sum whole population and people over 70
  group_by(Code) %>% 
  summarise(`No. people` = sum(n_people),
            `No. people over 70` = sum(n_people[Age >= 70], na.rm = TRUE)) %>% 
  
  mutate(`Proportion people over 70` = `No. people over 70` / `No. people`)

pop_eng_older = pop_eng %>% 
  select(Code, `Proportion people over 70`)


##
## Scotland Intermediate Zone (2011) Population Estimates
## source: https://www.opendata.nhs.scot/dataset/population-estimates/resource/93df4c88-f74b-4630-abd8-459a19b12f47
##
pop_sco = read_csv("https://www.opendata.nhs.scot/dataset/7f010430-6ce1-4813-b25c-f7f335bdc4dc/resource/93df4c88-f74b-4630-abd8-459a19b12f47/download/iz2011-pop-est_02042020.csv")

pop_sco = pop_sco %>% 
  filter(Year == max(Year)) %>% 
  
  # sum across males and females
  group_by(IntZone) %>% 
  summarise_at(vars(contains("Age")), sum) %>% 
  
  pivot_longer(cols = Age0:Age90plus, names_to = "Age", values_to = "n_people") %>% 
  mutate(Age = as.integer(str_extract(Age, "[0-9]+"))) %>%    # extract ages as numbers
  rename(Code = IntZone) %>% 
  
  # sum whole population and people over 70
  group_by(Code) %>% 
  summarise(`No. people` = sum(n_people),
            `No. people over 70` = sum(n_people[Age >= 70], na.rm = TRUE)) %>% 
  
  mutate(`Proportion people over 70` = `No. people over 70` / `No. people`)

pop_sco_older = pop_sco %>% 
  select(Code, `Proportion people over 70`)


##
## NI population estimates 2018
##
GET("https://www.ninis2.nisra.gov.uk/Download/Population/Population%20Totals%20(statistical%20geographies).ods",
    write_disk(tf <- tempfile(fileext = ".ods")))

pop_ni = read_ods(tf, sheet = "SOA", skip = 3)
names(pop_ni)[names(pop_ni) == "Persons"] = as.character(2019:2001)

unlink(tf); rm(tf)

pop_ni = pop_ni %>% select(Code = `SOA Code`, `No. people` = `2019`)

# combine UK population estimates
pop = pop_eng %>% 
  select(Code, `No. people`) %>% 
  bind_rows(pop_sco %>% select(Code, `No. people`)) %>% 
  bind_rows(pop_ni  %>% select(Code, `No. people`))

# ---- Calculate estimates across LA's and tactical cells ----
# Load lookup table
lookup <- read_csv("data/lookup mosa11 to lad17 to lad19 to tactical cell.csv")

# Join to pop tables
pop_lookup <- pop %>% 
  left_join(lookup, by = c("Code" = "MSOA11CD")) %>% 
  rename(MSOA11CD = Code,
         num_people = `No. people`) %>% 
  relocate(num_people, .after = TacticalCell)

# Remove error in pop table for MSOA code "S92000003" which states a population of 10,876,200
# which is twice the population of Scotland
pop_lookup <- pop_lookup %>% 
  filter(MSOA11CD != "S92000003")

# Calculate population estimates for each geographic level
pop_estimates <- pop_lookup %>% 
  group_by(LAD17CD) %>% 
  mutate(pop_lad17 = sum(num_people)) %>% 
  ungroup() %>% 
  group_by(LAD19CD) %>% 
  mutate(pop_lad19 = sum(num_people)) %>% 
  ungroup() %>% 
  group_by(TacticalCell) %>% 
  mutate(pop_tacticalcell = sum(num_people)) %>% 
  ungroup() %>% 
  rename(pop_msoa11 = num_people)

# Save
write_csv(pop_estimates, "data/population estimates msoa11 lad17 lad19 tacticall cell.csv")
