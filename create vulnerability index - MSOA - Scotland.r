##
## MSOA-level vulnerability index for Scotland
##
library(tidyverse)
library(readxl)
library(httr)
library(sf)
library(rmapshaper)

source("functions.r")
source("load lookup tables.r")

lookup_dz_iz = load_lookup_dz_iz_lad() %>% 
  select(LSOA11CD, MSOA11CD)

lookup_iz_names = load_lookup_dz_iz_lad() %>% 
  select(Code = MSOA11CD, Name = MSOA11NM) %>% 
  distinct()


###############################################################################
## Load and prep all data sources
##

# vulnerability indicator ranks and z-scores provided by the Scottish Public Health Observator, used in their version of a vulnerability index: https://scotland.shinyapps.io/scotpho-covid-vulnerability/
pho = read_csv("data/scotland-clinical-data-processed.csv")

# sort(unique(pho$indicator))

##
## clinical vulnerability
##
clinical_indicator_names = c(
  "Alcohol-related hospital admissions", 
  "Asthma patient hospitalisations",
  "Cancer registrations",
  "Chronic obstructive pulmonary disease (COPD) patient hospitalisations",
  "Coronary heart disease (CHD) patient hospitalisations",
  # "Deaths all ages",
  # "Deaths, aged 15-44 years",
  "Diabetes hospitalisations",
  "Early deaths from cancer, aged <75 years",
  "Early deaths from coronary heart disease (CHD), aged <75 years",
  # "Emergency patient hospitalisations",
  "Multiple emergency hospital admissions, aged >65 years",
  "Mid-year population estimate - aged 65+ years"
)

clinical_indicators = pho %>% 
  filter(indicator %in% clinical_indicator_names & areatype == "Intermediate zone") %>% 
  select(Code = code, indicator, rank_area) %>% 
  pivot_wider(names_from = indicator, values_from = rank_area)


##
## health and wellbeing
##
wellbeing_indicator_names = c(
  "Population prescribed drugs for anxiety/depression/psychosis",
  "Drug-related hospital admissions"
  # "Psychiatric patient hospitalisations"
)

wellbeing_indicators = pho %>% 
  filter(indicator %in% wellbeing_indicator_names & areatype == "Intermediate zone") %>% 
  select(Code = code, indicator, rank_area) %>% 
  pivot_wider(names_from = indicator, values_from = rank_area)


##
## economic vulnerability
##
economic_indicator_names = c(
  "Children in low income families",
  # "Population income deprived",
  "Working age population employment deprived"
)

economic_indicators = pho %>% 
  filter(indicator %in% economic_indicator_names & areatype == "Intermediate zone") %>% 
  select(Code = code, indicator, rank_area) %>% 
  pivot_wider(names_from = indicator, values_from = rank_area)


##
## social vulnerability
## - commenting out this set of indicators because most of them are only available for Council Areas (Scotland's Local Authorities)
## - the only one available for Intermediate Zones is 'single adult dwellings' but the evidence suggests people in overcrowded accommodation are more vulnerable
##
# social_indicator_names = c(
#   "Children on the child protection register",
#   "Children registered for free school meals",
#   "Households with children living in fuel poverty",
#   "People aged 65+ with high levels of care needs who are cared for at home",
#   
#   "Single adult dwellings"
# )
# 
# social_indicators = pho %>% 
#   filter(indicator %in% social_indicator_names & areatype == "Intermediate zone") %>% 
#   select(Code = code, indicator, rank_area) %>% 
#   pivot_wider(names_from = indicator, values_from = rank_area)


##
## OCSI indicators
##
source("prep ocsi data - scotland.r")

ocsi_economic = ocsi_sco %>% 
  select(Code,
         `Older people social care benefit (Attendance Allowance) Rate`,
         `Employment and Support Allowance claimants, disease code nervous system Rate`,
         `Employment and Support Allowance claimants, disease code respiratory or circulatory Rate`,
         `Disability benefit (DLA) Rate`, 
         `Workless through sickness benefit (IB/ESA) Rate`, 
         `Personal Independence Payment (PIP), respiratory disease claimants Rate`,
         `Households on Universal Credit - Limited Capability for Work Entitlement Rate`,
         `Universal Credit claimants - Conditionality Regime: No work requirements Rate`, 
         `Pensioners in poverty (Pension Credit) Rate`,
         
         `Jobs in accommodation and food services (hospitality) Rate`, 
         `Jobs in arts, entertainment, recreation and other services Rate`, 
         `Jobs in retail Rate`, 
         `Jobs in transport and storage (inc postal) Rate`)

##
## loneliness risks
## source: https://github.com/matthewgthomas/loneliness
##
loneliness = read_csv("https://github.com/matthewgthomas/loneliness/raw/master/Scotland/msoa_loneliness.csv") %>% 
  select(Code = InterZone, Loneliness = loneills_2018)


##
## indicators from Scottish Index of Multiple Deprivation 2020
## source: https://www.gov.scot/publications/scottish-index-of-multiple-deprivation-2020-indicator-data2/
##
GET("https://www.gov.scot/binaries/content/documents/govscot/publications/statistics/2020/01/scottish-index-of-multiple-deprivation-2020-indicator-data/documents/simd_2020_indicators/simd_2020_indicators/govscot%3Adocument/SIMD_2020_Indicators.xlsx",
    write_disk(tf <- tempfile(fileext = ".xlsx")))

imd_indicators = read_excel(tf, sheet = "Data")
unlink(tf); rm(tf)

imd_social_dz = imd_indicators %>% 
  select(Data_Zone, drive_GP, drive_retail, drive_post, Broadband, overcrowded_rate, nocentralheat_rate)

imd_social_iz = imd_social_dz %>% 
  left_join(lookup_dz_iz, by = c("Data_Zone" = "LSOA11CD")) %>% 
  rename(Code = MSOA11CD) %>% 

  # summarise into Intermediate Zones
  group_by(Code) %>% 
  summarise(
    `Longest drive time to a GP surgery (minutes)` = max(drive_GP),
    `Longest drive time to a retail centre (minutes)` = max(drive_retail),
    `Longest drive time to a Post Office (minutes)` = max(drive_post),
    # `% premises without access to superfast broadband` = max(Broadband),  # will use the CACI digital exclusion data instead
    `% people in households that are overcrowded ` = max(overcrowded_rate),
    `% people in households without central heating` = max(nocentralheat_rate)
  )


##
## Load distance to food banks
##
foodbank_distance = read_csv("data/foodbank/nearest-foodbanks-lsoas.csv")  # produced by `prep food bank accessibility.py`

# similar to road distances in the IMD data, calculate longest mean distance
foodbank_distance = foodbank_distance %>% 
  select(LSOA11CD = lsoa11cd, mean_distance_nearest_three_foodbanks) %>% 
  mutate(mean_distance_nearest_three_foodbanks = mean_distance_nearest_three_foodbanks / 1000) %>%  # convert to km
  
  # merge MSOA codes
  left_join(lookup_dz_iz, by = "LSOA11CD") %>% 
  
  # take further mean distance to a hospital for LSOAs within an MSOA
  group_by(MSOA11CD) %>% 
  summarise(`Longest distance to food bank (km)` = max(mean_distance_nearest_three_foodbanks)) %>% 
  rename(Code = MSOA11CD)


##
## Load digital exclusion
##
digital_exclusion = read_csv("data/CACI/digital-exclusion-msoa.csv")

##
## financial vulnerability (from CACI)
##
fin_msoa = read_csv("data/CACI/financial-msoa.csv")
fin_msoa = fin_msoa %>% select(Code = MSOA11CD, `Financial Vulnerability score`)

# ---- Load access to gardens ----
gardens <- read_excel("data/green-space-access/garden-space-2020.xlsx", sheet = "MSOA gardens") %>% 
  mutate(`Percentage of adresses with private outdoor space (reverse ranked)` = invert_this(rank(`Percentage of adresses with private outdoor space`))) %>% 
  select(Code = `MSOA code`,
         `Percentage of adresses with private outdoor space (reverse ranked)`)

# ---- Load access to parks and playing fields ----
parks <- read_excel("data/green-space-access/parks-playing-fields-2020.xlsx", sheet = "LSOA Parks and Playing Fields") %>% 
  select(Code= `MSOA code`,
         `Average distance to nearest Park, Public Garden, or Playing Field (m)`) %>% 
  group_by(Code) %>% 
  mutate(`Average distance to nearest Park, Public Garden, or Playing Field (m)` = mean(`Average distance to nearest Park, Public Garden, or Playing Field (m)`)) %>% 
  ungroup() %>% 
  distinct()


###############################################################################

# ---- Calculate scores for each domain of vulnerability ----
# Methodology:
# 1. Combine data to create domains (e.g., clinical, health and wellbeing, etc.)
# 2. Create weighted domain scores for each MSOA using unsupervised learning.
#    See weighted_domain_score() function in functions.r file for more details
#    on the methodology used.

# ---- Clinical vulnerability domain ----
# Use Maximum Likelihood Factor Analysis (MLFA) to determine weights
# as it is assumed indicators have a relationship
clinical = clinical_indicators %>% 
  
  # Use MLFA model
  weighted_domain_scores(model = "MLFA",
                         domain = "Clinical")

# ---- Health and wellbeing domain ----
# Use Principle Components Factor Analysis (PCA) to determine weights
# as it is assumed indicators do not have a clear relationship
health_wellbeing = wellbeing_indicators %>% 
  left_join(loneliness, by = "Code") %>% 
  
  # Join green space access data
  left_join(gardens, by = "Code") %>%
  left_join(parks, by = "Code") %>%

  # Use PCA model
  weighted_domain_scores(model = "PCA",
                         domain = "Health/Wellbeing")

# ---- Economic vulnerability domain ----
# Use Principle Components Factor Analysis (PCA) to determine weights
# as it is assumed indicators do not have a clear relationship
economic = economic_indicators %>% 
  left_join(ocsi_economic,  by = "Code") %>% 
  left_join(fin_msoa, by = "Code") %>% 
  
  # Use PCA model
  weighted_domain_scores(model = "PCA",
                         domain = "Economic")

# ---- Social vulnerability domain ----
# Split the domain into three separate subdomains - access, housing, and digital exclusion.
# The reason for splitting is there are three distinct subsets of indicators within the domain.
# Use MLFA to determine the weights for the housing and access subdomains and set air quality to have
# a weight of 1/3 of the overall domain.

# Calculate access vulnerability score
social_access <- imd_social_iz %>% 
  select(Code,
         `Longest drive time to a GP surgery (minutes)`,
         `Longest drive time to a Post Office (minutes)`, 
         `Longest drive time to a retail centre (minutes)`) %>% 
  
  left_join(foodbank_distance, by = "Code") %>% 
  
  weighted_domain_scores(model = "MLFA",
                         domain = "Access") %>% 
  select(-`Access Vulnerability rank`,
         -`Access Vulnerability decile`)

# Calculate housing vulnerability score
social_housing <- imd_social_iz %>% 
  select(Code, 
         `% people in households that are overcrowded `,
         `% people in households without central heating`) %>% 
  
  weighted_domain_scores(model = "PCA",
                         domain = "Housing") %>% 
  select(-`Housing Vulnerability rank`,
         -`Housing Vulnerability decile`)

# get digital vulnerability score and rank
social_digital <- digital_exclusion %>% 
  select(Code = MSOA11CD, `Digital Vulnerability score`, `Digital Vulnerability rank`)

# Combine subdomains
social <- social_access %>% 
  left_join(social_housing, by = "Code") %>% 
  left_join(social_digital, by = "Code")

# Calculate social domain score
social <- social %>% 
  mutate(`Access Vulnerability score` = `Access Vulnerability score`* (1/3),
         `Housing Vulnerability score` =  `Housing Vulnerability score` * (1/3),
         `Digital Vulnerability score` = `Digital Vulnerability score` * (1/3)) %>%
  
  mutate(`Social Vulnerability score` = reduce(select(., ends_with("Vulnerability score")), `+`)) %>% 
  mutate(`Social Vulnerability rank` = rank(`Social Vulnerability score`)) %>%
  mutate(`Social Vulnerability decile` = calc_risk_quantiles(`Social Vulnerability rank`, quants = 10)) %>% 
  select(-`Access Vulnerability score`, -`Housing Vulnerability score`, -`Digital Vulnerability score`)


###############################################################################
## Construct the overall MSOA-level vulnerability index
##
vulnerability = clinical %>% 
  # keep only vulnerability ranks for each domain
  select(Code, `Clinical Vulnerability rank`) %>% 
  
  left_join(health_wellbeing %>% select(Code, `Health/Wellbeing Vulnerability rank`),
            by = "Code") %>% 
  
  left_join(economic %>% select(Code, `Economic Vulnerability rank`),
            by = "Code") %>% 
  
  left_join(social %>% select(Code, `Social Vulnerability rank`),
            by = "Code") %>% 
  
  calc_domain_scores(rank.indicators = FALSE) %>% 
  
  select(Code, starts_with("Vulnerability"))

# ---- Construct a socioeconomic vulnerability index ----
vulnerability_se <- clinical %>%
  
  # keep only vulnerability ranks for each domain
  select(Code, `Clinical Vulnerability rank`) %>%
  
  left_join(health_wellbeing %>% select(Code, `Health/Wellbeing Vulnerability rank`),
            by = "Code") %>%
  
  left_join(economic %>% select(Code, ends_with("Vulnerability rank")),
            by = "Code") %>%
  
  left_join(social %>% select(Code, `Social Vulnerability rank`),
            by = "Code") %>%
  
  calc_domain_scores(domain = "Socioeconomic", rank.indicators = FALSE, clinical_weight = 0, health_weight = 0, economic_weight = 0.5, social_weight = 0.5) %>%
  
  select(Code, starts_with("Socioeconomic"))

##
## combine all domains and overall scores into one dataframe and save
##
vulnerability_all = clinical %>% 
  left_join(health_wellbeing, by = "Code") %>% 
  left_join(economic, by = "Code") %>% 
  left_join(social, by = "Code") %>% 
  left_join(vulnerability_se, by = "Code") %>%
  left_join(vulnerability, by = "Code") %>%
  
  # get MSOA names
  left_join(lookup_iz_names, by = "Code") %>% 
  
  select(Code, Name, everything())

# save
vulnerability_all %>% write_csv("output/vulnerability-MSOA-Scotland.csv")

# save a copy with only vulnerability scores
vulnerability_all %>% 
  select(Code, Name, contains("Vulnerability")) %>% 
  write_csv("output/vulnerability-scores-MSOA-Scotland.csv")


##
## save as geojson
##
# Intermediate zones
iz = read_sf("data/boundaries/SG_IntermediateZone_Bdry_2011.shp") %>% 
  st_transform(crs = 4326) %>% 
  ms_simplify(keep_shapes = T)

iz_vi = iz %>% 
  left_join(vulnerability_all, by = c("InterZone" = "Code")) %>% 
  mutate(`Socioeconomic Vulnerability quintile` = calc_risk_quantiles(`Socioeconomic Vulnerability rank`, quants = 5),
         `Vulnerability quintile` = calc_risk_quantiles(`Vulnerability rank`, quants = 5))

geojson_name = "output/vulnerability-MSOA-Scotland.geojson"
if (file.exists(geojson_name)) file.remove(geojson_name)

iz_vi %>% 
  # append a note to deciles and ranks
  rename_at(vars(matches("decile|rank")), ~ str_c(., " (1 = least vulnerable)")) %>% 
  
  select(Code = InterZone, Name = Name.x, `Alcohol-related hospital admissions`:`Vulnerability quintile`) %>% 
  write_sf(geojson_name)


##
## checking and debugging
##
# check that it's not just giving high vulnerability scores to larger MSOAs (which it shouldn't necessarily)
# the correlation is not statistically significant is tiny (r = 0.009884844), so nothing to worry about
cor.test(~ StdAreaKm2 + `Vulnerability rank`, data = iz_vi)

# get most and least vulnerable MSOAs to check their underlying indicators look correct (they do)
test = vulnerability_all %>% filter(`Vulnerability rank` %in% c(1, nrow(vulnerability_all)))

# check relationship between socioeconomic vulnerability and overall vulnerability; cor = 0.9427326
vulnerability_all %>% ggplot(aes(x = `Vulnerability rank`, `Socioeconomic Vulnerability rank`)) + geom_point(alpha = 0.1) + geom_smooth()
cor.test(~ `Vulnerability rank` + `Socioeconomic Vulnerability rank`, data = vulnerability_all)
