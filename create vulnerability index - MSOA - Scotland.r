##
## MSOA-level vulnerability index for Scotland
##
library(tidyverse)

library(readxl)
library(httr)
library(sf)

source("functions.r")
source("load lookup tables.r")

lookup_dz_iz = load_lookup_dz_iz_lad() %>% 
  select(LSOA11CD, MSOA11CD)

lookup_iz_names = load_lookup_dz_iz_lad() %>% 
  select(Code = MSOA11CD, Name = MSOA11NM) %>% 
  distinct()


###############################################################################
## Load and prep all data sources
##

# vulnerability indicator ranks and z-scores provided by the Scottish Public Health Observator, used in their version of a vulnerability index: https://scotland.shinyapps.io/scotpho-covid-vulnerability/
pho = read_csv("data/scotland-clinical-data-processed.csv")

# sort(unique(pho$indicator))

##
## clinical vulnerability
##
clinical_indicators = c(
  "Alcohol-related hospital admissions", 
  "Asthma patient hospitalisations",
  "Cancer registrations",
  "Chronic obstructive pulmonary disease (COPD) patient hospitalisations",
  "Coronary heart disease (CHD) patient hospitalisations",
  "Deaths all ages",
  "Deaths, aged 15-44 years",
  "Diabetes hospitalisations",
  "Drug-related hospital admissions",
  "Early deaths from cancer, aged <75 years",
  "Early deaths from coronary heart disease (CHD), aged <75 years",
  "Emergency patient hospitalisations",
  "Multiple emergency hospital admissions, aged >65 years",
  "Mid-year population estimate - aged 65+ years"
)

clinical_indicators = pho %>% 
  filter(indicator %in% clinical_indicators & areatype == "Intermediate zone") %>% 
  select(Code = code, indicator, rank_area) %>% 
  pivot_wider(names_from = indicator, values_from = rank_area)


##
## health and wellbeing
##
wellbeing_indicators = c(
  "Population prescribed drugs for anxiety/depression/psychosis",
  "Psychiatric patient hospitalisations"
)

wellbeing_indicators = pho %>% 
  filter(indicator %in% wellbeing_indicators & areatype == "Intermediate zone") %>% 
  select(Code = code, indicator, rank_area) %>% 
  pivot_wider(names_from = indicator, values_from = rank_area)


##
## social vulnerability
##
social_indicators = c(
  "Children in low income families",
  "Children on the child protection register",
  "Children registered for free school meals",
  "Households with children living in fuel poverty",
  "People aged 65+ with high levels of care needs who are cared for at home",
  "Single adult dwellings",
  "Population income deprived",
  "Working age population employment deprived"
)

social_indicators = pho %>% 
  filter(indicator %in% social_indicators & areatype == "Intermediate zone") %>% 
  select(Code = code, indicator, rank_area) %>% 
  pivot_wider(names_from = indicator, values_from = rank_area)


##
## loneliness risks
## source: https://github.com/matthewgthomas/loneliness
##
loneliness = read_csv("https://github.com/matthewgthomas/loneliness/raw/master/Scotland/msoa_loneliness.csv") %>% 
  select(Code = InterZone, Loneliness = loneills_2018)


##
## indicators from Scottish Index of Multiple Deprivation 2020
## source: https://www.gov.scot/publications/scottish-index-of-multiple-deprivation-2020-indicator-data2/
##
GET("https://www.gov.scot/binaries/content/documents/govscot/publications/statistics/2020/01/scottish-index-of-multiple-deprivation-2020-indicator-data/documents/simd_2020_indicators/simd_2020_indicators/govscot%3Adocument/SIMD_2020_Indicators.xlsx",
    write_disk(tf <- tempfile(fileext = ".xlsx")))

imd_indicators = read_excel(tf, sheet = "Data")
unlink(tf); rm(tf)

imd_social_dz = imd_indicators %>% 
  select(Data_Zone, drive_GP, drive_retail, Broadband, overcrowded_rate, nocentralheating_rate)

imd_social_iz = imd_social_dz %>% 
  left_join(lookup_dz_iz, by = c("Data_Zone" = "LSOA11CD")) %>% 
  rename(Code = MSOA11CD) %>% 

  # summarise into Intermediate Zones
  group_by(Code) %>% 
  summarise(
    `Longest drive time to a GP surgery (minutes)` = max(drive_GP),
    `Longest drive time to a retail centre (minutes)` = max(drive_retail),
    `% premises without access to superfast broadband` = max(Broadband),
    `% people in households that are overcrowded ` = max(overcrowded_rate),
    `% people in households without central heating` = max(nocentralheating_rate)
  )


###############################################################################
## Calculate scores for each domain of vulnerability
##
clinical = clinical_indicators %>% 
  calc_domain_scores(domain = "Clinical")

health_wellbeing = wellbeing_indicators %>% 
  left_join(loneliness, by = "Code") %>% 
  calc_domain_scores(domain = "Health/Wellbeing")

social = social_indicators %>% 
  left_join(imd_social_iz, by = "Code") %>% 
  calc_domain_scores(domain = "Social")


###############################################################################
## Construct the overall MSOA-level vulnerability index
##
vulnerability = clinical %>% 
  # keep only vulnerability ranks for each domain
  select(Code, `Clinical Vulnerability rank`) %>% 
  
  left_join(health_wellbeing %>% select(Code, `Health/Wellbeing Vulnerability rank`),
            by = "Code") %>% 
  
  left_join(social %>% select(Code, `Social Vulnerability rank`),
            by = "Code") %>% 
  
  calc_domain_scores(rank.indicators = FALSE) %>% 
  
  select(Code, starts_with("Vulnerability"))

##
## combine all domains and overall scores into one dataframe and save
##
vulnerability_all = clinical %>% 
  left_join(health_wellbeing, by = "Code") %>% 
  left_join(social, by = "Code") %>% 
  left_join(vulnerability, by = "Code") %>% 
  
  # get MSOA names
  left_join(lookup_iz_names, by = "Code") %>% 
  
  select(Code, Name, everything())

vulnerability_all %>% write_csv("output/vulnerability-MSOA-Scotland.csv")

# save a copy with only vulnerability scores
vulnerability_all %>% 
  select(Code, Name, contains("Vulnerability")) %>% 
  write_csv("output/vulnerability-scores-MSOA-Scotland.csv")


##
## checking and debugging
##
# get most and least vulnerable MSOAs to check their underlying indicators look correct (they do)
test = vulnerability_all %>% filter(`Vulnerability rank` %in% c(1, nrow(vulnerability_all)))
