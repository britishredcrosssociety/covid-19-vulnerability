##
## Create an index of multiple deprivation based on income, education, barriers to housing/services, and living environment
## - summarise these into wards by counting the proportion of a ward's LSOAs that are in the 20% most deprived in the country
## - for England only (at the moment)
##
## To do:
## - could include income deprivation affecting older people
## - population-weight the aggregated measures?
##
library(tidyverse)
library(httr)
library(readxl)
library(janitor)
library(Hmisc)
library(brclib)  # use `devtools::install_github("matthewgthomas/brclib")` if you need to install this

source("load lookup tables.r")
lsoa_ward = load_lookup_lsoa_ward(2017)


###############################################################################
## Create an index of multiple deprivation for income, employment, barriers and environment
## - following instructions in Appendix C of https://assets.publishing.service.gov.uk/government/uploads/system/uploads/attachment_data/file/833947/IoD2019_Research_Report.pdf
##
# download transformed domain scores from https://www.gov.uk/government/statistics/english-indices-of-deprivation-2019 (File 9)
GET("https://assets.publishing.service.gov.uk/government/uploads/system/uploads/attachment_data/file/833994/File_9_-_IoD2019_Transformed_Scores.xlsx",
    write_disk(tf <- tempfile(fileext = ".xlsx")))

imd_scores = read_excel(tf, sheet = "IoD2019 Transformed Scores")  # check the sheet name is still valid if you're updating the URL above
unlink(tf); rm(tf)

# create the mutiple deprivation index, using recommended weightings
# uncomment the commented lines to replicate the full IMD, to check this process works (it does)
imd_covid = imd_scores %>% 
  select(LSOA11CD = `LSOA code (2011)`, Income = `Income Score - exponentially transformed`, Employment = `Employment Score - exponentially transformed`
         , Barriers = `Barriers Score - exponentially transformed`, Environment = `Living Environment Score - exponentially transformed`
         # , Education = `Education Score - exponentially transformed`, Health = `Health Score - exponentially transformed`, Crime = `Crime Score - exponentially transformed`
  ) %>% 
  
  # rather than re-weight based on a subset of domains, the guidance says to set weighting for unused domains to zero, so we'll use the original weights here
  mutate(IMD_score = (Income * 22.5) + (Employment * 22.5) + (Barriers * 9.3) + (Environment * 9.3)
                   # + (Health * 13.5) + (Education * 13.5) + (Crime * 9.3)
  ) %>% 
  
  # calculate IMD rank
  mutate(IMD_rank = nrow(imd_scores) - rank(IMD_score) + 1) %>%   # need to reverse the scoring of R's ranking algorithm to get the same style of ranking as in IMD; add 1 to make it not zero-based
  
  # calculate IMD decile
  mutate(IMD_decile = as.integer(cut2(IMD_rank, g = 10)),
         IMD_quintile = as.integer(cut2(IMD_rank, g = 5)))


###############################################################################
## Calculate proportion of the most-deprived LSOAs in each ward
##
imd_covid_ward = imd_covid %>% 
  left_join(lsoa_ward, by = "LSOA11CD") %>% 
  
  # label LSOAs by whether they're in top 20% most-deprived then summarise by this label
  mutate(IMD_top20 = ifelse(IMD_decile <= 2, "Top20", "Other")) %>% 
  tabyl(WD17CD, IMD_top20) %>% 
  
  # calculate proportion of most deprived LSOAs
  mutate(Prop_top20 = Top20 / (Top20 + Other)) %>% 
  
  # split into quintiles
  # mutate(Deprivation_q = as.integer(cut2(Prop_top20, g = 5))) %>% 
  add_risk_quantiles("Prop_top20", "Deprivation", highest.number.is.worst = F) %>% 
  select(-Other, -Top20)
  
rm(imd_scores, lsoa_ward)
