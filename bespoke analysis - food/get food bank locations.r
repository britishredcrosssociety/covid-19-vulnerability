##
## food banks
##
library(tidyverse)
library(osmdata)
library(sf)
library(ggmap)


##
## download food bank locations from Trussell Trust website
##
tt_banks_url = "https://www.trusselltrust.org/get-help/find-a-foodbank/foodbank-search/?foodbank_s=all&callback=?"
tt_banks_str = RCurl::getURL(tt_banks_url)

# extract all latitudes and longitudes from the data
tt_banks_coords = str_match_all(tt_banks_str, "\"lat\":\"([-]*[0-9]+\\.[0-9]+)\",\"lng\":\"([-]*[0-9]+\\.[0-9]+)\"")

# keep only coordinates
tt_banks = tibble(Latitude = tt_banks_coords[[1]][, 2],
                  Longitude = tt_banks_coords[[1]][, 3]) %>% 
  # convert to spatial object
  st_as_sf(coords = c("Longitude", "Latitude"), crs = 4326)

# plot(tt_banks)  # appears there's one massive outlier

write_sf(tt_banks, "data/food-banks.geojson")


###############################################################################
## Get basemap, railways and roads from OSM
##
uk_bb = getbb("England")

# get all railway lines in Devon
foodbanks = opq(uk_bb) %>% 
  add_osm_feature("amenity", "social_facility") %>% 
  add_osm_feature("social_facility", "food_bank") %>% 
  osmdata_sf()

devon_map = get_stamenmap(devon_bb, maptype = "terrain", color = "bw")

ggmap(get_stamenmap(uk_bb, maptype = "terrain", color = "bw")) +
  coord_sf(crs = st_crs(3857)) + 
  
  # add floods and fires
  geom_sf(data = foodbanks)
