##
## Prevalence of underlying conditions
##
library(tidyverse)
library(httr)
library(sf)
# library(fingertipsR)  # their API wasn't available at the time of coding, but definitely want to use this in future

# Modelled Prevalence Estimates and GP practice addresses from https://fingertips.phe.org.uk/profile/prevalence/ (view the data then click the 'download' tab)
phe = read_csv("data/modelled-prevalence-estimates-indicators-GP.data.csv")
gp = read_csv("data/gp.addresses.csv")

# get COVID-related indicators for each GP
clinical = phe %>% 
  filter(`Area Type` == "GP") %>% 
  
  # keep only most relevant indicators to C-19: http://covid19-phenomics.org/
  filter(`Indicator Name` %in% c("Estimated prevalence of CHD (55-79 yrs)", "Estimated prevalence of Heart failure (16+)", 
                                 "Estimated prevalence of COPD (all ages)", "Estimated prevalence of peripheral arterial disease (PAD) (55-79 yrs)")) %>% 
  
  select(`Indicator Name`, Code = `Area Code`, Value) %>% 
  
  mutate(`Indicator Name` = str_replace(`Indicator Name`, " \\(.*\\)", "")) %>% 
  
  pivot_wider(names_from = `Indicator Name`, values_from = Value)

# categorise into quintiles and calculate an overall index based on the mean across quintiles
clinical = clinical %>%   
  # calculate quintiles for each indicator
  mutate(CHD_q =      as.integer(cut2(`Estimated prevalence of CHD`, g = 5))) %>% 
  mutate(COPD_q =     as.integer(cut2(`Estimated prevalence of COPD`, g = 5))) %>%
  mutate(HF_q =       as.integer(cut2(`Estimated prevalence of Heart failure`, g = 5))) %>% 
  mutate(Arterial_q = as.integer(cut2(`Estimated prevalence of peripheral arterial disease`, g = 5))) %>%
  
  # mutate(CHD_q =      ifelse(all(is.na(`Estimated prevalence of CHD`)), NA, as.integer(cut2(`Estimated prevalence of CHD`, g = 5)))) %>% 
  # mutate(COPD_q =     ifelse(all(is.na(`Estimated prevalence of COPD`)), NA, as.integer(cut2(`Estimated prevalence of COPD`, g = 5)))) %>% 
  # mutate(HF_q =       ifelse(all(is.na(`Estimated prevalence of Heart failure`)), NA, as.integer(cut2(`Estimated prevalence of Heart failure`, g = 5)))) %>% 
  # mutate(Arterial_q = ifelse(all(is.na(`Estimated prevalence of peripheral arterial disease`)), NA, as.integer(cut2(`Estimated prevalence of peripheral arterial disease`, g = 5)))) %>%
  
  # calculate 'clinical vulnerability' index based on the mean of the quintiles
  rowwise() %>% 
  mutate(Clinical_Risk = mean(c(CHD_q, COPD_q, HF_q, Arterial_q), na.rm = T)) %>% 
  ungroup() %>% 
  
  filter(!is.na(Clinical_Risk))  # drop any GP practices where the risk index is NA or NaN - it means there were no indicators for that GP


###############################################################################
## Geocode the GP surgeries
##
# download and unzip the ONS Postcode Directory (February 2020): https://geoportal.statistics.gov.uk/datasets/ons-postcode-directory-february-2020
GET("https://www.arcgis.com/sharing/rest/content/items/82889274464b48ae8bf3e9458588a64b/data",
    write_disk(tf <- tempfile(fileext = ".zip")))

unzip(tf, exdir = "data/postcodes")
unlink(tf); rm(tf)

# load postcode directory and keep only relevant fields
postcodes_raw = read_csv("data/postcodes/Data/ONSPD_FEB_2020_UK.csv")
postcodes = postcodes_raw %>% select(Postcode = pcd, Longitude = long, Latitude = lat, oseast1m, osnrth1m)

# the ONS data truncates 7-character postcodes to remove spaces (e.g. CM99 1AB --> CM991AB); get rid of all spaces in both datasets to allow merging
postcodes$Postcode2 = gsub(" ", "", postcodes$Postcode)
gp$Postcode2 = gsub(" ", "", gp$Postcode)

# geocode the GP surgeries
clinical_geo = clinical %>% 
  left_join(gp %>% select(Code, Name, Postcode2), by = "Code") %>% 
  left_join(postcodes, by = "Postcode2")

# don't need the truncated columns anymore
clinical_geo$Postcode2 = NULL

# save the file for clustering analysis in Python script (if needed)
write_csv(clinical_geo, "data/clinical-vulnerability.csv")


###############################################################################
## Aggregate GP surgeries' clinical vulnerability scores based on which wards they're in
##
# Wards (December 2019) Boundaries EW BGC
# source: https://geoportal.statistics.gov.uk/datasets/wards-december-2019-boundaries-ew-bgc
#wards = read_sf("https://opendata.arcgis.com/datasets/bf1a23cfe83f4da9844e7f34e4824d03_0.geojson")

# Wards (December 2017) Generalised Clipped Boundaries in UK (WGS84)
# source: https://geoportal.statistics.gov.uk/datasets/wards-december-2017-generalised-clipped-boundaries-in-uk-wgs84
wards = read_sf("https://opendata.arcgis.com/datasets/7193daa99995445aa84a0b23352e56a1_2.geojson")

clinical_wards = clinical_geo %>% 
  # convert clinical_geo to spatial object
  st_as_sf(coords = c("Longitude", "Latitude"), crs = 4326) %>% 

  # look up which ward each GP is in
  st_join(wards, join = st_intersects) %>% 
  st_drop_geometry() %>%  # don't need it to be a spatial dataframe anymore

  # calculate mean risks within each ward
  group_by(wd17cd) %>% 
  summarise(
    CHD_mean = mean(`Estimated prevalence of CHD`, na.rm = T),
    COPD_mean = mean(`Estimated prevalence of COPD`, na.rm = T),
    HF_mean = mean(`Estimated prevalence of Heart failure`, na.rm = T),
    PAD_mean = mean(`Estimated prevalence of peripheral arterial disease`, na.rm = T),
    
    # Clinical_Risk_mean = mean(Clinical_Risk, na.rm = T)
  ) %>% 
  ungroup() %>% 
  
  # calculate quintiles for each indicator
  mutate(CHD_q =      as.integer(cut2(CHD_mean,  g = 5))) %>% 
  mutate(COPD_q =     as.integer(cut2(COPD_mean, g = 5))) %>%
  mutate(HF_q =       as.integer(cut2(HF_mean,   g = 5))) %>% 
  mutate(Arterial_q = as.integer(cut2(PAD_mean,  g = 5))) %>%

  # calculate ward-level 'clinical vulnerability' index based on the mean of the quintiles
  rowwise() %>% 
  mutate(Clinical_Risk = mean(c(CHD_q, COPD_q, HF_q, Arterial_q), na.rm = T)) %>% 
  ungroup()

# a bit of tidying up
rm(phe, gp, clinical, clinical_geo, wards, postcodes, postcodes_raw)
