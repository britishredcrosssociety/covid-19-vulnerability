---
title: "Covid-19 deaths by deprivation, vulnerability and area types"
author: "Dr Matthew Gwynfryn Thomas"
date: "14 May 2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction

Question: What's the relationship between vulnerability, deprivation, region, rurality and Covid-19 deaths?

To answer this, we'll look at deaths and death rates in Middle Layer Super Output Areas. This analysis was inspired by the ONS's report on [Deaths involving COVID-19 by local area and socioeconomic deprivation: deaths occurring between 1 March and 17 April 2020](https://www.ons.gov.uk/peoplepopulationandcommunity/birthsdeathsandmarriages/deaths/bulletins/deathsinvolvingcovid19bylocalareasanddeprivation/latest) as well as the analysis of regional gradients in deprivation and health outcomes in the latest [Marmot Review of health equity in England](https://www.health.org.uk/publications/reports/the-marmot-review-10-years-on).

Next steps:

- calculate confidence intervals for the crude death rates
- analyse population density
- model the death rates to understand the relative effects of vulnerability, deprivation, rurality, regions and population density
- use spatial regression models in case of clustering effects
- get LSOA-level or MSOA-level age-standardised mortality rate data from ONS (?)

## Load and process data
This section combines the ONS's [MSOA-level data on Covid-19 deaths](https://www.ons.gov.uk/peoplepopulationandcommunity/birthsdeathsandmarriages/deaths/datasets/deathsinvolvingcovid19bylocalareaanddeprivation) with data from the Index of Multiple Deprivation and Rural-Urban Classifications. Most of the underlying code is hidden from this output; see [the R Markdown file](https://github.com/britishredcrosssociety/covid-19-vulnerability/blob/master/analysis%20-%20mortality/Covid%20deaths%2C%20deprivation%20and%20types%20of%20areas.Rmd) for details.

To summarise the LSOA-level multiple deprivation index into MSOAs, we calculate the average population-weighted score following the method described in [section N.1.8 of the IMD technical report](https://assets.publishing.service.gov.uk/government/uploads/system/uploads/attachment_data/file/833951/IoD2019_Technical_Report.pdf).

```{r include=FALSE}
library(tidyverse)
library(janitor)
library(readxl)
library(Hmisc)
library(broom)
library(httr)
library(sf)

source("../functions.r")
source("../load lookup tables.r")

# download ONS data into temp file
GET("https://www.ons.gov.uk/file?uri=%2fpeoplepopulationandcommunity%2fbirthsdeathsandmarriages%2fdeaths%2fdatasets%2fdeathsinvolvingcovid19bylocalareaanddeprivation%2f1march2020to17april2020/referencetablesdraft.xlsx",
    write_disk(tf <- tempfile(fileext = ".xlsx")))


##
## Load/create geographical lookup tables
##
lad_17_19 = read_csv("../data/LAD 2017 to LAD 2019 codes.csv")  # lookup of Local Authority codes from 2017 to 2019

lsoa_lad = load_lookup_lsoa_msoa_lad() %>% 
  select(LSOA11CD, LAD17CD) %>% 
  left_join(lad_17_19, by = "LAD17CD")

lad_names = read_csv("https://opendata.arcgis.com/datasets/c3ddcd23a15c4d7985d8b36f1344b1db_0.csv") %>% 
  select(LAD19CD, LAD19NM)

lad_regions = read_csv("https://opendata.arcgis.com/datasets/3ba3daf9278f47daba0f561889c3521a_0.csv") %>% 
  select(LAD19CD, RGN19NM)

lsoa_msoa = load_lookup_lsoa_msoa_lad() %>% 
  select(LSOA11CD, MSOA11CD)

msoa_lad = load_lookup_lsoa_msoa_lad() %>% 
  select(MSOA11CD, LAD17CD) %>% 
  left_join(lad_17_19, by = "LAD17CD")
```

```{r include=FALSE}
covid_MSOA = read_excel(tf, sheet = "Table 5", skip = 11)

##
## get MSOA population size
##
pop = read_excel("../data/population/SAPE21DT3a-mid-2018-msoa-on-2019-LA-syoa-estimates-formatted.xlsx", sheet = "Mid-2018 Persons", skip = 4)

pop = pop %>% 
  filter(!is.na(MSOA)) %>%  # drop Local Authorities
  
  # convert age columns to long format
  pivot_longer(cols = `0`:`90+`, names_to = "Age", values_to = "n_people") %>% 
  mutate(Age = as.integer(Age)) %>% 
  
  # sum whole population and people over 70
  group_by(`Area Codes`) %>% 
  summarise(`No. people` = sum(n_people)) %>% 
  rename(MSOA11CD = `Area Codes`)


##
## get MSOA area size
##
msoa = read_sf("https://opendata.arcgis.com/datasets/c661a8377e2647b0bae68c4911df868b_3.geojson")

msoa_areas = msoa %>% 
  select(MSOA11CD = msoa11cd, Area = st_area.shape.) %>% 
  st_drop_geometry()


##
## Vulnerability Index
##
vi = read_csv("../output/archive/vulnerability-scores-MSOA-England.csv")


##
## IMD scores
##
# File 5: scores for the indices of deprivation
GET("https://assets.publishing.service.gov.uk/government/uploads/system/uploads/attachment_data/file/833978/File_5_-_IoD2019_Scores.xlsx",
    write_disk(tf_scores <- tempfile(fileext = ".xlsx")))

# File 6: population denominators
GET("https://assets.publishing.service.gov.uk/government/uploads/system/uploads/attachment_data/file/833980/File_6_-_IoD2019_Population_Denominators.xlsx",
    write_disk(tf_pop <- tempfile(fileext = ".xlsx")))

imd_scores = read_excel(tf_scores, sheet = "IoD2019 Scores")
imd_pop = read_excel(tf_pop, sheet = "Population Denominators")

# merge scores and population denominators
imd_msoa = imd_scores %>% 
  select(LSOA11CD = `LSOA code (2011)`, IMD_Score = `Index of Multiple Deprivation (IMD) Score`) %>% 
  
  left_join(imd_pop %>% select(LSOA11CD = `LSOA code (2011)`, Pop = `Total population: mid 2015 (excluding prisoners)`),
            by = "LSOA11CD") %>% 
  
  left_join(lsoa_msoa, by = "LSOA11CD")

# calculate total population per MSOA
imd_pop_msoa = imd_msoa %>% 
  group_by(MSOA11CD) %>% 
  summarise(Pop_Total = sum(Pop))

# calculate average scores in each MSOA
imd_score_msoa = imd_msoa %>% 
  mutate(Score = IMD_Score * Pop) %>% 
  
  group_by(MSOA11CD) %>% 
  summarise(Score_Total = sum(Score))

n_msoa = nrow(imd_msoa)

# calculate average score for each MSOA
imd_msoa = imd_score_msoa %>% 
  left_join(imd_pop_msoa, by = "MSOA11CD") %>% 
  mutate(IMD_Score = Score_Total / Pop_Total) %>% 
  
  # calculate ranks and deciles
  mutate(IMD_Rank = rank(IMD_Score),
         IMD_Decile = 11 - as.integer(cut2(IMD_Score, g = 10)))


##
## Rural-urban classification: calculate proportion of urban neighbourhoods in each MSOA
##
## - these files were created by the code in https://github.com/mattmalcher/IndexOfNeed/tree/master/Datasets/Rural-Urban%20Classifications
## - for details of what the classification codes mean, see: https://github.com/mattmalcher/IndexOfNeed/blob/master/Datasets/Rural-Urban%20Classifications/rural-urban%20classification%20codes.md
##
ruc = read_csv("https://github.com/britishredcrosssociety/brc-risk-maps/raw/master/data/raw/rural-urban/RUC%20England%20Wales%20-%20LSOA.csv")

# dichotomise detailed classifications into rural or urban
ruc = ruc %>% 
  select(LSOA11CD, RUC11CD) %>% 
  mutate(RUC = case_when(
    RUC11CD %in% c("A1", "B1", "C1", "C2") ~ "Urban",
    RUC11CD %in% c("D1", "D2", "E1", "E2", "F1", "F2") ~ "Rural"
  ))

# summarise RUC into MSOAs, calculating proportions of urban versus rural areas in each
# - count the number of urban and rural LSOAs in each MSOA
# - calculate the proportion of urban LSOAs
# - categorise as 'urban' if more than half of the LSOAs are urban
ruc_msoa = ruc %>% 
  filter(startsWith(LSOA11CD, "E")) %>%
  left_join(lsoa_msoa, by = "LSOA11CD") %>% 
  
  tabyl(MSOA11CD, RUC) %>% 
  mutate(`Proportion of urban LSOAs` = Urban / (Urban + Rural)) %>% 
  
  # categorise
  mutate(RUC = ifelse(`Proportion of urban LSOAs` > 0.5, "Urban", "Rural")) %>% 
  
  select(-Rural, -Urban)


##
## Get regions for MSOAs
##
msoa_region = msoa_lad %>% 
  left_join(lad_regions, by = "LAD19CD") %>% 
  select(MSOA11CD, Region = RGN19NM)


##
## combine
##
covid_MSOA_all = covid_MSOA %>% 
  filter(startsWith(`MSOA code`, "E")) %>% 
  
  left_join(pop, by = c("MSOA code" = "MSOA11CD")) %>% 
  left_join(msoa_areas, by = c("MSOA code" = "MSOA11CD")) %>% 
  
  left_join(vi, by = c("MSOA code" = "Code")) %>% 
  left_join(imd_msoa, by = c("MSOA code" = "MSOA11CD")) %>% 
  left_join(ruc_msoa, by = c("MSOA code" = "MSOA11CD")) %>% 
  left_join(msoa_region, by = c("MSOA code" = "MSOA11CD"))

# calculate population density
covid_MSOA_all$Density = covid_MSOA_all$`No. people` / covid_MSOA_all$Area
```

After processing, the data looks like this:

```{r, results = 'asis'}
knitr::kable(head(covid_MSOA_all))
```

Before plotting onto graphs, we need to summarise the data by IMD deciles and regions:

```{r}
# Covid deaths and death rate by region and IMD decile
covid_imd_region = covid_MSOA_all %>% 
  # summarise deaths into regions and IMD deciles
  group_by(IMD_Decile, Region) %>% 
  summarise(Covid_Sum = sum(`COVID-19`, na.rm = TRUE),
            Death_Sum = sum(`All causes`, na.rm = TRUE),
            People_Sum = sum(`No. people`)) %>% 
  ungroup() %>% 
  
  # deaths per 100k
  mutate(Covid_Rate = (Covid_Sum / People_Sum) * 100000,
         Death_Rate = (Death_Sum / People_Sum) * 100000)
```

... and by IMD deciles and Rural-Urban Classification:

```{r}
covid_imd_ruc = covid_MSOA_all %>% 
  group_by(IMD_Decile, RUC) %>% 
  summarise(Covid_Sum = sum(`COVID-19`, na.rm = TRUE),
            Death_Sum = sum(`All causes`, na.rm = TRUE),
            People_Sum = sum(`No. people`)) %>% 
  ungroup() %>% 
  
  # deaths per 100k
  mutate(Covid_Rate = (Covid_Sum / People_Sum) * 100000,
         Death_Rate = (Death_Sum / People_Sum) * 100000)
```

... and by Vulnerability deciles and region:

```{r}
# Covid deaths and death rate by region and IMD decile
covid_vi_region = covid_MSOA_all %>% 
  # summarise deaths into regions and IMD deciles
  group_by(`Vulnerability decile`, Region) %>% 
  summarise(Covid_Sum = sum(`COVID-19`, na.rm = TRUE),
            Death_Sum = sum(`All causes`, na.rm = TRUE),
            People_Sum = sum(`No. people`)) %>% 
  ungroup() %>% 
  
  # deaths per 100k
  mutate(Covid_Rate = (Covid_Sum / People_Sum) * 100000,
         Death_Rate = (Death_Sum / People_Sum) * 100000)
```

... and by vulnerability deciles and Rural-Urban Classification:

```{r}
covid_vi_ruc = covid_MSOA_all %>% 
  group_by(`Vulnerability decile`, RUC) %>% 
  summarise(Covid_Sum = sum(`COVID-19`, na.rm = TRUE),
            Death_Sum = sum(`All causes`, na.rm = TRUE),
            People_Sum = sum(`No. people`)) %>% 
  ungroup() %>% 
  
  # deaths per 100k
  mutate(Covid_Rate = (Covid_Sum / People_Sum) * 100000,
         Death_Rate = (Death_Sum / People_Sum) * 100000)
```

## Deaths by deprivation and region
There's a regional gradient to deprivation in terms of total Covid-19 and all-cause deaths (but not in deaths per 100,000 people). The most deprived areas have the most deaths in London, the North East, North West, West Midlands, and Yorkshire and The Humber. Less-deprived areas have more deaths in the South East and East of England.

### Deaths involving Covid-19
```{r}
covid_imd_region %>% 
  ggplot(aes(x = factor(IMD_Decile), y = Covid_Sum, fill = Region)) +
  geom_col(show.legend = FALSE) +
  facet_wrap(~Region) +
  scale_y_continuous(labels = scales::comma) +
  theme_classic() +
  labs(x = "Deprivation decile (1 = most deprived)", y = "Total Covid-19 deaths")
```

### Covid-19 deaths per 100,000 people
```{r}
covid_imd_region %>% 
  ggplot(aes(x = factor(IMD_Decile), y = Covid_Rate, fill = Region)) +
  geom_col(show.legend = FALSE) +
  facet_wrap(~Region) +
  theme_classic() +
  labs(x = "Deprivation decile (1 = most deprived)", y = "Covid-19 deaths per 100,000 people")
```


### Total all-cause deaths
```{r}
covid_imd_region %>% 
  ggplot(aes(x = factor(IMD_Decile), y = Death_Sum, fill = Region)) +
  geom_col(show.legend = FALSE) +
  facet_wrap(~Region) +
  scale_y_continuous(labels = scales::comma) +
  theme_classic() +
  labs(x = "Deprivation decile (1 = most deprived)", y = "Total all-cause deaths")
```

### All-cause deaths per 100,000 people
```{r}
covid_imd_region %>% 
  ggplot(aes(x = factor(IMD_Decile), y = Death_Rate, fill = Region)) +
  geom_col(show.legend = FALSE) +
  facet_wrap(~Region) +
  theme_classic() +
  labs(x = "Deprivation decile (1 = most deprived)", y = "All-cause deaths per 100,000 people")
```

## Deaths by deprivation and rural-urban classification
Total numbers of deaths are higher in urban areas, especially in the most deprived parts. However, when looking at death rates, deprived rural areas are also badly affected in terms of Covid-19 deaths.

### Deaths involving Covid-19
```{r}
covid_imd_ruc %>% 
  ggplot(aes(x = factor(IMD_Decile), y = Covid_Sum, fill = RUC)) +
  geom_col(show.legend = FALSE) +
  facet_wrap(~RUC) +
  scale_y_continuous(labels = scales::comma) +
  theme_classic() +
  labs(x = "Deprivation decile (1 = most deprived)", y = "Total Covid-19 deaths")
```

### Covid-19 deaths per 100,000 people
```{r}
covid_imd_ruc %>% 
  ggplot(aes(x = factor(IMD_Decile), y = Covid_Rate, fill = RUC)) +
  geom_col(show.legend = FALSE) +
  facet_wrap(~RUC) +
  theme_classic() +
  labs(x = "Deprivation decile (1 = most deprived)", y = "Covid-19 deaths per 100,000 people")
```

### Total all-cause deaths
```{r}
covid_imd_ruc %>% 
  ggplot(aes(x = factor(IMD_Decile), y = Death_Sum, fill = RUC)) +
  geom_col(show.legend = FALSE) +
  facet_wrap(~RUC) +
  scale_y_continuous(labels = scales::comma) +
  theme_classic() +
  labs(x = "Deprivation decile (1 = most deprived)", y = "Total all-cause deaths")
```

### All-cause deaths per 100,000 people
```{r}
covid_imd_ruc %>% 
  ggplot(aes(x = factor(IMD_Decile), y = Death_Rate, fill = RUC)) +
  geom_col(show.legend = FALSE) +
  facet_wrap(~RUC) +
  theme_classic() +
  labs(x = "Deprivation decile (1 = most deprived)", y = "All-cause deaths per 100,000 people")
```

## Deaths by vulnerability and region
All-cause deaths are highest in the most vulnerable areas, regardless of region. The Covid-19 death rate is especially high in the most vulnerable parts of London.

### Covid-19 deaths per 100,000 people
```{r}
covid_vi_region %>% 
  ggplot(aes(x = factor(`Vulnerability decile`), y = Covid_Rate, fill = Region)) +
  geom_col(show.legend = FALSE) +
  facet_wrap(~Region) +
  theme_classic() +
  labs(x = "Vulnerability (10 = most vulnerable)", y = "Covid-19 deaths per 100,000 people")
```

### All-cause deaths per 100,000 people
```{r}
covid_vi_region %>% 
  ggplot(aes(x = factor(`Vulnerability decile`), y = Death_Rate, fill = Region)) +
  geom_col(show.legend = FALSE) +
  facet_wrap(~Region) +
  theme_classic() +
  labs(x = "Vulnerability (10 = most vulnerable)", y = "All-cause deaths per 100,000 people")
```

## Deaths by vulnerability and rural-urban classification
The all-cause death rate is highest for people in the most vulnerable areas, regardless of whether they are rural or urban - althought this pattern is more pronounced in urban areas.

### Covid-19 deaths per 100,000 people
```{r}
covid_vi_ruc %>% 
  ggplot(aes(x = factor(`Vulnerability decile`), y = Covid_Rate, fill = RUC)) +
  geom_col(show.legend = FALSE) +
  facet_wrap(~RUC) +
  theme_classic() +
  labs(x = "Vulnerability (10 = most vulnerable)", y = "Covid-19 deaths per 100,000 people")
```

### All-cause deaths per 100,000 people
```{r}
covid_vi_ruc %>% 
  ggplot(aes(x = factor(`Vulnerability decile`), y = Death_Rate, fill = RUC)) +
  geom_col(show.legend = FALSE) +
  facet_wrap(~RUC) +
  theme_classic() +
  labs(x = "Vulnerability (10 = most vulnerable)", y = "All-cause deaths per 100,000 people")
```
