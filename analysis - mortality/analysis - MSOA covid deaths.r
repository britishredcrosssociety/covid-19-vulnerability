##
## Two questions:
## - What's the relationship between deprivation, rurality and Covid-19 deaths?
## - what's the relationship between deprivation, region and Covid-19 deaths?
## - ... and population density
##
## Two approaches:
## - model age-standardised mortality rates in Local Authorities
## - model counts in MSOAs (to give a sense whether Simpson's Paradox is at play when analysing higher geographies)
##
## Next steps:
## - use spatial regression models in case of clustering effects
## - get LSOA-level age-standardised mortality rate data
##
## Inspired by the ONS's report on "Deaths involving COVID-19 by local area and socioeconomic deprivation: deaths occurring between 1 March and 17 April 2020"
## - report: https://www.ons.gov.uk/peoplepopulationandcommunity/birthsdeathsandmarriages/deaths/bulletins/deathsinvolvingcovid19bylocalareasanddeprivation/latest
## - data: https://www.ons.gov.uk/peoplepopulationandcommunity/birthsdeathsandmarriages/deaths/datasets/deathsinvolvingcovid19bylocalareaanddeprivation
##
library(tidyverse)
library(janitor)
library(readxl)
library(Hmisc)
library(broom)
library(httr)
library(sf)

source("functions.r")
source("load lookup tables.r")

# download ONS data into temp file
GET("https://www.ons.gov.uk/file?uri=%2fpeoplepopulationandcommunity%2fbirthsdeathsandmarriages%2fdeaths%2fdatasets%2fdeathsinvolvingcovid19bylocalareaanddeprivation%2f1march2020to17april2020/referencetablesdraft.xlsx",
    write_disk(tf <- tempfile(fileext = ".xlsx")))


##
## Load/create geographical lookup tables
##
lad_17_19 = read_csv("data/LAD 2017 to LAD 2019 codes.csv")  # lookup of Local Authority codes from 2017 to 2019

lsoa_lad = load_lookup_lsoa_msoa_lad() %>% 
  select(LSOA11CD, LAD17CD) %>% 
  left_join(lad_17_19, by = "LAD17CD")

lad_names = read_csv("https://opendata.arcgis.com/datasets/c3ddcd23a15c4d7985d8b36f1344b1db_0.csv") %>% 
  select(LAD19CD, LAD19NM)

lad_regions = read_csv("https://opendata.arcgis.com/datasets/3ba3daf9278f47daba0f561889c3521a_0.csv") %>% 
  select(LAD19CD, RGN19NM)

lsoa_msoa = load_lookup_lsoa_msoa_lad() %>% 
  select(LSOA11CD, MSOA11CD)

msoa_lad = load_lookup_lsoa_msoa_lad() %>% 
  select(MSOA11CD, LAD17CD) %>% 
  left_join(lad_17_19, by = "LAD17CD")


###############################################################################
## Local Authority analysis
##

##
## Load LA-level Covid data
##
covid_LA = read_excel(tf, sheet = "Table 2", skip = 4) %>% 
  filter(...1 == "Persons") %>% 
  remove_empty("cols")

names(covid_LA) = c("Sex", "Geography type", "Area code", "Area name", 
                    "All causes: Deaths", "All causes: Rate", "All causes: footnote", "All causes: lower CI", "All causes: upper CI",
                    "Covid-19: Deaths", "Covid-19: Rate", "Covid-19: footnote", "Covid-19: lower CI", "Covid-19: upper CI")

covid_LA = covid_LA %>% 
  mutate_at(vars(starts_with("All causes")), as.numeric) %>% 
  mutate_at(vars(starts_with("Covid")), as.numeric)


##
## Load LA-level deprivation scores
## - from: https://www.gov.uk/government/statistics/english-indices-of-deprivation-2019
## - source: File 10: local authority district summaries
##
## We'll use two summary measures of deprivation in LAs: extent and proportion of Lower-layer Super Output Areas in most deprived 10% nationally
## - extent =  the proportion of the local population that live in areas classified as among the most deprived in the country
## 
## (see Table 3.2 in the IMD technical report for more details: https://assets.publishing.service.gov.uk/government/uploads/system/uploads/attachment_data/file/833951/IoD2019_Technical_Report.pdf)
##
GET("https://assets.publishing.service.gov.uk/government/uploads/system/uploads/attachment_data/file/833995/File_10_-_IoD2019_Local_Authority_District_Summaries__lower-tier__.xlsx",
    write_disk(tf_imd <- tempfile(fileext = ".xlsx")))

imd = read_excel(tf_imd, sheet = "IMD") %>% 
  select(LAD19CD = `Local Authority District code (2019)`, 
         Proportion = `IMD - Proportion of LSOAs in most deprived 10% nationally`, Proportion_rank = `IMD - Rank of proportion of LSOAs in most deprived 10% nationally`, 
         Extent = `IMD 2019 - Extent`, Extent_rank = `IMD 2019 - Rank of extent`) %>% 
  
  # calculate deciles
  mutate(Proportion_decile = calc_risk_quantiles(Proportion_rank, quants = 10),
         Extent_decile = calc_risk_quantiles(Extent_rank, quants = 10))


##
## Calculate proportion of urban neighbourhoods in each LA
##
## - these files were created by the code in https://github.com/mattmalcher/IndexOfNeed/tree/master/Datasets/Rural-Urban%20Classifications
## - for details of what the classification codes mean, see: https://github.com/mattmalcher/IndexOfNeed/blob/master/Datasets/Rural-Urban%20Classifications/rural-urban%20classification%20codes.md
##
ruc = read_csv("https://github.com/britishredcrosssociety/brc-risk-maps/raw/master/data/raw/rural-urban/RUC%20England%20Wales%20-%20LSOA.csv")

# dichotomise detailed classifications into rural or urban
ruc = ruc %>% 
  select(LSOA11CD, RUC11CD) %>% 
  mutate(RUC = case_when(
    RUC11CD %in% c("A1", "B1", "C1", "C2") ~ "Urban",
    RUC11CD %in% c("D1", "D2", "E1", "E2", "F1", "F2") ~ "Rural"
  ))

# summarise RUC into Local Authorities, calculating proportions of urban versus rural areas in each
# - count the number of urban and rural LSOAs in each LAD
# - calculate the proportion of urban LSOAs
# - categorise into three quantiles
ruc_lad = ruc %>% 
  filter(startsWith(LSOA11CD, "E")) %>%
  left_join(lsoa_lad, by = "LSOA11CD") %>% 
  
  tabyl(LAD19CD, RUC) %>% 
  mutate(`Proportion of urban LSOAs` = Urban / (Urban + Rural)) %>% 
  
  # split into terciles
  mutate(Urban_tercile = 4 - calc_risk_quantiles(`Proportion of urban LSOAs`, quants = 3)) %>% 
  
  select(-Rural, -Urban)


##
## Calculate population density
##



##
## Merge data together
##
covid_LA_all = covid_LA %>% 
  filter(startsWith(`Area code`, "E")) %>% 
  filter(`Area code` %in% lad_names$LAD19CD) %>% 
  
  left_join(imd, by = c("Area code" = "LAD19CD")) %>% 
  left_join(ruc_lad, by = c("Area code" = "LAD19CD")) %>% 
  left_join(lad_regions, by = c("Area code" = "LAD19CD")) %>% 
  
  rename(Region = RGN19NM)


##
## Viz
##
covid_LA_all %>% 
  # calc medians and SDs
  group_by(Proportion_decile, Region) %>% 
  summarise(Rate_Median = median(`Covid-19: Rate`, na.rm = TRUE),
            Rate_SD = sd(`Covid-19: Rate`, na.rm = TRUE)) %>% 
  
  ggplot(aes(x = factor(Proportion_decile), y = Rate_Median, colour = Region)) +
  geom_col() +
  facet_wrap(~Region) +
  theme_classic()


covid_LA_all %>% 
  # calc medians and SDs
  group_by(Proportion_decile, Urban_tercile) %>% 
  summarise(Rate_Median = median(`Covid-19: Rate`, na.rm = TRUE),
            Rate_SD = sd(`Covid-19: Rate`, na.rm = TRUE)) %>% 
  
  ggplot(aes(x = factor(Proportion_decile), y = Rate_Median)) +
  geom_col() +
  geom_errorbar(aes(ymin = Rate_Median - Rate_SD, ymax = Rate_Median + Rate_SD), 
                size = 0.5, width = 0.25, position = position_dodge(.9)) +
  
  facet_wrap(~Urban_tercile) +
  theme_classic()



###############################################################################
## MSOAs
##


##
##
##
covid_MSOA = read_excel(tf, sheet = "Table 5", skip = 11)

##
## get MSOA population size
##
pop = read_excel("data/population/SAPE21DT3a-mid-2018-msoa-on-2019-LA-syoa-estimates-formatted.xlsx", sheet = "Mid-2018 Persons", skip = 4)

pop = pop %>% 
  filter(!is.na(MSOA)) %>%  # drop Local Authorities
  
  # convert age columns to long format
  pivot_longer(cols = `0`:`90+`, names_to = "Age", values_to = "n_people") %>% 
  mutate(Age = as.integer(Age)) %>% 
  
  # sum whole population and people over 70
  group_by(`Area Codes`) %>% 
  summarise(`No. people` = sum(n_people)) %>% 
  rename(MSOA11CD = `Area Codes`)


##
## get MSOA area size
##
msoa = read_sf("https://opendata.arcgis.com/datasets/c661a8377e2647b0bae68c4911df868b_3.geojson")

msoa_areas = msoa %>% 
  select(MSOA11CD = msoa11cd, Area = st_area.shape.) %>% 
  st_drop_geometry()


##
## IMD scores
##
# File 5: scores for the indices of deprivation
GET("https://assets.publishing.service.gov.uk/government/uploads/system/uploads/attachment_data/file/833978/File_5_-_IoD2019_Scores.xlsx",
    write_disk(tf_scores <- tempfile(fileext = ".xlsx")))

# File 6: population denominators
GET("https://assets.publishing.service.gov.uk/government/uploads/system/uploads/attachment_data/file/833980/File_6_-_IoD2019_Population_Denominators.xlsx",
    write_disk(tf_pop <- tempfile(fileext = ".xlsx")))

imd_scores = read_excel(tf_scores, sheet = "IoD2019 Scores")
imd_pop = read_excel(tf_pop, sheet = "Population Denominators")

# merge scores and population denominators
imd_msoa = imd_scores %>% 
  select(LSOA11CD = `LSOA code (2011)`, IMD_Score = `Index of Multiple Deprivation (IMD) Score`) %>% 
  
  left_join(imd_pop %>% select(LSOA11CD = `LSOA code (2011)`, Pop = `Total population: mid 2015 (excluding prisoners)`),
            by = "LSOA11CD") %>% 
  
  left_join(lsoa_msoa, by = "LSOA11CD")

# calculate total population per MSOA
imd_pop_msoa = imd_msoa %>% 
  group_by(MSOA11CD) %>% 
  summarise(Pop_Total = sum(Pop))

# calculate average scores in each MSOA
imd_score_msoa = imd_msoa %>% 
  mutate(Score = IMD_Score * Pop) %>% 
  
  group_by(MSOA11CD) %>% 
  summarise(Score_Total = sum(Score))

n_msoa = nrow(imd_msoa)

# calculate average score for each MSOA
imd_msoa = imd_score_msoa %>% 
  left_join(imd_pop_msoa, by = "MSOA11CD") %>% 
  mutate(IMD_Score = Score_Total / Pop_Total) %>% 
  
  # calculate ranks and deciles
  mutate(IMD_Rank = rank(IMD_Score),
         IMD_Decile = 11 - as.integer(cut2(IMD_Score, g = 10)))


##
## Rural-urban classification: calculate proportion of urban neighbourhoods in each MSOA
##
## - these files were created by the code in https://github.com/mattmalcher/IndexOfNeed/tree/master/Datasets/Rural-Urban%20Classifications
## - for details of what the classification codes mean, see: https://github.com/mattmalcher/IndexOfNeed/blob/master/Datasets/Rural-Urban%20Classifications/rural-urban%20classification%20codes.md
##
ruc = read_csv("https://github.com/britishredcrosssociety/brc-risk-maps/raw/master/data/raw/rural-urban/RUC%20England%20Wales%20-%20LSOA.csv")

# dichotomise detailed classifications into rural or urban
ruc = ruc %>% 
  select(LSOA11CD, RUC11CD) %>% 
  mutate(RUC = case_when(
    RUC11CD %in% c("A1", "B1", "C1", "C2") ~ "Urban",
    RUC11CD %in% c("D1", "D2", "E1", "E2", "F1", "F2") ~ "Rural"
  ))

# summarise RUC into MSOAs, calculating proportions of urban versus rural areas in each
# - count the number of urban and rural LSOAs in each MSOA
# - calculate the proportion of urban LSOAs
# - categorise as 'urban' if more than half of the LSOAs are urban
ruc_msoa = ruc %>% 
  filter(startsWith(LSOA11CD, "E")) %>%
  left_join(lsoa_msoa, by = "LSOA11CD") %>% 
  
  tabyl(MSOA11CD, RUC) %>% 
  mutate(`Proportion of urban LSOAs` = Urban / (Urban + Rural)) %>% 
  
  # categorise
  mutate(RUC = ifelse(`Proportion of urban LSOAs` > 0.5, "Urban", "Rural")) %>% 
  
  select(-Rural, -Urban)


##
## Get regions for MSOAs
##
msoa_region = msoa_lad %>% 
  left_join(lad_regions, by = "LAD19CD") %>% 
  select(MSOA11CD, Region = RGN19NM)


##
## combine
##
covid_MSOA_all = covid_MSOA %>% 
  filter(startsWith(`MSOA code`, "E")) %>% 
  
  left_join(pop, by = c("MSOA code" = "MSOA11CD")) %>% 
  left_join(msoa_areas, by = c("MSOA code" = "MSOA11CD")) %>% 
  
  left_join(imd_msoa, by = c("MSOA code" = "MSOA11CD")) %>% 
  left_join(ruc_msoa, by = c("MSOA code" = "MSOA11CD")) %>% 
  left_join(msoa_region, by = c("MSOA code" = "MSOA11CD"))

# calculate population density
covid_MSOA_all$Density = covid_MSOA_all$`No. people` / covid_MSOA_all$Area


##
## Viz
##
# Covid deaths and death rate by region and IMD decile
covid_MSOA_all %>% 
  # summarise deaths into regions and IMD deciles
  group_by(IMD_Decile, Region) %>% 
  summarise(Covid_Sum = sum(`COVID-19`, na.rm = TRUE),
            People_Sum = sum(`No. people`)) %>% 
  ungroup() %>% 
  mutate(Covid_Rate = (Covid_Sum / People_Sum) * 100000) %>%  # deaths per 100k
  
  ggplot(aes(x = factor(IMD_Decile), y = Covid_Rate, fill = Region)) +
  geom_col() +
  facet_wrap(~Region) +
  theme_classic()

# deaths by urban-rural and IMD decile
covid_MSOA_all %>% 
  # summarise deaths into regions and IMD deciles
  group_by(IMD_Decile, RUC) %>% 
  summarise(Covid_Sum = sum(`COVID-19`, na.rm = TRUE),
            People_Sum = sum(`No. people`)) %>% 
  ungroup() %>% 
  mutate(Covid_Rate = Covid_Sum / People_Sum) %>%  # per-capita deaths
  
  ggplot(aes(x = factor(IMD_Decile), y = Covid_Sum)) +
  geom_col() +
  facet_wrap(~RUC) +
  theme_classic()


##
## Model deaths
##
m_covid = glm(`COVID-19` ~ IMD_Score + `Proportion of urban LSOAs` + RUC, family = "poisson", data = covid_MSOA_all)

summary(m_covid)


##
## clean up temp files
##
unlink(tf); rm(tf)
unlink(tf_imd); rm(tf_imd)
