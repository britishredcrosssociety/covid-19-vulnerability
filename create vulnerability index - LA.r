##
## Aggregate England's MSOA-level Vulnerability Index into Wards, Local Authorities and Local Resilience Forums
##
library(tidyverse)
library(janitor)
library(sf)

source("functions.r")
source("load lookup tables.r")

# run "create vulnerability index - MSOA - England.r" to make this dataset
vi = read_csv("output/vulnerability-MSOA-UK.csv")


##
## lookup tables
##
# MSOA to LA codes for England, Wales and Scotland
msoa_lad = load_lookup_lsoa_msoa_lad() %>% 
  select(MSOA11CD, LAD17CD) %>% 
  distinct()

# SOA to LA codes for Northern Ireland
soa_lgd = load_lookup_sa_lgd() %>% 
  select(MSOA11CD = LSOA11CD, LAD17CD = LAD18CD) %>% 
  distinct()

# append NI's codes to the rest
msoa_lad = bind_rows(msoa_lad, soa_lgd)

lad_17_19 = read_csv("data/LAD 2017 to LAD 2019 codes.csv")  # lookup of Local Authority codes from 2017 to 2019

lad_names = read_csv("https://opendata.arcgis.com/datasets/c3ddcd23a15c4d7985d8b36f1344b1db_0.csv") %>% 
  select(LAD19CD, LAD19NM)

# Local Authority District to Local Resilience Forum (December 2019) Lookup in England and Wales
# https://geoportal.statistics.gov.uk/datasets/local-authority-district-to-local-resilience-forum-december-2019-lookup-in-england-and-wales
# lad_lrf = read_csv("https://opendata.arcgis.com/datasets/203ea94d324b4fcda24875e83e577060_0.csv")

# MSOA to LRF lookup
# msoa_lrf = msoa_lad %>% 
#   left_join(lad_17_19, by = "LAD17CD") %>% 
#   left_join(lad_lrf, by = "LAD19CD") %>% 
#   select(MSOA11CD, LRF19CD) %>% 
#   distinct()


##
## aggregate vulnerability domains into Local Authorities by calculating proportions of 20% most-vulnerable neighbourhoods in each LA
##
vi_lad = vi %>% 
  left_join(msoa_lad, by = c("Code" = "MSOA11CD")) %>% 
  left_join(lad_17_19, by = "LAD17CD")

# clinical vulnerability 
clinical = vi_lad %>% 
  # label MSOAs by whether they're in top 20% most-vulnerable then summarise by this label
  mutate(Top20 = ifelse(`Clinical Vulnerability decile` >= 9, "Top20", "Other")) %>% 
  tabyl(LAD19CD, Top20) %>% 
  
  # calculate proportion of most deprived LSOAs
  mutate(`Proportion of neighbourhoods in 20% most clinically vulnerable` = Top20 / (Top20 + Other)) %>% 
  
  # split into quintiles
  # mutate(`Clinical Vulnerability quintile` = calc_risk_quantiles(`Proportion of neighbourhoods in 20% most clinically vulnerable`, quants = 5)) %>% 
  select(-Other, -Top20)

# health/wellbeing vulnerability 
health_wellbeing = vi_lad %>% 
  # label MSOAs by whether they're in top 20% most-vulnerable then summarise by this label
  mutate(Top20 = ifelse(`Health/Wellbeing Vulnerability decile` >= 9, "Top20", "Other")) %>% 
  tabyl(LAD19CD, Top20) %>% 
  
  # calculate proportion of most deprived LSOAs
  mutate(`Proportion of neighbourhoods in 20% most health/wellbeing vulnerable` = Top20 / (Top20 + Other)) %>% 
  
  # split into quintiles
  # mutate(`Health/Wellbeing Vulnerability quintile` = calc_risk_quantiles(`Proportion of neighbourhoods in 20% most health/wellbeing vulnerable`, quants = 5)) %>% 
  select(-Other, -Top20)

# economic vulnerability
economic = vi_lad %>% 
  # label MSOAs by whether they're in top 20% most-vulnerable then summarise by this label
  mutate(Top20 = ifelse(`Economic Vulnerability decile` >= 9, "Top20", "Other")) %>% 
  tabyl(LAD19CD, Top20) %>% 
  
  # calculate proportion of most deprived LSOAs
  mutate(`Proportion of neighbourhoods in 20% most economically vulnerable` = Top20 / (Top20 + Other + NA_)) %>% 
  
  # split into quintiles
  # mutate(`Social Vulnerability quintile` = calc_risk_quantiles(`Proportion of neighbourhoods in 20% most socially vulnerable`, quants = 5)) %>% 
  select(-Other, -Top20, -NA_)

# social vulnerability 
social_props = vi_lad %>% 
  # label MSOAs by whether they're in top 20% most-vulnerable then summarise by this label
  mutate(Top20 = ifelse(`Social Vulnerability decile` >= 9, "Top20", "Other")) %>% 
  tabyl(LAD19CD, Top20) %>% 
  
  # calculate proportion of most deprived LSOAs
  mutate(`Proportion of neighbourhoods in 20% most socially vulnerable` = Top20 / (Top20 + Other)) %>% 
  
  # split into quintiles
  # mutate(`Social Vulnerability quintile` = calc_risk_quantiles(`Proportion of neighbourhoods in 20% most socially vulnerable`, quants = 5)) %>% 
  select(-Other, -Top20)


##
## Include LA-level indicators
##
asylum = read_csv("data/asylum-LA.csv") %>% 
  select(LAD19CD, `People receiving Section 95 support`)

digital = read_csv("data/digital-exclusion-LA.csv") %>% 
  select(LAD19CD, `Digital exclusion: infrastructure` = infrastructure, `Digital exclusion: access` = access,
         `Digital exclusion: skill` = skill, `Digital exclusion: use` = use)

community_needs_lad = read_csv("data/community-needs-LA.csv") %>%
  select(-`Proportion of wards with greatest community needs`)

# calculate new social vulnerability score
social = social_props %>% 
  left_join(asylum, by = "LAD19CD") %>% 
  left_join(digital, by = "LAD19CD") %>% 
  mutate(Country = get_country(LAD19CD))

# split into separate countries
v_eng = social %>% 
  filter(Country == "England") %>% 
  left_join(community_needs_lad, by = "LAD19CD") %>%  # Community Needs Index only exists for England at the moment
  calc_domain_scores(domain = "Social")

v_wal = social %>% 
  filter(Country == "Wales") %>% 
  calc_domain_scores(domain = "Social")

v_sco = social %>% 
  filter(Country == "Scotland") %>% 
  calc_domain_scores(domain = "Social")

v_ni = social %>% 
  filter(Country == "Northern Ireland") %>% 
  calc_domain_scores(domain = "Social")

# recombine
social = bind_rows(v_eng, v_wal, v_sco, v_ni) %>% 
  select(-Country)


##
## Calculate new overall vulnerability index
##
vulnerability = clinical %>% 
  left_join(health_wellbeing, by = "LAD19CD") %>% 
  
  left_join(economic, by = "LAD19CD") %>% 
  
  left_join(social %>% select(LAD19CD, ends_with("Vulnerability score")),
            by = "LAD19CD") %>%
  
  mutate(Country = get_country(LAD19CD))

# split into separate datasets for each country then calculate vulnerability scores - until can work out how to get this code working:
#   group_by(Country) %>% 
#   calc_domain_scores() %>% 
#   ungroup() %>% 
v_eng = vulnerability %>% 
  filter(Country == "England") %>% 
  calc_domain_scores()

v_wal = vulnerability %>% 
  filter(Country == "Wales") %>% 
  calc_domain_scores()

v_sco = vulnerability %>% 
  filter(Country == "Scotland") %>% 
  calc_domain_scores()

v_ni = vulnerability %>% 
  filter(Country == "Northern Ireland") %>% 
  calc_domain_scores()

# recombine
vulnerability = bind_rows(v_eng, v_wal, v_sco, v_ni) %>% 
  select(LAD19CD, starts_with("Vulnerability"))

# merge all proportions togethers
vulnerability_all = clinical %>% 
  left_join(health_wellbeing, by = "LAD19CD") %>% 
  left_join(economic, by = "LAD19CD") %>% 
  left_join(social, by = "LAD19CD") %>% 
  left_join(vulnerability, by = "LAD19CD") %>% 
  
  mutate(Country = get_country(LAD19CD)) %>% 
  
  # calculate quintiles
  group_by(Country) %>% 
  mutate(`Clinical Vulnerability quintile` = calc_risk_quantiles(`Proportion of neighbourhoods in 20% most clinically vulnerable`, quants = 5),
         `Health/Wellbeing Vulnerability quintile` = calc_risk_quantiles(`Proportion of neighbourhoods in 20% most health/wellbeing vulnerable`, quants = 5),
         `Economic Vulnerability quintile` = calc_risk_quantiles(`Proportion of neighbourhoods in 20% most economically vulnerable`, quants = 5),
         `Social Vulnerability quintile` = calc_risk_quantiles(`Social Vulnerability rank`, quants = 5),
         `Vulnerability quintile` = calc_risk_quantiles(`Vulnerability rank`, quants = 5)) %>% 
  ungroup() %>% 
  
  # get LA names
  left_join(lad_names, by = "LAD19CD") %>% 
  select(Code = LAD19CD, Name = LAD19NM, everything())

# calculate quintiles
vulnerability_scores = vulnerability_all %>% 
  mutate(`Clinical Vulnerability quintile` = calc_risk_quantiles(`Proportion of neighbourhoods in 20% most clinically vulnerable`, quants = 5),
         `Health/Wellbeing Vulnerability quintile` = calc_risk_quantiles(`Proportion of neighbourhoods in 20% most health/wellbeing vulnerable`, quants = 5),
         `Economic Vulnerability quintile` = calc_risk_quantiles(`Proportion of neighbourhoods in 20% most economically vulnerable`, quants = 5),
         `Social Vulnerability quintile` = calc_risk_quantiles(`Social Vulnerability rank`, quants = 5),
         `Vulnerability quintile` = calc_risk_quantiles(`Vulnerability rank`, quants = 5)) %>% 
  
  select(Code, Name, ends_with("quintile"))


##
## save
##
vulnerability_all %>% write_csv("output/vulnerability-LA.csv")

vulnerability_all %>% 
  select(Code, Name, ends_with("quintile")) %>% 
  write_csv("output/vulnerability-scores-LA.csv")

# Local Authority Districts (December 2019) Boundaries UK BUC
# source: https://geoportal.statistics.gov.uk/datasets/local-authority-districts-december-2019-boundaries-uk-buc
lads = read_sf("https://opendata.arcgis.com/datasets/3a4fa2ce68f642e399b4de07643eeed3_0.geojson")

lads %>% 
  left_join(vulnerability_all, by = c("lad19cd" = "Code")) %>% 
  select(Code = lad19cd, Name, everything(), -objectid, -lad19nm, -lad19nmw, -st_areashape, -st_lengthshape, -bng_e, -bng_n, -long, -lat) %>% 
  write_sf("output/vulnerability-LA.geojson")


##
## check aggregated version of vulnerabilty index against previous LA-level version
##
original_la = read_csv("output/archive/vulnerability-LA.csv")

cor.test(vulnerability_all$`Vulnerability quintile`, original_la$Vulnerability_q)  # r = 0.7343329
