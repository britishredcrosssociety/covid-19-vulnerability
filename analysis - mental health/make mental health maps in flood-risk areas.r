##
## mental health maps for insight pack on mental health and wellbeing
##
library(tidyverse)
library(sf)
library(rmapshaper)

source("functions.r")

# ---- Load vulnerability data ----
vi_eng = read_csv("output/vulnerability-MSOA-England.csv")
vi_wal = read_csv("output/vulnerability-MSOA-Wales.csv")
vi_sco = read_csv("output/vulnerability-MSOA-Scotland.csv")
vi_ni  = read_csv("output/vulnerability-SOA-NI.csv")

# ---- Load flood risk data ----
flood_msoa <- read_csv("data/resilience-index/MSOAs in flood risk zones.csv")
flood_lsoa <- read_csv("data/resilience-index/LSOAs in flood risk zones.csv")

# ---- Load Tactical Cell lookup ----
msoa_tc = read_csv("data/lookup mosa11 to lad17 to lad19 to tactical cell.csv")

# make sure all TCs and regions are named
msoa_tc = msoa_tc %>% 
  mutate(TacticalCell = case_when(
    str_sub(MSOA11CD, 1, 1) == "9" ~ "Northern Ireland and Isle of Man",
    TRUE ~ TacticalCell
  ))

# ---- England ----
mh_eng = vi_eng %>% 
  select(Code, `Learning Disabilities prevalence Rate`, `Serious Mental Illness prevalence Rate`, Loneliness, `Average distance to nearest Park, Public Garden, or Playing Field (m)`, `Percentage of adresses with private outdoor space (reverse ranked)`) %>% 
  # Use PCA model
  weighted_domain_scores(model = "PCA",
                         domain = "Mental Health")

access_eng = vi_eng %>% 
  select(Code, `Longest distance to GP surgery (km)`, `Longest distance to hospital (km)`) %>% 
  # Use PCA model
  weighted_domain_scores(model = "PCA",
                         domain = "Access")

# ---- Wales ----
mh_wal = vi_wal %>% 
  select(Code, `GP-recorded mental health condition (rate per 100)`, Loneliness, `Percentage of adresses with private outdoor space (reverse ranked)`, `Average distance to nearest Park, Public Garden, or Playing Field (m)`) %>% 
  # Use PCA model
  weighted_domain_scores(model = "PCA",
                         domain = "Mental Health")

access_wal = vi_wal %>% 
  select(Code, `Average private return travel time to a GP surgery (minutes)`, `Average private return travel time to a pharmacy (minutes)`, `Longest distance to hospital (km)`) %>% 
  # Use PCA model
  weighted_domain_scores(model = "PCA",
                         domain = "Access")

# ---- Scotland ----
mh_sco = vi_sco %>% 
  select(Code, `Population prescribed drugs for anxiety/depression/psychosis`, Loneliness, `Percentage of adresses with private outdoor space (reverse ranked)`, `Average distance to nearest Park, Public Garden, or Playing Field (m)`) %>% 
  # Use PCA model
  weighted_domain_scores(model = "PCA",
                         domain = "Mental Health")

access_sco = vi_sco %>% 
  select(Code, `Longest drive time to a GP surgery (minutes)`) %>% 
  mutate_if(is.numeric,
            list(`Access Vulnerability score` = function(x) standardised(rank2(x))))

# ---- NI ----
# don't need to recalculate NI's mental health domain
mh_ni = vi_ni %>% 
  select(Code, `Mental Health Vulnerability score` = `Health/Wellbeing Vulnerability score`, `Mental Health Vulnerability rank` = `Health/Wellbeing Vulnerability rank`, `Mental Health Vulnerability decile` = `Health/Wellbeing Vulnerability decile`)

access_ni = vi_ni %>% 
  select(Code, `Service-weighted fastest travel time by private transport (Rank)`) %>% 
  mutate_if(is.numeric,
            list(`Access Vulnerability score` = function(x) standardised(rank2(x))))

# ---- Sum up for whole UK ----
mh_uk = bind_rows(
  mh_eng %>% select(Code, `Mental Health Vulnerability score`, `Mental Health Vulnerability rank`, `Mental Health Vulnerability decile`) %>% mutate(`Mental Health Vulnerability quintile` = calc_risk_quantiles(`Mental Health Vulnerability rank`, quants = 5)),
  mh_wal %>% select(Code, `Mental Health Vulnerability score`, `Mental Health Vulnerability rank`, `Mental Health Vulnerability decile`) %>% mutate(`Mental Health Vulnerability quintile` = calc_risk_quantiles(`Mental Health Vulnerability rank`, quants = 5)),
  mh_sco %>% select(Code, `Mental Health Vulnerability score`, `Mental Health Vulnerability rank`, `Mental Health Vulnerability decile`) %>% mutate(`Mental Health Vulnerability quintile` = calc_risk_quantiles(`Mental Health Vulnerability rank`, quants = 5)),
  mh_ni  %>% select(Code, `Mental Health Vulnerability score`, `Mental Health Vulnerability rank`, `Mental Health Vulnerability decile`) %>% mutate(`Mental Health Vulnerability quintile` = calc_risk_quantiles(`Mental Health Vulnerability rank`, quants = 5))
) %>% 
  
  left_join(msoa_tc, by = c("Code" = "MSOA11CD")) %>% 
  
  mutate(TacticalCell = case_when(
    str_sub(Code, 1, 1) == "9" ~ "Northern Ireland and Isle of Man",
    TRUE ~ TacticalCell
  ))

# ---- Filter out MSOAs not in flood risk areas ----
mh_uk_flood = mh_uk %>% 
  filter(Code %in% flood_msoa_all$MSOA11CD)

# ---- Set and up save .geojson ----
# Middle Layer Super Output Areas (December 2011) Boundaries EW BSC
# source: https://geoportal.statistics.gov.uk/datasets/middle-layer-super-output-areas-december-2011-boundaries-ew-bsc
msoa = read_sf("https://opendata.arcgis.com/datasets/87aa4eb6393644768a5f85929cc704c2_0.geojson") %>% 
  st_transform(crs = 4326)

# Intermediate zones
iz = read_sf("data/boundaries/SG_IntermediateZone_Bdry_2011.shp") %>% 
  st_transform(crs = 4326) %>% 
  ms_simplify(keep_shapes = T)

# Super Output Areas
# soa = read_sf("https://cc-p-ni.ckan.io/dataset/678697e1-ae71-41f3-abba-0ef5f3f352c2/resource/80392e82-8bee-42de-a1e3-82d1cbaa983f/download/soa2001.json") %>% 
soa = read_sf("data/boundaries/SOA2011.shp") %>% 
  st_transform(crs = 4326) %>% 
  ms_simplify(keep_shapes = T)

# combine into a single spatial dataframe and merge in vulnerability index
msoa_uk = rbind(msoa %>% select(Code = MSOA11CD), 
                iz %>% select(Code = InterZone),
                soa %>% select(Code = SOA_CODE)) %>% 
  
  left_join(mh_uk_flood, by = "Code") %>% 
  filter(!is.na(`Mental Health Vulnerability score`))

geojson_name = "analysis - mental health/mental-health-flood.geojson"
if (file.exists(geojson_name)) file.remove(geojson_name)

msoa_uk %>% 
  write_sf(geojson_name)

# ---- Summarise into Tactical Cells ----
# get MSOA-level population estimates
source("prep population estimates.r")

mh_cell = mh_uk %>% 
  left_join(pop, by = "Code") %>% 
  aggregate_scores(domain = "Mental Health", aggregate_by = "TacticalCell") %>% 
  rename(`Proportion of neighbourhoods in 20% most vulnerable` = Proportion,
         `Extent of population living in highly vulnerable areas` = Extent,
         `Population-weighted vulnerability score` = Score)

write_csv(mh_cell, "analysis - mental health/mental health in cells.csv")


# ---- Analyse how flood risks are linked to deprivation and vulnerability ----
# Mental health deciles in flood zones
mh_uk_flood %>% 
  ggplot(aes(x = `Mental Health Vulnerability decile`)) + 
  geom_histogram(binwidth = 1)

# Socioeconomic vulnerability in flood zones
vi_ses = bind_rows(
  vi_eng %>% select(Code, Loneliness, `Socioeconomic Vulnerability decile`) %>% mutate(`Loneliness decile` = calc_risk_quantiles(Loneliness, quants = 10)),
  vi_wal %>% select(Code, Loneliness, `Socioeconomic Vulnerability decile`) %>% mutate(`Loneliness decile` = calc_risk_quantiles(Loneliness, quants = 10)),
  vi_sco %>% select(Code, Loneliness, `Socioeconomic Vulnerability decile`) %>% mutate(`Loneliness decile` = calc_risk_quantiles(Loneliness, quants = 10)),
  vi_ni  %>% select(Code, Loneliness, `Socioeconomic Vulnerability decile`) %>% mutate(`Loneliness decile` = calc_risk_quantiles(Loneliness, quants = 10))
)

vi_ses = bind_rows(
  vi_eng %>% select(Code, Loneliness, `Socioeconomic Vulnerability decile`) %>% mutate(`Loneliness decile` = as.integer(Hmisc::cut2(Loneliness, g = 10))),
  vi_wal %>% select(Code, Loneliness, `Socioeconomic Vulnerability decile`) %>% mutate(`Loneliness decile` = as.integer(Hmisc::cut2(Loneliness, g = 10))),
  vi_sco %>% select(Code, Loneliness, `Socioeconomic Vulnerability decile`) %>% mutate(`Loneliness decile` = as.integer(Hmisc::cut2(Loneliness, g = 10))),
  vi_ni  %>% select(Code, Loneliness, `Socioeconomic Vulnerability decile`) %>% mutate(`Loneliness decile` = as.integer(Hmisc::cut2(Loneliness, g = 10)))
)

vi_ses_flood = vi_ses %>% 
  filter(Code %in% flood_msoa_all$MSOA11CD)

vi_ses_flood %>% 
  ggplot(aes(x = `Socioeconomic Vulnerability decile`)) + 
  geom_histogram(binwidth = 1)

# Loneliness
vi_ses_flood %>% 
  ggplot(aes(x = `Loneliness decile`)) + 
  geom_histogram(binwidth = 1)

vi_ses %>% 
  ggplot(aes(x = `Loneliness decile`)) + 
  geom_histogram(binwidth = 1)


# Deprivation in flood zones
imd = read_csv("https://github.com/matthewgthomas/IMD/raw/master/data/UK%20IMD%20domains.csv")

imd %>% 
  filter(LSOA %in% flood_lsoa$LSOA11CD) %>% 
  ggplot(aes(x = IMD_decile)) +
  geom_histogram(binwidth = 1)


