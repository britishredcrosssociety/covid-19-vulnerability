##
## MSOA-level vulnerability index for England
##
library(tidyverse)
library(readxl)
library(httr)
library(sf)

source("functions.r")
source("load lookup tables.r")


###############################################################################
## Load and prep all data sources
##

# load LSOA to MSOA codes lookup table
lookup_lsoa_msoa = load_lookup_lsoa_msoa_lad() %>% 
  select(LSOA11CD, MSOA11CD)

# get neater versions of MSOA names
msoa_names = read_csv("https://visual.parliament.uk/msoanames/static/MSOA-Names-v1.1.0.csv") %>% 
  select(MSOA11CD = msoa11cd, Name = msoa11nm)

##
## data provided by OCSI containing various useful indicators: https://ocsi.uk/2020/04/01/covid-19-vulnerability-index-and-data-download/
##
# ocsi = read_excel("data/England MSOA data from OCSI.xlsx", sheet = "Subset of indicators")
source("prep ocsi data - england.r")

# make a lookup table from MSOA codes to neat names
# lookup_msoa_names = ocsi %>% 
#   select(MSOA11CD = `MSOA Code`, `MSOA Name` = `MSOA New Name`)


##
## calculate proportion of older population from MSOA population estimates
## source: https://www.ons.gov.uk/peoplepopulationandcommunity/populationandmigration/populationestimates/datasets/middlesuperoutputareamidyearpopulationestimates
##
GET("https://www.ons.gov.uk/file?uri=%2fpeoplepopulationandcommunity%2fpopulationandmigration%2fpopulationestimates%2fdatasets%2fmiddlesuperoutputareamidyearpopulationestimates%2fmid2018sape21dt3a/sape21dt3amid2018msoaon2019lasyoaestimatesformatted.zip",
    write_disk(tf <- tempfile(fileext = ".zip")))

unzip(tf, exdir = "data/population")
unlink(tf); rm(tf)

pop = read_excel("data/population/SAPE21DT3a-mid-2018-msoa-on-2019-LA-syoa-estimates-formatted.xlsx", sheet = "Mid-2018 Persons", skip = 4)

pop_older = pop %>% 
  filter(!is.na(MSOA)) %>%  # drop Local Authorities
  
  # convert age columns to long format
  rename(`90` = `90+`) %>% 
  pivot_longer(cols = `0`:`90`, names_to = "Age", values_to = "n_people") %>% 
  mutate(Age = as.integer(Age)) %>% 
  
  # sum whole population and people over 70
  group_by(`Area Codes`) %>% 
  summarise(`No. people` = sum(n_people),
            `No. people over 70` = sum(n_people[Age >= 70], na.rm = TRUE)) %>% 
  
  mutate(`Proportion people over 70` = `No. people over 70` / `No. people`) %>% 
  rename(MSOA11CD = `Area Codes`)

rm(pop)


##
## Load loneliness risks
## source: https://github.com/matthewgthomas/loneliness
##
loneliness = read_csv("https://github.com/matthewgthomas/loneliness/raw/master/England/msoa_loneliness.csv") %>% 
  select(MSOA11CD = msoa11cd, Loneliness = loneills_2018)


##
## IMD data: load "File 3: supplementary indices - income deprivation affecting children index and income deprivation affecting older people index"
## source: https://www.gov.uk/government/statistics/english-indices-of-deprivation-2019
##
# GET("https://assets.publishing.service.gov.uk/government/uploads/system/uploads/attachment_data/file/833974/File_3_-_IoD2019_Supplementary_Indices_-_IDACI_and_IDAOPI.xlsx",
#     write_disk(tf <- tempfile(fileext = ".xlsx")))
# 
# imd_eng_scores = read_excel(tf, sheet = "IoD2019 Transformed Scores")  # check the sheet name is still valid if you're updating the URL above
# unlink(tf); rm(tf)


##
## Load underlying indicators for IMD
## source: "File 8: underlying indicators" from https://www.gov.uk/government/statistics/english-indices-of-deprivation-2019
##
GET("https://assets.publishing.service.gov.uk/government/uploads/system/uploads/attachment_data/file/833992/File_8_-_IoD2019_Underlying_Indicators.xlsx",
    write_disk(tf <- tempfile(fileext = ".xlsx")))

# skip income and employment numerators for now - they should be covered by the OCSI data
# imd_income   = read_excel(tf, sheet = "IoD2019 Income Domain")
# imd_employ   = read_excel(tf, sheet = "IoD2019 Employment Domain")
imd_barriers = read_excel(tf, sheet = "IoD2019 Barriers Domain")
imd_env      = read_excel(tf, sheet = "IoD2019 Living Env Domain")

unlink(tf); rm(tf)

# summarise access to services indicators into MSOAs
access = imd_barriers %>% 
  select(LSOA11CD = `LSOA code (2011)`, `Road distance to general store or supermarket indicator (km)`, `Road distance to a GP surgery indicator (km)`, `Road distance to a post office indicator (km)`) %>% 
  
  # merge MSOA codes
  left_join(lookup_lsoa_msoa, by = "LSOA11CD") %>% 
  
  # aggregate indicators into MSOAs - use the longest distances within each LSOA
  group_by(MSOA11CD) %>% 
  summarise(`Longest distance to supermarket (km)` = max(`Road distance to general store or supermarket indicator (km)`),
            `Longest distance to GP surgery (km)` = max(`Road distance to a GP surgery indicator (km)`),
            `Longest distance to Post Office (km)` = max(`Road distance to a post office indicator (km)`))


# summarise housing indicators into MSOAs
housing = imd_barriers %>% 
  select(LSOA11CD = `LSOA code (2011)`, `Household overcrowding indicator`, `Homelessness indicator (rate per 1000 households)`) %>% 
  
  # merge in other housing-related indicators
  left_join(imd_env %>% select(LSOA11CD = `LSOA code (2011)`, `Housing in poor condition indicator`, `Houses without central heating indicator`),
            by = "LSOA11CD") %>% 
  
  # merge MSOA codes
  left_join(lookup_lsoa_msoa, by = "LSOA11CD") %>% 
  
  # aggregate indicators into MSOAs
  group_by(MSOA11CD) %>% 
  summarise(`Household overcrowding` = max(`Household overcrowding indicator`),  # higher number means higher proportion of houses classed as overcrowded
             Homelessness = max(`Homelessness indicator (rate per 1000 households)`),
            `Housing in poor condition` = max(`Housing in poor condition indicator`),  # proportion of social and private homes that fail to meet the Decent Homes standard
            `Houses without central heating` = max(`Houses without central heating indicator`))

  
# summarise living environment indicators into MSOAs
env = imd_env %>%
  select(LSOA11CD = `LSOA code (2011)`, `Air quality indicator`) %>%

  # merge MSOA codes
  left_join(lookup_lsoa_msoa, by = "LSOA11CD") %>%

  # aggregate indicators into MSOAs
  group_by(MSOA11CD) %>%
  summarise(`Air quality` = max(`Air quality indicator`))  # highest concentration of four pollutants


##
## Load distance to hospitals
##
hospital_distance = read_csv("data/hospital-data/england-wales-nearest-hospitals-lsoa.csv")  # produced by `prep hospitals accessibility.py`

# similar to road distances in the IMD data, calculate longest mean distance
hospital_distance = hospital_distance %>% 
  select(LSOA11CD = lsoa11cd, mean_distance_nearest_three_hospitals) %>% 
  mutate(mean_distance_nearest_three_hospitals = mean_distance_nearest_three_hospitals / 1000) %>%  # convert to km
  
  # merge MSOA codes
  left_join(lookup_lsoa_msoa, by = "LSOA11CD") %>% 
  
  # take further mean distance to a hospital for LSOAs within an MSOA
  group_by(MSOA11CD) %>% 
  summarise(`Longest distance to hospital (km)` = max(mean_distance_nearest_three_hospitals))
  
# another option: get the shortest distance to a hospital from each LSOA
# hospital_distance %>% 
#  select(lsoa11cd, distance1:distance3) %>% 
#  pivot_longer(cols = starts_with("distance"), names_to = "col", values_to = "distance") %>% 


##
## Load distance to food banks
##
foodbank_distance = read_csv("data/foodbank/nearest-foodbanks-lsoas.csv")  # produced by `prep food bank accessibility.py`

# similar to road distances in the IMD data, calculate longest mean distance
foodbank_distance = foodbank_distance %>% 
  select(LSOA11CD = lsoa11cd, mean_distance_nearest_three_foodbanks) %>% 
  mutate(mean_distance_nearest_three_foodbanks = mean_distance_nearest_three_foodbanks / 1000) %>%  # convert to km
  
  # merge MSOA codes
  left_join(lookup_lsoa_msoa, by = "LSOA11CD") %>% 
  
  # take further mean distance to a hospital for LSOAs within an MSOA
  group_by(MSOA11CD) %>% 
  summarise(`Longest distance to food bank (km)` = max(mean_distance_nearest_three_foodbanks))


##
## Load frailty
##
frailty = read_csv("data/frailty-MSOA-England.csv")


##
## Load digital exclusion
##
digital_exclusion = read_csv("data/CACI/digital-exclusion-msoa.csv")


###############################################################################

# ---- Calculate scores for each domain of vulnerability ----
# Methodology:
# 1. Combine data to create domains (e.g., clinical, health and wellbeing, etc.)
# 2. Create weighted domain scores for each MSOA using unsupervised learning.
#    See weighted_domain_score() function in functions.r file for more details
#    on the methodology used.

# ---- Clinical vulnerability domain ----
# Use Maximum Likelihood Factor Analysis (MLFA) to determine weights
# as it is assumed indicators have a relationship

clinical <- ocsi %>%
  select(MSOA11CD = `MSOA Code`,
         `Modelled prevalence of people aged 15 who are regular smokers Rate`,
         `Obesity prevalence Rate`,
         `Cancer prevalence Rate`,
         `Asthma prevalence Rate`,
         `Atrial Fibrillation prevalence Rate`,
         `Cardiovascular Disease prevalence Rate`,
         `COPD prevalence Rate`,
         `Diabetes prevalence Rate`,
         `Coronary Heart Disease prevalence Rate`,
         `Heart Failure prevalence Rate`,
         `High Blood Pressure prevalence Rate`,
         `Chronic Kidney Disease prevalence Rate`,
         `Peripheral Arterial Disease prevalence Rate`) %>%
  # could instead use: `Elective hospital admissions (coronary heart disease)`,`Emergency hospital admissions (coronary heart disease)`, `Emergency hospital admissions, Chronic Obstructive Pulmonary Disease (COPD)`, `Emergency hospital admissions, Myocardial Infarction`,

  # include % of older people
  left_join(pop_older %>% select(MSOA11CD, `Proportion people over 70`),
            by = "MSOA11CD") %>% 
  
  # Use MLFA model
  weighted_domain_scores(model = "MLFA",
                         domain = "Clinical")

# ---- Health and wellbeing domain ----
# Use Principle Components Factor Analysis (PCA) to determine weights
# as it is assumed indicators do not have a clear relationship

health_wellbeing <- ocsi %>%
  select(MSOA11CD = `MSOA Code`,
         `Dementia prevalence Rate`,
         `Learning Disabilities prevalence Rate`,
         `Serious Mental Illness prevalence Rate`) %>%
  
  # Join loneliness and frailty data
  left_join(loneliness, by = "MSOA11CD") %>%
  left_join(frailty, by = "MSOA11CD") %>%
  
  # Use PCA model
  weighted_domain_scores(model = "PCA",
                         domain = "Health/Wellbeing")

# ---- Economic vulnerability domain ----
# Use Principle Components Factor Analysis (PCA) to determine weights
# as it is assumed indicators do not have a clear relationship

economic <- ocsi %>% 
    select(MSOA11CD = `MSOA Code`,
           `Older people social care benefit (Attendance Allowance) Rate`,
           `Employment and Support Allowance claimants, disease code nervous system Rate`,
           `Employment and Support Allowance claimants, disease code respiratory or circulatory Rate`,
           `People receiving Disability Benefits Rate`,
           `Personal Independence Payment (PIP), respiratory disease claimants Rate`,
           `Households on Universal Credit - Limited Capability for Work Entitlement Rate`,
           `Universal Credit claimants - Conditionality Regime: No work requirements Rate`, 
           
           `Jobs in accommodation and food services (hospitality) Rate`, 
           `Jobs in arts, entertainment, recreation and other services Rate`, 
           `Jobs in retail Rate`, 
           `Jobs in transport and storage (inc postal) Rate`) %>%
  
  # Use PCA model
  weighted_domain_scores(model = "PCA",
                         domain = "Economic")

# ---- Social vulnerability domain ----
# Split the domain into four separate subdomains - access, housing, air quality and digital exclusion.
# The reason for splitting is there are three distinct subsets of indicators within the domain.
# Use MLFA to determine the weights for the housing and access subdomains and set air quality to have
# a weight of 1/4 of the overall domain.

# Calculate access vulnerability score
social_access <- access %>% 
  left_join(hospital_distance, by = "MSOA11CD") %>% 
  left_join(foodbank_distance, by = "MSOA11CD") %>% 
  
  weighted_domain_scores(model = "MLFA",
                         domain = "Access") %>% 
  select(-`Access Vulnerability rank`,
         -`Access Vulnerability decile`)

# Calculate housing vulnerability score
social_housing <- housing %>% 
  weighted_domain_scores(model = "MLFA",
                         domain = "Housing") %>% 
  select(-`Housing Vulnerability rank`,
         -`Housing Vulnerability decile`)

# Calculate air (env) vulnerability score. 
social_env <- env %>% 
  mutate_if(is.numeric,
            list(`Env Vulnerability score` = function(x) standardised(rank2(x))))

# get digital vulnerability score and rank
social_digital <- digital_exclusion %>% 
  select(-`Digital Vulnerability decile`)

# Combine subdomains
social <- social_access %>% 
  left_join(social_housing, by = "MSOA11CD") %>% 
  left_join(social_env, by = "MSOA11CD") %>% 
  left_join(social_digital, by = "MSOA11CD")

# Calculate social domain score
social <- social %>% 
  mutate(`Access Vulnerability score` = `Access Vulnerability score`* (1/4),
         `Housing Vulnerability score` =  `Housing Vulnerability score` * (1/4),
         `Env Vulnerability score` = `Env Vulnerability score` * (1/4),
         `Digital Vulnerability score` = `Digital Vulnerability score` * (1/4)) %>%
  
  mutate(`Social Vulnerability score` = reduce(select(., ends_with("Vulnerability score")), `+`)) %>% 
  mutate(`Social Vulnerability rank` = rank(`Social Vulnerability score`)) %>%
  mutate(`Social Vulnerability decile` = calc_risk_quantiles(`Social Vulnerability rank`, quants = 10)) %>% 
  select(-`Access Vulnerability score`, -`Housing Vulnerability score`, -`Env Vulnerability score`, -`Digital Vulnerability score`)

###############################################################################
## Construct the overall MSOA-level vulnerability index
vulnerability <- clinical %>%

  # keep only vulnerability ranks for each domain
  select(MSOA11CD, `Clinical Vulnerability rank`) %>%

  left_join(health_wellbeing %>% select(MSOA11CD, `Health/Wellbeing Vulnerability rank`),
            by = "MSOA11CD") %>%

  left_join(economic %>% select(MSOA11CD, ends_with("Vulnerability rank")),
            by = "MSOA11CD") %>%

  left_join(social %>% select(MSOA11CD, `Social Vulnerability rank`),
            by = "MSOA11CD") %>%

  calc_domain_scores(rank.indicators = FALSE) %>%

  select(MSOA11CD, starts_with("Vulnerability"))

##
## combine all domains and overall scores into one dataframe and save
##
vulnerability_all <- clinical %>%
  left_join(health_wellbeing, by = "MSOA11CD") %>%
  left_join(economic, by = "MSOA11CD") %>%
  left_join(social, by = "MSOA11CD") %>%
  left_join(vulnerability, by = "MSOA11CD") %>%

  # get MSOA names
  left_join(msoa_names, by = "MSOA11CD") %>%

  select(Code = MSOA11CD, everything())

# save all indicators
vulnerability_all %>% write_csv("output/vulnerability-MSOA-England.csv")

# save a copy with only vulnerability scores
vulnerability_all %>%
  select(Code, Name, contains("Vulnerability")) %>%
  write_csv("output/vulnerability-scores-MSOA-England.csv")


##
## save as geojson
##
# Middle Layer Super Output Areas (December 2011) Boundaries EW BSC
# source: https://geoportal.statistics.gov.uk/datasets/middle-layer-super-output-areas-december-2011-boundaries-ew-bsc
msoa = read_sf("https://opendata.arcgis.com/datasets/c661a8377e2647b0bae68c4911df868b_3.geojson") %>%
  st_transform(crs = 4326)

msoa_vi = msoa %>%
  filter(startsWith(msoa11cd, "E")) %>%
  left_join(vulnerability_all, by = c("msoa11cd" = "Code")) %>%
  mutate(`Vulnerability quintile` = calc_risk_quantiles(`Vulnerability rank`, quants = 5))

msoa_vi %>%
  # append a note to deciles and ranks
  rename_at(vars(matches("decile|rank")), ~ str_c(., " (1 = least vulnerable)")) %>% 

  select(Code = msoa11cd, Name, everything(), -objectid, -msoa11nm, -msoa11nmw, -st_area.shape., -st_length.shape.) %>%
  write_sf("output/vulnerability-MSOA-England.geojson")


##
## checking and debugging
##
# check that it's not just giving high vulnerability scores to larger MSOAs (which it shouldn't necessarily)
# the correlation is statistically significant (unsurprising because there's a lot of data)
# ... but the correlation itself is teeny (r = 0.001468604), so nothing to worry about
cor.test(~ st_area.shape. + `Vulnerability rank`, data = msoa_vi)

# get most and least vulnerable MSOAs to check their underlying indicators look correct (they do)
test = vulnerability_all %>% filter(`Vulnerability rank` %in% c(1, nrow(vulnerability_all)))
