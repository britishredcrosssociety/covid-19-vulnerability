##
## MSOA-level vulnerability index for 
##
library(tidyverse)
library(readxl)
library(httr)
library(sf)

source("init.r")
source("load lookup tables.r")

##
## helper functions
##
# use the exponential transformation function listed in Welsh IMD's tech report - see Appendix A: https://gov.wales/sites/default/files/statistics-and-research/2020-02/welsh-index-multiple-deprivation-2019-technical-report.pdf
exp_transform = function(x) -23 * log(1 - x * (1 -exp(-100/23)))

scale_ranks = function(x) (x - 1) / (length(x) - 1)  # normalise so rank is between 0 and 1

# function to calculate domain scores, ranks and deciles
calc_domain_scores = function(d, rank.indicators = TRUE) {
  if (rank.indicators) {
    d = d %>% 
      mutate_if(is.numeric, list(rank = rank))  # convert indicators to ranks
  }
  
  d %>% 
    # normalise the ranks so they're between 0 and 1
    mutate_at(vars(ends_with("rank")), list(scaled = scale_ranks)) %>% 
    
    # transform to an exponential distribution
    mutate_at(vars(ends_with("_scaled")), exp_transform) %>% 
    
    # combine with equal weights to get domain score
    mutate(`Vulnerability score` = reduce(select(., ends_with("_scaled")), `+`)) %>%   # source: https://stackoverflow.com/a/54527609
    
    # calculate domain ranks and deciles
    mutate(`Vulnerability rank` = rank(`Vulnerability score`)) %>% 
    mutate(`Vulnerability decile` = calc_risk_quantiles(`Vulnerability rank`, quants = 10)) %>%
    
    # keep only original indicators and domain vulnerability score/rank/decile
    select(-ends_with("_rank"), -ends_with("_scaled"))
}


###############################################################################
## Load and prep all data sources
##
# load LSOA to MSOA codes lookup table
lookup_lsoa_msoa = load_lookup_lsoa_msoa_lad() %>% 
  select(LSOA11CD, MSOA11CD)


##
## data provided by OCSI containing various useful indicators
##
ocsi = read_excel("data/England MSOA data from OCSI.xlsx", sheet = "Subset of indicators")

# make a lookup table from MSOA codes to neat names
lookup_msoa_names = ocsi %>% 
  select(MSOA11CD = `MSOA Code`, `MSOA Name` = `MSOA New Name`)


##
## calculate proportion of older population from MSOA population estimates
## source: https://www.ons.gov.uk/peoplepopulationandcommunity/populationandmigration/populationestimates/datasets/middlesuperoutputareamidyearpopulationestimates
##
GET("https://www.ons.gov.uk/file?uri=%2fpeoplepopulationandcommunity%2fpopulationandmigration%2fpopulationestimates%2fdatasets%2fmiddlesuperoutputareamidyearpopulationestimates%2fmid2018sape21dt3a/sape21dt3amid2018msoaon2019lasyoaestimatesformatted.zip",
    write_disk(tf <- tempfile(fileext = ".zip")))

unzip(tf, exdir = "data/population")
unlink(tf); rm(tf)

pop = read_excel("data/population/SAPE21DT3a-mid-2018-msoa-on-2019-LA-syoa-estimates-formatted.xlsx", sheet = "Mid-2018 Persons", skip = 4)

pop_older = pop %>% 
  filter(!is.na(MSOA)) %>%  # drop Local Authorities
  
  # convert age columns to long format
  pivot_longer(cols = `0`:`90+`, names_to = "Age", values_to = "n_people") %>% 
  mutate(Age = as.integer(Age)) %>% 
  
  # sum whole population and people over 70
  group_by(`Area Codes`) %>% 
  summarise(`No. people` = sum(n_people),
            `No. people over 70` = sum(n_people[Age >= 70], na.rm = TRUE)) %>% 
  
  mutate(`Proportion people over 70` = `No. people over 70` / `No. people`) %>% 
  rename(MSOA11CD = `Area Codes`)

rm(pop)


##
## Load loneliness risks
## source: https://github.com/matthewgthomas/loneliness
##
loneliness = read_csv("https://github.com/matthewgthomas/loneliness/raw/master/England/msoa_loneliness.csv") %>% 
  select(MSOA11CD = msoa11cd, Loneliness = loneills_2018)


##
## IMD data: load "File 3: supplementary indices - income deprivation affecting children index and income deprivation affecting older people index"
## source: https://www.gov.uk/government/statistics/english-indices-of-deprivation-2019
##
# GET("https://assets.publishing.service.gov.uk/government/uploads/system/uploads/attachment_data/file/833974/File_3_-_IoD2019_Supplementary_Indices_-_IDACI_and_IDAOPI.xlsx",
#     write_disk(tf <- tempfile(fileext = ".xlsx")))
# 
# imd_eng_scores = read_excel(tf, sheet = "IoD2019 Transformed Scores")  # check the sheet name is still valid if you're updating the URL above
# unlink(tf); rm(tf)


##
## Load underlying indicators for IMD
## source: "File 8: underlying indicators" from https://www.gov.uk/government/statistics/english-indices-of-deprivation-2019
##
GET("https://assets.publishing.service.gov.uk/government/uploads/system/uploads/attachment_data/file/833992/File_8_-_IoD2019_Underlying_Indicators.xlsx",
    write_disk(tf <- tempfile(fileext = ".xlsx")))

# skip income and employment numerators for now - they should be covered by the OCSI data
# imd_income   = read_excel(tf, sheet = "IoD2019 Income Domain")
# imd_employ   = read_excel(tf, sheet = "IoD2019 Employment Domain")
imd_barriers = read_excel(tf, sheet = "IoD2019 Barriers Domain")
imd_env      = read_excel(tf, sheet = "IoD2019 Living Env Domain")

unlink(tf); rm(tf)

# summarise access to services indicators into MSOAs
access = imd_barriers %>% 
  select(LSOA11CD = `LSOA code (2011)`, `Road distance to general store or supermarket indicator (km)`, `Road distance to a GP surgery indicator (km)`) %>% 
  
  # merge MSOA codes
  left_join(lookup_lsoa_msoa, by = "LSOA11CD") %>% 
  
  # aggregate indicators into MSOAs - use the longest distances within each LSOA
  group_by(MSOA11CD) %>% 
  summarise(`Longest distance to supermarket (km)` = max(`Road distance to general store or supermarket indicator (km)`),
            `Longest distance to GP surgery (km)` = max(`Road distance to a GP surgery indicator (km)`))


# summarise housing indicators into MSOAs
housing = imd_barriers %>% 
  select(LSOA11CD = `LSOA code (2011)`, `Household overcrowding indicator`, `Homelessness indicator (rate per 1000 households)`) %>% 
  
  # merge in other housing-related indicators
  left_join(imd_env %>% select(LSOA11CD = `LSOA code (2011)`, `Housing in poor condition indicator`, `Houses without central heating indicator`),
            by = "LSOA11CD") %>% 
  
  # merge MSOA codes
  left_join(lookup_lsoa_msoa, by = "LSOA11CD") %>% 
  
  # aggregate indicators into MSOAs
  group_by(MSOA11CD) %>% 
  summarise(`Household overcrowding` = max(`Household overcrowding indicator`),  # higher number means higher proportion of houses classed as overcrowded
             Homelessness = max(`Homelessness indicator (rate per 1000 households)`),
            `Housing in poor condition` = max(`Housing in poor condition indicator`),  # proportion of social and private homes that fail to meet the Decent Homes standard
            `Houses without central heating` = max(`Houses without central heating indicator`))

  
# summarise living environment indicators into MSOAs
env = imd_env %>% 
  select(LSOA11CD = `LSOA code (2011)`, `Air quality indicator`) %>% 
  
  # merge MSOA codes
  left_join(lookup_lsoa_msoa, by = "LSOA11CD") %>% 
  
  # aggregate indicators into MSOAs
  group_by(MSOA11CD) %>% 
  summarise(`Air quality` = max(`Air quality indicator`))  # highest concentration of four pollutants


##
## Load distance to hospitals
##
hospital_distance = read_csv("output/nearest-hospitals-LSOA.csv")  # produced by `prep hospitals accessibility.py`

# similar to road distances in the IMD data, 
hospital_distance = hospital_distance %>% 
  select(LSOA11CD = lsoa11cd, mean_distance_nearest_three_hospitals) %>% 
  mutate(mean_distance_nearest_three_hospitals = mean_distance_nearest_three_hospitals / 1000) %>%  # convert to km
  
  # merge MSOA codes
  left_join(lookup_lsoa_msoa, by = "LSOA11CD") %>% 
  
  # take further mean distance to a hospital for LSOAs within an MSOA
  group_by(MSOA11CD) %>% 
  summarise(`Longest distance to hospital (km)` = max(mean_distance_nearest_three_hospitals))
  
# another option: get the shortest distance to a hospital from each LSOA
# hospital_distance %>% 
#  select(lsoa11cd, distance1:distance3) %>% 
#  pivot_longer(cols = starts_with("distance"), names_to = "col", values_to = "distance") %>% 


###############################################################################
## Calculate scores for each domain of vulnerability
##
## Following the process used in created IMD
## 1. Rank the indiactors
## 2. Scale to the range (0, 1]
## 3. Exponentially Transform
## 4. Sum with equal weights
## 5. Rank and quantise into deciles

##
## clinical vulnerability domain
##
clinical = ocsi %>% 
  select(MSOA11CD = `MSOA Code`, `Modelled prevalence of people aged 15 who are regular smokers`, `Obese adults`, `Cancer prevalence`, `Asthma prevalence`, `Atrial Fibrillation prevalence`, `Cardiovascular Disease prevalence`, `COPD prevalence`, `Diabetes prevalence`, `Coronary Heart Disease prevalence`, `Heart Failure prevalence`, `High Blood Pressure prevalence`, `Chronic Kidney Disease prevalence`, `Peripheral Arterial Disease prevalence`) %>% 
  # could instead use: `Elective hospital admissions (coronary heart disease)`, `Emergency hospital admissions (coronary heart disease)`, `Emergency hospital admissions, Chronic Obstructive Pulmonary Disease (COPD)`, `Emergency hospital admissions, Myocardial Infarction`,
  
  # include % of older people
  left_join(pop_older %>% select(MSOA11CD, `Proportion people over 70`),
            by = "MSOA11CD") %>%
  
  calc_domain_scores()

# label scores/ranks/deciles as "clinical vulnerability"
names(clinical)[ grepl("Vulnerability", names(clinical)) ] = paste0("Clinical ", grep("Vulnerability", names(clinical), value = T))


##
## health and wellbeing domain
##
health_wellbeing = ocsi %>% 
  select(MSOA11CD = `MSOA Code`, `Dementia prevalence`, `Learning Disabilities prevalence`, `Serious Mental Illness prevalence`) %>% 
  
  left_join(loneliness, by = "MSOA11CD") %>% 
  
  calc_domain_scores()

# label scores/ranks/deciles as "clinical vulnerability"
names(health_wellbeing)[ grepl("Vulnerability", names(health_wellbeing)) ] = paste0("Health/Wellbeing ", grep("Vulnerability", names(health_wellbeing), value = T))


##
## social vulnerability domain
##
social = access %>% 
  left_join(hospital_distance, by = "MSOA11CD") %>% 
  left_join(housing, by = "MSOA11CD") %>% 
  left_join(env, by = "MSOA11CD") %>% 

  calc_domain_scores()

# label scores/ranks/deciles as "clinical vulnerability"
names(social)[ grepl("Vulnerability", names(social)) ] = paste0("Social ", grep("Vulnerability", names(social), value = T))


###############################################################################
## Construct the overall MSOA-level vulnerability index
##
vulnerability = clinical %>% 
  # keep only vulnerability ranks for each domain
  select(MSOA11CD, `Clinical Vulnerability rank`) %>% 
  
  left_join(health_wellbeing %>% select(MSOA11CD, `Health/Wellbeing Vulnerability rank`),
            by = "MSOA11CD") %>% 
  
  left_join(social %>% select(MSOA11CD, `Social Vulnerability rank`),
            by = "MSOA11CD") %>% 
  
  calc_domain_scores(rank.indicators = FALSE) %>% 
  
  select(MSOA11CD, starts_with("Vulnerability"))
  
##
## combine all domains and overall scores into one dataframe and save
##
vulnerability_all = clinical %>% 
  left_join(health_wellbeing, by = "MSOA11CD") %>% 
  left_join(social, by = "MSOA11CD") %>% 
  left_join(vulnerability, by = "MSOA11CD") %>% 
  
  # get MSOA names
  left_join(lookup_msoa_names, by = "MSOA11CD") %>% 
  
  select(MSOA11CD, `MSOA Name`, everything())

vulnerability_all %>% write_csv("output/vulnerability-MSOA.csv")

vulnerability %>% 
  count(`Vulnerability decile`)

# Middle Layer Super Output Areas (December 2011) Boundaries EW BSC
# source: https://geoportal.statistics.gov.uk/datasets/middle-layer-super-output-areas-december-2011-boundaries-ew-bsc
msoa = read_sf("https://opendata.arcgis.com/datasets/c661a8377e2647b0bae68c4911df868b_3.geojson")

msoa = msoa %>% 
  left_join(vulnerability_all, by = c("msoa11cd" = "MSOA11CD"))

msoa %>% 
  select(msoa11cd, `MSOA Name`, ends_with("rank"), ends_with("decile")) %>% 
  write_sf("output/vulnerability-MSOA.geojson")

# cor.test(~ st_areashape + `Vulnerability rank`, data = msoa)  # just check that it's not just giving high vulnerability scores to larger MSOAs (which it shouldn't necessarily)

