##
## Prepare the Community Needs Index, showing the Index and its domains for all Wards, along with which are the left-behind areas
##
## More info: https://ocsi.uk/2020/01/15/community-needs-index-your-questions-answered/
## The data isn't public but OCSI can provide it to social purpose organisations - email them for info
##
library(tidyverse)
library(readxl)
# library(brclib)  # use `devtools::install_github("matthewgthomas/brclib")` if you need to install this
library(Hmisc)

data.dir.cmi = "P:/Operations/Innovation & Insight/Insight/Data science/Data/Community Needs Index"  # use our local copy of the data

##
## Load data
##
index_scores  = read_excel(file.path(data.dir.cmi, "Phase 2 Community Needs Index Score and Rank.xlsx"))
index_domains = read_excel(file.path(data.dir.cmi, "Community Needs Index domain scores.xlsx"))
left_behind   = read_excel(file.path(data.dir.cmi, "Phase 2 Left Behind Areas.xlsx"))

##
## Merge index scores, domains and left-behind areas into one dataframe
##
left_behind$left_behind = 1  # flag which wards are 'left behind'

community_needs = index_domains %>% 
  left_join(index_scores %>% select(`Ward Code`, `Community Need Score Phase 2 Score`, `Community Needs Index Phase 2 Rank`),
            by = "Ward Code") %>% 
  
  left_join(left_behind %>% select(`Ward Code`, left_behind),
            by = "Ward Code") %>% 
  
  mutate(left_behind = replace_na(left_behind, 0))

##
## Calculate risk quantiles
##
community_needs = community_needs %>%
  mutate(civic_assets_q = as.integer(cut2(`Civic Assets score`, g = 5)),
         connectedness_q = as.integer(cut2(`Connectedness score`, g = 5)),
         engaged_q = as.integer(cut2(`Engaged community score`, g = 5)),
         need_index_q = as.integer(cut2(`Community Need Score Phase 2 Score`, g = 5)))
  
  # add_risk_quantiles("Civic Assets score", output.col = "civic_assets") %>%
  # add_risk_quantiles("Connectedness score", output.col = "connectedness") %>%
  # add_risk_quantiles("Engaged community score", output.col = "engaged") %>%
  # add_risk_quantiles("Community Need Score Phase 2 Score", output.col = "need_index")

community_needs = community_needs %>% 
  select(wd17cd = `Ward Code`, left_behind, need_index_q)

rm(index_scores, index_domains, left_behind, data.dir.cmi)

write_csv(community_needs, "data/community-needs.csv")
