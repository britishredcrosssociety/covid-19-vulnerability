##
## Prepare the Community Needs Index, showing the Index and its domains for all Wards, along with which are the left-behind areas
##
## More info: https://ocsi.uk/2020/01/15/community-needs-index-your-questions-answered/
## The data isn't public but OCSI can provide it to social purpose organisations - email them for info
##
library(tidyverse)
library(readxl)
library(Hmisc)

data.dir.cmi = "P:/Operations/Innovation & Insight/Insight/Data science/Data/Community Needs Index"  # use our local copy of the data

##
## Load data
##
index_scores  = read_excel(file.path(data.dir.cmi, "Phase 2 Community Needs Index Score and Rank.xlsx"))
index_domains = read_excel(file.path(data.dir.cmi, "Community Needs Index domain scores.xlsx"))
left_behind   = read_excel(file.path(data.dir.cmi, "Phase 2 Left Behind Areas.xlsx"))

# get ward to Local Authority lookup
ward_lad = read_csv("https://opendata.arcgis.com/datasets/500d4283cbe54e3fa7f358399ba3783e_0.csv") %>% 
  select(WD17CD, LAD17CD)

# lookup of Local Authority codes from 2017 to 2019
lad_17_19 = read_csv("data/LAD 2017 to LAD 2019 codes.csv")

##
## Merge index scores, domains and left-behind areas into one dataframe
##
left_behind$left_behind = 1  # flag which wards are 'left behind'

community_needs = index_domains %>% 
  left_join(index_scores %>% select(`Ward Code`, `Community Need Score Phase 2 Score`, `Community Needs Index Phase 2 Rank`),
            by = "Ward Code") %>% 
  
  left_join(left_behind %>% select(`Ward Code`, left_behind),
            by = "Ward Code") %>% 
  
  mutate(left_behind = replace_na(left_behind, 0))

##
## Calculate risk quantiles
##
community_needs = community_needs %>%
  mutate(civic_assets_q = as.integer(cut2(`Civic Assets score`, g = 5)),
         connectedness_q = as.integer(cut2(`Connectedness score`, g = 5)),
         engaged_q = as.integer(cut2(`Engaged community score`, g = 5)),
         need_index_q = as.integer(cut2(`Community Need Score Phase 2 Score`, g = 5)))

##
## Save subset of data for wards
##
community_needs_ward = community_needs %>% 
  select(wd17cd = `Ward Code`, left_behind, need_index_q)

write_csv(community_needs_ward, "output/community-needs-ward.csv")

##
## Aggregate wards into Local Authorities
## - according to OCSI, we can only look for higher concentrations of wards that score highly on the Community Needs Index within a larger geographical area
##
community_needs_lad = community_needs %>% 
  left_join(ward_lad, by = c("Ward Code" = "WD17CD")) %>% 
  left_join(lad_17_19, by = "LAD17CD") %>% 
  
  # label wards by whether they're in worst-score category then summarise by this label
  mutate(Worst = ifelse(need_index_q == 5, "Worst", "Other")) %>% 
  tabyl(LAD19CD, Worst) %>% 
  
  # calculate proportion of most deprived LSOAs
  mutate(Prop_Highest_Need = Worst / (Worst + Other)) %>% 
  
  # split into quintiles
  mutate(Community_Need_q = as.integer(cut2(Prop_Highest_Need, g = 5))) %>% 
  
  select(-Other, -Worst) %>% 
  na.omit()

write_csv(community_needs_lad, "output/community-needs-LA.csv")

rm(index_scores, index_domains, left_behind, data.dir.cmi, ward_lad)
