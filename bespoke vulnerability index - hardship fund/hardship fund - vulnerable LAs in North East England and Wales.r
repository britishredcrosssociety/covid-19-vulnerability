##
## Create bespoke Vulnerability Index for British Red Cross Hardship Fund eligibility
##
library(tidyverse)

source("functions.r")
source("load lookup tables.r")
source("prep population estimates.r")

# load hardship fund vulnerability index data
vi_hardship_eng = read_csv("bespoke vulnerability index - hardship fund/hardship-vulnerability-MSOA-England.csv")
vi_hardship_wal = read_csv("bespoke vulnerability index - hardship fund/hardship-vulnerability-MSOA-Wales.csv")
vi_hardship_sco = read_csv("bespoke vulnerability index - hardship fund/hardship-vulnerability-MSOA-Scotland.csv")
vi_hardship_ni = read_csv("bespoke vulnerability index - hardship fund/hardship-vulnerability-MSOA-NI.csv")


##
## lookup tables
##
# MSOA to LA codes for England, Wales and Scotland
msoa_lad_ews = load_lookup_lsoa_msoa_lad() %>% 
  select(MSOA11CD, LAD17CD) %>% 
  distinct()

# SOA to LA codes for Northern Ireland
soa_lgd = load_lookup_sa_lgd() %>% 
  select(MSOA11CD = LSOA11CD, LAD17CD = LAD18CD) %>% 
  distinct()

# append NI's codes to the rest
msoa_lad = bind_rows(msoa_lad_ews, soa_lgd)

lad_17_19 = read_csv("data/LAD 2017 to LAD 2019 codes.csv")  # lookup of Local Authority codes from 2017 to 2019

lad_regions = read_csv("https://opendata.arcgis.com/datasets/3ba3daf9278f47daba0f561889c3521a_0.csv") %>% 
  select(LAD19CD, RGN19NM)

lad_names = read_csv("https://opendata.arcgis.com/datasets/c3ddcd23a15c4d7985d8b36f1344b1db_0.csv") %>% 
  select(LAD19CD, LAD19NM)

# tactical cells
msoa_tc = read_csv("data/lookup msoa to tactical cell.csv") %>% select(MSOA11CD, TacticalCell)
lad_tc = read_csv("data/lookup local authority to tactical cell.csv")

# get 2019 LA codes and regions and Cells
msoa_lad_tc = msoa_lad %>% 
  left_join(lad_17_19, by = "LAD17CD") %>% 
  left_join(lad_regions, by = "LAD19CD") %>% 
  left_join(msoa_tc, by = "MSOA11CD")

# make sure all TCs and regions are named
msoa_lad_tc = msoa_lad_tc %>% 
  mutate(TacticalCell = case_when(
    str_sub(MSOA11CD, 1, 1) == "9" ~ "Northern Ireland and Isle of Man",
    TRUE ~ TacticalCell
  )) %>% 
  
  mutate(RGN19NM = case_when(
    str_sub(MSOA11CD, 1, 1) == "9" ~ "Northern Ireland and Isle of Man",
    str_sub(MSOA11CD, 1, 1) == "S" ~ "Scotland",
    str_sub(MSOA11CD, 1, 1) == "W" ~ "Wales",
    TRUE ~ RGN19NM
  ))


###############################################################################
## Aggregate into LAs
##
# England
extent_eng = vi_hardship_eng %>% 
  left_join(msoa_lad_tc, by = c("Code" = "MSOA11CD")) %>% 
  left_join(pop_eng, by = "Code") %>% 
  aggregate_scores(domain = "Hardship Fund", aggregate_by = "LAD19CD")

# Wales
extent_wal = vi_hardship_wal %>% 
  left_join(msoa_lad_tc, by = c("Code" = "MSOA11CD")) %>% 
  left_join(pop_eng, by = "Code") %>% 
  aggregate_scores(domain = "Hardship Fund", aggregate_by = "LAD19CD")

# Scotland
extent_sco = vi_hardship_sco %>% 
  left_join(msoa_lad_tc, by = c("Code" = "MSOA11CD")) %>% 
  left_join(pop_sco, by = "Code") %>% 
  aggregate_scores(domain = "Hardship Fund", aggregate_by = "LAD19CD")

# NI
extent_ni = vi_hardship_ni %>% 
  left_join(msoa_lad_tc, by = c("Code" = "MSOA11CD")) %>% 
  left_join(pop_ni, by = "Code") %>% 
  aggregate_scores(domain = "Hardship Fund", aggregate_by = "LAD19CD")

# combine and save
hardship_la = bind_rows(extent_eng, extent_wal, extent_sco, extent_ni) %>% 
  rename(`Proportion of neighbourhoods in 20% most vulnerable for hardship` = Proportion,
         `Proportion of population living in highly vulnerable areas for hardship` = Extent,
         `Population-weighted vulnerability score for hardship` = Score)

hardship_la %>% 
  write_csv("bespoke vulnerability index - hardship fund/hardship-vulnerability-LA.csv")

##
## save .geojson
##
# Local Authority Districts (December 2019) Boundaries UK BUC
# source: https://geoportal.statistics.gov.uk/datasets/local-authority-districts-december-2019-boundaries-uk-buc
lads = read_sf("https://opendata.arcgis.com/datasets/3a4fa2ce68f642e399b4de07643eeed3_0.geojson")

geojson_name = "bespoke vulnerability index - hardship fund/hardship-vulnerability-LA.geojson"
if (file.exists(geojson_name)) file.remove(geojson_name)

lads %>% 
  left_join(hardship_la, by = c("lad19cd" = "LAD19CD")) %>% 
  select(Code = lad19cd, Name = lad19nm, everything(), -objectid, -lad19nmw, -st_areashape, -st_lengthshape, -bng_e, -bng_n, -long, -lat) %>% 
  write_sf(geojson_name)


###############################################################################
## Aggregate into Local Authorities and choose the most vulnerable in NE England and Wales
##

##
## England
##
vi_hardship_eng_LA = vi_hardship_eng %>% 
  left_join(msoa_lad, by = c("Code" = "MSOA11CD")) %>% 
  
  mutate(Top20 = ifelse(`Hardship Fund Vulnerability decile` >= 9, "Top20", "Other")) %>% 
  tabyl(LAD19CD, Top20) %>% 
  
  # calculate proportion of most deprived LSOAs
  mutate(`Proportion of neighbourhoods in 20% most vulnerable` = Top20 / (Top20 + Other)) %>% 
  select(-Other, -Top20) %>% 
  na.omit()

eng_summary = vi_hardship_eng_LA %>% 
  left_join(lad_names, by = "LAD19CD") %>% 
  left_join(lad_regions, by = "LAD19CD") %>% 
  filter(RGN19NM %in% c("North East")) %>% 
  
  select(Region = RGN19NM, `Local Authority` = LAD19NM, `Proportion of neighbourhoods in 20% most vulnerable`) %>% 
  arrange(desc(`Proportion of neighbourhoods in 20% most vulnerable`))


##
## Wales
##
vi_hardship_wal_LA = vi_hardship_wal %>% 
  left_join(msoa_lad, by = c("Code" = "MSOA11CD")) %>% 
  
  mutate(Top20 = ifelse(`Hardship Fund Vulnerability decile` >= 9, "Top20", "Other")) %>% 
  tabyl(LAD19CD, Top20) %>% 
  
  # calculate proportion of most deprived LSOAs
  mutate(`Proportion of neighbourhoods in 20% most vulnerable` = Top20 / (Top20 + Other)) %>% 
  select(-Other, -Top20) %>% 
  na.omit()

wales_summary = vi_hardship_wal_LA %>% 
  left_join(lad_names, by = "LAD19CD") %>% 
  mutate(Region = "Wales") %>% 
  
  select(Region, `Local Authority` = LAD19NM, `Proportion of neighbourhoods in 20% most vulnerable`) %>% 
  arrange(desc(`Proportion of neighbourhoods in 20% most vulnerable`))

bind_rows(eng_summary, wales_summary) %>% 
  write_csv("bespoke analysis - hardship fund/Hardship Fund Local Authorities.csv")


##
## test
##
vi_eng = read_csv("output/vulnerability-MSOA-England.csv")
food = read_csv("bespoke vulnerability index - food/food-vulnerability-MSOA-England.csv")

cor.test(vi_eng$`Vulnerability score`, vi_hardship_eng$`Hardship Fund Vulnerability score`)
cor.test(food$`Food Vulnerability score`, vi_hardship_eng$`Hardship Fund Vulnerability score`)

vi_eng = vi_eng %>% 
  select(Code, `Vulnerability score`) %>% 
  left_join(vi_hardship_eng, by = "Code") %>% 
  left_join(food, by = "Code")

plot(vi_eng$`Vulnerability score`, vi_eng$`Hardship Fund Vulnerability score`)
plot(vi_eng$`Vulnerability score`, vi_eng$`Food Vulnerability score`)


###############################################################################
## Aggregate into Tactical Cells
## - what proportion of the population is in the most vulnerable areas?
##
# load population estimates
source("prep population estimates.r")

# England
extent_eng = vi_hardship_eng %>% 
  left_join(msoa_tc, by = c("Code" = "MSOA11CD")) %>% 
  left_join(pop_eng, by = "Code") %>% 
  aggregate_scores(domain = "Hardship Fund", aggregate_by = "TacticalCell")

# Wales
extent_wal = vi_hardship_wal %>% 
  left_join(pop_eng, by = "Code") %>% 
  mutate(TacticalCell = "Wales") %>% 
  aggregate_scores(domain = "Hardship Fund", aggregate_by = "TacticalCell")

# Scotland
extent_sco = vi_hardship_sco %>% 
  left_join(pop_sco, by = "Code") %>% 
  mutate(TacticalCell = "Scotland") %>% 
  aggregate_scores(domain = "Hardship Fund", aggregate_by = "TacticalCell")

# NI
extent_ni = vi_hardship_ni %>% 
  left_join(pop_ni, by = "Code") %>% 
  mutate(TacticalCell = "Northern Ireland") %>% 
  aggregate_scores(domain = "Hardship Fund", aggregate_by = "TacticalCell")

# combine and save
bind_rows(extent_eng, extent_wal, extent_sco, extent_ni) %>% 
  mutate(Percentage = (Score / sum(Score) * 100)) %>% 
  write_csv("bespoke vulnerability index - hardship fund/Tactical Cell allocation.csv")


###############################################################################
## Aggregate into Regions
##
# England
extent_eng = vi_hardship_eng %>% 
  left_join(msoa_lad, by = c("Code" = "MSOA11CD")) %>% 
  left_join(pop_eng, by = "Code") %>% 
  aggregate_scores(domain = "Hardship Fund", aggregate_by = "RGN19NM")

# Wales
extent_wal = vi_hardship_wal %>% 
  left_join(pop_eng, by = "Code") %>% 
  mutate(RGN19NM = "Wales") %>% 
  aggregate_scores(domain = "Hardship Fund", aggregate_by = "RGN19NM")

# Scotland
extent_sco = vi_hardship_sco %>% 
  left_join(pop_sco, by = "Code") %>% 
  mutate(RGN19NM = "Scotland") %>% 
  aggregate_scores(domain = "Hardship Fund", aggregate_by = "RGN19NM")

# NI
extent_ni = vi_hardship_ni %>% 
  left_join(pop_ni, by = "Code") %>% 
  mutate(RGN19NM = "Northern Ireland") %>% 
  aggregate_scores(domain = "Hardship Fund", aggregate_by = "RGN19NM")

# combine and save
bind_rows(extent_eng, extent_wal, extent_sco, extent_ni) %>% 
  mutate(Percentage = (Score / sum(Score) * 100)) %>% 
  write_csv("bespoke vulnerability index - hardship fund/Regional allocation.csv")
