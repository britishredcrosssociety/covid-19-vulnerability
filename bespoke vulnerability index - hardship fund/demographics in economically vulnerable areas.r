##
## Demographics in most vulnerable areas
##
library(tidyverse)
library(readxl)
library(httr)

##
## load hardship data 
##
vi_hardship_eng = read_csv("bespoke vulnerability index - hardship fund/hardship-vulnerability-MSOA-England.csv")
vi_hardship_wal = read_csv("bespoke vulnerability index - hardship fund/hardship-vulnerability-MSOA-Wales.csv")
vi_hardship_sco = read_csv("bespoke vulnerability index - hardship fund/hardship-vulnerability-MSOA-Scotland.csv")
vi_hardship_ni  = read_csv("bespoke vulnerability index - hardship fund/hardship-vulnerability-MSOA-NI.csv")

vi_hardship = bind_rows(
  vi_hardship_eng %>% select(Code, starts_with("Hardship Fund")),
  vi_hardship_wal %>% select(Code, starts_with("Hardship Fund")),
  vi_hardship_sco %>% select(Code, starts_with("Hardship Fund")),
  vi_hardship_ni  %>% select(Code, starts_with("Hardship Fund"))
)

# keep only most vulnerable areas
vi_hardship = vi_hardship %>% 
  filter(`Hardship Fund Vulnerability decile` == 10)


##
## Load population estimates
##

# England and Wales
# source: https://www.ons.gov.uk/peoplepopulationandcommunity/populationandmigration/populationestimates/datasets/middlesuperoutputareamidyearpopulationestimates
# GET("https://www.ons.gov.uk/file?uri=%2fpeoplepopulationandcommunity%2fpopulationandmigration%2fpopulationestimates%2fdatasets%2fmiddlesuperoutputareamidyearpopulationestimates%2fmid2018sape21dt3a/sape21dt3amid2018msoaon2019lasyoaestimatesformatted.zip",
#     write_disk(tf <- tempfile(fileext = ".zip")))
# 
# unzip(tf, exdir = "data/population")
# unlink(tf); rm(tf)

pop_eng_m = read_excel("data/population/SAPE21DT3a-mid-2018-msoa-on-2019-LA-syoa-estimates-formatted.xlsx", sheet = "Mid-2018 Males", skip = 4)
pop_eng_f = read_excel("data/population/SAPE21DT3a-mid-2018-msoa-on-2019-LA-syoa-estimates-formatted.xlsx", sheet = "Mid-2018 Females", skip = 4)

# Scotland Intermediate Zone (2011) Population Estimates
# source: https://www.opendata.nhs.scot/dataset/population-estimates/resource/93df4c88-f74b-4630-abd8-459a19b12f47
pop_sco = read_csv("https://www.opendata.nhs.scot/dataset/7f010430-6ce1-4813-b25c-f7f335bdc4dc/resource/93df4c88-f74b-4630-abd8-459a19b12f47/download/iz2011-pop-est_02042020.csv")


##
## prep population data
##
pop_eng_m_age = pop_eng_m %>% 
  filter(!is.na(MSOA)) %>%  # drop Local Authorities
  
  # convert age columns to long format
  rename(`90` = `90+`) %>% 
  pivot_longer(cols = `0`:`90`, names_to = "Age", values_to = "n_people") %>% 
  mutate(Age = as.integer(Age)) %>% 
  
  mutate(AgeGroup = case_when(
    Age <= 17 ~ "Age 0 to 17",
    Age >= 18 & Age <= 64 ~ "Age 18 to 64",
    Age >= 65 & Age <= 79 ~ "Age 65 to 79",
    Age >= 80 ~ "Age 80+"
  )) %>% 
  
  rename(Code = `Area Codes`) %>% 
  
  # summarise into age groups
  group_by(Code, AgeGroup) %>% 
  summarise(n_people = sum(n_people, na.rm = TRUE)) %>% 
  
  mutate(Sex = "Male")

pop_eng_f_age = pop_eng_f %>% 
  filter(!is.na(MSOA)) %>%  # drop Local Authorities
  
  # convert age columns to long format
  rename(`90` = `90+`) %>% 
  pivot_longer(cols = `0`:`90`, names_to = "Age", values_to = "n_people") %>% 
  mutate(Age = as.integer(Age)) %>% 
  
  mutate(AgeGroup = case_when(
    Age <= 17 ~ "Age 0 to 17",
    Age >= 18 & Age <= 64 ~ "Age 18 to 64",
    Age >= 65 & Age <= 79 ~ "Age 65 to 79",
    Age >= 80 ~ "Age 80+"
  )) %>% 
  
  rename(Code = `Area Codes`) %>% 
  
  # summarise into age groups
  group_by(Code, AgeGroup) %>% 
  summarise(n_people = sum(n_people, na.rm = TRUE)) %>% 
  
  mutate(Sex = "Female")

pop_sco_age = pop_sco %>% 
  filter(Year == max(Year)) %>% 
  
  # sum across males and females
  group_by(IntZone, Sex) %>% 
  summarise_at(vars(contains("Age")), sum) %>% 
  
  pivot_longer(cols = Age0:Age90plus, names_to = "Age", values_to = "n_people") %>% 
  mutate(Age = as.integer(str_extract(Age, "[0-9]+"))) %>%    # extract ages as numbers
  rename(Code = IntZone) %>% 
  
  mutate(AgeGroup = case_when(
    Age <= 17 ~ "Age 0 to 17",
    Age >= 18 & Age <= 64 ~ "Age 18 to 64",
    Age >= 65 & Age <= 79 ~ "Age 65 to 79",
    Age >= 80 ~ "Age 80+"
  )) %>% 
  
  
  # sum whole population and people over 70
  group_by(Code, Sex, AgeGroup) %>% 
  summarise(n_people = sum(n_people, na.rm = TRUE))

# combine into one dataframe
pop_age = bind_rows(pop_eng_m_age, pop_eng_f_age, pop_sco_age)

# get proportions of people within age groups for whole nation
age_sex_uk = pop_age %>% 
  group_by(Sex) %>% 
  summarise(total = sum(n_people))

age_sex_uk = pop_age %>% 
  group_by(Sex, AgeGroup) %>% 
  summarise(n_people = sum(n_people, na.rm = TRUE)) %>% 
  
  left_join(age_sex_uk, by = "Sex") %>% 
  mutate(prop_people = n_people / total)


##
## get proportions of people in the most economically vulnerable areas
##
sex_vuln = pop_age %>% 
  filter(Code %in% vi_hardship$Code) %>% 
  
  group_by(Sex) %>% 
  summarise(total = sum(n_people))

age_sex_vuln = pop_age %>% 
  filter(Code %in% vi_hardship$Code) %>% 
  
  group_by(Sex, AgeGroup) %>% 
  summarise(n_people = sum(n_people, na.rm = TRUE)) %>% 
  
  left_join(sex_vuln, by = "Sex") %>% 
  mutate(prop_people = n_people / total)


##
## plot age pyramid
##
# make male age counts negative so the age pyramid displays properly
age_sex_uk   = age_sex_uk   %>% mutate(prop_people2 = ifelse(Sex == "Female", -1 * prop_people, prop_people))
age_sex_vuln = age_sex_vuln %>% mutate(prop_people2 = ifelse(Sex == "Female", -1 * prop_people, prop_people))

n_breaks = 0.1

ggplot(age_sex_vuln, aes(x = AgeGroup, y = prop_people2, fill = Sex, shape = Sex)) +
  geom_col(data = subset(age_sex_vuln, Sex == "Female")) +
  geom_col(data = subset(age_sex_vuln, Sex == "Male")) +
  
  geom_point(data = subset(age_sex_uk, Sex == "Female"), size = 2.5) +
  geom_point(data = subset(age_sex_uk, Sex == "Male"),   size = 2.5) +
  
  coord_flip() +
  
  scale_fill_brewer(palette = "Accent") +
  
  # make sure the scales are symmetrical and the -ve values (for plotting) are converted to their actual positive values
  scale_y_continuous(labels = scales::percent(c(rev(seq(0, max(age_sex_vuln$prop_people2), n_breaks)), seq(0, max(age_sex_vuln$prop_people2), n_breaks))),
                     breaks = c(-1 * rev(seq(0, max(age_sex_vuln$prop_people2), n_breaks)), seq(0, max(age_sex_vuln$prop_people2), n_breaks))) +
  
  labs(x = NULL, y = "Percentage of people") +
  
  theme_light() +
  theme(panel.border        = element_blank()
        ,axis.text          = element_text(size = 8)
        ,legend.text        = element_text(size = 8)
        ,legend.title       = element_blank()
        ,legend.position    = "bottom"
        ,panel.grid.major.x = element_blank()
        ,panel.grid.minor.x = element_blank()
        ,plot.margin        = margin(0.5, 0, 0.2, 0, "cm")
  )

ggsave("bespoke vulnerability index - hardship fund/age and sex pyramid.png", width = 175, height = 75, units = "mm")

sex_vuln$total[ sex_vuln$Sex == "Female" ] - sex_vuln$total[ sex_vuln$Sex == "Male" ]
