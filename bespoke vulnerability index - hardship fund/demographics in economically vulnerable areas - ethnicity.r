##
## Ethnicity in most economically vulnerable areas
##
library(tidyverse)
library(nomisr)
library(readxl)

# load mappings from censuses' ethnic groups to a standard list
eth_map = read_excel("data/census/Ethnic group mapping from census.xlsx") %>% 
  mutate(`BRC category` = trimws(`BRC category`))

##
## load hardship data 
##
vi_hardship_eng = read_csv("bespoke vulnerability index - hardship fund/hardship-vulnerability-MSOA-England.csv")
vi_hardship_wal = read_csv("bespoke vulnerability index - hardship fund/hardship-vulnerability-MSOA-Wales.csv")
vi_hardship_sco = read_csv("bespoke vulnerability index - hardship fund/hardship-vulnerability-MSOA-Scotland.csv")
vi_hardship_ni  = read_csv("bespoke vulnerability index - hardship fund/hardship-vulnerability-MSOA-NI.csv")

vi_hardship = bind_rows(
  vi_hardship_eng %>% select(Code, starts_with("Hardship Fund")),
  vi_hardship_wal %>% select(Code, starts_with("Hardship Fund")),
  vi_hardship_sco %>% select(Code, starts_with("Hardship Fund")),
  vi_hardship_ni  %>% select(Code, starts_with("Hardship Fund"))
)

# keep only most vulnerable areas
vi_hardship = vi_hardship %>% 
  filter(`Hardship Fund Vulnerability decile` == 10)


##
## Census ethnicity data from table KS201EW: Ethnic Group
## https://www.nomisweb.co.uk/census/2011/ks201ew
##
# Nomis API URL: https://www.nomisweb.co.uk/api/v01/dataset/NM_608_1.jsonstat.json?date=latest&geography=&rural_urban=0,100,101&cell=0,100,1...4,200,5...8,300,9...13,400,14...16,500,17,18&measures=20301
census_raw = nomis_get_data(
  id = "NM_608_1",
  date = "latest",
  geography = "TYPE297",  # MSOA
  
  rural_urban = "0,100,101",  # total urban and total rural, plus overall total
  cell = "0,100,1...4,200,5...8,300,9...13,400,14...16,500,17,18",  # all ethnic group categories
  
  # measures = "20301",  # percentages
  measure = "20100",   # values
  
  
  # variables to keep
  select = c(
    "GEOGRAPHY_CODE",
    "MEASURES_NAME",
    "RURAL_URBAN_NAME",
    "CELL_NAME",
    "OBS_VALUE"
  )
)

# unique(census_raw$CELL_NAME)

# census = census_raw %>% 
#   filter(RURAL_URBAN_NAME == "Total") %>% 
#   select(Code = GEOGRAPHY_CODE, Ethnicity = CELL_NAME, Value = OBS_VALUE) %>% 
#   filter(Ethnicity %in% c("White", "Asian/Asian British", "Black/African/Caribbean/Black British", "Mixed/multiple ethnic groups", "Other ethnic group"))

census_detailed = census_raw %>% 
  filter(RURAL_URBAN_NAME == "Total") %>% 
  select(Code = GEOGRAPHY_CODE, Ethnicity = CELL_NAME, Value = OBS_VALUE) %>% 
  filter(!Ethnicity %in% c("All usual residents", "White", "Asian/Asian British", "Black/African/Caribbean/Black British", "Mixed/multiple ethnic groups", "Other ethnic group"))

census_detailed = census_detailed %>% 
  left_join(eth_map %>% filter(Country == "England & Wales"), by = c("Ethnicity" = "Census category")) %>% 
  select(-Country, -Ethnicity, Ethnicity = `BRC category`, n = Value)

##
## Scotland ethnicity data
##
census_raw_sco = read_csv("data/census/Scotland/KS201SC.csv")

census_sco = census_raw_sco %>% 
  select(-`All people`, -contains("Total")) %>% 
  rename(Code = X1) %>% 
  filter(Code != "S92000003") %>% 
  gather(Ethnicity, n, -Code)

census_sco = census_sco %>% 
  left_join(eth_map %>% filter(Country == "Scotland"), by = c("Ethnicity" = "Census category")) %>% 
  na.omit() %>% 
  select(-Country, -Ethnicity, Ethnicity = `BRC category`)


##
## NI ethnicity data
##


# combine
census_all = bind_rows(census_detailed, census_sco)


##
## calculate UK-wide proportions
##
census_uk = census_all %>% 
  group_by(Ethnicity) %>% 
  summarise(Prop = sum(n) / sum(census_all$n))

census_vuln = census_all %>% 
  filter(Code %in% vi_hardship$Code)

# histogram of ethnicities within each the Cell
census_vuln %>% 
  group_by(Ethnicity) %>% 
  summarise(Prop = sum(n) / sum(census_vuln$n)) %>% 
  
  ggplot(aes(x = reorder(Ethnicity, Prop), y = Prop)) + 
  
  geom_col(fill = "cornflowerblue") +
  geom_point(data = census_uk, size = 1.5) +
  
  coord_flip() +
  
  scale_y_continuous(labels = scales::percent) +
  
  labs(x = NULL, y = "Percentage of people") +
  
  theme_light() +
  theme(panel.border        = element_blank()
        ,axis.text          = element_text(size = 8)
        ,legend.text        = element_text(size = 8)
        ,legend.title       = element_blank()
        ,legend.position    = "bottom"
        ,panel.grid.major.x = element_blank()
        ,panel.grid.minor.x = element_blank()
        ,plot.margin        = margin(0.5, 0, 0.2, 0, "cm")
        ,panel.grid.major   = element_blank()
        ,panel.grid.minor   = element_blank()
        ,panel.background   = element_rect(fill = "transparent", colour = NA)
        ,plot.background    = element_rect(fill = "transparent", colour = NA)
  )

ggsave("bespoke vulnerability index - hardship fund/ethnicity.png", bg = "transparent", width = 200, height = 85, units = "mm")
