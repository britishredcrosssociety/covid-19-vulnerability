##
## Create Hardship Fund Vulnerability Index
##
library(tidyverse)
library(readxl)
library(readODS)
library(httr)

source("functions.r")
source("load lookup tables.r")


##
## lookup tables
##
# load LSOA to MSOA codes lookup table
lsoa_msoa = load_lookup_lsoa_msoa_lad() %>% 
  select(LSOA11CD, MSOA11CD)

# Scotland
lookup_dz_iz = load_lookup_dz_iz_lad() %>% 
  select(LSOA11CD, MSOA11CD)


##
## Population estimates
##
source("prep population estimates.r")


##
## Load data on jobs in vulnerable sectors
##
source("prep ocsi data - england.r")
jobs_eng = ocsi %>% 
  select(Code = `MSOA Code`, `Jobs in accommodation and food services (hospitality) Rate`, `Jobs in arts, entertainment, recreation and other services Rate`, `Jobs in retail Rate`)

# Wales
source("prep ocsi data - wales.r")
jobs_wal = ocsi_wal %>% 
  select(Code, `Jobs in accommodation and food services (hospitality) Rate`, `Jobs in arts, entertainment, recreation and other services Rate`, `Jobs in retail Rate`)

# Scotland
source("prep ocsi data - scotland.r")
jobs_sco = ocsi_sco %>% 
  select(Code, `Jobs in accommodation and food services (hospitality) Rate`, `Jobs in arts, entertainment, recreation and other services Rate`, `Jobs in retail Rate`)

rm(ocsi, ocsi_wal, ocsi_sco)


##
## income deprivation (England):
## - Adults and children in Income Support families
## - Adults and children in income-based Jobseeker's Allowance families
## - Adults and children in income-based Employment and Support Allowance families
## - Adults and children in Pension Credit (Guarantee) families
## - Adults and children in Working Tax Credit and Child Tax Credit families not already counted
## - Adults and children in Universal Credit families where no adult is in 'Working - no requirements' conditionality regime
## - Asylum seekers in England in receipt of subsistence support, accommodation support, or both
##
# load underlying indicators for IMD
# source: "File 5: scores for the indices of deprivation" from https://www.gov.uk/government/statistics/english-indices-of-deprivation-2019
GET("https://assets.publishing.service.gov.uk/government/uploads/system/uploads/attachment_data/file/833978/File_5_-_IoD2019_Scores.xlsx",
    write_disk(tf <- tempfile(fileext = ".xlsx")))
imd_eng_scores = read_excel(tf, sheet = "IoD2019 Scores")
unlink(tf); rm(tf)

# aggregate into MSOAs
imd_eng_income = imd_eng_scores %>% 
  select(LSOA11CD = `LSOA code (2011)`, `Income Score (rate)`) %>% 
  
  left_join(lsoa_msoa, by = "LSOA11CD") %>% 
  rename(Code = MSOA11CD) %>% 
  
  group_by(Code) %>% 
  summarise(`Income deprivation` = max(`Income Score (rate)`))


##
## Homelessness indicator from English IMD
##
GET("https://assets.publishing.service.gov.uk/government/uploads/system/uploads/attachment_data/file/833992/File_8_-_IoD2019_Underlying_Indicators.xlsx",
    write_disk(tf <- tempfile(fileext = ".xlsx")))

imd_eng_barriers = read_excel(tf, sheet = "IoD2019 Barriers Domain")
unlink(tf); rm(tf)

imd_eng_homelessness = imd_eng_barriers %>% 
  select(LSOA11CD = `LSOA code (2011)`, `Homelessness indicator (rate per 1000 households)`) %>% 
  left_join(lsoa_msoa, by = "LSOA11CD") %>% 
  rename(Code = MSOA11CD) %>% 
  
  group_by(Code) %>% 
  summarise(Homelessness = max(`Homelessness indicator (rate per 1000 households)`))


##
## income deprivation (Wales):
## - Income-Related Benefit claimants
## - Tax Credit recipient
## - Supported Asylum Seeker
## - People on Universal Credit (excluding those "working with no requirements")
##
# load function to download data from Stats Wales (without having to install the assocaited `brclib` package)
source("https://github.com/matthewgthomas/brclib/raw/master/R/download_wales.R")

imd_wal = download_wales("http://open.statswales.gov.wales/en-gb/dataset/wimd1912")

imd_wal_income = imd_wal %>% 
  select(Code = MSOA_Code, Indicator = Indicator_ItemName_ENG, Data) %>% 
  filter(Indicator == "People in income deprivation (%)") %>% 
  pivot_wider(names_from = Indicator, values_from = Data)


##
## income deprivation (Scotland)
## - Income Support and Income-based Employment Support Allowance claimants (16-59)
## - Job Seekers Allowance and Guaranteed Pension Credit Claimants (All ages)
## - Universal Credit claimants with no employment marker
## - Number of children in JSA, IS or ESA households
## - Number of Adults and children dependent on adults in receipt of tax credits
##
GET("https://www.gov.scot/binaries/content/documents/govscot/publications/statistics/2020/01/scottish-index-of-multiple-deprivation-2020-indicator-data/documents/simd_2020_indicators/simd_2020_indicators/govscot%3Adocument/SIMD_2020_Indicators.xlsx",
    write_disk(tf <- tempfile(fileext = ".xlsx")))

imd_sco = read_excel(tf, sheet = "Data")
unlink(tf); rm(tf)

imd_sco_income = imd_sco %>% 
  select(Data_Zone, Income_count) %>% 
  left_join(lookup_dz_iz, by = c("Data_Zone" = "LSOA11CD")) %>% 
  rename(Code = MSOA11CD) %>% 
  group_by(Code) %>% 
  summarise(income_count = max(Income_count))


##
## income deprivation (NI)
##
# download Super Output Area results
# source: https://www.nisra.gov.uk/statistics/deprivation/northern-ireland-multiple-deprivation-measure-2017-nimdm2017
GET("https://www.nisra.gov.uk/sites/nisra.gov.uk/files/publications/NIMDM17_SOAresults.xls",
    write_disk(tf <- tempfile(fileext = ".xls")))

imd_ni_income = read_excel(tf, sheet = "Income")
unlink(tf); rm(tf)

imd_ni_income = imd_ni_income %>% 
  select(Code = SOA2001, `Proportion of low-income population` = `Proportion of the population living in households whose equivalised income is below 60 per cent of the NI median \n(%)`)


##
## people living alone (from CACI)
##
living_alone_lsoa = read_csv("data/CACI/living-alone-lsoa.csv")
living_alone_msoa = read_csv("data/CACI/living-alone-msoa.csv")

# merge SOAs for Northern Ireland into the MSOA dataframe
living_alone_msoa = living_alone_msoa %>% 
  filter(!startsWith(MSOA11CD, "N")) %>%  # no MSOAs in Northern Ireland
  
  bind_rows( living_alone_lsoa %>% filter(startsWith(LSOA11CD, "9")) %>% rename(MSOA11CD = LSOA11CD) ) %>% 
  rename(Code = MSOA11CD)

rm(living_alone_lsoa)


##
## calculate bespoke vulnerability scores for hardship fund (England)
##
vi_hardship_eng = jobs_eng %>% 
  left_join(imd_eng_income, by = "Code") %>% 
  left_join(imd_eng_homelessness, by = "Code") %>% 
  left_join(pop_eng_older, by = "Code") %>% 
  left_join(living_alone_msoa, by = "Code") %>% 
  
  calc_domain_scores(domain = "Hardship Fund")

vi_hardship_wal = jobs_wal %>%
  left_join(imd_wal_income, by = "Code") %>% 
  left_join(pop_eng_older, by = "Code") %>% 
  left_join(living_alone_msoa, by = "Code") %>% 
  
  calc_domain_scores(domain = "Hardship Fund")

vi_hardship_sco = imd_sco_income %>% 
  left_join(jobs_sco, by = "Code") %>% 
  left_join(pop_sco_older, by = "Code") %>% 
  left_join(living_alone_msoa, by = "Code") %>% 
  
  calc_domain_scores(domain = "Hardship Fund")

vi_hardship_ni = imd_ni_income %>% 
  left_join(living_alone_msoa, by = "Code") %>% 
  
  calc_domain_scores(domain = "Hardship Fund")

# save
write_csv(vi_hardship_eng, "bespoke vulnerability index - hardship fund/hardship-vulnerability-MSOA-England.csv")
write_csv(vi_hardship_wal, "bespoke vulnerability index - hardship fund/hardship-vulnerability-MSOA-Wales.csv")
write_csv(vi_hardship_sco, "bespoke vulnerability index - hardship fund/hardship-vulnerability-MSOA-Scotland.csv")
write_csv(vi_hardship_ni,  "bespoke vulnerability index - hardship fund/hardship-vulnerability-MSOA-NI.csv")
