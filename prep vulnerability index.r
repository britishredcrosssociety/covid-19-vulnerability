##
## combine clinical and social vulnerability into a single map
##
library(tidyverse)
library(Hmisc)
library(sf)

reproduce_data = FALSE

if (reproduce_data) {
  source("prep deprivation.r")
  source("prep community needs index.r")
  source("prep prevalence of underlying conditions.r")
}

# load data for mapping
imd_covid_ward = read_csv("data/covid-deprivation.csv")
clinical_wards = read_csv("data/clinical-vulnerability.csv")
community_needs = read_csv("data/community-needs.csv")

# Wards (December 2017) Generalised Clipped Boundaries in UK (WGS84)
# source: https://geoportal.statistics.gov.uk/datasets/wards-december-2017-generalised-clipped-boundaries-in-uk-wgs84
wards = read_sf("https://opendata.arcgis.com/datasets/7193daa99995445aa84a0b23352e56a1_2.geojson")

# keep only England
wards = wards %>% 
  filter(startsWith(wd17cd, "E"))

# combine all the data sources
wards_vulnerability = wards %>% 
  left_join(clinical_wards, by = "wd17cd") %>% 
  left_join(imd_covid_ward, by = c("wd17cd" = "WD17CD")) %>% 
  left_join(community_needs, by = "wd17cd")

# make a combined vulnerability index (weighting everything equally)
wards_vulnerability = wards_vulnerability %>% 
  filter(left_behind == 1) %>% 
  
  # if any risk quintile is NA (missing data), just set to zero so the total doesn't become NA
  mutate(Clinical_Risk = replace_na(Clinical_Risk, 0),
         Deprivation_q = replace_na(Deprivation_q, 0)) %>% 
  
  mutate(Vulnerability = Clinical_Risk + Deprivation_q) %>%  # don't need to include community needs index because we're only looking at left-behind areas
  mutate(Vulnerability_q = as.integer(cut2(Vulnerability, g = 5)))

# save spatial file so don't have to keep re-making this
write_sf(wards_vulnerability, "data/wards_vulnerability.geojson")

# save .csv with indicators
wards_vulnerability %>% 
  st_drop_geometry() %>% 
  select(wd17cd, wd17nm, CHD_mean:Vulnerability_q) %>% 
  write_csv("data/wards_vulnerability.csv")

# make the interactive map
rmarkdown::render("ward-vulnerability.Rmd", output_file="index.html", output_dir="docs")
